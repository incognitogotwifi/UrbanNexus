/**
 * Copyright: 2022 iAppsBeats LTD, All rights reserved
 */
var requirejs,require,define;(function(r){function K(e){return O.call(e)==="[object Function]"}function G(e){return O.call(e)==="[object Array]"}function $(e,t,n){for(var r in t)!(r in L)&&(!(r in e)||n)&&(e[r]=t[r]);return d}function P(e,t,n){return e=Error(t+"\nhttp://requirejs.org/docs/errors.html#"+e),n&&(e.originalError=n),e}function aa(e,t,n){var r,i,s;for(r=0;s=t[r];r++)s=typeof s=="string"?{name:s}:s,i=s.location,n&&(!i||i.indexOf("/")!==0&&i.indexOf(":")===-1)&&(i=n+"/"+(i||s.name)),e[s.name]={name:s.name,location:i||s.name,main:(s.main||"main").replace(fa,"").replace(ba,"")}}function V(e,t){e.holdReady?e.holdReady(t):t?e.readyWait+=1:e.ready(!0)}function ga(e){function t(e,t){var n,r;if(e&&e.charAt(0)===".")if(t){E.pkgs[t]?t=[t]:(t=t.split("/"),t=t.slice(0,t.length-1)),n=e=t.concat(e.split("/"));var i;for(r=0;i=n[r];r++)if(i===".")n.splice(r,1),r-=1;else if(i===".."){if(r===1&&(n[2]===".."||n[0]===".."))break;r>0&&(n.splice(r-1,2),r-=2)}r=E.pkgs[n=e[0]],e=e.join("/"),r&&e===n+"/"+r.main&&(e=n)}else e.indexOf("./")===0&&(e=e.substring(2));return e}function n(e,n){var r=e?e.indexOf("!"):-1,i=null,s=n?n.name:null,o=e,u,a;return r!==-1&&(i=e.substring(0,r),e=e.substring(r+1,e.length)),i&&(i=t(i,s)),e&&(i?u=(r=N[i])&&r.normalize?r.normalize(e,function(e){return t(e,s)}):t(e,s):(u=t(e,s),a=T[u],a||(a=b.nameToUrl(e,null,n),T[u]=a))),{prefix:i,name:u,parentMap:n,url:a,originalName:o,fullName:i?i+"!"+(u||""):u}}function i(){var e=!0,t=E.priorityWait,n,r;if(t){for(r=0;n=t[r];r++)if(!C[n]){e=!1;break}e&&delete E.priorityWait}return e}function s(e,t,n){return function(){var r=ha.call(arguments,0),i;return n&&K(i=r[r.length-1])&&(i.__requireJsBuild=!0),r.push(t),e.apply(null,r)}}function o(e,t,n){return t=s(n||b.require,e,t),$(t,{nameToUrl:s(b.nameToUrl,e),toUrl:s(b.toUrl,e),defined:s(b.requireDefined,e),specified:s(b.requireSpecified,e),isBrowser:d.isBrowser}),t}function u(e){var t,i,s,o=e.callback,u=e.map,a=u.fullName,f=e.deps;s=e.listeners;var l=E.requireExecCb||d.execCb;if(o&&K(o)){if(E.catchError.define)try{i=l(a,e.callback,f,N[a])}catch(c){t=c}else i=l(a,e.callback,f,N[a]);a&&((o=e.cjsModule)&&o.exports!==r&&o.exports!==N[a]?i=N[a]=e.cjsModule.exports:i===r&&e.usingExports?i=N[a]:(N[a]=i,H[a]&&(B[a]=!0)))}else a&&(i=N[a]=o,H[a]&&(B[a]=!0));k[e.id]&&(delete k[e.id],e.isDone=!0,b.waitCount-=1,b.waitCount===0&&(A=[])),delete _[a],d.onResourceLoad&&!e.placeholder&&d.onResourceLoad(b,u,e.depArray);if(t)return i=(a?n(a).url:"")||t.fileName||t.sourceURL,s=t.moduleTree,t=P("defineerror",'Error evaluating module "'+a+'" at location "'+i+'":\n'+t+"\nfileName:"+i+"\nlineNumber: "+(t.lineNumber||t.line),t),t.moduleName=a,t.moduleTree=s,d.onError(t);for(t=0;o=s[t];t++)o(i);return r}function a(e,t){return function(n){e.depDone[t]||(e.depDone[t]=!0,e.deps[t]=n,e.depCount-=1,e.depCount||u(e))}}function f(e,t){var r=t.map,i=r.fullName,s=r.name,a=D[e]||(D[e]=N[e]),f;t.loading||(t.loading=!0,f=function(e){t.callback=function(){return e},u(t),C[t.id]=!0,w()},f.fromText=function(e,t){var n=Q;C[e]=!1,b.scriptCount+=1,b.fake[e]=!0,n&&(Q=!1),d.exec(t),n&&(Q=!0),b.completeLoad(e)},i in N?f(N[i]):a.load(s,o(r.parentMap,!0,function(e,i){var s=[],o,u;for(o=0;u=e[o];o++)u=n(u,r.parentMap),e[o]=u.fullName,u.prefix||s.push(e[o]);return t.moduleDeps=(t.moduleDeps||[]).concat(s),b.require(e,i)}),f,E))}function l(e){k[e.id]||(k[e.id]=e,A.push(e),b.waitCount+=1)}function c(e){this.listeners.push(e)}function h(e,t){var r=e.fullName,i=e.prefix,s=i?D[i]||(D[i]=N[i]):null,o,a;return r&&(o=_[r]),!o&&(a=!0,o={id:(i&&!s?M++ +"__p@:":"")+(r||"__r@"+M++),map:e,depCount:0,depDone:[],depCallbacks:[],deps:[],listeners:[],add:c},x[o.id]=!0,r&&(!i||D[i]))&&(_[r]=o),i&&!s?(r=n(i),i in N&&!N[i]&&(delete N[i],delete O[r.url]),i=h(r,!0),i.add(function(){var t=n(e.originalName,e.parentMap),t=h(t,!0);o.placeholder=!0,t.add(function(e){o.callback=function(){return e},u(o)})})):a&&t&&(C[o.id]=!1,b.paused.push(o),l(o)),o}function p(e,t,i,s){var e=n(e,s),f=e.name,c=e.fullName,p=h(e),d=p.id,v=p.deps,m;if(c){if(c in N||C[d]===!0||c==="jquery"&&E.jQuery&&E.jQuery!==i().fn.jquery)return;x[d]=!0,C[d]=!0,c==="jquery"&&i&&W(i())}p.depArray=t,p.callback=i;for(i=0;i<t.length;i++)if(d=t[i])d=n(d,f?e:s),m=d.fullName,t[i]=m,m==="require"?v[i]=o(e):m==="exports"?(v[i]=N[c]={},p.usingExports=!0):m==="module"?p.cjsModule=v[i]={id:f,uri:f?b.nameToUrl(f,null,s):r,exports:N[c]}:!(m in N)||m in k||c in H&&!(c in H&&B[m])?(c in H&&(H[m]=!0,delete N[m],O[d.url]=!1),p.depCount+=1,p.depCallbacks[i]=a(p,i),h(d,!0).add(p.depCallbacks[i])):v[i]=N[m];p.depCount?l(p):u(p)}function v(e){p.apply(null,e)}function m(e,t){var n=e.map.fullName,i=e.depArray,s=!0,o,u,a,f;if(e.isDone||!n||!C[n])return f;if(t[n])return e;t[n]=!0;if(i){for(o=0;o<i.length;o++){u=i[o];if(!C[u]&&!ia[u]){s=!1;break}if((a=k[u])&&!a.isDone&&C[u])if(f=m(a,t))break}s||(f=r,delete t[n])}return f}function g(e,t){var i=e.map.fullName,s=e.depArray,o,u,a,f;if(e.isDone||!i||!C[i])return r;if(i){if(t[i])return N[i];t[i]=!0}if(s)for(o=0;o<s.length;o++)if(u=s[o])if((a=n(u).prefix)&&(f=k[a])&&g(f,t),(a=k[u])&&!a.isDone&&C[u])u=g(a,t),e.depCallbacks[o](u);return N[i]}function y(){var e=E.waitSeconds*1e3,e=e&&b.startTime+e<(new Date).getTime(),t="",n=!1,s=!1,o=[],u,a;if(b.pausedCount>0)return r;if(E.priorityWait){if(!i())return r;w()}for(u in C)if(!(u in L)&&(n=!0,!C[u]))if(e)t+=u+" ";else{if(s=!0,u.indexOf("!")===-1){o=[];break}(a=_[u]&&_[u].moduleDeps)&&o.push.apply(o,a)}if(!n&&!b.waitCount)return r;if(e&&t)return e=P("timeout","Load timeout for modules: "+t),e.requireType="timeout",e.requireModules=t,e.contextName=b.contextName,d.onError(e);if(s&&o.length)for(t=0;u=k[o[t]];t++)if(u=m(u,{})){g(u,{});break}if(!e&&(s||b.scriptCount))return(I||da)&&!X&&(X=setTimeout(function(){X=0,y()},50)),r;if(b.waitCount){for(t=0;u=A[t];t++)g(u,{});b.paused.length&&w(),Y<5&&(Y+=1,y())}return Y=0,d.checkReadyState(),r}var b,w,E={waitSeconds:7,baseUrl:"./",paths:{},pkgs:{},catchError:{}},S=[],x={require:!0,exports:!0,module:!0},T={},N={},C={},k={},A=[],O={},M=0,_={},D={},H={},B={},j=0;return W=function(e){!b.jQuery&&(e=e||(typeof jQuery!="undefined"?jQuery:null))&&(!E.jQuery||e.fn.jquery===E.jQuery)&&("holdReady"in e||"readyWait"in e)&&(b.jQuery=e,v(["jquery",[],function(){return jQuery}]),b.scriptCount)&&(V(e,!0),b.jQueryIncremented=!0)},w=function(){var e,t,n,s,o,u;b.takeGlobalQueue(),j+=1,b.scriptCount<=0&&(b.scriptCount=0);for(;S.length;){if(e=S.shift(),e[0]===null)return d.onError(P("mismatch","Mismatched anonymous define() module: "+e[e.length-1]));v(e)}if(!E.priorityWait||i())for(;b.paused.length;){o=b.paused,b.pausedCount+=o.length,b.paused=[];for(s=0;e=o[s];s++)t=e.map,n=t.url,u=t.fullName,t.prefix?f(t.prefix,e):!O[n]&&!C[u]&&((E.requireLoad||d.load)(b,u,n),n.indexOf("empty:")!==0&&(O[n]=!0));b.startTime=(new Date).getTime(),b.pausedCount-=o.length}return j===1&&y(),j-=1,r},b={contextName:e,config:E,defQueue:S,waiting:k,waitCount:0,specified:x,loaded:C,urlMap:T,urlFetched:O,scriptCount:0,defined:N,paused:[],pausedCount:0,plugins:D,needFullExec:H,fake:{},fullExec:B,managerCallbacks:_,makeModuleMap:n,normalize:t,configure:function(e){var t,n,r;e.baseUrl&&e.baseUrl.charAt(e.baseUrl.length-1)!=="/"&&(e.baseUrl+="/"),t=E.paths,r=E.pkgs,$(E,e,!0);if(e.paths){for(n in e.paths)n in L||(t[n]=e.paths[n]);E.paths=t}if((t=e.packagePaths)||e.packages){if(t)for(n in t)n in L||aa(r,t[n],n);e.packages&&aa(r,e.packages),E.pkgs=r}e.priority&&(n=b.requireWait,b.requireWait=!1,w(),b.require(e.priority),w(),b.requireWait=n,E.priorityWait=e.priority),(e.deps||e.callback)&&b.require(e.deps||[],e.callback)},requireDefined:function(e,t){return n(e,t).fullName in N},requireSpecified:function(e,t){return n(e,t).fullName in x},require:function(t,r,i){if(typeof t=="string")return K(r)?d.onError(P("requireargs","Invalid require call")):d.get?d.get(b,t,r):(r=n(t,r),t=r.fullName,t in N?N[t]:d.onError(P("notloaded","Module name '"+r.fullName+"' has not been loaded yet for context: "+e)));(t&&t.length||r)&&p(null,t,r,i);if(!b.requireWait)for(;!b.scriptCount&&b.paused.length;)w();return b.require},takeGlobalQueue:function(){U.length&&(ja.apply(b.defQueue,[b.defQueue.length-1,0].concat(U)),U=[])},completeLoad:function(e){var t;for(b.takeGlobalQueue();S.length;){if(t=S.shift(),t[0]===null){t[0]=e;break}if(t[0]===e)break;v(t),t=null}t?v(t):v([e,[],e==="jquery"&&typeof jQuery!="undefined"?function(){return jQuery}:null]),d.isAsync&&(b.scriptCount-=1),w(),d.isAsync||(b.scriptCount-=1)},toUrl:function(e,t){var n=e.lastIndexOf("."),r=null;return n!==-1&&(r=e.substring(n,e.length),e=e.substring(0,n)),b.nameToUrl(e,r,t)},nameToUrl:function(e,n,r){var i,s,o,u,a=b.config,e=t(e,r&&r.fullName);if(d.jsExtRegExp.test(e))n=e+(n?n:"");else{i=a.paths,s=a.pkgs,r=e.split("/");for(u=r.length;u>0;u--){if(o=r.slice(0,u).join("/"),i[o]){r.splice(0,u,i[o]);break}if(o=s[o]){e=e===o.name?o.location+"/"+o.main:o.location,r.splice(0,u,e);break}}n=r.join("/")+(n||".js"),n=(n.charAt(0)==="/"||n.match(/^[\w\+\.\-]+:/)?"":a.baseUrl)+n}return a.urlArgs?n+((n.indexOf("?")===-1?"?":"&")+a.urlArgs):n}},b.jQueryCheck=W,b.resume=w,b}function ka(){var e,t,n;if(C&&C.readyState==="interactive")return C;e=document.getElementsByTagName("script");for(t=e.length-1;t>-1&&(n=e[t]);t--)if(n.readyState==="interactive")return C=n;return null}var la=/(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/mg,ma=/require\(\s*["']([^'"\s]+)["']\s*\)/g,fa=/^\.\//,ba=/\.js$/,O=Object.prototype.toString,u=Array.prototype,ha=u.slice,ja=u.splice,I=typeof window!="undefined"&&!!navigator&&!!document,da=!I&&typeof importScripts!="undefined",na=I&&navigator.platform==="PLAYSTATION 3"?/^complete$/:/^(complete|loaded)$/,ea=typeof opera!="undefined"&&opera.toString()==="[object Opera]",L={},D={},U=[],C=null,Y=0,Q=!1,ia={require:!0,module:!0,exports:!0},d,u={},J,y,v,E,o,w,F,B,z,W,X;if(typeof define=="undefined"){if(typeof requirejs!="undefined"){if(K(requirejs))return;u=requirejs,requirejs=r}typeof require!="undefined"&&!K(require)&&(u=require,require=r),d=requirejs=function(e,t,n){var r="_",i;return!G(e)&&typeof e!="string"&&(i=e,G(t)?(e=t,t=n):e=[]),i&&i.context&&(r=i.context),n=D[r]||(D[r]=ga(r)),i&&n.configure(i),n.require(e,t)},d.config=function(e){return d(e)},require||(require=d),d.toUrl=function(e){return D._.toUrl(e)},d.version="1.0.8",d.jsExtRegExp=/^\/|:|\?|\.js$/,y=d.s={contexts:D,skipAsync:{}};if(d.isAsync=d.isBrowser=I)if(v=y.head=document.getElementsByTagName("head")[0],E=document.getElementsByTagName("base")[0])v=y.head=E.parentNode;d.onError=function(e){throw e},d.load=function(e,t,n){d.resourcesReady(!1),e.scriptCount+=1,d.attach(n,e,t),e.jQuery&&!e.jQueryIncremented&&(V(e.jQuery,!0),e.jQueryIncremented=!0)},define=function(e,t,n){var i,s;return typeof e!="string"&&(n=t,t=e,e=null),G(t)||(n=t,t=[]),!t.length&&K(n)&&n.length&&(n.toString().replace(la,"").replace(ma,function(e,n){t.push(n)}),t=(n.length===1?["require"]:["require","exports","module"]).concat(t)),Q&&(i=J||ka())&&(e||(e=i.getAttribute("data-requiremodule")),s=D[i.getAttribute("data-requirecontext")]),(s?s.defQueue:U).push([e,t,n]),r},define.amd={multiversion:!0,plugins:!0,jQuery:!0},d.exec=function(a){return eval(a)},d.execCb=function(e,t,n,r){return t.apply(r,n)},d.addScriptToDom=function(e){J=e,E?v.insertBefore(e,E):v.appendChild(e),J=null},d.onScriptLoad=function(e){var t=e.currentTarget||e.srcElement,n;if(e.type==="load"||t&&na.test(t.readyState))C=null,e=t.getAttribute("data-requirecontext"),n=t.getAttribute("data-requiremodule"),D[e].completeLoad(n),t.detachEvent&&!ea?t.detachEvent("onreadystatechange",d.onScriptLoad):t.removeEventListener("load",d.onScriptLoad,!1)},d.attach=function(e,t,n,r,i,s){var o;return I?(r=r||d.onScriptLoad,o=t&&t.config&&t.config.xhtml?document.createElementNS("http://www.w3.org/1999/xhtml","html:script"):document.createElement("script"),o.type=i||t&&t.config.scriptType||"text/javascript",o.charset="utf-8",o.async=!y.skipAsync[e],t&&o.setAttribute("data-requirecontext",t.contextName),o.setAttribute("data-requiremodule",n),o.attachEvent&&!(o.attachEvent.toString&&o.attachEvent.toString().indexOf("[native code]")<0)&&!ea?(Q=!0,s?o.onreadystatechange=function(){o.readyState==="loaded"&&(o.onreadystatechange=null,o.attachEvent("onreadystatechange",r),s(o))}:o.attachEvent("onreadystatechange",r)):o.addEventListener("load",r,!1),o.src=e,s||d.addScriptToDom(o),o):(da&&(importScripts(e),t.completeLoad(n)),null)};if(I){o=document.getElementsByTagName("script");for(B=o.length-1;B>-1&&(w=o[B]);B--){v||(v=w.parentNode);if(F=w.getAttribute("data-main")){u.baseUrl||(o=F.split("/"),w=o.pop(),o=o.length?o.join("/")+"/":"./",u.baseUrl=o,F=w.replace(ba,"")),u.deps=u.deps?u.deps.concat(F):[F];break}}}d.checkReadyState=function(){var e=y.contexts,t;for(t in e)if(!(t in L)&&e[t].waitCount)return;d.resourcesReady(!0)},d.resourcesReady=function(e){var t,n;d.resourcesDone=e;if(d.resourcesDone)for(n in e=y.contexts,e)!(n in L)&&(t=e[n],t.jQueryIncremented)&&(V(t.jQuery,!1),t.jQueryIncremented=!1)},d.pageLoaded=function(){document.readyState!=="complete"&&(document.readyState="complete")},I&&document.addEventListener&&!document.readyState&&(document.readyState="loading",window.addEventListener("load",d.pageLoaded,!1)),d(u),d.isAsync&&typeof setTimeout!="undefined"&&(z=y.contexts[u.context||"_"],z.requireWait=!0,setTimeout(function(){z.requireWait=!1,z.scriptCount||z.resume(),d.checkReadyState()},0))}})(),define("lib/require",function(){});var initializing=!1,fnTest=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Class=function(){},Class.extend=function(e){var t=this.prototype;initializing=!0;var n=new this;initializing=!1;for(var r in e)n[r]=typeof e[r]=="function"&&typeof t[r]=="function"&&fnTest.test(e[r])?function(e,n){return function(){var r=this._super;this._super=t[e];var i=n.apply(this,arguments);return this._super=r,i}}(r,e[r]):e[r];return Class=function(){!initializing&&this.init&&this.init.apply(this,arguments)},Class.prototype=n,Class.constructor=Class,Class.extend=arguments.callee,Class},typeof exports!="undefined"&&(exports.Class=Class),define("lib/class",function(){}),define("app",["lib/class"],function(){var e=Class.extend({init:function(){this.language=window.navigator?(window.navigator.userLanguage||window.navigator.language||"en").substring(0,2):null,this.ready=!1,gui.addClass("playbutton","loading"),this.keyAction={},this.keyScript=null},setGame:function(e){this.game=e,this.isMobile=this.game.renderer.isMobile,this.isDesktop=!this.isMobile,this.isMobile?(gui.show("weaponpad"),gui.show("movepad")):gui.hide("movepad"),this.ready=!0,gui.removeClass("playbutton","loading")},center:function(){window.scrollTo(0,1)},tryStartGame:function(){this.startGame()},startGame:function(){if(!this.game)return;gui.setClick("playbutton",null),gui.addClass("playbutton","loading"),this.start()},start:function(){if(this.game&&this.game.started)return;this.game.setServerOptions(this.config.serveraddress),this.center(),this.game.run()},setMouseCoordinates:function(e){var t=gui.getPositionFromEvent("gamecontainer",e);this.game.mouse.x=Math.max(0,Math.min(t.x,this.game.renderer.canvas.width-1)),this.game.mouse.y=Math.max(0,Math.min(t.y,this.game.renderer.canvas.height-1))},showChat:function(){return this.game.shop.hasExternInterfaceVersion(1.1)&&Config_Extern["platform"]=="iphone"?(this.game.shop.sendOpenTextField("chat","",""),gui.blur("chatbutton"),this.game.client&&this.game.client.sendIsTalking(!0),this.game.player&&(this.game.player.talk=!0),!1):this.game&&this.game.started?(gui.show("chatbox"),gui.focus("chatinput"),this.game.client&&this.game.client.sendIsTalking(!0),this.game.player&&(this.game.player.talk=!0),!0):!1},hideChat:function(){this.game&&this.game.started&&(gui.isVisible("chatbox")&&this.game.client&&this.game.client.sendIsTalking(!1),this.game.player&&(this.game.player.talk=!1),gui.hide("chatbox"),gui.blur("chatinput"))},hideWindows:function(){gui.isVisible("reconnectscreen")?this.reconnect():(gui.isVisible("deathscreen")||!this.game.player)&&this.revive(!1)},revive:function(e){gui.fadeOut("deathscreen"),this.game.restart(e)},reconnect:function(){window.location.href=window.location.href}});return e});var clientstorageversion=1;define("storage",["lib/class"],function(){var e=Class.extend({init:function(){this.ghostcookie="xt:ghost";if(logincookie==this.ghostcookie)this.loadWithCookie(""),this.ghost=!0;else{var e=Config_Extern&&Config_Extern["platform"]=="facebook";e&&logincookie&&logincookie.length&&logincookie.indexOf(":")<0&&(logincookie="fc:"+logincookie),this.loadWithCookie(logincookie),e||(this.ghost=!0)}},loadWithCookie:function(e){this.ghost=!1;var t=e&&e.length>0?e:null,n=!1;if(!this.load())this.resetData(t),n=!0;else if(!this.data||!this.data.version||this.data.version<clientstorageversion)window.console&&console.log("Resetting local data because of outdated version."),this.resetData(t),n=!0;t&&t.length>0?(!n&&this.data.cookie&&this.data.cookie.indexOf(":")<0&&(this.data.cookie2=this.data.cookie),this.data.cookie=t):this.data.cookie&&this.data.cookie.indexOf(":")>=0&&(this.data.cookie2?(this.data.cookie=this.data.cookie2,delete this.data.cookie2):this.resetData()),this.save()},resetData:function(e){var t=e?e:Guid.newGuid();this.data={version:clientstorageversion,cookie:t,player:{name:""}}},hasLocalStorage:function(){return typeof e!="undefined"},load:function(){if(this.ghost)return;try{if(this.hasLocalStorage()&&localStorage.data)return this.data=JSON.parse(localStorage.data),!0}catch(e){}return!1},save:function(){if(this.ghost)return;try{this.hasLocalStorage()&&(localStorage.data=JSON.stringify(this.data))}catch(e){}},clear:function(){if(this.ghost)return;try{this.hasLocalStorage()&&(localStorage.data="",this.resetData())}catch(e){}},getCookie:function(){return this.ghost?this.ghostcookie:this.data.cookie},getCookie2:function(){return this.ghost?this.data.cookie:this.data.cookie2},setPlayerName:function(e){if(this.ghost)return;this.data.player.name=e,this.save()}});return e}),define("infomanager",[],function(){var e=Class.extend({init:function(e){this.game=e,this.damageinfos={},this.destroyQueue=[],this.ingamedoms={},this.killerinfos=[]},addInGameDom:function(e,t,n){if(this.ingamedoms[e])gui.setHTML(this.ingamedoms[e],t);else{var r=document.createElement("div");r.innerHTML=t,r.style.position="absolute",this.updateInGamePosByEntity(r,n),gui.getDom("ingamedoms").appendChild(r),this.ingamedoms[e]=r}},updateInGamePos:function(e){var t=this.ingamedoms[e];if(!t)return;var n=this.game.getEntityById(e);if(!n)return;this.updateInGamePosByEntity(t,n)},updateInGamePosByEntity:function(e,t){var n=this.game.renderer,r=n.context.transformGridToScreen(t.x,t.y,t.tileWidth,t.tileHeight);r.x!=NaN&&r.y!=NaN&&(e.style.left=r.x+"px",e.style.top=r.y+"px")},updateAllInGamePos:function(){for(var e in this.ingamedoms)this.updateInGamePos(e)},updateInGameSize:function(e){var t=this.ingamedoms[e];if(!t)return;var n=this.game.getEntityById(e);if(!n)return;var r=gui.find(t,"iframe");if(r&&r.length>0){var i=this.game.renderer,s=i.zoom*(this.game.settings.buttonzoom?1/this.game.settings.buttonzoom:1),o=Math.floor(n.tileWidth*i.tilesize*s),u=Math.floor(n.tileHeight*i.tilesize*s);r[0].parentNode.style.width=o+"px",r[0].parentNode.style.height=u+"px",r[0].width=o,r[0].height=u}},updateAllInGameSize:function(){for(var e in this.ingamedoms)this.updateInGameSize(e)},removeInGameDom:function(e){this.ingamedoms[e]&&(gui.remove(this.ingamedoms[e]),delete this.ingamedoms[e])},removeAllInGameDom:function(){for(var e in this.ingamedoms)this.removeInGameDom(e)},addDamageInfo:function(e,t,r,i){var s=this.game.currentTime+""+Math.abs(e)+""+t+""+r,o=new n(s,e,t,r,n.DURATION,i),u=this;return o.onDestroy(function(e){u.destroyQueue.push(e)}),this.damageinfos[s]=o,o},hasDamageInfos:function(){return Object.keys(this.damageinfos).length>0},forEachDamageInfo:function(e){var t=this;_.each(this.damageinfos,function(t,n){e(t)})},update:function(e){var t=this;this.forEachDamageInfo(function(t){t.update(e)}),_.each(this.destroyQueue,function(e){delete t.damageinfos[e]}),this.destroyQueue=[]},addKillerInfo:function(e,t){this.killerinfos.push({time:this.game.currentTime,x:e.x,y:e.y,victim:{head:e.head,hat:e.hat,name:e.name},killer:t,isfriend:e.clanname&&this.game.player&&this.game.player.clanname==e.clanname})},clearKillerInfos:function(){this.killerinfos=[]}}),t={received:{fill:"rgb(255, 50, 50)",stroke:"rgb(255, 180, 180)"},inflicted:{fill:"white",stroke:"#373737"},healed:{fill:"rgb(80, 255, 80)",stroke:"rgb(50, 120, 50)"}},n=Class.extend({DURATION:1e3,init:function(e,n,r,i,s,o){this.id=e,this.value=n,this.duration=s,this.x=r,this.y=i,this.opacity=1,this.lastTime=0,this.speed=100,t[o]?(this.fillColor=t[o].fill,this.strokeColor=t[o].stroke):(this.fillColor=o,this.strokeColor="#373737")},isTimeToAnimate:function(e){return e-this.lastTime>this.speed},update:function(e){this.isTimeToAnimate(e)&&(this.lastTime=e,this.tick())},tick:function(){this.y-=1,this.opacity-=.07,this.opacity<0&&this.destroy()},onDestroy:function(e){this.destroy_callback=e},destroy:function(){this.destroy_callback&&this.destroy_callback(this.id)}});return e}),define("camera",[],function(){var e=Class.extend({init:function(e){this.game=e,this.x=0,this.y=0,this.gridX=0,this.gridY=0},setPosition:function(e,t){if(this.x!=e||this.y!=t)this.x=this.rx=e,this.y=this.ry=t,this.gridX=Math.floor(e/this.game.renderer.tilesize),this.gridY=Math.floor(t/this.game.renderer.tilesize),this.game.infoManager&&this.game.infoManager.updateAllInGamePos()},setGridPosition:function(e,t){this.gridX=e,this.gridY=t,this.x=this.rx=this.gridX*this.game.renderer.tilesize,this.y=this.ry=this.gridY*this.game.renderer.tilesize},setSize:function(e,t){this.gridW=e,this.gridH=t,this.sendScreenSize(!1)},sendScreenSize:function(e){if(!this.game.client||!this.game.player)return;var t,n;this.game.settings&&this.game.settings.smallsync?(t=1024,n=768):(t=Math.floor(this.gridW)*this.game.renderer.tilesize,n=Math.floor(this.gridH)*this.game.renderer.tilesize);var r=this.game.player.lastSyncSize;if(!e&&r&&r[0]==t&&r[1]==n)return;this.game.player.lastSyncSize=[t,n],this.game.client.sendScreenSize(t,n)},lookAt:function(e){if(!e)return;var t=e.getFocus?e.getFocus():e,n=this.game.renderer,r=this.game.mapmanager.currentmap,i=Math.floor(t.x+.5*n.tilesize)-Math.floor(this.gridW/2*n.tilesize),s=Math.floor(t.y)-Math.floor(this.gridH/2*n.tilesize);r&&r.isLoaded&&!r.getCenterView()&&(i=Math.max(r.offsetx*n.tilesize,Math.min(i,(r.offsetx+r.width-this.gridW)*n.tilesize)),s=Math.max(r.offsety*n.tilesize,Math.min(s,(r.offsety+r.height-this.gridH)*n.tilesize))),this.setPosition(i,s),this.rx=this.x,this.ry=this.y,this.game.player&&this.game.player.screenshake&&(this.rx+=this.game.player.screenshake.dx,this.ry+=this.game.player.screenshake.dy)},isVisible:function(e,t){return t||(t=0),e.gridY-e.z>=this.gridY-t&&e.gridY-e.z<this.gridY+this.gridH+t&&e.gridX>=this.gridX-t&&e.gridX<this.gridX+this.gridW+t}});return e}),define("context2d",[],function(){var e=Class.extend({init:function(e,t,n){this.renderer=e,this.context=t,this.backcontext=n,this.initContext()},initContext:function(){this.disableImageSmoothing(this.context),this.disableImageSmoothing(this.backcontext)},setupForRender:function(){this.context.clearRect(0,0,this.renderer.canvas.width,this.renderer.canvas.height),this.context.save(),this.context.translate(-this.renderer.camera.rx,-this.renderer.camera.ry)},setScreenEffect:function(e){},drawDrawOverTiles:function(){},cleanUpRender:function(){this.context.restore()},getWidth:function(){return this.renderer.canvas.width},getHeight:function(){return this.renderer.canvas.height},getTileWidth:function(){return this.renderer.backcanvas.width},getTileHeight:function(){return this.renderer.backcanvas.height},rescale:function(){this.disableImageSmoothing(this.context),this.disableImageSmoothing(this.backcontext),this.renderer.game.started&&(this.renderer.drawTiles(),this.renderer.renderFrame())},updateCameraSize:function(){this.renderer.camera.setSize(this.renderer.canvas.width/this.renderer.tilesize,this.renderer.canvas.height/this.renderer.tilesize)},drawText:function(e,t,n,r,i,s){if(!e||!t||!n)return;this.context.save(),r&&(this.context.textAlign="center"),this.context.fillStyle="black",this.context.fillText(e,t+2,n+2),this.context.fillStyle=i||"white",this.context.fillText(e,t,n),this.context.restore()},drawCombatInfo:function(){if(!this.renderer.game.infoManager.hasDamageInfos())return;var e=this;this.renderer.game.infoManager.forEachDamageInfo(function(t){e.context.save(),e.context.font="bold 32px Helvetica",e.context.globalAlpha=t.opacity,e.drawText(t.value,t.x+8,t.y,!0,t.fillColor,t.strokeColor),e.context.restore()})},getTileBorder:function(){return Math.floor(this.renderer.mapmovegap/this.renderer.zoom)},updateTileOffset:function(){var e=this.renderer;if(!e.backcanvas.style)return;var t=e.game.mapmanager.currentmap,n=Math.floor((t.terrainrenderoffset.x-e.camera.x)*e.zoom)+"px",r=Math.floor((t.terrainrenderoffset.y-e.camera.y)*e.zoom)+"px";e.backcanvas.style.left!=n&&(e.backcanvas.style.left=n),e.backcanvas.style.top!=r&&(e.backcanvas.style.top=r)},setupCanvasForRender:function(){this.context.clearRect(0,0,this.renderer.canvas.width,this.renderer.canvas.height),this.context.save(),this.context.translate(-this.renderer.camera.rx,-this.renderer.camera.ry)},disableImageSmoothing:function(e){if(!e)return;e.mozImageSmoothingEnabled=!1,e.webkitImageSmoothingEnabled=!1,e.msImageSmoothingEnabled=!1,e.imageSmoothingEnabled=!1},deleteTexture:function(e){},drawImage:function(e,t,n,r,i,s,o){if(!e||!e.image)return;if(!r)r=[0,0,e.image.width,e.image.height];else{if(r[0]<0||r[1]<0)return;if(r[0]+r[2]>e.image.width||r[1]+r[3]>e.image.height)r=[r[0],r[1],Math.min(e.image.width-r[0],r[2]),Math.min(e.image.height-r[1],r[3])]}s?(this.context.save(),this.context.translate(t+s[1],n+s[2]),i&&this.context.scale(i[0],i[1]),this.context.rotate(-s[0]),t=-s[1],n=-s[2]):i&&(this.context.save(),this.context.translate(t+r[2]/2,n+r[3]/2),this.context.scale(i[0],i[1]),t=-r[2]/2,n=-r[3]/2),this.context.drawImage(e.image,r[0],r[1],r[2],r[3],Math.floor(t),Math.floor(n),r[2],r[3]),(s||i)&&this.context.restore()},setupObjXForm:function(e,t,n){return!n||n==1?null:(this.context.save(),this.context.translate(e*(1-n),t*(1-n)),this.context.scale(n,n),!0)},restoreObjXForm:function(e){if(!e)return;this.context.restore()},setAmbientColor:function(e,t,n){this.ambientColor=[e,t,n,1]},getCurrentAmbientColor:function(){return[1,1,1,1]},setColor:function(e){if(!e)return null;if(""+e==""+this.currentColor)return this.currentColor;var t=this.currentColor?this.currentColor:[1,1,1,1];return this.currentColor=e,this.context.globalAlpha=e[3],t?t:[1,1,1,1]},drawDarkHole:function(e){var t=this.renderer,n={x:t.camera.rx,y:t.camera.ry,w:this.getWidth(),h:this.getHeight()};if(!t.game.player){this.context.fillStyle="#000000",this.context.fillRect(n.x,n.y,n.w,n.h);return}var r={x:t.game.player.x+t.tilesize/2,y:t.game.player.y},i={x:r.x-e,y:r.y-e,w:e*2,h:e*2};this.context.fillStyle="#000000",i.y>n.y&&this.context.fillRect(n.x,n.y,n.w,i.y-n.y+1),i.x>n.x&&this.context.fillRect(n.x,i.y-16,i.x-n.x+1,i.h+32),i.x+i.w<n.x+n.w&&this.context.fillRect(i.x+i.w-1,i.y-16,n.x+n.w-(i.x+i.w-1),i.h+32),i.y+i.h<n.y+n.h&&this.context.fillRect(n.x,i.y+i.h-1,n.w,n.y+n.h-(i.y+i.h-1)),this.drawImage(t.getImage(t.game.filespath+"gui/hole_image.png"),i.x,i.y)},drawDarkEffect:function(e){},drawBattleEffect:function(e){},drawShadowMap:function(){},setBlendMode:function(e,t){},transformGridToScreen:function(e,t,n,r){var i=this.renderer,s=i.zoom*(i.game.settings.buttonzoom?1/i.game.settings.buttonzoom:1);return{x:Math.floor((e-i.camera.x)*s),y:Math.floor((t-i.camera.y)*s)}},transformScreenToGrid:function(e,t){var n=this.renderer;return{x:Math.floor((n.camera.x+e/n.zoom)/n.tilesize),y:Math.floor((n.camera.y+t/n.zoom)/n.tilesize)}}});return e}),function(e){"use strict";var t={};typeof exports=="undefined"?typeof define=="function"&&typeof define.amd=="object"&&define.amd?(t.exports={},define("lib/gl-matrix",[],function(){return t.exports})):t.exports=typeof window!="undefined"?window:e:t.exports=exports,function(e){if(!t)var t=1e-6;if(!n)var n=typeof Float32Array!="undefined"?Float32Array:Array;if(!r)var r=Math.random;var i={};i.setMatrixArrayType=function(e){n=e},typeof e!="undefined"&&(e.glMatrix=i);var s=Math.PI/180;i.toRadian=function(e){return e*s};var o={};o.create=function(){var e=new n(2);return e[0]=0,e[1]=0,e},o.transformMat4=function(e,t,n){var r=t[0],i=t[1];return e[0]=n[0]*r+n[4]*i+n[12],e[1]=n[1]*r+n[5]*i+n[13],e},o.forEach=function(){var e=o.create();return function(t,n,r,i,s,o){var u,a;n||(n=2),r||(r=0),i?a=Math.min(i*n+r,t.length):a=t.length;for(u=r;u<a;u+=n)e[0]=t[u],e[1]=t[u+1],s(e,e,o),t[u]=e[0],t[u+1]=e[1];return t}}(),typeof e!="undefined"&&(e.vec2=o);var u={};u.fromValues=function(e,t,r){var i=new n(3);return i[0]=e,i[1]=t,i[2]=r,i},typeof e!="undefined"&&(e.vec3=u);var a={};a.create=function(){var e=new n(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},a.clone=function(e){var t=new n(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},a.multiply=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=t[6],l=t[7],c=t[8],h=t[9],p=t[10],d=t[11],v=t[12],m=t[13],g=t[14],y=t[15],b=n[0],w=n[1],E=n[2],S=n[3];return e[0]=b*r+w*u+E*c+S*v,e[1]=b*i+w*a+E*h+S*m,e[2]=b*s+w*f+E*p+S*g,e[3]=b*o+w*l+E*d+S*y,b=n[4],w=n[5],E=n[6],S=n[7],e[4]=b*r+w*u+E*c+S*v,e[5]=b*i+w*a+E*h+S*m,e[6]=b*s+w*f+E*p+S*g,e[7]=b*o+w*l+E*d+S*y,b=n[8],w=n[9],E=n[10],S=n[11],e[8]=b*r+w*u+E*c+S*v,e[9]=b*i+w*a+E*h+S*m,e[10]=b*s+w*f+E*p+S*g,e[11]=b*o+w*l+E*d+S*y,b=n[12],w=n[13],E=n[14],S=n[15],e[12]=b*r+w*u+E*c+S*v,e[13]=b*i+w*a+E*h+S*m,e[14]=b*s+w*f+E*p+S*g,e[15]=b*o+w*l+E*d+S*y,e},a.mul=a.multiply,a.translate=function(e,t,n){var r=n[0],i=n[1],s=n[2],o,u,a,f,l,c,h,p,d,v,m,g;return t===e?(e[12]=t[0]*r+t[4]*i+t[8]*s+t[12],e[13]=t[1]*r+t[5]*i+t[9]*s+t[13],e[14]=t[2]*r+t[6]*i+t[10]*s+t[14],e[15]=t[3]*r+t[7]*i+t[11]*s+t[15]):(o=t[0],u=t[1],a=t[2],f=t[3],l=t[4],c=t[5],h=t[6],p=t[7],d=t[8],v=t[9],m=t[10],g=t[11],e[0]=o,e[1]=u,e[2]=a,e[3]=f,e[4]=l,e[5]=c,e[6]=h,e[7]=p,e[8]=d,e[9]=v,e[10]=m,e[11]=g,e[12]=o*r+l*i+d*s+t[12],e[13]=u*r+c*i+v*s+t[13],e[14]=a*r+h*i+m*s+t[14],e[15]=f*r+p*i+g*s+t[15]),e},a.scale=function(e,t,n){var r=n[0],i=n[1],s=n[2];return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*s,e[9]=t[9]*s,e[10]=t[10]*s,e[11]=t[11]*s,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},a.rotateZ=function(e,t,n){var r=Math.sin(n),i=Math.cos(n),s=t[0],o=t[1],u=t[2],a=t[3],f=t[4],l=t[5],c=t[6],h=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*i+f*r,e[1]=o*i+l*r,e[2]=u*i+c*r,e[3]=a*i+h*r,e[4]=f*i-s*r,e[5]=l*i-o*r,e[6]=c*i-u*r,e[7]=h*i-a*r,e},a.ortho=function(e,t,n,r,i,s,o){var u=1/(t-n),a=1/(r-i),f=1/(s-o);return e[0]=-2*u,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*f,e[11]=0,e[12]=(t+n)*u,e[13]=(i+r)*a,e[14]=(o+s)*f,e[15]=1,e},typeof e!="undefined"&&(e.mat4=a)}(t.exports)}(this),define("context3d",["lib/gl-matrix"],function(e){var t=Class.extend({init:function(e,t){this.renderer=e,this.contextGL=t,this.setAmbientColor(1,1,1),this.initContext()},initContext:function(){var e=this.renderer.game.app.config.clearcolor;e?this.contextGL.clearColor(e[0],e[1],e[2],1):this.contextGL.clearColor(0,0,0,1),this.contextGL.enable(this.contextGL.BLEND),this.blendMode=null,this.setBlendMode("normal",!0),this.initDefaultBuffers(),this.initShader(null)},setupForRender:function(){this.mode3d=this.renderer.game.settings.mode3d,this.imageStack=[],this.boundinfo=null,this.newBlendMode=this.newColor=this.newWorldTransform=null,this.newWorldGround=!1,this.setupViewProjection(),this.contextGL.useProgram(this.shader),this.contextGL.viewport(0,0,this.renderer.canvas.clientWidth,this.renderer.canvas.clientHeight),this.contextGL.disable(this.contextGL.SCISSOR_TEST),this.contextGL.clear(this.contextGL.COLOR_BUFFER_BIT),this.contextGL.enableVertexAttribArray(this.mShaderVertexPositionAttribute),this.contextGL.enableVertexAttribArray(this.mShaderTextureCoordAttribute),this.setColor(this.getCurrentAmbientColor(),!0),this.contextGL.uniformMatrix4fv(this.mWorldTransform,!1,this.mVPMatrix),this.screenEffect=="vignette"&&this.contextGL.uniform2fv(this.mScreenSize,[Math.max(128,this.renderer.canvas.width),Math.max(128,this.renderer.canvas.height)]),this.setBlendMode("normal",!0),this.drawTilesBuffers(!1)},getCurrentAmbientColor:function(){var e=this.renderer.game;if(!e.settings.nodaynight&&(!e.player||!e.player.ghost)){var t=e.mapmanager.currentmap;if(t&&t.properties.ambient){var n=this.renderer.getColorArrayFromVar(t.properties.ambient);if(n)return n}if(t&&(t.mapname==e.mapmanager.getDefaultOutsideMap()||t.getEnableDayNight()))return this.ambientColor}return[1,1,1,1]},drawDrawOverTiles:function(){this.drawTilesBuffers(!0)},cleanUpRender:function(){this.flushImageStack(),this.boundinfo=null,this.contextGL.bindTexture(this.contextGL.TEXTURE_2D,null)},getWidth:function(){return this.renderer.canvas.width/this.renderer.zoom},getHeight:function(){return this.renderer.canvas.height/this.renderer.zoom},getTileWidth:function(){return this.getWidth()+this.renderer.mapmovegap},getTileHeight:function(){return this.getHeight()+this.renderer.mapmovegap},rescale:function(){this.setupViewProjection()},updateCameraSize:function(){this.renderer.camera.setSize(this.getWidth()/this.renderer.tilesize,this.getHeight()/this.renderer.tilesize)},drawCombatInfo:function(){if(!this.renderer.game.infoManager.hasDamageInfos())return;this.combattexts||(this.combattexts={});var e,t=this,n=this.renderer.game.app.config.combatfontsize||30;this.renderer.game.infoManager.forEachDamageInfo(function(r){if(!r.value)return;var i=t.setColor([1,1,1,r.opacity]);i&&!e&&(e=i);var s=""+r.value,o=s+"_"+r.fillColor+"_"+r.strokeColor;t.combattexts[o]=t.renderer.drawTextCached(t.combattexts[o],s,r.x+8,r.y,{centered:!0,color:r.fillColor,strokeColor:r.strokeColor,fontSize:n,bold:!0})}),e&&this.setColor(e)},getTileBorder:function(){return this.renderer.mapmovegap},updateTileOffset:function(){},initDefaultBuffers:function(){this.gSquareVertexBuffer=this.contextGL.createBuffer(),this.mTextureCoordBuffer=this.contextGL.createBuffer()},setScreenEffect:function(e){if(e==this.screenEffect)return;var t=this.initShader(e);e&&!t&&this.initShader(null)},initShader:function(e){this.shader&&this.contextGL.deleteProgram&&this.contextGL.deleteProgram(this.shader),this.shader=null,this.screenEffect=null;var t=this.loadAndCompileShader("precision mediump float;\nuniform mat4 uWorldTransform;\nattribute vec2 aSquareVertexPosition;\nattribute vec2 aTextureCoordinate;\nvarying vec2 vTexCoord;\n\nvoid main(void) {\n    gl_Position = uWorldTransform * vec4(aSquareVertexPosition, 0.0, 1.0);\n    vTexCoord = aTextureCoordinate;\n}",this.contextGL.VERTEX_SHADER),n=this.loadAndCompileShader("precision mediump float;\nuniform vec4 uPixelColor;\n"+(e=="vignette"?"uniform vec2 uScreenSize;\n":"")+"uniform sampler2D uSampler;\n"+"varying vec2 vTexCoord;\n"+"\n"+"void main(void) {\n"+(e=="vignette"?"    vec2 uv = gl_FragCoord.xy / uScreenSize.xy;\n    uv *=  1.0 - uv.yx;\n    gl_FragColor = vec4(min(pow(uv.x * uv.y * 30.0, 0.25),1.0)) * uPixelColor * texture2D(uSampler, vTexCoord);\n":"    gl_FragColor = uPixelColor * texture2D(uSampler, vTexCoord);\n")+"}",this.contextGL.FRAGMENT_SHADER);return this.shader=this.contextGL.createProgram(),this.contextGL.attachShader(this.shader,t),this.contextGL.attachShader(this.shader,n),this.contextGL.linkProgram(this.shader),this.contextGL.getProgramParameter(this.shader,this.contextGL.LINK_STATUS)?(this.mShaderVertexPositionAttribute=this.contextGL.getAttribLocation(this.shader,"aSquareVertexPosition"),this.mShaderTextureCoordAttribute=this.contextGL.getAttribLocation(this.shader,"aTextureCoordinate"),this.mPixelColor=this.contextGL.getUniformLocation(this.shader,"uPixelColor"),e=="vignette"&&(this.mScreenSize=this.contextGL.getUniformLocation(this.shader,"uScreenSize")),this.mWorldTransform=this.contextGL.getUniformLocation(this.shader,"uWorldTransform"),this.screenEffect=e,!0):(window.console&&console.log("Error linking shader"),!1)},loadAndCompileShader:function(e,t){var n=this.contextGL.createShader(t);return this.contextGL.shaderSource(n,e),this.contextGL.compileShader(n),this.contextGL.getShaderParameter(n,this.contextGL.COMPILE_STATUS)||window.console&&console.log("A shader compiling error occurred: "+this.contextGL.getShaderInfoLog(n)),n},loadGLTexture:function(e){if(!e.image)return null;var t=this.contextGL.createTexture();this.contextGL.bindTexture(this.contextGL.TEXTURE_2D,t);var n=!1;try{this.contextGL.texParameteri(this.contextGL.TEXTURE_2D,this.contextGL.TEXTURE_WRAP_S,this.contextGL.CLAMP_TO_EDGE),this.contextGL.texParameteri(this.contextGL.TEXTURE_2D,this.contextGL.TEXTURE_WRAP_T,this.contextGL.CLAMP_TO_EDGE),this.contextGL.texParameteri(this.contextGL.TEXTURE_2D,this.contextGL.TEXTURE_MIN_FILTER,this.contextGL.NEAREST),this.contextGL.texParameteri(this.contextGL.TEXTURE_2D,this.contextGL.TEXTURE_MAG_FILTER,e==this.shadowimage?this.contextGL.LINEAR:this.contextGL.NEAREST),e==this.shadowimage?this.contextGL.texImage2D(this.contextGL.TEXTURE_2D,0,this.contextGL.LUMINANCE,e.image.width,e.image.height,0,this.contextGL.LUMINANCE,this.contextGL.UNSIGNED_BYTE,e.image.pixels):this.contextGL.texImage2D(this.contextGL.TEXTURE_2D,0,this.contextGL.RGBA,this.contextGL.RGBA,this.contextGL.UNSIGNED_BYTE,e.image),this.contextGL.getError()!=this.contextGL.NO_ERROR&&(n=!0)}catch(r){n=!0}return n&&(window.console&&console.log("Error loading texture",e),this.deleteTexture(t),t=null),this.contextGL.bindTexture(this.contextGL.TEXTURE_2D,null),this.boundinfo=null,t},setupViewProjection:function(){this.mVPMatrix=e.mat4.create();var t=this.renderer.game.player;if(t&&t.effect&&t.effect["type"]=="freeze"&&t.effect.params.screenzoom){var n=t.effect.params.screenzoom,r=this.getWidth()/2,i=this.getHeight()/2;e.mat4.ortho(this.mVPMatrix,r-r/n,r+r/n,i+i/n,i-i/n,-1,1)}else e.mat4.ortho(this.mVPMatrix,0,this.getWidth(),this.getHeight(),0,-1,1);this.mVPMatrixGround=e.mat4.clone(this.mVPMatrix),this.mode3d&&(this.mVPMatrixGround[7]-=2e-4)},getXform:function(t,n,r,i,s,o){var u=e.mat4.create();if(this.mode3d&&!this.newWorldGround){var a=1+(n+i)*2e-4;t=(t+r/2-this.getWidth()/2)*a-r/2+this.getWidth()/2,n=(n+i-this.getHeight()/2)*a-i+this.getHeight()/2}return o?(e.mat4.translate(u,u,e.vec3.fromValues(t+o[1],n+o[2],0)),s&&e.mat4.scale(u,u,e.vec3.fromValues(s[0],s[1],1)),e.mat4.rotateZ(u,u,-o[0]),e.mat4.translate(u,u,e.vec3.fromValues(-o[1],-o[2],0)),(r!=1||i!=1)&&e.mat4.scale(u,u,e.vec3.fromValues(r,i,1))):s?(e.mat4.translate(u,u,e.vec3.fromValues(t+r/2-r/2*s[0],n+i/2-i/2*s[1],0)),e.mat4.scale(u,u,e.vec3.fromValues(r*s[0],i*s[1],1))):(e.mat4.translate(u,u,e.vec3.fromValues(t,n,0)),(r!=1||i!=1)&&e.mat4.scale(u,u,e.vec3.fromValues(r,i,1))),u},transformGridToScreen:function(e,t,n,r){var i=this.renderer,s=i.zoom*(i.game.settings.buttonzoom?1/i.game.settings.buttonzoom:1);e=Math.floor((e-i.camera.x)*s),t=Math.floor((t-i.camera.y)*s);if(this.mode3d){n*=i.tilesize/s,r*=i.tilesize/s;var o=1+(t+r)*2e-4;e=Math.floor((e+n/2-this.getWidth()/2)*o-n/2+this.getWidth()/2),t=Math.floor((t+r-this.getHeight()/2)*o-r+this.getHeight()/2)}return{x:e,y:t}},transformScreenToGrid:function(e,t){if(this.mode3d){var n=1+t*2e-4;n!=0&&(e=(e-this.getWidth()/2)/n+this.getWidth()/2,t=(t-this.getHeight()/2)/n+this.getHeight()/2)}var r=this.renderer;return{x:Math.floor((r.camera.x+e/r.zoom)/r.tilesize),y:Math.floor((r.camera.y+t/r.zoom)/r.tilesize)}},setupObjXForm:function(t,n,r,i){if(r&&r!=1){var s=this.mVPMatrix;t-=this.renderer.camera.rx,n-=this.renderer.camera.ry;var o=e.mat4.clone(i?this.mVPMatrixGround:this.mVPMatrix);return e.mat4.translate(o,o,e.vec3.fromValues(t,n,0)),e.mat4.scale(o,o,e.vec3.fromValues(r,r,1)),e.mat4.translate(o,o,e.vec3.fromValues(-t,-n,0)),this.mVPMatrix=o,this.newWorldTransform=o,this.newWorldGround=i,s}if(i){var s=this.mVPMatrix;return this.newWorldTransform=this.mVPMatrixGround,this.newWorldGround=!0,s}return null},restoreObjXForm:function(e){if(!e)return;this.mVPMatrix=e,this.newWorldTransform=e,this.newWorldGround=!1},bindBuffers:function(e,t){this.contextGL.bindBuffer(this.contextGL.ARRAY_BUFFER,e),this.contextGL.vertexAttribPointer(this.mShaderVertexPositionAttribute,2,this.contextGL.FLOAT,!1,0,0),this.contextGL.bindBuffer(this.contextGL.ARRAY_BUFFER,t),this.contextGL.vertexAttribPointer(this.mShaderTextureCoordAttribute,2,this.contextGL.FLOAT,!1,0,0)},setAmbientColor:function(e,t,n){this.ambientColor=[e,t,n,1]},setColor:function(e,t){if(!e)return null;if(!t&&""+e==""+this.currentColor)return e;var n=this.currentColor;return this.currentColor=e,t?this.contextGL.uniform4fv(this.mPixelColor,e):this.newColor=e,n?n:[1,1,1,1]},setBlendMode:function(e,t){if(e==this.blendMode&&!t)return;if(t)switch(e){case"add":this.contextGL.blendFunc(this.contextGL.SRC_ALPHA,this.contextGL.ONE);break;case"subtract":this.contextGL.blendFunc(this.contextGL.ZERO,this.contextGL.ONE_MINUS_SRC_ALPHA);break;case"shadow":this.contextGL.blendFunc(this.contextGL.ONE,this.contextGL.SRC_COLOR);break;default:this.contextGL.blendFunc(this.contextGL.SRC_ALPHA,this.contextGL.ONE_MINUS_SRC_ALPHA)}else this.newBlendMode=e;this.blendMode=e},deleteTexture:function(e){this.contextGL.deleteTexture(e)},drawImage:function(e,t,n,r,i,s){if(!e||!this.bindTexture(e))return;if(!r)r=[0,0,e.image.width,e.image.height];else{if(r[0]<0||r[1]<0)return;if(r[0]+r[2]>e.image.width||r[1]+r[3]>e.image.height)r=[r[0],r[1],Math.min(e.image.width-r[0],r[2]),Math.min(e.image.height-r[1],r[3])]}this.addImageToStack(e,r,this.getXform(t-this.renderer.camera.rx,n-this.renderer.camera.ry,r[2],r[3],i,s))},drawImageAt:function(e,t,n){if(!e||!this.bindTexture(e))return;n||(n=[0,0,e.image.width,e.image.height]),this.addImageToStack(e,n,this.getXform(t.x,t.y,t.w,t.h))},addImageToStack:function(e,t,n){if(this.imageStack.length>=1e4)return;this.imageStack.push({i:e,t:t,m:n,b:this.newBlendMode,c:this.newColor,w:this.newWorldTransform}),this.newBlendMode=this.newColor=this.newWorldTransform=null},flushImageStack:function(){if(this.imageStack.length<=0)return;var t=new Float32Array(this.imageStack.length*8),n=0;for(var r=0;r<this.imageStack.length;r++,n+=8){var i=this.imageStack[r];t.set([0,0,1,0,0,1,1,1],n),e.vec2.forEach(t,2,n,4,e.vec2.transformMat4,i.m)}this.contextGL.bindBuffer(this.contextGL.ARRAY_BUFFER,this.gSquareVertexBuffer),this.contextGL.vertexAttribPointer(this.mShaderVertexPositionAttribute,2,this.contextGL.FLOAT,!1,0,0),this.contextGL.bufferData(this.contextGL.ARRAY_BUFFER,t,this.contextGL.STATIC_DRAW);var s=new Float32Array(this.imageStack.length*8);n=0;for(var r=0;r<this.imageStack.length;r++,n+=8){var i=this.imageStack[r],o=1/i.i.image.width,u=1/i.i.image.height;s.set([i.t[0]*o,i.t[1]*u,(i.t[0]+i.t[2])*o,i.t[1]*u,i.t[0]*o,(i.t[1]+i.t[3])*u,(i.t[0]+i.t[2])*o,(i.t[1]+i.t[3])*u],n)}this.contextGL.bindBuffer(this.contextGL.ARRAY_BUFFER,this.mTextureCoordBuffer),this.contextGL.vertexAttribPointer(this.mShaderTextureCoordAttribute,2,this.contextGL.FLOAT,!1,0,0),this.contextGL.bufferData(this.contextGL.ARRAY_BUFFER,s,this.contextGL.STATIC_DRAW);for(var r=0;r<this.imageStack.length;r++){var i=this.imageStack[r];if(i.b)switch(i.b){case"add":this.contextGL.blendFunc(this.contextGL.SRC_ALPHA,this.contextGL.ONE);break;case"subtract":this.contextGL.blendFunc(this.contextGL.ZERO,this.contextGL.ONE_MINUS_SRC_ALPHA);break;case"shadow":this.contextGL.blendFunc(this.contextGL.ONE,this.contextGL.SRC_COLOR);break;default:this.contextGL.blendFunc(this.contextGL.SRC_ALPHA,this.contextGL.ONE_MINUS_SRC_ALPHA)}i.c&&this.contextGL.uniform4fv(this.mPixelColor,i.c),i.w&&this.contextGL.uniformMatrix4fv(this.mWorldTransform,!1,i.w);if(!this.bindTexture(i.i))continue;this.contextGL.drawArrays(this.contextGL.TRIANGLE_STRIP,r*4,4)}this.imageStack=[],this.newBlendMode=null,this.newColor=null},drawTilesBuffers:function(t){var n=this.renderer.game.mapmanager.currentmap;if(!n)return!1;if(!n.layervertices||n.layervertices.length<=0)return!1;if(t&&this.countDrawOverLayers<=0)return!1;this.flushImageStack(),this.setBlendMode("normal",!0);var r=this.getCurrentAmbientColor(),i=1;this.setColor(r,!0);var s=e.mat4.clone(this.mVPMatrixGround),o=Math.floor((n.terrainrenderoffset.x-this.renderer.camera.rx)*1),u=Math.floor((n.terrainrenderoffset.y-this.renderer.camera.ry)*1);e.mat4.translate(s,s,e.vec3.fromValues(o,u,0)),this.contextGL.uniformMatrix4fv(this.mWorldTransform,!1,s),this.bindBuffers(n.tilebuffers.vertices,n.tilebuffers.texcoords);for(var a in n.layervertices){var f=n.layervertices[a];if(f.drawover!=t)continue;if(!this.bindTexture(n.getTilesetForLayer(f.layer)))continue;var l=f.layer.opacity&&f.layer.opacity<1?f.layer.opacity:1;l!=i&&(i=l,this.setColor([r[0],r[1],r[2],r[3]*i],!0)),this.contextGL.drawArrays(this.contextGL.TRIANGLES,f.offset,f.count)}return this.contextGL.uniformMatrix4fv(this.mWorldTransform,!1,this.mVPMatrix),i!=1&&this.setColor(r,!0),!0},bindTexture:function(e){if(e==this.boundinfo)return!0;if(!e||!e.image)return!1;if(!e.texture){e.texture=this.loadGLTexture(e);if(!e.texture)return e.image=null,!1}return this.contextGL.bindTexture(this.contextGL.TEXTURE_2D,e.texture),this.boundinfo=e,!0},drawDarkHole:function(e){var t=this.renderer,n=t.getColorImage("black");if(!t.game.player){var r={x:-16,y:-16,w:this.getWidth()+32,h:this.getHeight()+32};this.drawImageAt(n,r);return}this.drawImageAndBorder(t.getImage(t.game.filespath+"gui/hole_image.png"),n,{x:t.game.player.gridX+.5,y:t.game.player.gridY},e/t.tilesize,!0)},drawImageAndBorder:function(e,t,n,r,i){if(!e)return;var s=this.setupObjXForm(0,0,1,!0),o=this.renderer;r*=o.tilesize;var u={x:n.x*o.tilesize-o.camera.rx-r,y:n.y*o.tilesize-o.camera.ry-r,w:r*2,h:r*2},a={x:-16,y:-16,w:this.getWidth()+32,h:this.getHeight()+32};u.y>a.y&&this.drawImageAt(t,{x:a.x,y:a.y,w:a.w,h:u.y-a.y}),u.x>a.x&&this.drawImageAt(t,{x:a.x,y:u.y-(i?16:0),w:u.x-a.x,h:u.h+(i?32:0)}),u.x+u.w<a.x+a.w&&this.drawImageAt(t,{x:u.x+u.w,y:u.y-(i?16:0),w:a.x+a.w-(u.x+u.w),h:u.h+(i?32:0)}),u.y+u.h<a.y+a.h&&this.drawImageAt(t,{x:a.x,y:u.y+u.h,w:a.w,h:a.y+a.h-(u.y+u.h)}),this.drawImageAt(e,u),s&&this.restoreObjXForm(s)},drawDarkEffect:function(e){var t=this.renderer,n={x:-16,y:-16,w:this.getWidth()+32,h:this.getHeight()+32},r=this.setColor([1,1,1,e]);this.drawImageAt(t.getColorImage("black"),n),this.setColor(r)},drawBattleEffect:function(e){if(!e||e["shape"]!="circle"||!e.center||!e.radius)return;var t=this.setColor(this.renderer.getColorArrayFromVar(e.color));this.drawImageAndBorder(this.renderer.getImage(this.renderer.game.filespath+"gui/circle_image.png"),this.renderer.getColorImage("white"),e.center,e.radius,!1),this.setColor(t)},drawShadowMap:function(){}});return t}),define("renderer",["camera","context2d","context3d"],function(e,t,n){var r=Class.extend({init:function(e,t,n,r){this.game=e,this.canvas=t,this.backcanvas=n,this.mapmovegap=64,this.tilesize=32,this.isMobile=window.navigator&&window.navigator.userAgent.match(/(iPad|iPhone|iPod|Android|webOS|BlackBerry|Windows Phone)/g)?!0:!1,window.navigator&&window.navigator.userAgent.match("Macintosh")&&window.navigator.maxTouchPoints&&window.navigator.maxTouchPoints>1&&(this.isMobile=!0),this.zoom=this.isMobile?2:1,this.images={},this.customtextures={},this.colorimages={},this.initContext(r),this.rescale(),this.setFontSize(16),this.lastTime=new Date,this.frameCount=0},getWidth:function(){return this.context.getWidth()},getHeight:function(){return this.context.getHeight()},getTileWidth:function(){return this.context.getTileWidth()},getTileHeight:function(){return this.context.getTileHeight()},hideConnectingMessage:function(){this.backcanvas&&(this.backcanvas.style.background="none")},rescale:function(){this.createCamera(),this.context.rescale()},createCamera:function(){this.camera=new e(this.game),this.context.updateCameraSize(),this.game.mapmanager&&this.game.mapmanager.currentmap&&(this.game.mapmanager.currentmap.terrainrenderoffset={x:0,y:0})},setFontSize:function(e){this.fontSize=e,this.currentFont=""+e+"px "+this.game.font},drawTextCached:function(e,t,n,r,i,s){if(!t||t.length<=0)return;t=this.unescapeHTMLChars(t);if(!e||!e.image||e.text!=t)e={text:t,image:this.createTextCanvas(t,i,s)};i.centered&&(n-=e.image.width/2);var o=e.image.height-(i.withArrow?10:0);r-=o,i.keepInScreen&&(n=Math.max(0,Math.min(n-this.camera.rx,this.getWidth()-e.image.width))+this.camera.rx,r=Math.max(0,Math.min(r-this.camera.ry,this.getHeight()-o))+this.camera.ry);var u=this.context.setColor([1,1,1,1]);return this.drawImage(e,Math.floor(n),Math.floor(r)),this.context.setColor(u),e},unescapeHTMLChars:function(e){return e.replace(/&amp;/g,"&").replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&#34;/g,'"')},createCanvas:function(e,t){var n=document.createElement("canvas");if(e!=1||t!=1)n.width=e,n.height=t;return n},createTextCanvas:function(e,t,n){var r=t.fontSize?t.fontSize:this.fontSize,i=5,s=10,o=t.outlineWidth?t.outlineWidth:5;this.measureCanvas||(this.measureCanvas=this.createCanvas(1,1),this.measureContext=this.measureCanvas.getContext("2d"));var u=t.fontSize?(t.bold?"bold ":"")+t.fontSize+"px "+this.game.font:this.currentFont;this.measureContext.font=u;var a=Date.now(),f,l,c;t.maxWidth?(c=this.wrapText(this.measureContext,e,t.maxWidth,Math.ceil(r*1.1),t.maxLines),f=Math.ceil(c.width+o*2),l=c.height+i):(f=Math.ceil(this.measureContext.measureText(e).width+o*2),l=r+i),t.fillColor&&t.withArrow&&(l+=s);if(n&&this.game.client){var h=Date.now()-a;h>50&&this.game.client.sendLagLog("chat",h,n,e)}var p=this.createCanvas(f,l),d=p.getContext("2d");d.mozImageSmoothingEnabled=!1,d.font=u,t.fillColor&&(d.fillStyle=t.fillColor,this.roundRect(d,0,0,f,l,8,!0,!1,t.withArrow?{x:f/2,w:s/2,h:s}:null)),t.strokeColor&&!c&&(d.strokeStyle=t.strokeColor,d.lineWidth=o,d.strokeText(e,o,r+.5)),d.fillStyle=t.color;if(c)for(var v in c.lines){var m=c.lines[v];r+m.y<l&&d.fillText(m.text,o+(t.centered?Math.floor((c.width-m.width)/2):0),r+m.y)}else d.fillText(e,o,r);return p},roundRect:function(e,t,n,r,i,s,o,u,a){var f=i-(a?a.h:0),l=this.game.app.config.shiftchat?r>=40?3:2:0;e.beginPath(),e.moveTo(t+s,n+l),e.lineTo(t+r-s,n),e.quadraticCurveTo(t+r,n,t+r,n+s),e.lineTo(t+r,n+f-s-l),e.quadraticCurveTo(t+r,n+f-l,t+r-s,n+f-l),a&&(e.lineTo(a.x+a.w,n+f),e.lineTo(a.x,n+i),e.lineTo(a.x-a.w,n+f)),e.lineTo(t+s,n+f),e.quadraticCurveTo(t,n+f,t,n+f-s),e.lineTo(t,n+s+l),e.quadraticCurveTo(t,n+l,t+s,n+l),e.closePath(),o&&e.fill(),u&&e.stroke()},wrapText:function(e,t,n,r,i){var s=e.measureText(t);if(s.width<=n)return{lines:[{text:t,y:0,width:s.width}],width:s.width,height:r};var o=[],u="",a=0,f=0,l=0,c=t.split(" ");for(var h=0;h<c.length&&h<100;h++){var p=c[h],d=e.measureText(p);if(d.width>n){var v=0,m=p.length;for(var g=0;g<1e3;g++){var y=v+Math.floor((m-v)/2),b=c[h].substring(0,y);if(y<=v){p=b;break}d=e.measureText(b),d.width>n?m=y:v=y}}c[h]!=p&&(c.splice(h+1,0,c[h].substr(p.length)),c[h]=p),p=u+c[h];var w=e.measureText(p);w.width>n&&h>0?(o.push({text:u.trim(),y:l,width:f}),a=Math.max(a,f),u=c[h]+" ",f=d.width,l+=r):(u=p+" ",f=w.width)}return o.push({text:u.trim(),y:l,width:f}),a=Math.max(a,f),i&&o.length>i&&(o=o.slice(0,i)),{lines:o,width:a,height:o.length*r}},drawEntities:function(){this.game.forEachVisibleEntityByDepth(this.camera,function(e){e.drawEntity()})},drawProjectiles:function(){this.game.mapmanager.currentmap.projectiles.drawProjectiles()},isIntersecting:function(e,t){return!(t.left>e.right||t.right<e.left||t.top>e.bottom||t.bottom<e.top)},drawTiles:function(){this.game.mapmanager&&this.game.mapmanager.drawTiles()},drawKillerInfos:function(){if(this.game.infoManager.killerinfos.length<=0)return;var e=this.game.animationmanager,t=this.game.infoManager.killerinfos,n=this.game.currentTime,r=this.getImage(e.getGraphic(null,"../gui/bbuilder_x_red.png")),i=this.getImage(e.getGraphic(null,"../gui/bbuilder_x_green.png"));for(var s=t.length-1;s>=0;s--){var o=t[s];if(n>=o.time+3e3){t.splice(s,1);continue}var u=Math.floor(o.x),a=Math.floor(o.y-48-(n-o.time)/100);this.drawImage(this.getImage(e.getGraphic(o.killer,"HEAD")),u-28,a,[96,0,48,48],[.75,.75]),this.drawImage(this.getImage(e.getGraphic(o.killer,"HAT")),u-28,a-16,[96,0,48,72],[.75,.75]),this.drawImage(this.getImage(e.getGraphic(o.killer,"MASK")),u-28,a-16,[96,0,48,72],[.75,.75]),this.drawImage(this.getImage(e.getGraphic(o.victim,"HEAD")),u+12,a,[96,0,48,48],[-0.75,.75]),this.drawImage(this.getImage(e.getGraphic(o.victim,"HAT")),u+12,a-16,[96,0,48,72],[-0.75,.75]),this.drawImage(this.getImage(e.getGraphic(o.victim,"MASK")),u+12,a-16,[96,0,48,72],[-0.75,.75]),this.drawImage(o.isfriend?r:i,u+12,a,[0,0,48,48],[.75,.75])}},drawCombatInfo:function(){this.context.drawCombatInfo()},updateTiles:function(e){var t=this.game.mapmanager.currentmap;if(!t)return;t.checkTilesetsLoaded();if(!t.isLoaded||!this.game.player)return;this.camera.lookAt(this.game.player);var n=this.context.getTileBorder();if(e||!t.terrainrenderoffset||this.camera.x<t.terrainrenderoffset.x||this.camera.x>=t.terrainrenderoffset.x+n||this.camera.y<t.terrainrenderoffset.y||this.camera.y>=t.terrainrenderoffset.y+n)t.terrainrenderoffset={x:Math.floor(this.camera.x/n)*n,y:Math.floor(this.camera.y/n)*n},this.drawTiles();this.context.updateTileOffset()},initContext:function(e){var r=null;if(e){var i={alpha:!1,antialias:!1,depth:!1,stencil:!1};r=this.canvas.getContext("webgl",i)||this.canvas.getContext("experimental-webgl",i)}r?(this.backcanvas&&(this.backcanvas.style.display="none"),this.context=new n(this,r)):(e&&window.console&&console.log("Cannot initialize WebGL"),this.backcanvas&&this.backcanvas.style&&(this.backcanvas.style.display="block"),this.context=new t(this,this.canvas.getContext("2d"),this.backcanvas?this.backcanvas.getContext("2d"):null))},hasWebGL:function(){return this.context.contextGL},renderFrame:function(){this.updateTiles(),this.context.setupForRender(),this.renderchats=[];var e=this.game.mapmanager.currentmap;e&&(this.game.app.config.noguimaps.indexOf(e.mapname)<0&&(this.drawEntities(),this.drawKillerInfos(),this.drawCombatInfo(),this.drawProjectiles()),e.getDarkEffect()&&this.context.drawDarkEffect(parseFloat(e.getDarkEffect()))),this.context.drawDrawOverTiles();if(e){var t=e.getScriptVar("battleeffect");t&&this.context.drawBattleEffect(t);if(e.getCutOutHole()||e.getCutOutHoleNoDayNight()&&this.game.settings&&this.game.settings.nodaynight){var n=this.game.mapmanager.currentmap.getCutOutHoleRadius()||4*this.tilesize;this.game.player&&this.game.player.weaponMode&&this.game.player.weaponMode.lightradius&&(n=Math.floor(n*this.game.player.weaponMode.lightradius)),this.context.drawDarkHole(n)}}this.context.setColor([1,1,1,1]),this.renderchats.length>0&&this.drawChats(),this.game.animationmanager.drawWeather(),this.drawCopyrightImage(),this.context.cleanUpRender(),this.cleanupTextures()},drawChats:function(){for(var e in this.renderchats){var t=this.renderchats[e];t.drawChat()}this.renderchats=[]},getImage:function(e,t){if(!e)return null;var n=this.customtextures[e];if(n)return this.getCurrentAnimationFrame(n);var r=this.images[e];if(r)return r.lastaccess=this.game.currentTime,t&&(r.keeptime=t),!r.image||r.loading?null:this.getCurrentAnimationFrame(r);if(this.getFileNameFromPath(e).indexOf(".")<0)return null;var r={filename:e,image:new Image,loading:!0,lastaccess:this.game.currentTime,keeptime:t};this.images[e]=r;if(this.needServerModTime(e))this.loadGraphicFile(e.substring(this.game.filespath.length));else{var i,s=this.game.getUrlVars(e);s.t&&s.t>0?i=e:i=this.game.getFilenameWithHash(e),this.loadGraphicFileFullPath(r,i)}return r.loading?null:this.getCurrentAnimationFrame(r)},needServerModTime:function(e){if(!this.game.client||this.game.isstory||e.indexOf(this.game.filespath)!=0||e.indexOf("?")>=0)return!1;var t=this.game.app.config.ignoremodtimefor;if(t)for(var n=0;n<t.length;n++)if(e.indexOf(t[n])>=0)return!1;return!0},loadGraphicFile:function(e,t){var t=t||this.game.animationmanager.requestFileModTime(e);if(!t)return;var n=this.images[this.game.filespath+e];if(!n||!n.image)return;n.texture&&(this.context.deleteTexture(n.texture),delete n.texture),this.loadGraphicFileFullPath(n,this.game.filespath+e+"?t="+t)},loadGraphicFileFullPath:function(e,t){var n=this;e.loading=!0,e.image.onload=function(){e.loading=!1},e.image.onerror=function(){e.loading=!1,e.image=null};if(e.filename.indexOf(".gif")>=0){var n=this;gui.ajax(t,!1,function(t){n.loadGifData(e,t)},function(t,n,r){window.console&&console.log("Loading gif "+e.filename+" failed: "+r)},"text/plain; charset=x-user-defined")}else e.image.crossOrigin="anonymous",e.image.src=t},getFileNameFromPath:function(e){return e.replace(/^.*[\\\/]/,"")},cleanupTextures:function(){for(var e in this.images){var t=this.images[e];if(t.lastaccess>this.game.currentTime-(t.keeptime?t.keeptime:5e3))continue;t.texture&&(this.context.deleteTexture(t.texture),delete t.texture),t.image&&(t.image.onload=null,t.image.onerror=null,delete t.image),delete this.images[e]}},drawImage:function(e,t,n,r,i,s,o){this.context.drawImage(e,t,n,r,i,s,o)},loadGifData:function(e,t){var n={frames:[],frame:null,header:null,lastImg:null,canvas:null,disposalRestoreFromIdx:null},r=this;try{parseGIF(new Stream(t),{hdr:function(e){n.header=e,n.canvas=r.createCanvas(n.header.width,n.header.height)},gce:function(e){n.frame={width:n.header.width,height:n.header.height,transparentIndex:e.transparencyGiven?e.transparencyIndex:null,delay:Math.max(50,e.delayTime*10),disposalMethod:e.disposalMethod}},com:function(){},app:{NETSCAPE:function(e){}},img:function(e){if(!n.frame||!n.canvas)return;var t=n.canvas.getContext("2d",{willReadFrequently:!0}),r=e.lctFlag?e.lct:n.header.gct,i=n.frames.length;if(i>0){var s=n.lastImg;n.frames[i-1].disposalMethod===3?n.disposalRestoreFromIdx!==null?t.putImageData(n.frames[disposalRestoreFromIdx].image,0,0):t.clearRect(s.leftPos,s.topPos,s.width,s.height):n.disposalRestoreFromIdx=i-1,n.frames[i-1].disposalMethod===2&&t.clearRect(s.leftPos,s.topPos,s.width,s.height)}var o=t.getImageData(e.leftPos,e.topPos,e.width,e.height),u=n.frame.transparentIndex;e.pixels.forEach(function(e,t){e!==u&&(o.data[t*4+0]=r[e][0],o.data[t*4+1]=r[e][1],o.data[t*4+2]=r[e][2],o.data[t*4+3]=255)}),t.putImageData(o,e.leftPos,e.topPos),n.frame.image=t.getImageData(0,0,n.header.width,n.header.height),n.frame.urldata=n.canvas.toDataURL(),n.frames.push(n.frame),n.lastImg=e},eof:function(t){n.frames.length>=1&&r.setImageAnimationFrames(e,n.frames),e.loading=!1,n=null},error:function(t){r.game.client&&r.game.client.logError("Gif parse error of "+e.filename+": "+t),e.loading=!1}})}catch(i){}},getCurrentAnimationFrame:function(e){if(!e||!e.frames||e.totalDelay<=0)return e;var t=(this.game.currentTime-e.loadTime)%e.totalDelay,n=0,r=null;for(var i=0;i<e.frames.length;i++){var s=e.frames[i];if(s.image){r=s;if(t<n+s.delay)return s}n+=s.delay}return r},setImageAnimationFrames:function(e,t){e.frames=t,e.loadTime=Date.now(),e.totalDelay=0;for(var n=0;n<e.frames.length;n++){var r=e.frames[n];e.totalDelay+=r.delay,this.loadFrameData(e,n,r)}},loadFrameData:function(e,t,n){if(!n.urldata)return;n.image=new Image,n.image.onload=function(){},n.image.onerror=function(){window.console&&console.log("Failed to load gif frame: "+e.filename+" #"+t),n.image=null},n.image.src=n.urldata,n.urldata=null},getColorImage:function(e){if(!this.colorimages[e]){var t=16,n=this.createCanvas(t,t);if(!n)return null;var r=n.getContext("2d");r.fillStyle=e,r.fillRect(0,0,t,t),this.colorimages[e]={image:n}}return this.colorimages[e]},drawDebugHitCircle:function(e,t,n,r){var i=this.getImage(this.game.filespath+"gui/debug_circle.png");if(!i)return;var s=i.image.width,o=i.image.height,u=this.context.setColor(r),a=n!=s||n!=o?[n/s,n/o]:null;this.drawImage(i,e*this.tilesize-s/2,t*this.tilesize-o/2,null,a),this.context.setColor(u)},drawDebugHitRectangle:function(e,t,n,r,i){var s=this.getImage(this.game.filespath+"gui/debug_rectangle.png");if(!s)return;var o=s.image.width,u=s.image.height,a=this.context.setColor(i),f=n!=o||r!=u?[n/o,r/u]:null;this.drawImage(s,e*this.tilesize+(n-o)/2,t*this.tilesize+(r-u)/2,null,f),this.context.setColor(a)},drawCopyrightImage:function(){if(!this.game.mapmanager||!this.game.mapmanager.currentmap)return;var e=this.game.mapmanager.currentmap.getCopyrightImage();if(!e)return;var t=this.getImage(this.game.filespath+"gui/"+e);if(!t||!t.image)return;var n=this.getWidth(),r=this.getHeight(),i=t.image.width,s=t.image.height,o=r/t.image.height/4,u=this.context.setColor([1,1,1,.5]);this.drawImage(t,this.camera.rx+n/2-i/2,this.camera.ry+r-s*o-30,null,[o,o],[Math.PI/12,i/2,s/2]),this.context.setColor(u)},getColorArrayFromVar:function(e){if(typeof e=="string"&&e.length>=7){var t=[parseInt(e.substr(-6,2),16)/255,parseInt(e.substr(-4,2),16)/255,parseInt(e.substr(-2,2),16)/255,e.length>=9?parseInt(e.substr(-8,2),16)/255:1];return t}return e instanceof Array&&e.length>=3?[e[0],e[1],e[2],e.length>=4?e[3]:1]:null},transformScreenToGrid:function(e,t){return this.context.transformScreenToGrid(e,t)}});return r}),define("entity",[],function(){var e=Class.extend({init:function(e,t,n){this.game=e,this.id=t,this.kind=n,this.initializeAnimationInfo(),this.tileWidth=1,this.tileHeight=1,this.arrow="bbuilder_arrow1.png",this.argObjects=[],this.setGridPosition(0,0),this.z=0,this.zoom=1,this.angle=0,this.visible=!0},setExtendedData:function(e){if(!e)return;var t=e.x||e.y,n=!1;for(var r in e)r.indexOf("_")==0?this.getScriptObject()[r.substring(1)]=e[r]:(r!="ani"&&(this[this.mapServerAttributeToClient(r)]=e[r]),typeof r=="string"&&r.indexOf("arg")==0&&(n=!0));"ani"in e&&this.setAnimation(e.ani,!1,!0),"chat"in e&&(this.chat=""+this.chat,this.showChat(""+e.chat)),("stealth"in e||"namecolor"in e)&&this.nameCache&&delete this.nameCache,("title"in e||"titlecolor"in e)&&this.titleCache&&delete this.titleCache,typeof e.name=="string"&&this.onNameUpdated(),n&&this.updateArgAnimations(),t&&this.setGridPosition(this.gridX,this.gridY)},updateArgAnimations:function(){for(var e=0;e<=9;e++){var t="arg"+e;if(!this[t]||typeof this[t]!="string"||this[t].substr(this[t].length-".bani".length)!=".bani"){delete this.argObjects[e];continue}var n=this[t].substr(0,this[t].length-".bani".length);if(this.argObjects[e]){if(this.argObjects[e].animation==n)continue}else this.argObjects[e]=this.getEmptyAnimationInfo();this.setNewAnimationInfo(this.argObjects[e],n,null,!0,null,[])}},mapServerAttributeToClient:function(e){return e=="x"?"gridX":e=="y"?"gridY":e=="class"?"npcclass":e=="clanname"?"shopclan":e},prepareRemoveFromMap:function(){this.stopMoveInterpolation(),this.countdownTimer&&(clearInterval(this.countdownTimer),this.countdownTimer=null),(!this.game||this!=this.game.player)&&delete this.scriptObject,this.game&&(this.game.mapmanager.removeFromActiveObjects(this),this.game.infoManager&&this.game.infoManager.removeInGameDom(this.id))},setPosition:function(e,t){this.x=e,this.y=t},setGridPosition:function(e,t){this.gridX=e,this.gridY=t,this.setPosition(e*32,t*32),this.game&&this.game.infoManager&&this.game.infoManager.updateInGamePos(this.id)},getHead:function(){return this.head},setHead:function(e){this.head=e},getHat:function(){return this.hat},setHat:function(e){this.hat=e},getMask:function(){return this.mask},setMask:function(e){this.mask=e},getArmor:function(){return this.armor},setArmor:function(e){this.armor=e},getWeapon:function(){return this.weapon},setWeapon:function(e){this.weapon=e},hasWeapon:function(){return this.weapon!=null},onNameUpdated:function(){this.clanname=this.game.getClanFromName(this.name),delete this.nameCache},initializeAnimationInfo:function(){this.animationInfo=this.getEmptyAnimationInfo()},getEmptyAnimationInfo:function(){return{animation:null,frame:0,dontProceed:!1,lastAnimationTime:0,direction:Types.Directions.DOWN,emitterTime:{},params:[]}},getAnimation:function(e){var t=this.animationInfo.animation;return e&&(this.animationInfo.dontProceed&&(t+="["+this.animationInfo.frame+"]"),this.animationInfo.params.length>0&&(t+=","+this.animationInfo.params)),t},setAnimation:function(e,t,n){var r=null,i=[];if(typeof e=="number")e=this.game.animationmanager.decode(e);else if(e){i=e.split(","),i.length>=1&&(e=i.shift());var s=e.indexOf("[");s>=0&&e.substr(e.length-1)=="]"&&(r=parseInt(e.substring(s+1,e.length-1)),e=e.substring(0,s))}if(this.game&&e==this.animationInfo.animation){var o=this.game.animationmanager.loadAnimation(e);if(o&&o.isLoaded&&o.options.continuous){this.animationInfo.isexternal=n;return}}if(!e&&e!=="")return;if(e.indexOf("_idle")>=0&&this.animationInfo.isexternal&&!n)return;this.setNewAnimationInfo(this.animationInfo,e,this.currentAnimation,n,r,i),this.onAnimationChanged(t)},setNewAnimationInfo:function(e,t,n,r,i,s){e.animation=t,e.animation.length<=0&&delete e.animation,e.frame=i!==null?i:0,e.dontProceed=i!==null,e.params=s,e.frameDuration=null,e.lastAnimationTime=this.game?this.game.currentTime:Date.now(),e.emitterTime={},e.playedSound=!1,n&&n.options&&n.options.particlescontinueafterdeath||(e.particles=null),e.isexternal=r},animateAsPlayer:function(e,t){var n=e=="idle"||e=="walk"||e=="death"?"player_"+e:e;n=this.getAniFromWeapon(this.makeSwimOrSit(n)),this.setAnimation(n,t)},makeSwimOrSit:function(e){if((e=="player_idle"||e=="player_walk")&&this.game){var t=this.isInWater();if(this.mountData){if(t){if(!this.mountData.allowinwater)return"player_swim";if(this.mountData.swim)return this.mountData.swim}var n;this.carHornTime&&this.game.currentTime<this.carHornTime?n="horn":(delete this.carHornTime,n=e=="player_idle"?"idle":"walk"),this.mountData["mounttype"]=="car"&&this.carLightsOn&&this.mountData[n+"_lights"]&&(n+="_lights");if(this.mountData[n])return this.mountData[n]}else{if(t)return"player_swim";if(this.game.mapmanager.currentmap){if(this.game.app.config.enablesleep&&this.game.mapmanager.currentmap.isBed(this.gridX+.5,this.gridY+.5))return"player_sleep";if(this.game.mapmanager.currentmap.isChair(this.gridX+.5,this.gridY+.5))return"player_sit"}}}return e},getAniFromWeapon:function(e){if(this.weapon&&this.weaponMode){var t;switch(e){case"player_idle":t=this.weaponMode.idle;break;case"player_walk":t=this.weaponMode.walk;break;case"player_swim":t=this.weaponMode.swim;break;case"player_sit":t=this.weaponMode.sit}if(t)return t}return e},isInWater:function(){return this.getAttachedToObject()||!this.game.mapmanager.currentmap?!1:this.game.mapmanager.currentmap.isWater(this.gridX+.5,this.gridY+.5)},onAnimationChanged:function(e){},onAnimate:function(){this.animationInfo.direction=Types.convertOrientationToDirection(this.dir);if(!this.animationInfo.animation)return;var e=this.game.animationmanager.loadAnimation(this.animationInfo.animation);if(!e||!e.isLoaded)return;this.currentAnimation=e,this.playAniSoundandProceed(e,this.animationInfo,!0)},playAniSoundandProceed:function(e,t,n){if(!e||!t||!e.frames[t.frame])return;var r=e.frames[t.frame];if(!t.playedSound){if(this.game.sounds&&r.sound){var i=r.sound.constructor===Array?r.sound[Math.floor(Math.random()*r.sound.length)]:r.sound;(!r.soundchance||Math.random()*100<r.soundchance)&&this.game.sounds.play(this.replaceSoundArgs(t,i))}r.emit&&e.emitParticlesByList(this,t,r.emit),r.screenshake&&this.game.player&&this.game.player.addScreenShake&&this.game.player.addScreenShake(this,r.screenshake),t.playedSound=!0}if(!t.dontProceed){var s=this;e.checkProceedAnimation(t,function(e){return n?(s.setAnimation(e,!0),s.currentAnimation=s.game.animationmanager.loadAnimation(s.animationInfo.animation),!0):!1})}},replaceSoundArgs:function(e,t){return t.indexOf("ARG")==0?this[t.toLowerCase()]:t.indexOf("PARAM")==0?e.params[parseInt(t.substring(5))-1]:t},prepareDrawAnimation:function(){var e=this.animationInfo;e.direction=Types.convertOrientationToDirection(this.dir);if(!this.game||!e.animation)return;var t=this.game.animationmanager.loadAnimation(e.animation);if(!t||!t.isLoaded)return;this.currentAnimation=t,t.options.zoom&&(this.zoom=t.options.zoom),t.options.color&&(this.color=t.options.color),t.processParticlesAndEmitters(this,e);if(!t.frames[e.frame])return;var n=t.frames[e.frame];n.zoom&&(this.zoom=n.zoom),n.color&&(this.color=n.color)},drawAnimation:function(){if(!this.currentAnimation)return;this.currentAnimation.drawAnimation(this,this.animationInfo),this.onAnimate()},drawArgObjects:function(){for(var e in this.argObjects){var t=this.argObjects[e],n=this.game.animationmanager.loadAnimation(t.animation);if(!n||!n.isLoaded)continue;n.processParticlesAndEmitters(this,t),n.drawAnimation(this,t),this.playAniSoundandProceed(n,t,!1)}},onActivate:function(){},deleteTextCache:function(){this.chatCache&&delete this.chatCache,this.nameCache&&delete this.nameCache},showChat:function(e){var t=this.game.mapmanager.currentmap;e&&t&&(t.isSpar()||t.isPvpEvent())?this.chathidetime=this.game.currentTime+15e3:delete this.chathidetime,delete this.chatCache;if(!this.game)return;!this.showEmoticon(e)&&this==this.game.player&&e&&e.length>0&&e.indexOf("/")!=0&&this.game.invokeScriptEvent("says"),this.chat&&this.chat.length>0&&!this.emoticonfile&&this!=this.game.player&&!this.game.settings.notranslate&&(!t||t.templatename!="jail")&&this.translateChat(this.chat)},showEmoticon:function(e){this.emoticonfile=null;switch(e?e.toUpperCase():null){case">:(":case"X(":case"X-(":this.emoticonfile="bbuilder_emoticon_angry.png";break;case"O-O":case"O.O":this.emoticonfile="bbuilder_emoticon_bigeyes.png";break;case":cool:":case"B)":case"B-)":case"8)":case"8-)":case"D)":case"D-)":this.emoticonfile="bbuilder_emoticon_cool.png";break;case"X)":case"XD":case"X-)":case"X-D":case"X-X":case"X_X":case"X.X":this.emoticonfile="bbuilder_emoticon_crosseyes.png";break;case"&LT;3":case"<3":this.emoticonfile="bbuilder_emoticon_heart.png";break;case"(I)":this.emoticonfile="bbuilder_emoticon_idea.png";break;case":*":case":-*":this.emoticonfile="bbuilder_emoticon_kiss.png";break;case":)]":this.emoticonfile="bbuilder_emoticon_phone.png";break;case":(":case":-(":this.emoticonfile="bbuilder_emoticon_sad.png";break;case"Z/":case"ZZ":case"ZZZ":case"Z_Z":this.emoticonfile="bbuilder_emoticon_sleep.png";break;case":)":case":-)":this.emoticonfile="bbuilder_emoticon_smile.png";break;case":D":case":-D":this.emoticonfile="bbuilder_emoticon_smilebig.png";break;case"?(":case"?-(":this.emoticonfile="bbuilder_emoticon_sorry.png";break;case":_(":case":'(":this.emoticonfile="bbuilder_emoticon_tears.png";break;case":P":case":-P":this.emoticonfile="bbuilder_emoticon_tongue.png";break;case":|":case":-|":this.emoticonfile="bbuilder_emoticon_widemouth.png";break;case";)":case";-)":this.emoticonfile="bbuilder_emoticon_wink.png"}if(this.game.app.config.extendedemoticons)switch(e?e.toUpperCase():null){case":BRB:":this.emoticonfile="bbuilder_emoticon_brb.png";break;case":HELP:":this.emoticonfile="bbuilder_emoticon_help.png";break;case":GO:":this.emoticonfile="bbuilder_emoticon_go.png";break;case":AFK:":this.emoticonfile="bbuilder_emoticon_afk.png";break;case":OK:":this.emoticonfile="bbuilder_emoticon_ok.png"}return this.emoticonfile&&(delete this.chathidetime,this.emoticontime=this.game.currentTime),this.emoticonfile?!0:!1},translateChat:function(e){var t=this;this.game.getGoogleTranslation(e,function(n){if(n&&n.toLowerCase()==e.toLowerCase())return;t.chat=n+"⌝",delete t.chatCache,t.chathidetime&&(t.chathidetime+=1)})},getControlModeAt:function(e,t){return null},moveXX:function(e,t,n,r,i,s,o,u,a,f,l){i||(i=this.animationInfo.animation),r||(r=0),s||(s=0),o||(o=0),u||(u=0),a||(a=0),this.stopMoveInterpolation(),this.setOrientation(e),this.setAnimation(i,!1);if(o>0){this.moveInfo={delay:o,dir:e,x:t,y:n,z:r,start:this.game.currentTime,defaultanis:(s&Types.AnimationFlags.DEFAULTANIS)!=0,angle:u},this.attachTo(a),this.attachInfo&&(this.moveInfo.x=this.attachInfo.object.gridX+f,this.moveInfo.y=this.attachInfo.object.gridY+l);var c=this,h=this.game.currentTime;this.moveinterval=setInterval(function(){var e=c.game.currentTime;c.updateMoveInterpolation(Math.max(c.game.minFrameTime,Math.min(e-h,1e3))),h=e},this.game.minFrameTime);if(this.attachedObjects)for(var p in this.attachedObjects){var d=this.attachedObjects[p];d==this.game.player&&d.getAnimation()&&d.getAnimation().indexOf("idle")>=0&&d.attachInfo&&this.game.client.sendMoveXX(d.dir,this.gridX+d.attachInfo.gridX,this.gridY+d.attachInfo.gridY,d.z,d.getAnimation(!0),Types.AnimationFlags.PREDICT,0,d.angle)}}else this.z=r,this.setGridPosition(t,n),this.angle=u,this.attachTo(a),this.attachInfo&&(this.attachInfo.gridX=f,this.attachInfo.gridY=l),this.onHasMoved()},onHasMoved:function(){},updateMoveInterpolation:function(e){if(!this.moveInfo)return;if(this.moveInfo.delay<e+this.game.minFrameTime/4){this.moveInfo.defaultanis&&this.animateAsPlayer("idle",!1),this.moveXX(this.moveInfo.dir,this.moveInfo.x,this.moveInfo.y,this.moveInfo.z,this.getAnimation(!0),0,0,this.moveInfo.angle);return}var t=e/this.moveInfo.delay,n=(this.moveInfo.x-this.gridX)*t,r=(this.moveInfo.y-this.gridY)*t,i=this.z+(this.moveInfo.z-this.z)*t,s=Math.abs(this.angle-this.moveInfo.angle)>Math.PI?this.angle+2*Math.PI*(this.angle>=Math.PI?-1:1):this.angle,o=s+(this.moveInfo.angle-s)*t;for(var u=0;u<this.attachedObjects.length;u++){var a=this.attachedObjects[u];a.attachInfo&&a.setNewAttachPosition(this.gridX+a.attachInfo.gridX,this.gridY+a.attachInfo.gridY),a.moveprediction&&(a.moveprediction.x+=n,a.moveprediction.y+=r)}this.setOrientation(this.moveInfo.dir),this.setGridPosition(this.gridX+n,this.gridY+r),this.updateAttachPosition(),this.z=i,this.angle=o,this.moveInfo.defaultanis&&this.animateAsPlayer("walk",!1),this.onHasMoved(),Math.abs(o-s)>.01&&this.getAnimation()&&this.getAnimation().indexOf("car")==0&&(this.carSkidTime=this.game.currentTime),this.moveInfo.delay-=e},stopMoveInterpolation:function(){this.moveinterval&&(clearInterval(this.moveinterval),this.moveinterval=null),this.moveInfo=null},attachTo:function(e){var t=this.getAttachID();if(e==t)return!1;var n=this.attachInfo?this.attachInfo.object:null;if(n){var r=n.attachedObjects.indexOf(this);r>=0&&n.attachedObjects.splice(r,1)}return this.attachInfo=null,e>0&&(this.attachInfo={id:e},this.linkAttachedToObject()),!0},getAttachID:function(){return this.attachInfo?this.attachInfo.id:0},getAttachedToObject:function(){return this.attachInfo?this.attachInfo.object:null},linkAttachedToObject:function(){if(!this.attachInfo||this.attachInfo.object)return;var e=this.game.getEntityById(this.attachInfo.id);if(!e)return;e.attachedObjects.indexOf(this)<0&&e.attachedObjects.push(this),this.attachInfo.object=e,this.attachInfo.gridX=this.gridX-e.gridX,this.attachInfo.gridY=this.gridY-e.gridY},updateAttachPosition:function(){if(!this.attachInfo||!this.attachInfo.object)return;this.attachInfo.gridX=this.gridX-this.attachInfo.object.gridX,this.attachInfo.gridY=this.gridY-this.attachInfo.object.gridY},isInRectangle:function(e){return this.gridX>=e.x&&this.gridX<e.x+e.w&&this.gridY>=e.y&&this.gridY<e.y+e.h},setOrientation:function(e){e&&(this.dir=e)},isOnMount:function(){return this.mountData!=null||this.getAnimation()&&this.getAnimation().indexOf("mount_")==0},ch:function(e,t){var n=this.game.renderer.tilesize,r=(e.currentAnimation&&e.currentAnimation.options?e.currentAnimation.options.hitbox:null)||t||e.defaultHitbox,i=(this.currentAnimation&&this.currentAnimation.options?this.currentAnimation.options.hitbox:null)||this.defaultHitbox;if(r["shape"]=="circle"&&i["shape"]=="circle"){if(!r.center||!r.radius||!i.center||!i.radius)return!1;var s={x:e.gridX+r.center.x/n-(this.gridX+i.center.x/n),y:e.gridY+r.center.y/n-e.z-(this.gridY+i.center.y/n-this.z)};return(s.x*s.x+s.y*s.y)*n*n<(r.radius+i.radius)*(r.radius+i.radius)}var o=r["shape"]=="circle"?[r.center.x-r.radius,r.center.y-r.radius,r.radius*2,r.radius*2]:r.bounds,u=i["shape"]=="circle"?[i.center.x-i.radius,i.center.y-i.radius,i.radius*2,i.radius*2]:i.bounds;if(!o||!u)return!1;var a=e.gridX+o[0]/n,f=this.gridX+u[0]/n,l=e.gridY-e.z+o[1]/n,c=this.gridY-this.z+u[1]/n;return f<=a+o[2]/n&&a<=f+u[2]/n&&c<=l+o[3]/n&&l<=c+u[3]/n}});return e}),define("character",["entity"],function(e){var t=e.extend({init:function(t,n,r){e.prototype.init.call(this,t,n,r),this.dir=Types.Orientations.DOWN,this.sidekickpositions=[],this.attachedObjects=[],this.tileType=null,t.app.config.primaryweapon=="gun"?this.defaultHitbox={shape:"rectangle",bounds:[-7,-20,45,45]}:this.defaultHitbox={shape:"circle",center:{x:16,y:16},radius:16},this.hitboxColor=[0,1,0,1]},setDefaultAnimation:function(){this.idle()},animate:function(e,t){this.setAnimation(e,t)},idle:function(e){this.setOrientation(e),this.animate("idle",!0)},isHittingAnimation:function(){return this.animationInfo&&this.animationInfo.animation&&(this.animationInfo.animation.indexOf("_atk")>=0||this.animationInfo.animation.indexOf("attack")>=0)},isFreezing:function(){return this.attackfreezetime&&this.game.currentTime<this.attackfreezetime},isFiring:function(){return this.attackfiretime&&this.game.currentTime<this.attackfiretime},isReloading:function(){return this.attackreloadtime&&this.game.currentTime<this.attackreloadtime},getOrientationTo:function(e){var t=e.gridX+(e.tileWidth?e.tileWidth:1)/2,n=e.gridY+(e.tileHeight?e.tileHeight:1)/2;return this.getOrientationToPos(t-.5,n-.5)},getOrientationToPos:function(e,t){var n=e-this.gridX,r=t-this.gridY;return n>0?Types.Orientations.RIGHT:r>0?Types.Orientations.DOWN:n<0?Types.Orientations.LEFT:r<0?Types.Orientations.UP:Types.Orientations.DOWN},getOrientationToPos2:function(e,t){var n=e-this.gridX,r=t-this.gridY;return Math.abs(n)>Math.abs(r)?n>=0?Types.Orientations.RIGHT:Types.Orientations.LEFT:r>=0?Types.Orientations.DOWN:Types.Orientations.UP},getOrientationForAngle:function(){return this.angle<Math.PI*1/4||this.angle>=Math.PI*7/4?Types.Orientations.RIGHT:this.angle<Math.PI*3/4?Types.Orientations.UP:this.angle<Math.PI*5/4?Types.Orientations.LEFT:Types.Orientations.DOWN},showCurrentHitPoints:function(){this.maxHitPoints&&(this.showHitPoints={points:this.hitPoints/this.maxHitPoints,time:this.game.currentTime,isRegen:!0})},updateDamage:function(e,t,n,r){e!=0&&this.game.infoManager.addDamageInfo(e,this.x+(this.tileWidth-.5)*this.game.renderer.tilesize/2+Math.round((Math.random()-.5)*this.game.renderer.tilesize),this.y-(this.zoom>1?80:32),t),r&&(!this.showHitPoints||t!="healed"||this.showHitPoints.isRegen)&&(this.showHitPoints={points:n/r,time:this.game.currentTime,isRegen:t=="healed"})},die:function(e){if(this.isDead)return;this.isDead=!0,this.onDeath(e)},onDeath:function(e){e&&this.game.infoManager.addKillerInfo(this,e),this.kind==Types.Entities.NEWNPC&&this.game.removeEntity(this)},drawName:function(){if(!this.name||this.name.length<=0||this.game.player&&this.game.player.ghost)return;if(!this.game.isDrawingNames()&&!this.isEventAdmin()&&!this.stealth)return;var e=this.game.renderer,t=this.currentAnimation,n=e.tilesize/2,r=t&&t.options&&"nameoffsety"in t.options?t.options.nameoffsety:t&&t.options&&"chatoffsety"in t.options?t.options.chatoffsety:45,i=Math.floor(this.x+n),s=Math.floor(this.y+r);this.nameCache=e.drawTextCached(this.nameCache,this.name,i,s,{centered:!0,color:this.getNameColor(),strokeColor:"#303030"});if(this.nameCache){var o=this.title;o&&o.length>0&&this.game.app.config.enabletitles&&(this.titleCache=e.drawTextCached(this.titleCache,o,i,s+16,{centered:!0,color:this.getTitleColor(),strokeColor:"#303030"}),s+=18);var u=this.clanlogo;if(u&&u.length>0){var a=this.game.mapmanager.currentmap;a&&(a.isSpar()||a.isEvent())&&e.drawImage(e.getImage(this.game.filespath+u),i-128,s-110,null,[1/6,1/6])}}},getNameColor:function(){return this.stealth?this.stealth>=2?"#ffa080":"#80a0ff":this.clanname=="Target"?"#8080ff":this.isEventAdmin()?"#ff0000":this.namecolor?this.namecolor:this==this.game.player?"#ffe060":this.game.player&&this.clanname&&this.clanname==this.game.player.clanname?"#00ff00":"#ffffff"},getTitleColor:function(){return this.titlecolor?this.titlecolor:"#ffffff"},drawEmoticon:function(){var e=this.game.animationmanager,t=this.game.renderer,n=this.game.app.config.emoticonoffset;t.drawImage(t.getImage(e.getPathForDefault("EMOTICON")+this.emoticonfile),Math.floor(this.x+n.x),Math.floor(this.y+n.y)),this.game.currentTime>=this.emoticontime+5e3&&(this.emoticonfile=null,this.chat="")},drawSpeechBubble:function(){var e=this.game.animationmanager.loadAnimation("speechbubble");if(!e||!e.isLoaded)return;this.speechBubbleAnimationInfo?e.checkProceedAnimation(this.speechBubbleAnimationInfo):this.speechBubbleAnimationInfo=this.getEmptyAnimationInfo(),e.drawAnimation({x:this.x,y:this.y-(this.zoom>1?48:this.isOnMount()?32:0),z:0},this.speechBubbleAnimationInfo)},drawHealthBar:function(){if(!this.showHitPoints)return;var e=this.game.renderer,t=e.getImage(this.game.filespath+"gui/player_healthbar.png"),n=Math.floor(this.x+(this.tileWidth-1)*e.tilesize/2),r=Math.floor(this.y-(this.zoom>1?80:this.isOnMount()?74:32)),i=[0,this.showHitPoints.isRegen?16:8,1+Math.floor(30*this.showHitPoints.points),8];i[2]>=2&&e.drawImage(t,n,r,i),e.drawImage(t,n,r,[0,0,32,8]),this.game.currentTime>=this.showHitPoints.time+5e3&&(this.showHitPoints=null)},drawEntity:function(){var e=this.game.renderer;this.prepareDrawAnimation();var t=null;this.stealth?t=e.context.setColor([1,1,1,.5]):this.color&&(t=e.context.setColor(this.color));var n;this.getShowSideKick()&&(n=this.getSideKickPosition(),n.y<=this.y&&(this.drawSideKick(n),n=null));var r=this.tileTypeAnimationInfo&&this.tileTypeAnimationInfo.wasbelow,i=this.tileTypeAnimationInfo&&this.tileTypeAnimationInfo.replaceplayerani;r&&this.drawTileType(),this.mountData||this.drawName();if(!i){var s=e.context.setupObjXForm(this.x+this.tileWidth*e.tilesize/2,this.y+this.tileHeight*e.tilesize-4,this.zoom,this.currentAnimation&&this.currentAnimation.options&&this.currentAnimation.options.onground);this.drawAnimation(),this.drawArgObjects(),s&&e.context.restoreObjXForm(s)}this.mountData&&this.drawName(),n&&this.drawSideKick(n),r||this.drawTileType(),e.context.setColor(t),this.drawHealthBar(),this.emoticonfile?this.drawEmoticon():this.chat&&this.chat.length>0&&(e.renderchats?e.renderchats.push(this):this.drawChat()),this.talk&&this.drawSpeechBubble(),this.game.settings&&this.game.settings.hitbox&&(this.drawDebugHitX(),this.isFiring()&&(this!=this.game.player||this.weaponData&&this.weaponData["weapontype"]!="gun")&&this.drawFireX())},drawDebugHitX:function(){var e=this.game.renderer,t=(this.currentAnimation&&this.currentAnimation.options?this.currentAnimation.options.hitbox:null)||this.defaultHitbox;switch(t.shape){case"circle":t.center&&t.radius&&e.drawDebugHitCircle(this.gridX+t.center.x/e.tilesize,this.gridY-this.z+t.center.y/e.tilesize,t.radius*2*this.zoom,this.hitboxColor);break;case"rectangle":t.bounds&&e.drawDebugHitRectangle(this.gridX+t.bounds[0]/e.tilesize,this.gridY-this.z+t.bounds[1]/e.tilesize,t.bounds[2],t.bounds[3],this.hitboxColor)}},drawFireX:function(){var e=Types.addOffsetInOrientation(this.gridX+.5,this.gridY+.5,this.dir,1);this.game.renderer.drawDebugHitCircle(e.x,e.y,2.5*this.game.renderer.tilesize,[0,0,1,1])},drawChat:function(){if(this.game.hidechat&&this.npcclass!="castleflag"||this.game.player&&this.game.player.ghost)return;var e=this.game.renderer,t=e.tilesize,n=this.x+t/2;this.tileWidth>1&&(n+=(this.tileWidth-1.5)*t/2);var r=this.y,i=this.currentAnimation;i&&i.options&&"chatoffsety"in i.options?r-=i.options.chatoffsety:(i&&(r-=t),this.isOnMount()?r-=32:this.zoom>1&&(r-=48));var s=e.getWidth();this.chatCache=e.drawTextCached(this.chatCache,this.chat,Math.floor(n),Math.floor(r),{centered:!0,color:"#ffffff",fillColor:"rgba(45,45,45,0.8)",fontSize:18,keepInScreen:!0,outlineWidth:12,maxWidth:Math.max(Math.min(240,s),Math.min(s/3,480)),withArrow:!0,maxLines:this.kind==Types.Entities.NEWNPC?30:6},this.id)},onHasMoved:function(){e.prototype.onHasMoved.call(this);if(this.sidekick){var t=250/this.game.minFrameTime,n=100;while(this.sidekickpositions.length>0){var r=this.sidekickpositions.length-1,i=this.sidekickpositions[r];if(!(r>=t||Math.abs(i.x-this.x)+Math.abs(i.y-this.y)>=n))break;this.sidekickpositions.pop()}this.sidekickpositions.unshift({x:this.x,y:this.y,dir:this.dir})}else this.sidekickpositions.length>0&&(this.sidekickpositions=[]);var s=this.game.renderer.tilesize;for(var r=0;r<this.attachedObjects.length;r++){var o=this.attachedObjects[r];o.attachInfo&&o.setNewAttachPosition(Math.floor(this.gridX*s)/s+o.attachInfo.gridX,Math.floor(this.gridY*s)/s+o.attachInfo.gridY)}this.game.mapmanager.currentmap&&(this.tileType=this.game.mapmanager.currentmap.getTileType(this.gridX+.5,this.gridY+.5))},setNewAttachPosition:function(e,t){var n=e-this.gridX,r=t-this.gridY;this.setGridPosition(e,t);var i=this.game.renderer.tilesize;for(var s in this.sidekickpositions){var o=this.sidekickpositions[s];o.x+=n*i,o.y+=r*i}},getSideKickPosition:function(){return this.sidekickpositions&&this.sidekickpositions.length>0?this.sidekickpositions[this.sidekickpositions.length-1]:{x:this.x+32,y:this.y,dir:this.dir}},getShowSideKick:function(){if(!this.sidekick)return!1;if(this==this.game.player)return!0;if(this.game.settings.hidesidekicks)return!1;if(this.game.app.config.hidepetsinspar){var e=this.game.mapmanager.currentmap;if(e&&(e.isSpar()||e.isEvent()))return!1}return!0},drawSideKick:function(e){if(!this.sidekick){delete this.sidekickAnimationInfo;return}var t=this.getAnimation();if(!t)return;var n,r;typeof this.sidekick=="object"?(n=this.sidekick,r=!this.isWalkAnimation()&&this.sidekick.idle?this.sidekick.idle:this.sidekick.walk?this.sidekick.walk:this.sidekick.ani?this.sidekick.ani:this.sidekick.itemid):(n={},r=this.sidekick),n.x=e.x,n.y=e.y,n.z=0;var i=this.game.animationmanager.loadAnimation(r);if(!i||!i.isLoaded)return;if(t.indexOf("_swim")>=0&&!i.options.showonwater)return;if(!this.sidekickAnimationInfo||this.sidekickAnimationInfo.animation!=r||!this.isWalkAnimation()&&!i.options.animateidle&&!n.idle)this.sidekickAnimationInfo=this.getEmptyAnimationInfo(),this.sidekickAnimationInfo.animation=r;this.sidekickAnimationInfo.direction=Types.convertOrientationToDirection(e.dir),this.drawDynamicAni(n,r,this.sidekickAnimationInfo)},isIdleAnimation:function(){var e=this.getAnimation();return!e||e.indexOf("idle")>=0||e.indexOf("_sit")>=0||this.isFreezing()},isWalkAnimation:function(){var e=this.getAnimation();return e&&e.indexOf("walk")>=0},drawTileType:function(){var e=this.game.mapmanager.tiletypeanis;if(this.tileType==Types.TileTypes.NONE||this.tileType<Types.TileTypes.GRASS||!e){delete this.tileTypeAnimationInfo;return}var t=e[this.tileType];if(!t){delete this.tileTypeAnimationInfo;return}if(!this.tileTypeAnimationInfo||this.tileTypeAnimationInfo.animation!=t||!this.isWalkAnimation())this.tileTypeAnimationInfo=this.getEmptyAnimationInfo(),this.tileTypeAnimationInfo.animation=t;this.tileTypeAnimationInfo.direction=Types.convertOrientationToDirection(this.dir);var n=this.drawDynamicAni(this,t,this.tileTypeAnimationInfo);this.tileTypeAnimationInfo.wasbelow=n&&n.options&&n.options["particleslayer"]=="drawunder",this.tileTypeAnimationInfo.replaceplayerani=n&&n.options&&n.options.replaceplayerani},drawDynamicAni:function(e,t,n){var r=this.game.animationmanager.loadAnimation(t);if(!r||!r.isLoaded)return null;if(!r.frames[n.frame])return null;var i=r.frames[n.frame];r.processParticlesAndEmitters(this,n);var s=this.game.renderer,o=s.context.setupObjXForm(e.x+s.tilesize/2,e.y+s.tilesize-4,e.zoom);return r.drawAnimation(e,n),o&&s.context.restoreObjXForm(o),r.checkProceedAnimation(n),this.playAniSoundandProceed(r,n,!1),r},scheduleTimeout:function(e,t,n,r){this.game.mapmanager.addToActiveObjects(this),n&&(this.timeouts=[]),this.timeouts.length<1e3&&this.timeouts.push({name:e,firetime:Date.now()+t,options:r})},removeScheduledTimeout:function(e){for(var t in this.timeouts){var n=this.timeouts[t];(!n||n.name==e)&&this.timeouts.splice(t,1)}},onUpdateInterval:function(){for(var e in this.timeouts){var t=this.timeouts[e];t?this.game.currentTime>=t.firetime&&(this.timeouts.splice(e,1),this.runTimeoutFunction(t.name,t.options)):this.timeouts.splice(e,1)}this.timeouts.length<=0&&this.game.mapmanager.removeFromActiveObjects(this)},runTimeoutFunction:function(e,t){e&&(e=="sleep"?this.game.scriptmanager.wakeUpFromSleep(t?t.iter:null,this):e.indexOf("script:")==0&&this.game.scriptmanager.runScript(this,null,e.substr("script:".length),t?t.params:null))},handleTrigger:function(e,t){e=="script"&&t&&(this.game.scriptmanager.makeSubArray(t.params),this.game.scriptmanager.runScript(this,this.game.player,"server"+t.action,t.params))},isEventAdmin:function(){return this.clanname&&this.clanname.indexOf("Admin")>=0},isGameAdmin:function(){return this.adminlevel&&this.adminlevel>0}});return t}),define("newnpc",["character"],function(e){var t=e.extend({init:function(t,n){e.prototype.init.call(this,t,n,Types.Entities.NEWNPC),this.imageLoaded=!1,this.showmovearrows=!1,this.timeouts=[],this.scriptenv={},this.guis=[],this.defaultHitbox={shape:"rectangle",bounds:[0,0,this.tileWidth*32,this.tileHeight*32]},this.hitboxColor=[1,0,1,1]},setExtendedData:function(t){e.prototype.setExtendedData.call(this,t),this.loadImage(),this.name=translate(this.name);switch(this.npcclass){case"easterbunny":this.moveSpeed=200;break;case"explosion":this.dosound&&this.game.sounds.play("death");break;case"shopitem":this.game.mapmanager.currentmap&&this.game.mapmanager.currentmap.isHouseInside()&&this.game.showCoinsArrow(!0)}"countdown"in t&&this.startCountdown(),("tileWidth"in t||"tileHeigth"in t)&&this.onUpdateTilesize(),"displayurl"in t&&this.setDisplayURL(this.displayurl,!0),("clientscript"in t||"scriptclasses"in t)&&this.game.scriptmanager.onScriptChanged(this),("nonblocking"in t||"nonblockingtile"in t||"drawunder"in t)&&this.afterChangeImageOrAnimation()},sendTrigger:function(e,t){this.game&&this.game.client&&this.game.client.sendNPCTrigger(this.id,e,t),e=="activate"?this.game.scriptmanager.runScript(this,this.game.player,t.type):["touch","grab"].indexOf(e)>=0&&this.game.scriptmanager.runScript(this,this.game.player,e)},loadImage:function(){if(!this.image||this.image.length<=0){(!this.animationInfo.animation||this.animationInfo.animation.length<=0)&&this.unloadImage();return}var e=this.game.filespath+(this.image&&this.image.indexOf("/")>=0?"":"npcs/")+this.image;if(this.imageLoaded&&this.imageLoadedPath==e)return;this.imageLoaded=!1,this.afterChangeImageOrAnimation()},unloadImage:function(){this.imageLoaded=!1,this.initializeAnimationInfo(),this.setNonBlocking(!0),this.setNonBlockingTile(!1),this.showHitPoints=null},getImageSize:function(){if(this.imageLoaded&&this.imageLoadedSize)return this.imageLoadedSize;if(this.currentAnimation&&this.currentAnimation.options){var e=this.currentAnimation.options.blockingbounds;if(e){var t=Types.convertOrientationToDirection(this.dir);return e[t]instanceof Array&&(e=e[t]),{width:e[2],height:e[3]}}}var n=this.game.renderer;return{width:this.tileWidth*n.tilesize,height:this.tileHeight*n.tilesize}},dontChangeTileSize:function(){return this.npcclass=="gate"||this.image&&(this.image.indexOf("eastershop")>=0||this.image.indexOf("sandcastle")>=0)},setNonBlocking:function(e){this.isNonBlocking=e},setNonBlockingTile:function(e){this.isNonBlockingTile=e},setDrawUnder:function(e){this.isDrawUnder=e},isChair:function(){return this.currentAnimation&&this.currentAnimation.options&&this.currentAnimation.options.ischair?!0:this.image&&(this.image.indexOf("_chair")>=0||this.image.indexOf("_bed")>=0)},isBed:function(){return this.currentAnimation&&this.currentAnimation.options&&this.currentAnimation.options.isbed?!0:this.image&&this.image.indexOf("_bed")>=0},isPet:function(){return this.getAnimation()&&this.getAnimation().indexOf("pet_")==0},setAnimation:function(t,n){e.prototype.setAnimation.call(this,t,n),this.animationLoaded=!1,this.currentAnimation=null;var r=this.game.animationmanager.loadAnimation(this.animationInfo.animation);this.checkAnimationLoaded(r,!1),this.afterChangeImageOrAnimation()},afterChangeImageOrAnimation:function(){this.setNonBlocking(this.nonblocking||this.isChair()||["buildmarker","ladder","gate","explosion","dropitem","monsterspawn"].indexOf(this.npcclass)>=0),this.setNonBlockingTile(this.nonblockingtile||this.npcclass=="ladder"||this.npcclass=="gate"&&this.animationInfo.animation.indexOf("closed")<0),this.setDrawUnder(this.drawunder||this.isBed()||["buildmarker","ladder"].indexOf(this.npcclass)>=0||this.npcclass=="furniture"&&this.image&&this.image.indexOf("_chair")>=0&&this.image.indexOf("_up")<0)},animate:function(e,t){this.npcclass=="easterbunny"&&this.animateAsPlayer(e,t)},setDisplayURL:function(e,t){if(this.displayurl==e&&!t)return;this.displayurl=e;if(!this.game||!this.game.infoManager)return;if(this.game.settings&&this.game.settings.noingametv)return;if(e.indexOf("youtu")>=0){var n=this.game.storymanager.getYoutubeIDFromURL(e);if(n){this.imageLoaded=!1,this.image=null,this.loadImage(),this.tileWidth<=1&&this.tileHeight<=1&&(this.setTileWidth(8),this.setTileHeight(5));var r=this.game.renderer,i=r.zoom*(this.game.settings.buttonzoom?1/this.game.settings.buttonzoom:1),s=Math.floor(this.tileWidth*r.tilesize*i),o=Math.floor(this.tileHeight*r.tilesize*i),u=this.game.storymanager.getYoutubeStoryHTML("youtube",n);u=u.replace("width=400 height=400","width="+s+" height="+o).replace("&autoplay=1",""),this.game.infoManager.addInGameDom(this.id,u,this);return}}this.game.infoManager.removeInGameDom(this.id)},isHouse:function(){return this.npcclass=="house"},startCountdown:function(){this.countdownTimer&&clearInterval(this.countdownTimer);if(!this.countdown||!this.countdown.time||this.countdown.time<=0)return;var e=parseInt(this.countdown.time);this.countdown.time=e;var t=this.countdown.text?this.countdown.text+": ":"";this.chat=t+this.printTimer(e,this.countdown.time),this.showChat(this.chat);var n=this;this.countdownTimer=setInterval(function(){n.countdown.time--,n.countdown.time<=0?(n.chat="",n.showChat(""),clearInterval(n.countdownTimer)):(n.chat=t+n.printTimer(e,n.countdown.time),n.showChat(n.chat))},1e3)},printTimer:function(e,t){return(e>=60?Math.floor(t/60)+":"+Math.floor(t%60/10)+Math.floor(t%10):Math.floor(t))+"s"},onTouch:function(e){if(this.touchtime&&this.game.currentTime<this.touchtime+500)return;this.touchtime=this.game.currentTime;if(!e){this.game.scriptmanager.runScript(this,this.game.player,"npctouch");return}this.isBall()&&this.isInWater()?this.sendTrigger("kick",{angle:this.getKickAngle()}):this.sendTrigger("touch",{}),this.isBall()&&!this.hasBeenKicked&&!this.isInWater()&&(!this.shownKickMessage||this.game.currentTime>=this.shownKickMessage+5e3)&&(this.shownKickMessage=this.game.currentTime,this.game.showShortMessage(this.game.renderer.isMobile?translate("Press the fire button to kick!"):translate("Press Space or S to kick!")))},isBall:function(){return this.npcclass=="ball"||this.npcclass=="furniture"&&["ball_idle","ball_walk"].indexOf(this.getAnimation())>=0},getKickAngle:function(){var e,t=this.game.player.getOrientationToPos(this.gridX,this.gridY);return t==Types.oppositeOrientation(this.game.player.dir)?e=Types.orientationToAngle(this.game.player.dir):e=-Math.atan2(this.gridY-this.game.player.gridY,this.gridX-this.game.player.gridX),e},onActivate:function(e){if(this.npcclass=="peg"){var t=this;setTimeout(function(){t.sendTrigger("activate",{type:e})},400)}else this.npcclass&&this.sendTrigger("activate",{type:e});["mouse","sword"].indexOf(e)>=0&&(e!="sword"||this.getAnimation()!="snowhill")&&(["furniture","ship"].indexOf(this.npcclass)>=0||this.game.player.isGameAdmin()&&e=="mouse"&&["shopitem","itemdisplay","scriptnpc"].indexOf(this.npcclass)>=0)&&(this.showmovearrows=!0)},onHasMoved:function(){e.prototype.onHasMoved.call(this),this.game.infoManager&&this.game.infoManager.updateInGamePos(this.id),!this.isNonBlockingTile&&!this.isNonBlocking&&!this.isRemoved&&!this.isBall()&&this.game.player&&this.game.player.isInRectangle({x:this.gridX,y:this.gridY,w:this.tileWidth,h:this.tileHeight})&&this.onTouch(!1)},drawEntity:function(){this.prepareDrawAnimation();var e=this.game.renderer,t=e.context.setColor(this.color),n;this.sidekick&&!this.game.settings.hidesidekicks&&(n=this.getSideKickPosition(),n.y<=this.y&&(this.drawSideKick(n),n=null));var r=e.context.setupObjXForm(this.x+this.tileWidth*e.tilesize/2,this.y+this.tileHeight*e.tilesize-4,this.zoom,this.currentAnimation&&this.currentAnimation.options&&this.currentAnimation.options.onground);this.image&&this.image.length>0?this.drawImage():this.animationInfo.animation&&(this.drawAnimation(),this.checkAnimationLoaded(this.currentAnimation,!0)),this.drawArgObjects(),r&&e.context.restoreObjXForm(r),n&&this.drawSideKick(n),e.context.setColor(t),this.drawName(),this.drawPrice(),this.drawHealthBar(),this.emoticonfile?this.drawEmoticon():this.chat&&this.chat.length>0&&(e.renderchats?e.renderchats.push(this):this.drawChat()),this.game.settings&&this.game.settings.hitbox&&!this.isNonBlocking&&(this.hitPoints>0||["sparcontrol"].indexOf(this.npcclass)>0)&&(this.drawDebugHitX(),this.isFiring()&&this.drawFireX()),this.showmovearrows&&this.drawMoveArrows()},checkAnimationLoaded:function(e,t){if(this.animationLoaded||!e||!e.isLoaded||!e.options.blockingbounds)return;var n=this.game.renderer;if(!this.dontChangeTileSize()){var r=e.options.blockingbounds;if(r){var i=Types.convertOrientationToDirection(this.dir);r[i]instanceof Array&&(r=r[i]);var s=this.game.renderer.tilesize,o=Math.min(this.game.mapmanager.getMapTileSize(),32);this.setTileWidth(Math.ceil(r[2]/o)*o/s),this.setTileHeight(Math.ceil(r[3]/o)*o/s)}}this.animationLoaded=!0},drawImage:function(){var e=this.game.renderer,t=this.game.filespath+(this.image&&this.image.indexOf("/")>=0?"":"npcs/")+this.image,n=e.getImage(t);e.drawImage(n,this.x,this.y),!this.imageLoaded&&n&&n.image&&(this.imageLoaded=!0,this.imageLoadedPath=t,this.imageLoadedSize={width:n.image.width,height:n.image.height},this.dontChangeTileSize()||((!this.tileWidth||this.tileWidth<15)&&this.setTileWidth(Math.ceil(n.image.width/e.tilesize)),(!this.tileHeight||this.tileHeight<15)&&this.setTileHeight(Math.ceil(n.image.height/e.tilesize))))},setTileWidth:function(e){this.tileWidth=e,this.onUpdateTilesize()},setTileHeight:function(e){this.tileHeight=e,this.onUpdateTilesize()},onUpdateTilesize:function(){var e=this.game.renderer;this.defaultHitbox={shape:"rectangle",bounds:[0,0,this.tileWidth*e.tilesize,this.tileHeight*e.tilesize]},this.game.infoManager&&this.game.infoManager.updateInGameSize(this.id)},drawName:function(){if(!this.name||this.name.length<=0||this.game.player&&this.game.player.ghost)return;var e=this.game.renderer,t=this.currentAnimation,n=(this.tileWidth-(this.isPet()?0:.5))*e.tilesize/2,r=t&&t.options&&"nameoffsety"in t.options?t.options.nameoffsety:this.imageLoaded?(this.tileHeight-2)*e.tilesize:4;this.nameCache=e.drawTextCached(this.nameCache,this.name,this.x+Math.floor(n),this.y+Math.floor(r),{centered:!0,color:this.getNameColor(),strokeColor:"#303030"})},getNameColor:function(){return this.namecolor?this.namecolor:"#ffffff"},drawPrice:function(){if(this.npcclass!="shopitem"&&(this.npcclass!="scriptnpc"||!this.price))return;if(this.shopclan)return;var e;this.price&&typeof this.price=="object"?"coins"in this.price?e=(this.price.coins|0)+"💰 + "+translate("Items"):"cookie"in this.price?e=(this.price.cookie|0)+"🍪":"eventcoin"in this.price?e=(this.price.eventcoin|0)+" EC":"eventgem"in this.price?e=(this.price.eventgem|0)+" EG":e=translate("Items"):e=!this.price||this.price<=0?this.shopclan?this.shopclan:"Free":(this.price|0)+"💰";var t=this.game.renderer,n=(this.tileWidth-.75)*t.tilesize/2,r=this.currentAnimation&&this.currentAnimation.options&&this.currentAnimation.options.priceoffsety?this.currentAnimation.options.priceoffsety:(this.tileHeight-.5)*t.tilesize;this.priceCache=t.drawTextCached(this.priceCache,e,this.x+Math.floor(n),this.y+Math.floor(r),{centered:!0,color:"#00ff00",strokeColor:"#303030"})},drawMoveArrows:function(){var e=this.getImageSize(),t=32;this.movearrowsprites=[{x:e.width/2-t/2,y:-t,w:t,h:t,mode:"moveup",srcx:0,srcy:0},{x:e.width/2-t/2,y:e.height,w:t,h:t,mode:"movedown",srcx:t,srcy:0},{x:-t,y:e.height/2-t/2,w:t,h:t,mode:"moveleft",srcx:t*2,srcy:0},{x:e.width,y:e.height/2-t/2,w:t,h:t,mode:"moveright",srcx:t*3,srcy:0},{x:-t,y:-t,w:t,h:t,mode:"turn",srcx:0,srcy:t*2},{x:e.width,y:-t,w:t,h:t,mode:"edit",srcx:t,srcy:t*2}];var n=this.game.renderer,r=n.context.setColor([1,1,1,this.isMouseDragging?.75:1]);this.isMouseDragging&&this.movearrowsprites.splice(4,100);for(var i in this.movearrowsprites){var s=this.movearrowsprites[i];s.active=this.checkControlModeActive(s.mode);if(!s.active)continue;this.isMouseDragging&&this.isMouseOnWall&&(s.srcy+=t),n.drawImage(n.getImage(this.game.filespath+"gui/bbuilder_movearrows.png"),this.x+s.x,this.y+s.y,[s.srcx,s.srcy,s.w,s.h])}n.context.setColor(r)},getControlModeAt:function(e,t){if(!this.showmovearrows||!this.movearrowsprites)return null;for(var n in this.movearrowsprites){var r=this.movearrowsprites[n];if(!r.active||r.mode.indexOf("move")==0)continue;if(e>=this.x+r.x&&e<this.x+r.x+r.w&&t>=this.y+r.y&&t<this.y+r.y+r.h)return r.mode}var i=32,s=this.getImageSize();return!this.isMouseDragging&&e>=this.x-i&&e<this.x+s.width+i&&t>=this.y-i&&t<this.y+s.height+i?(this.handleFullMouseDragging(e,t),"move"):(this.showmovearrows=!1,null)},handleFullMouseDragging:function(e,t){var n=e-this.x,r=t-this.y,i=this;i.isMouseDragging=!0,i.isMouseOnWall=!1,this.bound={touchmove:gui.bind("body","touchmove",function(e){i.onFurnitureMouseMove(i.getPositionFromEvent(e),n,r)}),touchend:gui.bind("body","touchend",function(e){i.onFurnitureMouseMove(i.getPositionFromEvent(e),n,r),i.onFurnitureMouseUp()}),mousemove:gui.bind("body","mousemove",function(e){i.onFurnitureMouseMove(i.getPositionFromEvent(e),n,r)}),mouseup:gui.bind("body","mouseup",function(e){i.onFurnitureMouseMove(i.getPositionFromEvent(e),n,r),i.onFurnitureMouseUp()})}},getPositionFromEvent:function(e){return e?(e.stopPropagation(),e.preventDefault(),gui.getPositionFromEvent("gamecontainer",e)):{x:0,y:0}},onFurnitureMouseMove:function(e,t,n){if(!this.isMouseDragging)return;e.x=e.x/this.game.renderer.zoom+this.game.renderer.camera.x,e.y=e.y/this.game.renderer.zoom+this.game.renderer.camera.y;var r=this.game.renderer.tilesize,i=Math.min(this.game.mapmanager.getMapTileSize(),32),s=Math.floor((e.x-t)/i)*i/r,o=Math.floor((e.y-n)/i)*i/r;this.x=s*r,this.y=o*r,this.isRemoved=!0;var u=2,a=this.game.mapmanager.isRectangleOutOfBounds(s-u,o-u,this.tileWidth+2*u,this.tileHeight+2*u);this.isRemoved=!1,this.isMouseOnWall=a},onFurnitureMouseUp:function(){if(!this.isMouseDragging)return;this.bound&&(gui.unbind("body","mousemove",this.bound.mousemove),gui.unbind("body","mouseup",this.bound.mouseup),gui.unbind("body","touchmove",this.bound.touchmove),gui.unbind("body","touchend",this.bound.touchend)),this.isMouseDragging=!1,this.showmovearrows=!1;var e=this.game.renderer.tilesize;if(!this.isMouseOnWall){var t=Math.min(this.game.mapmanager.getMapTileSize(),32),n=Math.floor(this.x/t)*t/e,r=Math.floor(this.y/t)*t/e;this.sendTrigger("dragmove",{x:n,y:r})}this.x=this.gridX*e,this.y=this.gridY*e,this.isMouseOnWall=!1},checkControlModeActive:function(e){switch(e){case"turn":return["shopitem","itemdisplay"].indexOf(this.npcclass)>=0?!1:this.currentAnimation&&this.currentAnimation.options&&this.currentAnimation.options.canrotate?!0:this.canrotate?!0:(this.getAnimation()&&this.getAnimation().indexOf("_idle"))>=0||this.getAnimation()=="ship"?!0:this.image&&(this.image.indexOf("bbuilder_chair")==0||this.image.indexOf("fence")>=0||this.image.indexOf("table")>=0);case"edit":return["shopitem","itemdisplay"].indexOf(this.npcclass)<0}return!0},onControlMode:function(e){e=="turn"?this.sendTrigger("turn",{}):e=="edit"&&this.sendTrigger("edit",{})},getScriptObject:function(){if(!this.scriptObject){var e=this;this.scriptObject={get type(){return"npc"},get id(){return e.id},get networkid(){return e.id},get itemid(){return e.itemid},get npcclass(){return e.npcclass},get map(){return e.game.mapmanager.currentmap.getScriptObject()},get hp(){return e.hitPoints},get maxhp(){return e.maxHitPoints},get name(){return e.name},set name(e){this.setname(e)},setname:function(t){e.name=translate(t)},get namecolor(){return e.namecolor},set namecolor(t){e.namecolor=t,delete e.nameCache},get color(){return e.color&&e.color instanceof Array?e.color.slice(0):[1,1,1,1]},set color(t){t instanceof Array&&t.length==4&&(e.color=t)},get chat(){return e.chat},set chat(e){this.setchat(e)},setchat:function(t){e.chat=""+t,e.showChat(""+t)},say:function(t){e.chat=""+t,e.showChat(""+t)},get weapon(){return e.weapon},get body(){return e.armor},set body(e){this.setbody(e)},setbody:function(t){e.armor=t},get head(){return e.head},set head(e){this.sethead(e)},sethead:function(t){e.head=t},get hat(){return e.hat},set hat(e){this.sethat(e)},sethat:function(t){e.hat=t},get bow(){return e.bow},get mount(){return e.mount},get shield(){return e.shield},get image(){return e.image},set image(e){this.setimg(e)},setimg:function(t){e.image=t,e.loadImage()},get icon(){return e.icon},set icon(e){this.seticon(e)},seticon:function(t){e.icon=t},get ani(){return e.getAnimation(!0)},set ani(e){this.setani(e)},setani:function(t){e.setAnimation(t)},get aniarg1(){return e.arg1},set aniarg1(e){this.setaniarg(1,e)},get aniarg2(){return e.arg2},set aniarg2(e){this.setaniarg(2,e)},get aniarg3(){return e.arg3},set aniarg3(e){this.setaniarg(3,e)},get aniarg4(){return e.arg4},set aniarg4(e){this.setaniarg(4,e)},get aniarg5(){return e.arg5},set aniarg5(e){this.setaniarg(5,e)},get aniarg6(){return e.arg6},set aniarg6(e){this.setaniarg(6,e)},get aniarg7(){return e.arg7},set aniarg7(e){this.setaniarg(7,e)},get aniarg8(){return e.arg8},set aniarg8(e){this.setaniarg(8,e)},get aniarg9(){return e.arg9},set aniarg9(e){this.setaniarg(9,e)},setaniarg:function(t,n){if(isInt(t)&&t>=1&&t<=9){var r={};e["arg"+t]=r["arg"+t]=n}},get emitters(){return e.emitters},set emitters(t){e.emitters=t},get x(){return e.gridX},set x(t){e.moveXX(e.dir,t,e.gridY,e.z,null,null,0)},get y(){return e.gridY},set y(t){e.moveXX(e.dir,e.gridX,t,e.z,null,null,0)},get z(){return e.z},get dir(){return Types.convertOrientationToDirection(e.dir)},set dir(e){this.setdir(e)},setdir:function(t){isInt(t)&&t>=Types.Directions.UP&&t<=Types.Directions.RIGHT&&t!=Types.convertOrientationToDirection(e.dir)&&(e.dir=Types.convertDirectionToOrientation(t))},offsetx:function(t){return Types.addOffsetInOrientation(e.gridX,e.gridY,e.dir,t).x},offsety:function(t){return Types.addOffsetInOrientation(e.gridX,e.gridY,e.dir,t).y},get storyid(){return e.storyid},move:function(t,n,r,i){var s=e.getOrientationToPos(n,r);if(i===undefined||i===null)i=e.z;e.moveXX(s,n,r,i,null,null,t*1e3)},get angle(){return e.angle},set angle(t){e.angle=t},get width(){return e.tileWidth},set width(t){e.setTileWidth(Math.max(0,t))},get height(){return e.tileHeight},set height(t){e.setTileHeight(Math.max(0,t))},get nonblocking(){return e.isNonBlocking},set nonblocking(t){e.isNonBlocking=t},get drawunder(){return e.isDrawUnder},set drawunder(t){e.isDrawUnder=t},get sidekick(){return e.sidekick},set sidekick(t){if(t!==null&&typeof t!="object")return;e.sidekick=t},get tiletype(){return e.tileType},play:function(t){t&&e.game.sounds.play(t)},setmusic:function(t){e.game.sounds.setScriptMusic(t)},stopmusic:function(){e.game.sounds.setScriptMusic()},get displayurl(){return e.displayurl},set displayurl(t){e.setDisplayURL(t,!1)},creategui:function(t,n,r,i){return e.game.scriptmanager.createGui(e,t,n,r,i)},triggerserver:function(t){if(e.game.client){var n=e.npcType=="menu"?{type:"menu",id:e.buttonid}:e.npcType=="weapon"?{type:"weapon"}:{type:"npc",id:e.id};e.game.client.sendNPCTrigger(n,"script",{action:t,params:Array.prototype.slice.call(arguments,1)})}},scheduleevent:function(t,n){e.scheduleTimeout("script:"+n,t*1e3,!1,{params:Array.prototype.slice.call(arguments,2)})},cancelevents:function(t){e.removeScheduledTimeout("script:"+t)},settimeout:function(t){e.scheduleTimeout("script:timeout",t*1e3)},sleep:function(t){e.game.scriptmanager.nextSleep={npc:e,delay:t*1e3}}}}return this.scriptObject}});return t}),define("player",["character"],function(e){var t=e.extend({init:function(t,n,r){e.prototype.init.call(this,t,n,r),this.name="",this.isNonBlocking=!0,this.armor=this.game.app.config.defaultarmor,this.weapon=this.game.app.config.defaultweapon,this.head=this.game.app.config.defaulthead,this.coins=0,this.setAnimation("player_idle",!1)},animate:function(e,t){this.animateAsPlayer(e,t)}});return t}),Types={Messages:{SYSTEM:0,HELLO:0,WELCOME:1,SPAWN:2,DESPAWN:3,HURTPROJECTILE:4,PROJECTILE:5,MAPSTREAM:6,ATTACK:7,MOVEXX:8,HURT:9,HEALTH:10,CHAT:11,ANI:12,WEATHER:13,SCORES:14,TELEPORT:15,DAMAGE:16,MODALMESSAGE:17,HOTKEY:18,LIST:19,WHO:20,USERPMS:21,EVENTINFO:22,HP:23,SHOWURL:24,NOTIFICATION:25,FOCUS:26,SHOWVS:27,SHOWVSCLANS:28,MAPMOVE:29,BUILDOBJECT:30,GENERALMESSAGE:31,STORYACTION:32,OBJECTDATA:33,NPCTRIGGER:34,MAPINFO:35,AUDIO:36,GETPROFILE:37,PROFILE:38,TRADEACTION:39,ASKBUYITEM:40,BUYITEM:41,REVIVE:42,SHARED:43,PLACEOBJECT:44,PUSHTOKEN:45,GETINVENTORY:46,INVENTORY:47,USEINVENTORY:48,CLANACTION:49,SHOWVSWINNER:50,SHOWVSCLANWINNER:51,FILEMODTIME:52,SHORTMESSAGE:53,GOTOHOUSE:54,GETPROFILEDB:55,PM:56,BUILDINFO:57,GETMYHOUSES:58,MYHOUSES:58,PMACTION:59,FURNITUREINFO:60,SELLITEMS:61,SELLITEM:62,CLIENTCLASS:63,GETMAPMARKERS:64,MAPMARKERS:64,PAYMENT2:65,PING:66,PONG:67,FRIENDS:68,SETSETTINGS:69,WINNER:70,CONSOLECHAT:71,REMOVESIDEKICKS:72,KICKVISITORS:73,ISTALKING:74,HOUSEINFO:75,SAVESTATUS:76,UNLOCKSTATUS:77,UPLOADACTION:78,ADMININVENTORY:79,BUYCOINS:80,CLIENTLOG:81,ACCOUNTINFO:82,TRACKACTION:83,ITEMDATA:84,PROJECTILEINFO:85,LIKE:86,LISTMESSAGES:87,PLAYERANIS:88,MENUBUTTONS:89,ADDNPC:90,LAGLOG:91,AMBIENTCOLOR:92,MAILINGACTION:93,PATHMESSAGE:94,GETPATH:95,PAYSESSION:96,SETPATH:97,PAYPACKAGES:98,IDENTIFY:99,STEAMPAYMENT:100,DELETEACCOUNT:101,CLANPMS:102,SCREENSIZE:103},IDPrefix:{TEMP:"0",MAP:"4",PLAYER:"5",NPC:"6"},Entities:{PLAYER:1,NEWNPC:2,PROJECTILE:3,MISC:4},Orientations:{UP:1,DOWN:2,LEFT:3,RIGHT:4},Directions:{UP:0,LEFT:1,DOWN:2,RIGHT:3},AnimationFlags:{DEFAULTANIS:1,PREDICT:2},TileTypes:{NONE:null,GRASS:0,TALLGRASS:1,BLOCK:2,SAND:3,BED:4,DEEPWATER:5,SHALLOWWATER:6,TURFPATH:7,WOODPATH:8,CHAIR:9,STONE:10,SNOW:11,ICE:12}},Types.getOrientationAsString=function(e){switch(e){case Types.Orientations.LEFT:return"left";case Types.Orientations.RIGHT:return"right";case Types.Orientations.UP:return"up";case Types.Orientations.DOWN:return"down"}},Types.convertOrientationToDirection=function(e){switch(e){case Types.Orientations.UP:return Types.Directions.UP;case Types.Orientations.LEFT:return Types.Directions.LEFT;case Types.Orientations.DOWN:return Types.Directions.DOWN;case Types.Orientations.RIGHT:return Types.Directions.RIGHT}},Types.convertDirectionToOrientation=function(e){switch(e){case Types.Directions.UP:return Types.Orientations.UP;case Types.Directions.LEFT:return Types.Orientations.LEFT;case Types.Directions.DOWN:return Types.Orientations.DOWN;case Types.Directions.RIGHT:return Types.Orientations.RIGHT}},Types.convertKeyToOrientation=function(e){switch(e){case 37:return Types.Orientations.LEFT;case 38:return Types.Orientations.UP;case 39:return Types.Orientations.RIGHT;case 40:return Types.Orientations.DOWN}},Types.addOffsetInOrientation=function(e,t,n,r){switch(n){case Types.Orientations.UP:t-=r;break;case Types.Orientations.LEFT:e-=r;break;case Types.Orientations.DOWN:t+=r;break;case Types.Orientations.RIGHT:e+=r}return{x:e,y:t,gridX:Math.floor(e),gridY:Math.floor(t)}},Types.orientationLeft=function(e){switch(e){case Types.Orientations.UP:return Types.Orientations.LEFT;case Types.Orientations.LEFT:return Types.Orientations.DOWN;case Types.Orientations.DOWN:return Types.Orientations.RIGHT;case Types.Orientations.RIGHT:return Types.Orientations.UP}},Types.orientationRight=function(e){switch(e){case Types.Orientations.UP:return Types.Orientations.RIGHT;case Types.Orientations.LEFT:return Types.Orientations.UP;case Types.Orientations.DOWN:return Types.Orientations.LEFT;case Types.Orientations.RIGHT:return Types.Orientations.DOWN}},Types.oppositeOrientation=function(e){switch(e){case Types.Orientations.UP:return Types.Orientations.DOWN;case Types.Orientations.LEFT:return Types.Orientations.RIGHT;case Types.Orientations.DOWN:return Types.Orientations.UP;case Types.Orientations.RIGHT:return Types.Orientations.LEFT}},Types.orientationIsHorizontal=function(e){return e==Types.Orientations.LEFT||e==Types.Orientations.RIGHT},Types.orientationIsVertical=function(e){return e==Types.Orientations.UP||e==Types.Orientations.DOWN},Types.orientationToAngle=function(e){switch(e){case Types.Orientations.UP:return Math.PI/2;case Types.Orientations.LEFT:return Math.PI;case Types.Orientations.DOWN:return Math.PI*3/2;case Types.Orientations.RIGHT:return 0}return 0},Types.getMessageTypeAsString=function(e){for(var t in Types.Messages)if(Types.Messages[t]==e)return t;return"UNKNOWN"},typeof exports!="undefined"&&(module.exports=Types),define("gametypes",function(){}),define("projectiles",["character","newnpc","gametypes"],function(e,t){var n=Class.extend({init:function(e){this.map=e,this.projectiles=[]},createProjectile:function(t,n,r,i,s,o,u,a){var f=this.getTypeInfo(n);if(!f)return null;var l=new e(this.map.game,this.map.game.getTemporaryEntityID(),Types.Entities.PROJECTILE);return l.created=Date.now(),l.owner=t,l.type=n,l.setGridPosition(r,i),l.z=s,l.angle=o,l.ping=u/2e3,l.info=f,l.arrow=f.arrow,l.defaultHitbox={shape:"circle",center:{x:0,y:0},radius:16},l.hitboxColor=[1,0,0,1],l.zangle=f.zangle,l.dx=f.speed*Math.cos(o),l.dy=-f.speed*Math.sin(o),this.checkLoadAnimationForProjectile(l),this.projectiles.push(l),a&&this.sendProjectile(l),this.checkAssignOwner(l),l},sendProjectile:function(e){this.map.game.client.sendProjectile(e.type,e.gridX,e.gridY,e.z,e.angle)},checkAssignOwner:function(e){if(this.map.game.player&&e.owner==this.map.game.player.id){e.clanname=this.map.game.player.clanname;return}if(!e.arrow)return;for(var t in this.map.game.players){var n=this.map.game.players[t];if(n&&n.id==e.owner){n.arrow=e.arrow,e.clanname=n.clanname;return}}},getProjectileSound:function(e){var t=this.getTypeInfo(e);if(!t||!t.image)return null;var n=t.image.indexOf(".bani");if(n<0)return null;var r=this.map.game.animationmanager.loadAnimation(t.image.substring(0,n));if(!r||!r.frames||r.frames.length<=0)return null;var i=r.frames[0];return i.sound?i.sound.constructor===Array?i.sound[Math.floor(Math.random()*i.sound.length)]:i.sound:null},checkLoadAnimationForProjectile:function(e){var t=e.info.image,n=t.indexOf(".bani");n>=0&&e.setAnimation(t.substring(0,n)+t.substring(n+".bani".length),!1)},drawProjectiles:function(){var e=this.map.game.renderer,t=this.map.game.animationmanager,n=this.map.game.settings&&this.map.game.settings.hitbox;for(var r in this.projectiles){var i=this.projectiles[r],s=i.animationInfo&&i.animationInfo.particles&&i.animationInfo.particles.length>0;if(!e.camera.isVisible(i,s?4:0))continue;if(i.animationInfo.animation)i.prepareDrawAnimation(),i.drawAnimation();else{var o=e.getImage(this.map.game.filespath+"npcs/"+i.info.image);if(o){var u=i.gridX*e.tilesize-o.image.width/2,a=(i.gridY-i.z)*e.tilesize-o.image.height/2;e.drawImage(o,u,a)}}n&&i.drawDebugHitX()}},processProjectiles:function(){var e=this.map.game.frameTimeS,t=Date.now();for(var n in this.projectiles){var r=this.projectiles[n],i=e;r.ping>0&&t<r.created+1e3&&(i*=1+r.ping),r.gridX+=r.dx*i,r.gridY+=r.dy*i,r.x=r.gridX*32,r.y=r.gridY*32,r.z+=r.zangle*i,r.zangle-=r.info.gravity*20*i;if(this.checkHurtPlayer(r)||this.checkHurtOthers(r)){this.projectiles.splice(n,1);continue}if(r.z<0||r.info.collidetiles&&this.map.isColliding(r.gridX,r.gridY,!0)){this.projectiles.splice(n,1);continue}if(this.isOutOfSync(r)){this.projectiles.splice(n,1);continue}}},isOutOfSync:function(e){var t=20,n=this.map.game.renderer.camera;return!(e.gridX>=n.gridX-t&&e.gridX<n.gridX+n.gridW+t&&e.gridY>=n.gridY-t&&e.gridY<n.gridY+n.gridH+t)},checkHurtPlayer:function(e){if(!e.info.hittype)return!1;var t=this.map.game.player;return!t||t.isInWater()?!1:e.owner==t.id?!1:!this.map.isSpar()&&!this.map.isPvpEvent()&&e.clanname&&e.clanname==t.clanname?!1:this.map.isSpar()&&e.info.nospar?!1:e.z>t.z+3?!1:t.ch(e)?(this.map.game.client.sendHurtProjectile(e.owner,e.type),this.map.game.app.config.projectilebounce&&t.bounceByHurt(e),this.map.game.sounds.play("arrow_impact"),e.info["hittype"]=="snow"&&t.setSnowFrozen(),!0):!1},checkHurtOthers:function(e){if(!e.info.hittype)return!1;var n;if(!this.map.isInWater(e.gridX,e.gridY-e.z)){var r=this.map.game.findNearestPlayer(e.gridX-.5,e.gridY-e.z-.5,10);r&&r.ch(e)&&(n=r)}if(!n){var i=this.map.getEntitiesAt(e.gridX,e.gridY-e.z,.5,.5);for(var s in i){var o=i[s];if(!(o instanceof t)||o.isNonBlocking||(!o.hitPoints||o.hitPoints<=0)&&o.npcclass!="sparcontrol")continue;if(o.npcclass!="sparcontrol"&&!o.ch(e))continue;n=o;break}if(!n)return!1}return n.id==e.owner?!1:!this.map.isSpar()&&e.clanname&&e.clanname==n.clanname?!1:e.z>n.z+3?!1:(this.map.game.sounds.play("arrow_impact"),!0)},getTypeInfo:function(e){return this.map.game.projectileInfo?this.map.game.projectileInfo[e]:null}});return n}),define("newmap",["newnpc","player","projectiles","character","gametypes"],function(e,t,n,r){var i=Class.extend({init:function(e,t,r){this.game=e,this.mapname=t,this.templatename=r,this.id=Types.IDPrefix.MAP+t,this.isLoaded=!1,this.loadTime=e.currentTime,this.properties={},this.projectiles=new n(this),this.hasTileTypes=!1,this.usezonefiles=!1},initTilesets:function(){for(var e in this.layers)this.getTilesetForLayer(this.layers[e])},getTilesetForLayer:function(e){return this.game.renderer.getImage(this.game.filespath+"maps/tiles/"+e.tileset,864e5)},addStreamData:function(e){var t=!1;if(e.header){this.isLoaded=!1;if("properties"in e.header){this.properties=e.header.properties;if(this.properties.musicareas)try{this.properties.musicareas=JSON.parse(this.properties.musicareas)}catch(n){}}"usezonefiles"in e.header&&(this.usezonefiles=e.header.usezonefiles);var r=this.game.renderer.tilesize;this.width=Math.floor(e.header.width/r),this.height=Math.floor(e.header.height/r),this.offsetx=(e.header.offsetx?e.header.offsetx:0)/r,this.offsety=(e.header.offsety?e.header.offsety:0)/r;var i=!1;this.layers=[];for(var s in e.header.layers){var o=e.header.layers[s],u={layer:o.layer,offsetx:o.offsetx,offsety:o.offsety,width:o.width,height:o.height,tilewidth:o.tilewidth,tileheight:o.tileheight,tilesinrow:o.tilesinrow,tileset:o.tileset,tilesetwidth:o.tilesetwidth,collision:o.collision,drawover:o.drawover&&!i,water:o.water,tiletypes:o.tiletypes,isstatic:o["static"],opacity:o.opacity},a=u.tileset.indexOf("?");u.tilesetbase=a>=0?u.tileset.substring(0,a):u.tileset,u.tiles=new Array(u.width*u.height),this.initLayerTilesLookup(u),this.layers.push(u),u.tiletypes&&(this.hasTileTypes=!0)}this.initTilesets(),t=!0}this.mergeZoneLayers(e.zones,t)},mergeZoneLayers:function(e,t){var n={};for(var r in this.layers)n[this.layers[r].layer]=this.layers[r];for(var r in e){var i=e[r],s=n[i.layer];if(!s)continue;var o=i.x,u=i.y,a=i.w,f=i.h;for(var l=0;l<f;l++)for(var c=0;c<a;c++)s.tiles[o+c+(u+l)*s.width]=i.tiles[c+l*a];this.markLayerUsedForLookup(s,i);if(!this.terrainrenderoffset)t=!0;else{var h=(this.terrainrenderoffset.x-s.offsetx)/s.tilewidth,p=Math.floor(h),d=Math.min(Math.ceil(h+this.game.renderer.getTileWidth()/s.tilewidth),s.width),v=(this.terrainrenderoffset.y-s.offsety)/s.tileheight,m=Math.floor(v),g=Math.min(Math.ceil(v+this.game.renderer.getTileHeight()/s.tileheight),s.height);o<d&&o+a>p&&u<g&&u+f>m&&(t=!0)}}t&&this.isLoaded&&this.game.started&&this.game.renderer&&this.game.renderer.updateTiles(!0)},loadZoneFile:function(e){},checkLoadZone:function(){},checkTilesetsLoaded:function(){this.game.currentTime>=this.loadTime+15e3&&this.hideStartScreen();if(this.isLoaded||!this.layers)return;for(var e in this.layers){var t=this.getTilesetForLayer(this.layers[e]);if(!t)return}this.isLoaded=!0,this.hideStartScreen(),this.game.started&&this.game.renderer&&this.game.renderer.updateTiles(!0),this.checkLoadZone()},hideStartScreen:function(){!this.game.tilesFinishedLoading&&this.game.checkHideStartScreen&&(this.game.tilesFinishedLoading=!0,this.game.checkHideStartScreen())},initLayerTilesLookup:function(e){e.tilesLookupSize=Math.ceil(256/e.tilewidth),e.tilesLookupWidth=Math.floor(e.width/e.tilesLookupSize),e.tilesLookupHeight=Math.floor(e.height/e.tilesLookupSize),e.tilesLookup=new Array(e.tilesLookupWidth*e.tilesLookupHeight)},markLayerUsedForLookup:function(e,t){var n=Math.floor(t.x/e.tilesLookupSize),r=Math.floor((t.x+t.w-1)/e.tilesLookupSize),i=Math.floor(t.y/e.tilesLookupSize),s=Math.floor((t.y+t.h-1)/e.tilesLookupSize);for(var o=i;o<=s;o++)for(var u=n;u<=r;u++)e.tilesLookup[o*e.tilesLookupWidth+u]=!0},getUsedLayers:function(e){var t=this.game.renderer;e||(e={x:this.terrainrenderoffset.x,y:this.terrainrenderoffset.y,w:t.getTileWidth(),h:t.getTileHeight()});var n=[];for(var r=0;r<this.layers.length;r++){var i=this.layers[r];if(i.tiletypes)continue;var s=(e.x-i.offsetx)/i.tilewidth;i.minx=Math.floor(s),i.maxx=Math.min(Math.ceil(s+e.w/i.tilewidth),i.width);var o=Math.floor(i.minx/i.tilesLookupSize),u=Math.floor((i.maxx-1)/i.tilesLookupSize),a=(e.y-i.offsety)/i.tileheight;i.miny=Math.floor(a),i.maxy=Math.min(Math.ceil(a+e.h/i.tileheight),i.height);var f=Math.floor(i.miny/i.tilesLookupSize),l=Math.floor((i.maxy-1)/i.tilesLookupSize),c=!1,h=null,p=null,d=null,v=null;for(var m=f;m<=l;m++)for(var g=o;g<=u;g++)i.tilesLookup[m*i.tilesLookupWidth+g]&&(c=!0,h==null?(h=p=g,d=v=m):(h=Math.min(g,h),d=Math.min(m,d),p=Math.max(g,p),v=Math.max(m,v)));c&&(i.minx=Math.max(i.minx,h*i.tilesLookupSize),i.miny=Math.max(i.miny,d*i.tilesLookupSize),i.maxx=Math.min(i.maxx,(p+1)*i.tilesLookupSize),i.maxy=Math.min(i.maxy,(v+1)*i.tilesLookupSize),n.push(i))}return n},drawTiles:function(){this.layervertices=[];if(!this.layers||!this.isLoaded)return;this.terrainrenderoffset||(this.terrainrenderoffset={x:0,y:0}),this.countDrawOverLayers=0;var e=this.game.renderer;this.checkClearBack();var t=[],n=[],r=0,i=this.getUsedLayers(),s=e.hasWebGL(),o=e.context.backcontext;for(var u in i){var a=i[u],f=null,l,c,h={layer:a,offset:r,count:0,drawover:a.drawover!=undefined&&a.drawover,opacity:a.opacity},p=a.tilewidth,d=a.tileheight;for(var v=a.miny;v<a.maxy;v++){var m=-1,g=-1;for(var y=a.minx;y<a.maxx;y++){var b=v*a.width+y,w=a.tiles[b];if(w===undefined||w==-1){g=-1;continue}var E=w&268435455,S=(w&4026531840)>>>28,x=E%a.tilesinrow*p,T=Math.floor(E/a.tilesinrow)*d,N=b%a.width*p+a.offsetx-this.terrainrenderoffset.x,C=Math.floor(b/a.width)*d+a.offsety-this.terrainrenderoffset.y;if(!f||!f.image){f=this.getTilesetForLayer(a);if(!f||!f.image){v=a.maxy;break}l=1/f.image.width,c=1/f.image.height}if(s)if(T==g&&x==m+p&&S==0){var k=t.length-12;t[k+2]+=p,t[k+6]+=p,t[k+8]+=p,n[k+2]+=p*l,n[k+6]+=p*l,n[k+8]+=p*l}else{t.push(N,C,N+p,C,N,C+d,N+p,C,N+p,C+d,N,C+d);if(S){var L=[x*l,T*c],A=[(x+p)*l,T*c],O=[x*l,(T+d)*c],M=[(x+p)*l,(T+d)*c];switch(S){case 2:var _=A;A=O,O=_;break;case 4:var _=L;L=O,O=_,_=A,A=M,M=_;break;case 6:var _=L;L=A,A=M,M=O,O=_;break;case 8:var _=L;L=A,A=_,_=O,O=M,M=_;break;case 10:var _=L;L=O,O=M,M=A,A=_;break;case 12:var _=L;L=M,M=_,_=A,A=O,O=_;break;case 14:var _=L;L=M,M=_}n.push(L[0],L[1],A[0],A[1],O[0],O[1],A[0],A[1],M[0],M[1],O[0],O[1])}else n.push(x*l,T*c,(x+p)*l,T*c,x*l,(T+d)*c,(x+p)*l,T*c,(x+p)*l,(T+d)*c,x*l,(T+d)*c);h.count+=6}else o&&(S?(o.save(),o.translate(N+p/2,C+d/2),S&2&&o.rotate(Math.PI*.5),o.scale(S==6||S==8||S==12||S==14?-1:1,S==2||S==4||S==6||S==12?-1:1),o.drawImage(f.image,x,T,p,d,-p/2,-d/2,p,d),o.restore()):o.drawImage(f.image,x,T,p,d,N,C,p,d));m=x,g=T}}s&&h.count>0&&(this.layervertices.push(h),r+=h.count,h.drawover&&this.countDrawOverLayers++)}e.hasWebGL()&&this.updateTileBuffers(r,t,n)},updateTileBuffers:function(e,t,n){var r=this.game.renderer;e>0?(this.tilebuffers||(this.tilebuffers={}),this.tilebuffers.vertices||(this.tilebuffers.vertices=r.context.contextGL.createBuffer()),r.context.contextGL.bindBuffer(r.context.contextGL.ARRAY_BUFFER,this.tilebuffers.vertices),r.context.contextGL.bufferData(r.context.contextGL.ARRAY_BUFFER,new Float32Array(t),r.context.contextGL.STATIC_DRAW),this.tilebuffers.texcoords||(this.tilebuffers.texcoords=r.context.contextGL.createBuffer()),r.context.contextGL.bindBuffer(r.context.contextGL.ARRAY_BUFFER,this.tilebuffers.texcoords),r.context.contextGL.bufferData(r.context.contextGL.ARRAY_BUFFER,new Float32Array(n),r.context.contextGL.STATIC_DRAW)):this.tilebuffers&&(this.tilebuffers.vertices&&r.context.contextGL.deleteBuffer(this.tilebuffers.vertices),this.tilebuffers.texcoords&&r.context.contextGL.deleteBuffer(this.tilebuffers.texcoords),this.tilebuffers=null)},checkClearBack:function(){var e=this.game.renderer;if(!e.context.backcontext)return;var t=e.getTileWidth(),n=e.getTileHeight(),r=e.tilesize;if(this.getCenterView()||this.terrainrenderoffset.x<0||this.terrainrenderoffset.y<0||this.terrainrenderoffset.x+t>this.width*r||this.terrainrenderoffset.y+n>this.height*r)e.context.backcontext.fillStyle="black",e.context.backcontext.fillRect(0,0,e.context.backcontext.canvas.width,e.context.backcontext.canvas.height)},getFirstLayerTileSize:function(){return this.layers&&this.layers.length>0?this.layers[0].tilewidth:this.game.renderer.tilesize},getTile:function(e,t,n){if(!e.tiles||e.tiles.length<=0)return-1;var r=this.game.renderer.tilesize,i=Math.floor((t*r-e.offsetx)/e.tilewidth),s=Math.floor((n*r-e.offsety)/e.tileheight);if(i<0||i>=e.width||s<0||s>=e.height)return-1;var o=s*e.width+i;return o>=e.tiles.length?e.tiles[e.tiles.length-1]:e.tiles[o]},isOutOfBounds:function(e,t){return e<this.offsetx||e>=this.offsetx+this.width||t<this.offsety||t>=this.offsety+this.height},isWater:function(e,t){if(this.isOutOfBounds(e,t))return!1;for(var n in this.layers){var r=this.layers[n];if(r.tiletypes&&this.getTile(r,e,t)==Types.TileTypes.DEEPWATER)return!0;if(r.water){var i=this.getTile(r,e,t);if(i!==undefined&&i!=-1)return!0}if(r.tilesetbase.indexOf("water")>=0&&this.getTile(r,e,t)==6)return!0}return!1},isChair:function(t,n){if(this.isOutOfBounds(t,n))return!1;if(this.hasTileTypes)for(var r in this.layers){var i=this.layers[r];if(i.tiletypes&&this.getTile(i,t,n)==Types.TileTypes.CHAIR)return!0}var s=this.getEntitiesAt(t,n,0,0);return s.length>0&&_.any(s,function(t){return t instanceof e&&t.isChair()})},isBed:function(t,n){if(this.isOutOfBounds(t,n))return!1;if(this.hasTileTypes)for(var r in this.layers){var i=this.layers[r];if(i.tiletypes&&this.getTile(i,t,n)==Types.TileTypes.BED)return!0}var s=this.getEntitiesAt(t,n,0,0);return s.length>0&&_.any(s,function(t){return t instanceof e&&t.isBed()})},getTileType:function(e,t){if(!this.hasTileTypes||this.isOutOfBounds(e,t))return Types.TileTypes.NONE;for(var n in this.layers){var r=this.layers[n];if(r.tiletypes){var i=this.getTile(r,e,t);if(i>=Types.TileTypes.GRASS)return i}}return Types.TileTypes.NONE},matchesTileDefinitions:function(e,t,n){if(this.isOutOfBounds(e,t))return!1;for(var r in this.layers){var i=this.layers[r],s=n[i.tilesetbase];if(!s)continue;var o=this.getTile(i,e,t);if(o!==undefined&&o!=-1&&s.indexOf(o&268435455)>=0)return!0}return!1},getTileByTileset:function(e,t,n){if(this.isOutOfBounds(e,t))return null;for(var r in this.layers){var i=this.layers[r];if(!n||n==i.tilesetbase){var s=this.getTile(i,e,t);if(s!==undefined&&s!=-1)return s&268435455}}return null},isSpar:function(){return this.templatename.indexOf("spar")>=0},isMeleeSpar:function(){return this.isSpar()&&this.templatename.indexOf("melee")>=0},isBowSpar:function(){return this.isSpar()&&(this.game.app.config.primaryweapon=="gun"||this.templatename.indexOf("bow")>=0)},isEvent:function(){return this.templatename.indexOf("event")>=0},isPvpEvent:function(){return this.isEvent()||this.properties.pvpevent},getEnableDayNight:function(){return this.properties.enabledaynight},getCopyrightImage:function(){return this.properties.copyrightimage},getDarkEffect:function(){return this.properties.darkeffect},getCutOutHole:function(){return this.properties.cutouthole},getCutOutHoleRadius:function(){return this.properties.cutoutholeradius},setCutOutHoleRadius:function(e){this.properties.cutoutholeradius=Math.max(0,e)},getCutOutHoleNoDayNight:function(){return this.properties.cutoutholenodaynight},getCenterView:function(){return this.isHouseInside()||this.properties.centerview},getMusic:function(e,t){var n=this.properties.musicareas;if(n)for(var r=0;r<n.length;r++){var i=n[r];if(e>=i.x&&e<i.x+i.w&&t>=i.y&&t<i.y+i.h)return i.music}return this.properties.music},getCollisionX:function(e,t){if(this.isOutOfBounds(e,t))return{collision:!0,type:"border"};var n=this.getEntitiesAt(e,t,0,0),r;if(n.length>0){this.sortEntitiesForPickup(n,e,t,!1),r=n[0];if(r.npcclass=="link"||!_.all(n,function(e){return!e.isNonBlockingTile}))return{collision:!1,entity:r}}for(var i in this.layers){var s=this.layers[i];if(s.collision){var o=this.getTile(s,e,t);if(o!==undefined&&o!=-1)return{collision:!0,type:"tile",entity:r}}if(s.tiletypes&&this.getTile(s,e,t)==Types.TileTypes.BLOCK)return{collision:!0,type:"tile",entity:r}}if(n.length>0){var u=this.getNPCBlockingAt(n,e,t);if(u)return{collision:!0,type:"entity",entity:u}}return{collision:!1,entity:r}},isColliding:function(e,t,n){if(this.isOutOfBounds(e,t))return!0;for(var r in this.layers){var i=this.layers[r];if(i.collision){var s=this.getTile(i,e,t);if(s!==undefined&&s!=-1)return!0}if(i.tiletypes&&this.getTile(i,e,t)==Types.TileTypes.BLOCK)return!0}return n?!1:this.getNPCBlockingAt(this.getEntitiesAt(e,t,0,0),e,t)!=null},getNPCBlockingAt:function(e,t,n){for(var r in e){var i=e[r];if(i.isRemoved||i.isNonBlocking)continue;if(i.currentAnimation&&i.currentAnimation.isLoaded&&i.currentAnimation.options.tiletypes&&i.currentAnimation.getTile(t-i.gridX,n-i.gridY)!=Types.TileTypes.BLOCK)continue;return i}return null},isCollidingRectangle:function(e,t,n,r,i){for(var s=0;s<n;s++)for(var o=0;o<r;o++)if(this.isColliding(e+s,t+o,i))return!0;return!1},isHouseInside:function(){return this.templatename.indexOf("inside")>=0},getEntityAt:function(e,t,n,r){if(this.isOutOfBounds(e,t))return null;var i=this.getEntitiesAt(e,t,0,0),s=!1;return i.length<=0&&(n>0||r>0)&&(i=this.getEntitiesAt(e,t,n,r),s=!0),i.length<=0?null:(this.sortEntitiesForPickup(i,e,t,s),i[0])},sortEntitiesForPickup:function(t,n,r,i){var s=["dropitem","furniture","link","buildmarker"];t.sort(function(t,o){if(i){var u=Math.abs(t.gridX-n)+Math.abs(t.gridY-r),a=Math.abs(o.gridX-n)+Math.abs(o.gridY-r);if(u!=a)return u-a}return t instanceof e&&s.indexOf(t.npcclass)>=0?-1:o instanceof e&&s.indexOf(o.npcclass)>=0?1:o instanceof e&&o.isDrawUnder?-1:t instanceof e&&t.isDrawUnder?1:0})},getEntitiesAt:function(e,t,n,r){var i=[];return this.game.forEachEntity(function(s){var o=s.tileWidth,u=s.tileHeight;if(e+n<s.gridX||e-n>=s.gridX+o||t+r<s.gridY||t-r>=s.gridY+u)return;i.push(s)}),i},getControlEntityAt:function(e,t){var n=null;return this.game.forEachEntity(function(r){var i=r.getControlModeAt(e,t);i&&(n={entity:r,mode:i})}),n},setExtendedData:function(e){for(var t in e)t.indexOf("_")==0?this.getScriptObject()[t.substring(1)]=e[t]:this[t]=e[t]},getScriptVar:function(e){return this.getScriptObject()[e]},getScriptObject:function(){if(!this.scriptObject){var e=this;this.scriptObject={get type(){return"map"},name:e.mapname,template:e.templatename,width:e.width,height:e.height,toString:function(){return e.mapname},iswater:function(t,n){return e.isWater(t,n)},iswall:function(t,n,r){return e.isColliding(t,n,r)},matchestiles:function(t,n,r){return r?e.matchesTileDefinitions(t,n,r):!1},gettile:function(t,n,r){return e.getTileByTileset(t,n,r)},gettiletype:function(t,n){return e.getTileType(t,n)},get tiletypeanis(){return e.game.mapmanager.tiletypeanis},set tiletypeanis(t){t&&t instanceof Array&&(e.game.mapmanager.tiletypeanis=t)},setambient:function(t,n,r){e.properties||(e.properties={}),e.properties.ambient=[t,n,r]},get properties(){return e.properties},set properties(t){e.properties=t&&typeof t=="object"?t:{}},get cutouthole(){return e.getCutOutHole()},get cutoutholeradius(){return e.getCutOutHoleRadius()},set cutoutholeradius(t){e.setCutOutHoleRadius(t)},get cutoutholenodaynight(){return e.getCutOutHoleNoDayNight()}}}return this.scriptObject}});return i}),define("mapmanager",["newnpc","newmap"],function(e,t){var n=Class.extend({init:function(e){this.game=e,this.game.mapmanager=this,this.templates={},this.maps={},this.activeObjects=[],this.isLoaded=!0,this.tiletypeanis=[null,null,null,null,null,null,null,null,null,null],this.preloadMaps()},preloadMaps:function(){this.loadMap(this.getDefaultOutsideMap(),this.getDefaultOutsideMap())},getDefaultOutsideMap:function(){return this.game.app.config.defaultmapname},getDefaultInsideMap:function(){return"inside"},getMap:function(e){return this.maps[e]},loadMap:function(e,n){var r=this.maps[e];if(r&&r==this.currentmap)return;this.clearActiveObjects();if(r){this.currentmap=r;return}this.currentmap=new t(this.game,e,n),this.maps[e]=this.currentmap},drawTiles:function(){this.currentmap.drawTiles()},isOutOfBounds:function(e,t){return!this.currentmap||!isInt(e)||!isInt(t)?!0:e<0||e>=this.currentmap.width||t<0||t>=this.currentmap.height},isRectangleOutOfBounds:function(e,t,n,r){return this.currentmap?e<0||e+n>=this.currentmap.width||t<0||t+r>=this.currentmap.height:!0},isColliding:function(e,t,n){return this.currentmap.isColliding(e,t,n)},isCollidingRectangle:function(e,t,n,r,i){return this.currentmap.isCollidingRectangle(e,t,n,r,i)},getEntityAt:function(e,t,n,r){return this.currentmap.getEntityAt(e,t,n,r)},getControlEntityAt:function(e,t){return this.currentmap.getControlEntityAt(e,t)},getMapTileSize:function(){return this.currentmap?this.currentmap.getFirstLayerTileSize():this.game.renderer.tilesize},addToActiveObjects:function(e){if(e.isActiveObject)return;this.activeObjects.push(e),e.isActiveObject=!0},removeFromActiveObjects:function(e){if(!e.isActiveObject)return;var t=this.activeObjects.indexOf(e);t>=0&&this.activeObjects.splice(t,1),e.isActiveObject=!1},clearActiveObjects:function(){if(this.activeObjects.length<=0)return;for(var e in this.activeObjects){var t=this.activeObjects[e];t&&(t.isActiveObject=!1)}this.activeObjects=[]}});return n}),define("newanimation",[],function(){var e=Class.extend({init:function(e,t){this.game=e,this.animationname=t,this.isLoaded=!1},initAnimation:function(e){if(e["filetype"]!="bbuilderani"||e["aniversion"]!=1)return;this.options=e.options,this.defaults=e.defaults,this.sprites=e.sprites,this.frames=e.frames,this.emitters=e.emitters,this.animationOffset={x:this.options.center?this.options.center[0]-16:0,y:this.options.center?this.options.center[1]-16:0},this.game.animationmanager.loadAnimationImages(this),this.checkCorrect()},checkCorrect:function(){this.isLoaded=this.defaults&&this.options&&this.sprites&&this.frames?!0:!1},drawAnimation:function(e,t){if(!this.isLoaded||!t||!e)return;t.particles&&t.particles.length>0&&this.options["particleslayer"]=="drawunder"&&this.drawParticles(e,t),this.drawSprites(e,t),t.particles&&t.particles.length>0&&this.options["particleslayer"]!="drawunder"&&this.drawParticles(e,t)},drawSprites:function(e,t){if(t.frame==undefined||!this.frames[t.frame])return;var n=this.frames[t.frame].directions;if(!n||n.length!=1&&n.length!=4)return;var r=n[n.length==1?0:t.direction],i=this.game.renderer,s=this.game.animationmanager,o;for(var u in r){var a=r[u],f=this.sprites[a[0]];if(!f)continue;if(f.ambient&&this.checkBadAmbient(f.ambient))continue;var l=s.getGraphic(e,f.gfx,this,t),c=Math.floor(e.x)-this.animationOffset.x+a[1],h=Math.floor(e.y)-this.animationOffset.y+a[2],p=f.scale;e.z>0&&(a[0]>0?h-=e.z*i.tilesize:(c+=e.z*i.tilesize*.25,this.options.scaleshadow&&(p=[1/(1+e.z*.25),1/(1+e.z*.25)])));var d=null;f.rotation&&(d=this.rotValue(f.rotation,e,t));if(f.color){var v=i.context.setColor(f.color);v&&!o&&(o=v)}else o&&(i.context.setColor(o),o=null);f.mode?(i.context.setBlendMode(f.mode),i.drawImage(i.getImage(l),Math.floor(c),Math.floor(h),f.bounds,p,d,!1),i.context.setBlendMode("normal")):i.drawImage(i.getImage(l),Math.floor(c),Math.floor(h),f.bounds,p,d,!1)}o&&i.context.setColor(o)},checkBadAmbient:function(e){if(!e||e.length<2)return!1;var t=this.game.renderer.context.getCurrentAmbientColor(),n=t?(t[0]+t[1]+t[2])/3:1;return n<e[0]||n>e[1]},rotValue:function(e,t,n){var r=e[0];if(typeof r=="string"){if(r=="OBJECT")return[t.angle,e[1],e[2]];if(r.indexOf("ARG")==0)return[t[r.toLowerCase()],e[1],e[2]];if(r.indexOf("PARAM")==0)return[n.params[parseInt(r.substring(5))-1],e[1],e[2]]}return[r*Math.PI/180,e[1],e[2]]},checkProceedAnimation:function(e,t){if(!e.frameDuration&&this.frames.length>0){var n=this.frames[e.frame].duration;e.frameDuration=n&&n.constructor===Array?n[Math.floor(Math.random()*n.length)]:n}if(e.frameDuration&&(e.frameDuration<=1e3*this.game.frameTimeS||this.game.currentTime>=e.lastAnimationTime+e.frameDuration)){e.frame++,e.frameDuration=null;if(e.frame>=this.frames.length){e.frame=this.options.looping?0:this.frames.length-1;if(this.options.atend&&t&&t(this.options.atend))return}e.lastAnimationTime=this.game.currentTime,e.playedSound=!1}},processParticlesAndEmitters:function(e,t){var n=this.game.renderer;if(!n.hasWebGL())return;if(t.particles){var r=this.game.currentTime,i=this.game.frameTimeS;for(var s=t.particles.length-1;s>=0;s--){var o=t.particles[s],u=r-o.born;if(u>=o.lifetime*1e3){t.particles.splice(s,1),o.template.emitatend&&this.emitParticlesByList(null,t,o.template.emitatend,o.position);continue}o.speed&&(o.position[0]+=Math.cos(o.angle)*o.speed*i,o.position[1]-=Math.sin(o.angle)*o.speed*i),o.zangle!=undefined&&(o.position[2]+=o.zangle*i,o.zangle-=o.template.gravity*i),!o.relative&&o.screenwrap&&(o.position[0]<n.camera.gridX*n.tilesize?o.position[0]+=n.camera.gridW*n.tilesize:o.position[0]>=(n.camera.gridX+n.camera.gridW)*n.tilesize&&(o.position[0]-=n.camera.gridW*n.tilesize),o.position[1]<n.camera.gridY*n.tilesize?o.position[1]+=n.camera.gridH*n.tilesize:o.position[1]>=(n.camera.gridY+n.camera.gridH)*n.tilesize&&(o.position[1]-=n.camera.gridH*n.tilesize)),o.spin&&(o.rotation+=o.spin);for(var a in o.template.effects){var f=o.template.effects[a];if(f.type=="range"&&f.time&&f.time.length==2&&f.value&&f.value.length==2){var l=u-f.time[0]*1e3;if(l>=0){var c=(f.time[1]-f.time[0])*1e3,h=l>=c?1:l/c;o[f.attr]=f.value[0]+(f.value[1]-f.value[0])*h}}}}}this.emitters&&this.processEmitters(e,t,this.emitters),e.emitters&&this.processEmitters(e,t,e.emitters)},processEmitters:function(e,t,n){for(var r in n){var i=n[r];if(i.interval&&(i.quantity>0||i.quantity.constructor===Array)&&i.particles&&i.particles.length>0){var s=this.game.currentTime;(!t.emitterTime[r]||s>=t.emitterTime[r])&&(!i.isskidmark||!(!e.carSkidTime||s>=e.carSkidTime+500))&&(this.emitParticles(e,t,i,i.position),t.emitterTime[r]=s+i.interval*1e3)}}},emitParticlesByList:function(e,t,n,r){if(!this.game.renderer.hasWebGL())return;if(!n)return;if(n.constructor===Array){if(n.length<=0)return;var i;n.length==4&&n[0].constructor===Array?i=n[t.direction]:i=n;for(var s in i)this.emitParticles(e,t,this.emitters[i[s].emitter],i[s].position)}else this.emitParticles(e,t,this.emitters[n],r)},emitParticles:function(e,t,n,r){if(!n)return;if(n.ambient&&this.checkBadAmbient(n.ambient))return;if(!r){r=n.position;if(!r)return}t.particles||(t.particles=[]);var i=["lifetime","alpha","red","green","blue","angle","zangle","gravity","zoom","speed","spin","rotation"],s=this.game.renderer,o=n.quantity&&n.quantity.constructor===Array?n.quantity[0]+Math.floor(Math.random()*(n.quantity[1]-n.quantity[0]+1)):n.quantity;o=Math.min(o,n.limit-t.particles.length);var u=n.reduceonmobile?Math.min(s.camera.gridW*s.tilesize/1024,1)*Math.min(s.camera.gridH*s.tilesize/768,1):1;for(var a=0;a<o;a++){if(u<1&&Math.random()>u)continue;var f=r.slice(0);for(var l=0;l<3;l++)f[l]&&f[l].constructor===Array&&(f[l]=f[l][0]+Math.random()*(f[l][1]-f[l][0]));if(!n.relative&&e){f[0]=="RANDOMSCREENX"?f[0]=(s.camera.gridX+Math.random()*s.camera.gridW)*s.tilesize:f[0]+=Math.floor(e.x)-this.animationOffset.x,f[1]=="RANDOMSCREENY"?f[1]=(s.camera.gridY+Math.random()*s.camera.gridH)*s.tilesize:f[1]+=Math.floor(e.y)-this.animationOffset.y;if(n.tiletypes&&n.tiletypes.indexOf(this.game.mapmanager.currentmap.getTileType(f[0]/s.tilesize,f[1]/s.tilesize))<0)continue}var c=n.particles[Math.floor(Math.random()*n.particles.length)],h={template:c,born:this.game.currentTime,position:f,relative:n.relative,screenwrap:n.screenwrap};for(var l in i){var p=i[l],d=c[p];h[p]=d&&d.constructor===Array?d[0]+Math.random()*(d[1]-d[0]):d}h.rotation===undefined?h.rotation=h.angle:h.rotation=="OBJECT"&&(h.rotation=e.angle),h.red===undefined&&(h.red=1),h.green===undefined&&(h.green=1),h.blue===undefined&&(h.blue=1),t.particles.push(h)}if(n.sound&&(!n.soundchance||Math.random()*100<n.soundchance)){var v=n.sound.constructor===Array?n.sound[Math.floor(Math.random()*n.sound.length)]:n.sound;this.game.sounds.play(v)}t.draworder=n.draworder},drawParticles:function(e,t){var n=this.game.renderer,r=this.game.animationmanager,i=Math.floor(e.x)-this.animationOffset.x,s=Math.floor(e.y)-this.animationOffset.y,o,u=0,a=1,f=t.particles.length-1;t.draworder!="down"&&(u=f,f=0,a=-1);for(var l=u;a>0?l<=f:l>=f;l+=a){var c=t.particles[l],h=n.getImage(r.getGraphic(e,c.template.image,this,t));if(!h)continue;var p=(c.relative?i:0)+c.position[0]-h.image.width/2,d=(c.relative?s:0)+c.position[1]-c.position[2]-h.image.height/2,v=c.zoom!=undefined?[c.zoom,c.zoom]:[1,1],m=[c.rotation,h.image.width/2,h.image.height/2],g=n.context.setColor([c.red,c.green,c.blue,c.alpha]);g&&!o&&(o=g),c.template.mode&&n.context.setBlendMode(c.template.mode),n.context.drawImage(h,p,d,null,v,m)}o&&n.context.setColor(o),n.context.setBlendMode("normal")},getTile:function(e,t){if(!this.isLoaded)return null;var n=this.options.tiletypes;if(!n||!n.tilewidth||e<0||t<0)return null;var r=this.game.renderer,i=Math.floor(e*r.tilesize/n.tilewidth),s=Math.floor(t*r.tilesize/n.tilewidth),o=i+s*Math.floor(n.width/n.tilewidth);return n.data[o]}});return e}),define("animationmanager",["./newanimation"],function(e){var t=Class.extend({init:function(e){this.game=e,this.game.animationmanager=this,this.animations={},this.filemodtimes={},this.weather=null,this.weatherAnimation=null,this.weatherAnimationInfo={},this.defaultAnimation="player_idle",this.codedAnimations=null},loadAnimation:function(t){if(t===undefined)return null;var n=this.animations[t];return!n&&(this.game.client||this.game.isstory)&&(n=new e(this.game,t),this.animations[t]=n,this.loadAnimationFile("animations/"+t+".bani")),n},loadAnimationImages:function(e){for(var t in e.defaults){var n=this.getPathForDefault(t);this.game.renderer.getImage(n+e.defaults[t])}var n=this.getPathForDefault("");for(var r in e.sprites)this.game.renderer.getImage(n+e.sprites[r].gfx)},setPlayerAnis:function(e){this.codedAnimations=e;if(this.game.client)for(var t in this.filemodtimes)this.filemodtimes[t]>0&&this.game.client.sendGetFileModTime(t)},decode:function(e){return e>=1&&this.codedAnimations&&e<this.codedAnimations.length?this.codedAnimations[e]:this.defaultAnimation},getGraphic:function(e,t,n,r){if(!t)return"";var i;switch(t){case"ARMOR":i=e.armor+".png";break;case"BODY":i=this.expandGameFilename("body",e.armor);break;case"SWORD":case"HAMMER":case"SHOVEL":case"WEAPON":i=this.expandGameFilename("sword",e.weaponimage||e.weapon);break;case"BOW":case"MOUNT":case"SHIELD":i=this.expandGameFilename(t.toLowerCase(),e[t.toLowerCase()+"image"]||e[t.toLowerCase()]);break;case"ARG1":case"ARG2":case"ARG3":case"ARG4":case"ARG5":case"ARG6":case"ARG7":case"ARG8":case"ARG9":case"ARROW":case"BALLOON":case"BEACHBALL":case"HAT":case"HEAD":case"HOUSE":case"MASK":case"MOUNT":case"ICON":i=this.expandGameFilename(t.toLowerCase(),e[t.toLowerCase()]);break;default:r&&t.indexOf("PARAM")==0?i=this.expandGameFilename("param",r.params[parseInt(t.substring(5))-1]):i=t.indexOf(".")>=0?t:n?n.defaults[t]:""}return this.getPathForDefault(t)+i},expandGameFilename:function(e,t){return t?t.indexOf(".")>=0?t:!isNaN(t)&&isInt(t)?"bbuilder_"+e+t+".png":(t+=".png",t.indexOf("_")<0&&(t="bbuilder_"+t),t):""},getPathForDefault:function(e){switch(e){case"BODY":return this.game.filespath+"bodies/";case"WEAPON":return this.game.filespath+"swords/";case"ARMOR":case"ARROW":case"BALLOON":case"BEACHBALL":case"BOW":case"EMOTICON":case"HAT":case"HEAD":case"HOUSE":case"MASK":case"MOUNT":case"ICON":case"SHIELD":case"SWORD":return this.game.filespath+e.toLowerCase()+"s/";default:return this.game.filespath+"images/"}},onFileUpdate:function(e,t){var n=this.filemodtimes[e];if(t==n)return;this.filemodtimes[e]=t;var r=e.lastIndexOf("."),i=r>=0?e.substring(r+1):null;switch(i){case"bani":this.loadAnimationFile(e,t);break;case"png":case"gif":case"jpg":case"jpeg":this.game.renderer.loadGraphicFile(e,t)}},requestFileModTime:function(e){var t=this.filemodtimes[e];return t>0?t:this.game.isstory?this.game.getTimeHash():t==-1||!this.game.client?null:(this.filemodtimes[e]=-1,this.game.client.sendGetFileModTime(e),null)},loadAnimationFile:function(e,t){var t=t||this.requestFileModTime(e);if(!t)return;var n=e.substring("animations/".length,e.length-".bani".length),r=this;gui.ajax(this.game.filespath+e+"?t="+t,!0,function(e){var t=r.animations[n];t&&t.initAnimation(e)},function(e,t,r){window.console&&console.log("Loading animation "+n+" failed: "+r)})},setWeather:function(e){if(e==this.weather)return;this.weatherMap=this.game.mapmanager.currentmap,this.weather=e,this.weatherAnimation=null,this.weatherAnimationInfo={emitterTime:{}}},stopWeather:function(){if(!this.weather||this.game.mapmanager.currentmap==this.weatherMap)return;this.weather=null,this.weatherMap=null,this.weatherAnimation=null,this.weatherAnimationInfo={emitterTime:{}}},processWeather:function(){if(!this.weather||this.game.settings.noweather)return;var e=this.loadAnimation(this.weather);if(!e||!e.isLoaded)return;this.weatherAnimation=e,e.processParticlesAndEmitters(this.game.player,this.weatherAnimationInfo)},drawWeather:function(){if(!this.weatherAnimation)return;this.weatherAnimation.drawAnimation(this.game.player,this.weatherAnimationInfo);if(!this.weather&&this.weatherAnimationInfo.particles.length<=0||this.game.settings.noweather)this.weatherAnimation=null,this.weatherAnimationInfo={emitterTime:{}}}});return t}),define("localplayer",["player","newnpc"],function(e,t){var n=e.extend({init:function(t,n,r){e.prototype.init.call(this,t,n,r),this.accelerateCounter=0,this.currentSpeed=7,this.stickDir=this.lastStickKey=-1,this.strafeLock=!1,this.timeouts=[],this.scriptenv={},this.onlinetime=0},setExtendedData:function(t){e.prototype.setExtendedData.call(this,t);for(var n in t)switch(n){case"attachid":this.attachTo(this.attachid);break;case"body":this.game.scriptmanager.runScript(this,this,"bodychange");break;case"bow":this.game.markBombButtonUpdate();break;case"coins":this.game.onPlayerCoinsUpdated(this.coins);break;case"ghost":this.game.checkHideFullGui();break;case"hat":this.game.scriptmanager.runScript(this,this,"hatchange");break;case"mask":this.game.scriptmanager.runScript(this,this,"maskchange");break;case"head":this.game.scriptmanager.runScript(this,this,"headchange");break;case"hotkeys":case"_hotKeySlots":this.game.updateHotkeys();break;case"scriptclasses":this.game.scriptmanager.onScriptChanged(this);break;case"settings":typeof t.settings=="object"&&(this.game.settings=this.settings,this.game.onSettingsChanged(!1));break;case"shield":this.game.scriptmanager.runScript(this,this,"shieldchange")}},onNameUpdated:function(){e.prototype.onNameUpdated.call(this),this.game.shop&&this.game.shop.sendNameUpdated&&this.game.shop.sendNameUpdated(this.name),this.game.showClanChatButton(this.clanname&&this.clanname.length>0),this.game.forEachEntity(function(e){e.clanname&&!(e instanceof t)&&delete e.nameCache}),this.game.scriptmanager.runScript(this,this,"namechange")},setItemData:function(e,t){switch(e){case"bow":this.bowData=t,this.game.markBombButtonUpdate();break;case"weapon":this.weaponData=t,this.weaponMode=this.weaponData,this.lastIdleTime&&(this.lastIdleTime=this.game.currentTime),this.currentAttack&&delete this.currentAttack,this.isDead||(this.animationInfo.isexternal=!1,this.weaponMode.reload&&!this.isInWater()?this.stopAndAnimate(this.weaponMode.reload):this.animateAsPlayer("idle",!1)),this.game.updateHotkeys(),this.game.markBombButtonUpdate();break;case"mount":this.mountData=t,this.animationInfo.isexternal=!1,this.animateAsPlayer("idle",!1),this.mountData||delete this.carLightsOn,this.game.updateCarButtons()}this.checkEquipScript()},checkEquipScript:function(){var e=this.mountData&&this.mountData.scriptclasses&&this.mountData.scriptclasses.length>0?this.mountData:this.weaponData&&this.weaponData.scriptclasses&&this.weaponData.scriptclasses.length>0?this.weaponData:null;if(e&&this.weaponnpc&&this.weaponnpc["itemid"]==e["itemid"])return;this.game.scriptmanager.updateWeaponScript(this,e)},usePrimaryWeapon:function(e){if(this.isFocusOrEffectFrozen())return;if(this.isCar()){this.game.app.weaponpadDown||this.useHornButton();return}if(this.mountData){this.weaponnpc&&this.weaponnpc["itemid"]==this.mountData["itemid"]&&this.game.scriptmanager.runScript(this.weaponnpc,this,"activated",[Types.convertOrientationToDirection(e)]);return}var t=this.game.mapmanager.currentmap;if(t.isBowSpar()&&this.game.app.config.primaryweapon!="gun"){this.useSecondaryWeapon(!0);return}if(this.checkKickBall())return;if(!this.weaponMode)return;switch(this.weaponMode.weapontype){case"gun":this.useGun(e);break;default:this.weaponnpc&&this.weaponnpc["itemid"]==this.weaponData["itemid"]?this.game.scriptmanager.runScript(this.weaponnpc,this,"activated",[Types.convertOrientationToDirection(e)]):this.useSword(e)}},checkKickBall:function(){var e=Types.addOffsetInOrientation(this.gridX+.5,this.gridY+.5,this.dir,.75),n=_.select(this.game.mapmanager.currentmap.getEntitiesAt(e.gridX,e.gridY,1,1),function(e){return e instanceof t&&e.isBall()});if(n.length<=0)return!1;for(var r in n){var i=n[r];i.hasBeenKicked=!0,i.sendTrigger("kick",{angle:-Math.atan2(i.gridY-this.gridY,i.gridX-this.gridX)})}return this.stopAndAnimate("player_punch"),!0},useSword:function(e){e!=this.dir&&(this.dir=e,this.moveprediction||this.resyncMoveXX());var t=this.weaponMode.atk;this.game.app.config.randomatk2&&t=="player_atk"&&Math.random()*100<25&&(t+="2"),this.stopAndAnimate(t),this.attackfreezetime=this.game.currentTime+this.weaponMode.freezetime,this.attackfiretime=this.weaponMode.firetime?this.game.currentTime+this.weaponMode.firetime:this.attackfreezetime,this.game.client&&this.game.client.sendAttack()},useSecondaryWeapon:function(e){if(this.isFocusOrEffectFrozen())return;if(this.weaponnpc&&this.game.scriptmanager.runScript(this.weaponnpc,this,"bombbutton"))return;if(this.useGrab())return;if(this.isCar()){e||this.useLightsButton();return}if(this.weaponMode&&this.weaponMode["weapontype"]=="gun"&&(!this.bow||!this.bowData||this.bowData["weapontype"]!="snowball")){this.reloadGun();return}if(this.game.app.config.alwaysgrab)return;if(this.isInWater()){this.game.showShortMessage(translate("Better use this weapon on land!"));return}var t=this.game.mapmanager.currentmap;if(t.isMeleeSpar()){this.game.showShortMessage(translate("You can only use swords here!"));return}var n=this.bow&&this.bowData?this.bowData.weapontype:"bomb";if(t.isBowSpar()&&n!="bow"){this.game.showShortMessage(translate("You can only use bows here!"));return}switch(n){case"bow":this.useBow();break;case"snowball":this.throwSnowBall();break;case"bomb":this.game.client&&!this.game.app.config.disablebombs&&this.game.client.sendPlaceObject("bomb")}},useGrab:function(){if(!this.game.app.config.enablegrab)return!1;if(this.isFiring())return!1;if(!this.game.mapmanager.currentmap)return!1;if(this.getAnimation()=="player_grab")return!1;if(this.mountData)return!1;if(this.isInWater())return!1;if(this.weaponMode&&this.weaponMode.clip&&this.weaponMode.currentClip<this.weaponMode.clip)return!1;var e=this.game.app.config.primaryweapon=="gun";e&&this.stopAndAnimate("player_grab");var t=this.getGrabNPC();return t?(t.sendTrigger("grab",{}),e||this.stopAndAnimate("player_grab"),!0):e},getGrabNPC:function(){var e=Types.addOffsetInOrientation(this.gridX+.5,this.gridY+.5,this.dir,1),n=this.game.mapmanager.currentmap.getEntitiesAt(e.x,e.y,.5,.5),r=null,i=null;for(var s in n){var o=n[s];if(!(o instanceof t))continue;var u=Math.abs(o.gridX+o.tileWidth/2-e.x)+Math.abs(o.gridY+o.tileHeight/2-e.y);if(!r||u<i)r=o,i=u}return r},showGrabButton:function(){if(this.mountData||this.isInWater())return!1;if(this.weaponMode&&this.weaponMode.clip&&this.weaponMode.currentClip<this.weaponMode.clip)return!1;if(this.game.app.config["primaryweapon"]=="gun")return!0;if(!this.game.app.config.enablegrab)return!1;var e=this.getGrabNPC();return e&&e.currentAnimation&&e.currentAnimation.options&&e.currentAnimation.options.showgrab},useGun:function(e){if(this.isFiring()||!this.weaponMode||!this.weaponMode.projectile||this.weaponMode["projectile"]=="none")return;var t=this.game.mapmanager.currentmap,n=t.projectiles.getTypeInfo(this.weaponMode.projectile);if(!n||t.isSpar()&&n.nospar)return;var r=!1,i=n.ammotype?this.ammocount:this.arrows;if(!this.game.app.config.unlimitedammo&&!t.isBowSpar()&&!this.ammoend&&!this.weaponMode.usecount){if(!i||i<=0){this.game.showShortMessage(translate("You are out of bullets!<br>Get some ammo at shops!"));return}r=!0}var s=this.weaponMode.projectilenr?this.weaponMode.projectilenr:1;r&&s>i&&(s=i);if(this.weaponMode.clip){this.weaponMode.currentClip===undefined&&(this.weaponMode.currentClip=this.weaponMode.clip),this.weaponMode.currentClip-=s;if(this.weaponMode.currentClip<0){this.reloadGun();return}this.showCurrentClip(),this.game.markBombButtonUpdate()}r&&(n.ammotype?this.ammocount-=s:this.arrows-=s),e!=this.dir&&(this.dir=e,this.moveprediction||this.resyncMoveXX());var o=this.getActiveAttack();this.stopAndAnimate(o.atk),this.attackfreezetime=this.game.currentTime+o.freezetime,this.attackfiretime=o.firetime?this.game.currentTime+o.firetime:this.attackfreezetime,this.game.storymanager.addRecordAction("shoot",o.projectile);if(o.burstmode&&o.burstmode.length>=1)for(var u=0;u<o.burstmode.length;u++)this.shootBurstProjectiles(o.burstmode[u],e,o);else if(o.firedelay&&o.firedelay>0){var a=o,f=this;setTimeout(function(){f.shootGunProjectiles(s,e,o)},o.firedelay)}else this.shootGunProjectiles(s,e,o)},getActiveAttack:function(){if(!this.weaponMode)return null;var e=this.weaponMode.attacks;if(!e||e.length<=0)return this.weaponMode;this.currentAttack=this.currentAttack?this.currentAttack+1:1;var t=e[(this.currentAttack-1)%e.length],n={};for(var r in this.weaponMode)n[r]=this.weaponMode[r];for(var r in t)n[r]=t[r];return n},shootBurstProjectiles:function(e,t,n){if(!e.delay||parseInt(e.delay)<=0){this.shootGunProjectiles(parseInt(e.projectilenr),t,n);return}var r=this;setTimeout(function(){e&&n&&r.shootGunProjectiles(parseInt(e.projectilenr),t,n)},parseInt(e.delay))},shootGunProjectiles:function(e,t,n,r,i){var s=Types.convertOrientationToDirection(t),o=i||n.offset[s];for(var u=0;u<e;u++){var a=r!==undefined?r:(this.game.app.config.enable360projectiles&&this.game.app.weaponpadAngle!==undefined?this.game.app.weaponpadAngle:Types.orientationToAngle(t))+(Math.random()-.5)*n.spread;this.game.mapmanager.currentmap.projectiles.createProjectile(this.id,n.projectile,this.gridX+.5+o[0],this.gridY+.5+o[1],n.z||.3,a,0,!0)}},shootProjectilesForItem:function(e,t,n){if(!e||!this.game.mapmanager.currentmap)return;switch(e.weapontype){case"bow":this.shootBowProjectile(e);break;case"gun":case"mount":this.shootGunProjectiles(e.projectilenr?e.projectilenr:1,this.dir,e,t,n)}},reloadGun:function(){if(this.mountData)return;if(this.isFiring())return;if(!this.weaponMode||!this.weaponMode.clip||this.weaponMode.currentClip===undefined)return;if(this.weaponMode.currentClip>=this.weaponMode.clip){this.showCurrentClip();return}this.weaponMode.reload&&this.stopAndAnimate(this.weaponMode.reload),this.attackfreezetime=this.game.currentTime+this.weaponMode.reloadtime,this.attackreloadtime=this.attackfreezetime,this.attackfiretime=this.attackfreezetime,this.weaponMode.currentClip=this.weaponMode.clip,this.showCurrentClip(),this.game.storymanager.addRecordAction("reload"),this.game.markBombButtonUpdate()},showCurrentClip:function(){if(!this.weaponMode||!this.weaponMode.clip||this.weaponMode.currentClip===undefined)return;this.damageInfoClip&&this.damageInfoClip.destroy();var e=this.weaponMode.currentClip+"/"+this.weaponMode.clip,t=this.game.mapmanager.currentmap.projectiles.getTypeInfo(this.weaponMode.projectile);!this.ammoend&&t&&t.ammotype&&(e+=" ("+(this.ammocount||0)+")"),this.damageInfoClip=this.game.infoManager.addDamageInfo(e,this.x+8,this.y-32-(this.isOnMount()?32:0),this.weaponMode.currentClip>=this.weaponMode.clip?"healed":"#ffe080")},useBow:function(){if(this.isFreezing())return;if(this.mountData&&this.mountData.mounttype&&this.mountData["mounttype"]=="sled")return;var e=this.game.mapmanager.currentmap;if(!e.isBowSpar()&&!this.ammoend){if(!this.arrows||this.arrows<=0){this.game.showShortMessage(translate("You are out of arrows!<br>Pick some up or buy them in shop!"));return}this.arrows--,this.game.infoManager.addDamageInfo(this.arrows,this.x+8,this.y-32-(this.isOnMount()?32:0),"#ffe080")}this.shootBowProjectile(this.bowData)},shootBowProjectile:function(e){var t=this.game.mapmanager.currentmap,n=e&&e.projectile?e.projectile:"arrow",r=t.projectiles.getTypeInfo(n);r&&(this.arrow=r.arrow),this.shoot(n);var i=this;setTimeout(function(){t.projectiles.createProjectile(i.id,n,i.gridX+.5,i.gridY+.5,.3+(i.isOnMount()?1:0),Types.orientationToAngle(i.dir),0,!0)},450)},shoot:function(e){var t=this.mountData&&this.mountData.bow?this.mountData.bow:this.bowData&&this.bowData.atk?this.bowData.atk:"bow_atk";this.stopAndAnimate(t),this.attackfreezetime=this.game.currentTime+500,this.attackfiretime=this.attackfreezetime,this.game.storymanager.addRecordAction("shoot",e)},throwSnowBall:function(){var e=this.game.mapmanager.currentmap;if(this.isFreezing()||!e||e.isSpar())return;if(this.game.animationmanager.weather!="weather_snow"&&e.mapname.indexOf("playerland_")!=0&&e.mapname.indexOf("clanland_")!=0){this.game.showShortMessage(translate("You can only use it near snow!"));return}this.stopAndAnimate("player_throw"),this.attackfreezetime=this.game.currentTime+500,this.attackfiretime=this.attackfreezetime;var t=this.bowData&&this.bowData.projectile?this.bowData.projectile:this.bowData&&this.bowData.atk?this.bowData.atk:"snowball",n=this;setTimeout(function(){var e=n.gridX+(n.dir==Types.Orientations.DOWN||n.dir==Types.Orientations.RIGHT?0:.5);n.game.mapmanager.currentmap.projectiles.createProjectile(n.id,t,e,n.gridY+.5,.3,Types.orientationToAngle(n.dir),0,!0)},400)},activateNPCs:function(e,n,r){if(!r&&this.mountData)return;if(!this.weaponMode)return;n||(n=this.weaponMode.weapontype);if(n=="script")return;var i=this.weaponMode.radius?this.weaponMode.radius:0,s={x:this.gridX+.5,y:this.gridY+.5};if(this.weaponMode.offset){var o=Types.convertOrientationToDirection(e);s.x+=this.weaponMode.offset[o][0],s.y+=this.weaponMode.offset[o][1]}else s=Types.addOffsetInOrientation(s.x,s.y,e,1);var u=this.game.mapmanager.currentmap.getEntitiesAt(s.x,s.y,i,i);for(var a in u){var f=u[a];if(f instanceof t){f.onActivate(n);if(n=="trashpick")return}}},setMaxHitPoints:function(e,t){this.maxHitPoints=e,t&&(this.hitPoints=e),this.showHitPoints={points:this.hitPoints/this.maxHitPoints,time:this.game.currentTime,isRegen:!0},this.showHealthBar()},onDeath:function(e){this.hideChat(),this.stopAndAnimate("player_death3");var t=this;setTimeout(function(){t.game.playerdeath_callback(e)},1e3)},hideChat:function(){this.showChat(""),this.game.client&&this.game.client.sendChat("")},canSetAnimation:function(){return this.game.started&&!this.isDead&&!this.ghostBlocked()&&!this.isFreezing()},checkMovement:function(){this.chat&&this.chat.length>0&&!this.emoticonfile&&this.chathidetime&&this.game.currentTime>=this.chathidetime&&(this.hideChat(),this.chat="");if(!this.game.started||this.isDead||this.isFreezing())return;if(this.hurtendtime&&this.game.currentTime<this.hurtendtime)return;this.keepInAttachBounds();if(this.freezeUntilSpar&&this.game.mapmanager.currentmap.isSpar())return;if(this.isFocusOrEffectFrozen())return;if(this.ghostBlocked()){this.moveGhost();return}if(this.weaponMode&&this.weaponMode.controlsmovement)return;var e=this.isCar();if(e){var t=this.game.app.movepadDown&&this.game.app.movepadVector.x!=0,n=this.game.app.weaponpadDown||this.game.app.itemkeyDown;if(t||n){var r={x:t?this.game.app.movepadVector.x:0,y:this.game.app.itemkeyDown?1:n?-1:0};if(this.moveWithVector(r,this.die2(r.y<0,r.y>0)))return}}else{var r=this.game.app.movepadVector;if(this.game.app.movepadDown&&this.moveWithVector(r,this.die2(r.x!=0||r.y!=0,r.y>0)))return}if(this.game.app.keyPressedAny){var i=this.moveKeys;this.moveKeys=this.getMoveKeys(),this.checkStickKeys(this.moveKeys,i);var r={x:this.moveKeys[3]-this.moveKeys[1],y:this.moveKeys[2]-this.moveKeys[0]};e&&this.game.app.itemkeyDown&&(r.y=1);if((r.x!=0||r.y!=0)&&this.moveWithVector(r,this.die2(e?r.y<0:!0,r.y>0)))return}else this.moveKeys=null,this.stickDir=-1;if(this.accelerateCounter>0&&e&&this.moveWithVector({x:0,y:-1},this.die2(!1,!1)))return;if(this.iceVector){if(this.tileType==Types.TileTypes.ICE&&this.iceVector[2]>=.05&&this.moveWithVector({x:this.iceVector[0],y:this.iceVector[1]},this.iceVector[2]*.98,!0))return;this.iceVector=null}if(this.stickDir>=0&&this.dir!=this.stickDir&&!this.game.app.keyAction.Strafe&&!this.strafeLock)this.setOrientation(this.stickDir),this.stopAndAnimate("idle");else{var s=this.getAnimation();(!s||s.indexOf("walk")>=0||s.indexOf("hurt")>=0)&&this.stopAndAnimate("idle")}},getMoveKeys:function(){return[this.game.app.keyAction.MoveUp||this.game.app.keyAction.MoveUp2?1:0,this.game.app.keyAction.MoveLeft||this.game.app.keyAction.MoveLeft2?1:0,this.game.app.keyAction.MoveDown||this.game.app.keyAction.MoveDown2?1:0,this.game.app.keyAction.MoveRight||this.game.app.keyAction.MoveRight2?1:0]},checkStickKeys:function(e,t){if(this.isCar()){this.stickDir=-1;return}if(""+e==""+t)return;for(var n=0;n<4;n++)e[n]&&(this.stickDir=Types.convertDirectionToOrientation(n))},isCar:function(){return this.mountData&&this.mountData.mounttype&&this.mountData["mounttype"]=="car"},moveWithVector:function(e,t,n){this.currentSpeed=t;if(this.currentSpeed==0&&e.x==0)return this.iceVector=null,!1;this.effect&&this.effect["type"]=="inverse"&&(e={x:-e.x,y:-e.y});var r=this.angle,i;if(this.isCar()){var s=Math.PI/1.5*this.game.frameTimeS;e.x<0?(this.angle+=s,this.angle>Math.PI*2&&(this.angle-=Math.PI*2)):e.x>0&&(this.angle-=s,this.angle<0&&(this.angle+=Math.PI*2)),this.angle!=r&&(this.carSkidTime=this.game.currentTime),e.y!=0||this.currentSpeed!=0?i=this.moveAndCollide(Math.cos(this.angle)*this.currentSpeed*this.game.frameTimeS,-Math.sin(this.angle)*this.currentSpeed*this.game.frameTimeS):i={gridX:this.gridX,gridY:this.gridY,dir:this.getOrientationForAngle()}}else{if(!n&&this.tileType==Types.TileTypes.ICE&&this.iceVector){e.x+=this.iceVector[0]*5,e.y+=this.iceVector[1]*5;var o=Math.sqrt(e.x*e.x+e.y*e.y);e.x/=o,e.y/=o}i=this.moveAndCollide(e.x*this.currentSpeed*this.game.frameTimeS,e.y*this.currentSpeed*this.game.frameTimeS),this.angle=0;if(this.game.app.config.enablesleep)for(var u in this.collidedNPCs)this.collidedNPCs[u].isBed()&&(i.gridY=this.collidedNPCs[u].gridY+.5)}this.game.app.weaponpadDown?i.dir=this.game.app.weaponpadDirection:this.game.app.keyAction.Strafe||this.strafeLock?i.dir=this.dir:this.stickDir>=0&&(i.dir=this.stickDir);if(i.gridX==this.gridX&&i.gridY==this.gridY&&i.dir==this.dir)return this.angle!=r&&(this.setOrientation(i.dir),this.game.client&&this.game.client.sendMoveXX(this.dir,this.gridX,this.gridY,this.z,this.getAnimation(!0),0,0,this.angle)),this.stopAndAnimate("idle"),this.doOnTouchEvents(),!0;var a={x:i.gridX-this.gridX,y:i.gridY-this.gridY};return this.setGridPosition(i.gridX,i.gridY),this.updateAttachPosition(),this.setOrientation(i.dir),this.animate(n?"idle":"walk",!1),this.sendMoveWithPrediction(a,this.isCar(),n),this.iceVector=[e.x,e.y,this.currentSpeed],this.doOnTouchEvents(),this.onHasMoved(),this.game.hideMovementHelp(),!0},sendMoveWithPrediction:function(e,t,n){var r=!0;this.moveprediction&&--this.moveprediction.frames>0&&(t||Math.abs(this.moveprediction.x-e.x)<=1/32&&Math.abs(this.moveprediction.y-e.y)<=1/32)&&(r=!1);if(!r)return;var i=250,s=i/this.game.frameTimeS/1e3;if(s<=1)return;var o=this.getAnimation(),u=o&&o.indexOf("player_")==0&&!n;this.game.client&&this.game.client.sendMoveXX(this.dir,this.gridX+s*e.x,this.gridY+s*e.y,this.z,this.getAnimation(!0),(u?Types.AnimationFlags.DEFAULTANIS:0)|Types.AnimationFlags.PREDICT,i,this.angle),this.moveprediction={frames:s,x:e.x,y:e.y}},die2:function(e,t){var n=7;if(this.mountData&&this.mountData.speed){var r=this.isCar();e?(this.accelerateCounter<=0&&(this.carSkidTime=this.game.currentTime),this.accelerateCounter++,r?n=this.mountData.acceleration*this.accelerateCounter*this.game.frameTimeS:n+=2*this.accelerateCounter*this.game.frameTimeS,n>this.mountData.speed&&(n=this.mountData.speed,this.accelerateCounter--)):r&&(this.accelerateCounter-=t?2:1,this.accelerateCounter<=0?(this.accelerateCounter=0,n=t?-4:0):(n=this.mountData.acceleration*this.accelerateCounter*this.game.frameTimeS,this.carSkidTime=this.game.currentTime))}else this.weaponMode&&this.weaponMode.speed&&(n=Math.max(1,Math.min(this.weaponMode.speed,50)));return this.effect&&this.effect["type"]=="speed"&&this.effect.params.factor&&(n*=this.effect.params.factor),n},stopAndAnimate:function(e){this.accelerateCounter=0;var t=this.getAnimation();this.game.app.config.idlepose&&t&&e=="idle"&&this.weaponMode&&this.weaponMode["weapontype"]=="sword"&&this.weaponMode["itemid"]!="fist"&&!this.isOnMount()?t.indexOf("_idle")<0||!this.lastIdleTime?this.lastIdleTime=this.game.currentTime:this.game.currentTime>=this.lastIdleTime+this.game.app.config.idleposetime*1e3&&!this.isInWater()&&(e=this.game.app.config.idlepose):this.lastIdleTime&&(this.lastIdleTime=this.game.currentTime),e=="idle"&&t&&t.indexOf("hurt")>=0&&this.game.currentTime<this.hurtendtime+1e3||this.animate(e,!this.moveprediction),this.moveprediction&&this.resyncMoveXX()},resyncMoveXX:function(){this.moveprediction=null,this.game&&this.game.client&&this.game.client.sendMoveXX(this.dir,this.gridX,this.gridY,this.z,this.getAnimation(!0),0,0,this.angle)},doOnTouchEvents:function(){for(var e in this.collidedNPCs)this.collidedNPCs[e].onTouch(!0);this.collidedNPCs=[]},moveAndCollide:function(e,t){this.collidedNPCs=[];var n=(this.game.mapmanager.currentmap.getFirstLayerTileSize()-1)/this.game.renderer.tilesize,r={gridX:this.gridX,gridY:this.gridY,dir:this.dir};if(e!=0){r.dir=e>=0?Types.Orientations.RIGHT:Types.Orientations.LEFT;var i=Math.abs(e);if(i<=n)r.gridX+=e,this.moveAndCollideOneDir(r);else for(var s=0;s<i;s+=n){r.gridX+=(s+n>=i?i-s:n)*(e>0?1:-1);var o=this.moveAndCollideOneDir(r);if(o.collision){this.isCar()&&(this.accelerateCounter=0);break}}}if(t!=0){r.dir=t>=0?Types.Orientations.DOWN:Types.Orientations.UP;var i=Math.abs(t);if(i<=n)r.gridY+=t,this.moveAndCollideOneDir(r);else for(var s=0;s<i;s+=n){r.gridY+=(s+n>=i?i-s:n)*(t>0?1:-1);var o=this.moveAndCollideOneDir(r);if(o.collision){this.isCar()&&(this.accelerateCounter=0);break}}}return this.mountData&&this.mountData.mounttype&&this.mountData["mounttype"]=="car"?r.dir=this.getOrientationForAngle():r.dir=this.getOrientationToPos(this.gridX+e,this.gridY+t),r},moveAndCollideOneDir:function(e){var n=Types.addOffsetInOrientation(e.gridX+.5,e.gridY+.5,e.dir,.5),r=this.getAttachedToObject();r&&(n.gridX=Math.floor(n.x-r.gridX%1)+r.gridX%1,n.gridY=Math.floor(n.y-r.gridY%1)+r.gridY%1);var i=this.getCollisionX(n.x,n.y);i.entity&&i.entity instanceof t&&this.collidedNPCs.indexOf(i.entity)<0&&this.collidedNPCs.push(i.entity);var s=this.game.renderer.tilesize/Math.min(this.game.mapmanager.getMapTileSize(),this.game.renderer.tilesize);if(i.collision){if(i.type=="tile"||i.type=="border"){Types.orientationIsHorizontal(e.dir)?e.gridX=Math.floor(n.x*s)/s+(e.dir==Types.Orientations.LEFT?1/s:-1):e.gridY=Math.floor(n.y*s)/s+(e.dir==Types.Orientations.UP?1/s:-1);if(i.entity)switch(e.dir){case Types.Orientations.UP:e.gridY=Math.max(e.gridY,Math.min(i.entity.gridY+i.entity.tileHeight,this.gridY));break;case Types.Orientations.LEFT:e.gridX=Math.max(e.gridX,Math.min(i.entity.gridX+i.entity.tileWidth,this.gridX));break;case Types.Orientations.DOWN:e.gridY=Math.min(e.gridY,Math.max(this.gridY,i.entity.gridY-1));break;case Types.Orientations.RIGHT:e.gridX=Math.min(e.gridX,Math.max(this.gridX,i.entity.gridX-1))}}else if(i.entity)switch(e.dir){case Types.Orientations.UP:e.gridY=Math.min(i.entity.gridY+i.entity.tileHeight,this.gridY);break;case Types.Orientations.LEFT:e.gridX=Math.min(i.entity.gridX+i.entity.tileWidth,this.gridX);break;case Types.Orientations.DOWN:e.gridY=Math.max(this.gridY,i.entity.gridY-1);break;case Types.Orientations.RIGHT:e.gridX=Math.max(this.gridX,i.entity.gridX-1)}}else{var o=Types.addOffsetInOrientation(n.x,n.y,Types.orientationLeft(e.dir),.5),u=Types.addOffsetInOrientation(n.x,n.y,Types.orientationRight(e.dir),.5);r&&(o.gridX=Math.floor(o.x-r.gridX%1)+r.gridX%1,o.gridY=Math.floor(o.y-r.gridY%1)+r.gridY%1,u.gridX=Math.floor(u.x-r.gridX%1)+r.gridX%1,u.gridY=Math.floor(u.y-r.gridY%1)+r.gridY%1);var a,f;if(Math.floor(o.x*s)!=Math.floor(n.x*s)||Math.floor(o.y*s)!=Math.floor(n.y*s))a=this.getCollisionX(o.x,o.y).collision;if(Math.floor(u.x*s)!=Math.floor(n.x*s)||Math.floor(u.y*s)!=Math.floor(n.y*s))f=this.getCollisionX(u.x,u.y).collision;a?Types.orientationIsHorizontal(e.dir)?e.gridY=e.dir==Types.Orientations.RIGHT?Math.ceil(o.y*s)/s:Math.floor(o.y*s)/s-1:e.gridX=e.dir==Types.Orientations.UP?Math.ceil(o.x*s)/s:Math.floor(o.x*s)/s-1:f&&(Types.orientationIsHorizontal(e.dir)?e.gridY=e.dir==Types.Orientations.RIGHT?Math.floor(u.y*s)/s-1:Math.ceil(u.y*s)/s:e.gridX=e.dir==Types.Orientations.UP?Math.floor(u.x*s)/s-1:Math.ceil(u.x*s)/s)}return i},moveGhost:function(){if(this.game.startedIdentify)return;if(!this.ghostPos||this.ghostPos.map!=this.game.mapmanager.currentmap){this.ghostPos={map:this.game.mapmanager.currentmap,startX:this.gridX,startY:this.gridY,startTime:this.game.currentTime};return}var e=15,t={gridX:this.ghostPos.startX+Math.sin((this.game.currentTime-this.ghostPos.startTime)/3e3)*e,gridY:this.ghostPos.startY},n={x:t.gridX-this.gridX,y:t.gridY-this.gridY};this.setGridPosition(t.gridX,t.gridY),this.sendMoveWithPrediction(n,!0)},getCollisionX:function(e,t){var n=this.getAttachedToObject();if(n){var r=this.game.renderer.tilesize,i=(Math.floor(e)-n.gridX)*r,s=(Math.floor(t)-n.gridY)*r,o=n.getImageSize();return{collision:i<0||i>=o.width||s<0||s>=o.height}}return this.game.mapmanager.currentmap.getCollisionX(e,t)},keepInAttachBounds:function(){var e=this.getAttachedToObject();if(!e)return;var t=this.game.renderer.tilesize,n=(this.gridX-e.gridX)*t,r=(this.gridY-e.gridY)*t,i=e.getImageSize();n>i.width-this.tileWidth*t&&(this.attachInfo.gridX=i.width/t-this.tileWidth),n<0&&(this.attachInfo.gridX=0),r>i.height-this.tileHeight*t&&(this.attachInfo.gridY=i.height/t-this.tileHeight),r<0&&(this.attachInfo.gridY=0)},onAnimationChanged:function(e){e&&this.game&&this.game.client&&this.game.client.sendAni(this.getAnimation(!0)),this.game&&this.game.storymanager.recording&&this.game.storymanager.recording.state&&delete this.game.storymanager.recording.state.ani},ghostBlocked:function(){return this.ghost&&!this.ghostcanplay},checkBeingHurt:function(e){if(!e||this.ghostBlocked()||this.isDead)return;if(this.getAnimation()=="player_snow"&&e.weapon=="torch"){this.isFreezing()&&this.unfreeze(),this.stopAndAnimate("idle");return}if(this.isEventAdmin())return;if(this.game.currentTime<this.hurtendtime)return;if(this.isFocusOrEffectFrozen())return;e.attackfiretime=this.game.currentTime+250;var t=this.game.renderer.tilesize;if(!this.ch(e,{shape:"circle",center:Types.addOffsetInOrientation(t/2,t/2,e.dir,t),radius:t*1.25}))return;this.game.client.sendHurt(e),this.bounceByHurt(e)},bounceByHurt:function(e){if(!this.ispvp)return;var t=this.game.mapmanager.currentmap;if(!t)return;if(this.game.app&&this.game.app.config.primaryweapon=="gun"){var n=e.currentAnimation&&e.currentAnimation.options?e.currentAnimation.options.attackbounce:!1;if(!n)return}else if(t.isHouseInside())return;var r=250,i=this.getHurtAni(),s=Math.random()*.75;if(s<.25)this.setAnimation(i,!0);else{var o=this.gridX-e.gridX,u=this.gridY-e.gridY,a=Math.sqrt(o*o+u*u);a<=0&&(a=1);var f=this.moveAndCollide(o*s/a,u*s/a);this.moveXX(this.dir,f.gridX,f.gridY,this.z,i,Types.AnimationFlags.PREDICT,r,this.angle,this.attachInfo&&this.attachInfo.object?attachInfo.object.id:null,this.attachInfo?this.attachInfo.gridX:0,this.attachInfo?this.attachInfo.gridY:0),this.game.client&&this.game.client.sendMoveXX(this.dir,f.gridX,f.gridY,this.z,i,Types.AnimationFlags.PREDICT,r,this.angle)}this.attackfreezetime=null,this.attackfiretime=null,this.hurtendtime=this.game.currentTime+r,this.game.sounds.play("hurt"),this.doOnTouchEvents()},updateHitPoints:function(e,t,n){if(this.isDead)return;var r=e<this.hitPoints,i=e-this.hitPoints;this.hitPoints=e,this.hitPoints<=0&&this.die(n),this.showHitPoints={points:this.hitPoints/this.maxHitPoints,time:this.game.currentTime,isRegen:t},this.showHealthBar();var s=this.y-(this.zoom>1?80:32);r?(this.game.infoManager.addDamageInfo(i,this.x,s,"received"),this.setHurt()):!t&&i!=0&&this.game.infoManager.addDamageInfo("+"+i,this.x,s,"healed")},showHealthBar:function(){var e=gui.getDom("hitpoints");if(!e)return;gui.fadeIn("healthbar",200);var t=this.game.app.config.enablenewgui,n=gui.getWidth("healthbar")-gui.getPosition(e).left-(t?2:4),r=Math.round(n/this.maxHitPoints*(this.hitPoints>0?this.hitPoints:0));e.style.width=r+"px",this.healthbarTimeout&&clearTimeout(this.healthbarTimeout),this.healthbarTimeout=setTimeout(function(){gui.fadeOut("healthbar")},3e3)},setHurt:function(){if(this.getAnimation()&&this.getAnimation().indexOf("hurt")>=0)return;this.game.sounds.play("hurt");if(this.isHittingAnimation()||this.isDead)return;this.setAnimation(this.getHurtAni(),!0),this.hurtendtime=this.game.currentTime+(this.game.app.config.primaryweapon=="gun"?0:250)},getHurtAni:function(){return this.mountData&&this.mountData.hurt?this.mountData.hurt:this.weaponMode&&this.weaponMode.hurt?this.weaponMode.hurt:"player_hurt"},setSnowFrozen:function(){if(this.stealth)return;this.setAnimation("player_snow",!0),this.hurtendtime=this.game.currentTime+2500,this.attackfreezetime=this.hurtendtime,this.attackfiretime=this.attackfreezetime},unfreeze:function(){this.attackfreezetime=this.attackfiretime=this.hurtendtime=null},useLightsButton:function(){if(!this.isCar())return;this.carLightsOn=!this.carLightsOn,this.game.updateCarButtons(),this.getAnimation()&&this.getAnimation().indexOf("_horn")>=0&&this.stopAndAnimate("idle")},useHornButton:function(){if(!this.isCar())return;if(this.accelerateCounter>0)this.carHornTime=this.game.currentTime+500;else{var e="horn";this.carLightsOn&&this.mountData[e+"_lights"]&&(e+="_lights"),this.mountData[e]&&this.stopAndAnimate(this.mountData[e])}},useMode2Button:function(){if(!this.weaponData||!this.weaponData.mode2)return;if(this.weaponMode==this.weaponData){var e={};for(var t in this.weaponData)e[t]=this.weaponData[t];for(var t in this.weaponData.mode2)e[t]=this.weaponData.mode2[t];this.weaponMode=e}else this.weaponMode=this.weaponData;this.game.markBombButtonUpdate(),this.stopAndAnimate("idle")},onHasMoved:function(){e.prototype.onHasMoved.call(this),this.chathidetime||(this.chathidetime=this.game.currentTime+15e3),this.focus&&this.focusType=="sit"&&this.getAnimation()&&this.getAnimation().indexOf("sit")<0&&delete this.focus,this.game.mapmanager.currentmap&&this.game.mapmanager.currentmap.checkLoadZone(),this.game.app.config.enablegrab&&this.game.markBombButtonUpdate()},attachTo:function(t){return e.prototype.attachTo.call(this,t)?(this.attachInfo?this.game.showShipControls():this.game.hideShipControls(),this.resyncMoveXX(),!0):!1},allowClickWarp:function(){if(this.game.disableClickWarp)return!1;var e=this.game.mapmanager.currentmap;return this.isGameAdmin()||this.isEventAdmin()||e&&e.mapname.indexOf("playerland_")==0},isFocusOrEffectFrozen:function(){return this.focus&&this.focusType=="freeze"?!0:this.effect&&this.effect["type"]=="freeze"?!0:!1},setFocus:function(e,t){t?(this.focusType=e,this.focus={x:t.x*this.game.renderer.tilesize,y:t.y*this.game.renderer.tilesize},this.currentFocus=this.focus):(delete this.focus,delete this.currentFocus)},getFocus:function(){if(!this.focus)return this;if(this.game.mapmanager.currentmap.isSpar()&&this.focusType=="sit"){var e=this.focus,t=this.game.renderer,n=this.findSparrers();if(n.length>=2){var r=(n[0].x+n[1].x)/2,i=(n[0].y+n[1].y)/2,s=Math.abs(this.focus.x-r),o=Math.abs(this.focus.y-i);if(s>=t.camera.gridW*t.tilesize/3||o>=t.camera.gridH*t.tilesize/3)e={x:r,y:i}}var s=e.x-this.currentFocus.x,o=e.y-this.currentFocus.y;if(s!=0||o!=0){var u=Math.sqrt(s*s+o*o),a=16;u>a&&(s*=a/u,o*=a/u),this.currentFocus={x:this.currentFocus.x+s,y:this.currentFocus.y+o}}}return this.currentFocus},findSparrers:function(){var e=[],t=[];for(var n in this.game.players){var r=this.game.players[n];if(!r)continue;var i=Math.abs(this.focus.x-r.x),s=Math.abs(this.focus.y-r.y),o=Math.sqrt(i*s+s*s);e.length>=1&&o<t[0]?(e.splice(0,0,r),t.splice(0,0,o)):e.length>=2&&o<t[1]?(e.splice(1,0,r),t.splice(1,0,o)):e.length<2&&(e.push(r),t.push(o))}return e.slice(0,2)},handleTeleport:function(e){e=="spar"&&this.game.mapmanager.currentmap.isSpar()?this.freezeUntilSpar=!0:this.freezeUntilSpar&&(this.freezeUntilSpar=!1),this.resyncMoveXX()},addScreenShake:function(e,t){if(!t||!t.distance||!t.strength||!e||!this.isInRectangle({x:e.gridX+e.tileWidth/2-t.distance,y:e.gridY+e.tileHeight/2-t.distance,w:t.distance*2,h:t.distance*2})||this.screenshake&&t.strength<this.screenshake.strength)return;this.setScreenShake(t.strength,t.duration)},setScreenShake:function(e,t){if(!e||!t)return;this.screenshake={dx:0,dy:0,strength:e,duration:t,start:this.game.currentTime}},processScreenShake:function(){if(!this.screenshake)return;if(this.game.currentTime>=this.screenshake.start+this.screenshake.duration){this.screenshake=null;return}this.screenshake.dx=(2*Math.random()-1)*this.screenshake.strength,this.screenshake.dy=(2*Math.random()-1)*this.screenshake.strength},getScriptObject:function(){if(!this.scriptObject){var e=this;this.scriptObject={get type(){return"player"},get id(){return e.userid},get networkid(){return e.id},get map(){return e.game.mapmanager.currentmap.getScriptObject()},get hp(){return e.hitPoints},get maxhp(){return e.maxHitPoints},getsettings:function(){return e.game.settings},get adminlevel(){return e.adminlevel},get name(){return e.name},toString:function(){return e.name},get clanname(){return e.clanname},get namecolor(){return e.namecolor},set namecolor(t){e.namecolor=t,delete e.nameCache},get chat(){return e.chat},set chat(t){e.chat=t,e.showChat(t)},get color(){return e.color&&e.color instanceof Array?e.color.slice(0):[1,1,1,1]},set color(t){t instanceof Array&&t.length==4&&(e.color=t)},get weapon(){return e.weapon},get weaponimage(){return e.game.animationmanager.getGraphic(e,"WEAPON")},get weapondata(){return e.weaponMode},get body(){return e.armor},get bodyimage(){return e.game.animationmanager.getGraphic(e,"BODY")},get head(){return e.head},get headimage(){return e.game.animationmanager.getGraphic(e,"HEAD")},get hat(){return e.hat},get hatimage(){return e.game.animationmanager.getGraphic(e,"HAT")},get mask(){return e.mask},get maskimage(){return e.game.animationmanager.getGraphic(e,"MASK")},get bow(){return e.bow},get bowimage(){return e.game.animationmanager.getGraphic(e,"BOW")},get bowdata(){return e.bowData},get mount(){return e.mount},get mountimage(){return e.game.animationmanager.getGraphic(e,"MOUNT")},get mountdata(){return e.mountData},get shield(){return e.shield},get shieldimage(){return e.game.animationmanager.getGraphic(e,"SHIELD")},get title(){return e.title},get titlecolor(){return e.titlecolor},get ani(){return e.getAnimation(!0)},set ani(e){this.setani(e)},setani:function(t){arguments.length>1&&(t+=","+Array.prototype.slice.call(arguments,1)),e.accelerateCounter=0,e.setAnimation(t,!0),e.moveprediction&&e.resyncMoveXX()},get aniarg1(){return e.arg1},set aniarg1(e){this.setaniarg(1,e)},get aniarg2(){return e.arg2},set aniarg2(e){this.setaniarg(2,e)},get aniarg3(){return e.arg3},set aniarg3(e){this.setaniarg(3,e)},get aniarg4(){return e.arg4},set aniarg4(e){this.setaniarg(4,e)},get aniarg5(){return e.arg5},set aniarg5(e){this.setaniarg(5,e)},get aniarg6(){return e.arg6},set aniarg6(e){this.setaniarg(6,e)},get aniarg7(){return e.arg7},set aniarg7(e){this.setaniarg(7,e)},get aniarg8(){return e.arg8},set aniarg8(e){this.setaniarg(8,e)},get aniarg9(){return e.arg9},set aniarg9(e){this.setaniarg(9,e)},setaniarg:function(t,n){if(isInt(t)&&t>=1&&t<=9){var r={};e["arg"+t]=r["arg"+t]=n}},get emitters(){return e.emitters},set emitters(t){e.emitters=t},get x(){return e.gridX},get y(){return e.gridY},get z(){return e.z},get dir(){return Types.convertOrientationToDirection(e.dir)},set dir(e){this.setdir(e)},setdir:function(t){t=Types.convertDirectionToOrientation(t),t!=e.dir&&(e.dir=t,e.moveprediction||e.resyncMoveXX())},get movepadvector(){if(e.game.app.movepadDown)return e.game.app.movepadVector;if(e.game.app.keyPressedAny){var t=e.getMoveKeys();return{x:t[3]-t[1],y:t[2]-t[0]}}return{x:0,y:0}},movebyvector:function(t,n,r){t&&"x"in t&&"y"in t&&n>0&&e.moveWithVector(t,n,r)},offsetx:function(t){return Types.addOffsetInOrientation(e.gridX,e.gridY,e.dir,t).x},offsety:function(t){return Types.addOffsetInOrientation(e.gridX,e.gridY,e.dir,t).y},shoot:function(t,n,r){var i;!t||e.weaponMode&&e.weaponMode["itemid"]==t?i=e.weaponMode:e.bowData&&e.bowData["itemid"]==t?i=e.bowData:e.mountData&&e.mountData["itemid"]==t&&(i=e.mountData);if(!i)return;r&&!(r instanceof Array&&r.length>=2)&&(r=undefined),e.shootProjectilesForItem(i,n,r)},setfocus:function(t,n,r){e.setFocus(t,{x:n,y:r})},resetfocus:function(){e.setFocus(null,null)},get level(){return e.level?e.level:0},get angle(){return e.angle},set angle(t){e.angle=t},get onlinetime(){return e.onlinetime},get effect(){return e.effect?e.effect.type:null},setambient:function(t,n,r){e.game.renderer.context.setAmbientColor(t,n,r)},screenshake:function(t){e.setScreenShake(t.strength,t.duration)},play:function(t){t&&e.game.sounds.play(t)},showpm:function(t,n,r,i){var s="script";r&&typeof r=="function"&&(i=r,r={}),r||(r={});if(r.mapmarkers){var o=e.game.mapmanager.getMap(e.game.mapmanager.getDefaultOutsideMap());if(!o)return;r.mapmarkers={map:o.mapname,width:o.width,height:o.height,offsetx:o.offsetx,offsety:o.offsety,markers:r.mapmarkers}}r.type&&(s=r.type,delete r.type),e.game.showPMButton(s,0,n||{name:"Server",isadmin:!0,isonline:!0},t,r,0)},showurl:function(t){e.game.shop.showURL(t,"inside")},showmessage:function(t,n){e.game.showShortMessage(translate(t,n))},showprofile:function(t){e.game.client&&e.game.client.sendRequestDBPlayerProfile(parseInt(t))},freeze:function(t,n){e.attackfreezetime=e.game.currentTime+t*1e3,e.attackfiretime=e.game.currentTime+(n||t)*1e3},get isfrozen(){return e.isFreezing()},get isfiring(){return e.isFiring()},get isreloading(){return e.isReloading()},get language(){return e.game.app.language},attack:function(){e.game.client&&e.game.client.sendAttack(),e.activateNPCs(e.dir,"sword",!0)},get coins(){return e.coins},buycoins:function(t){e.game.shop.showBuyCoinsDialog("clientbuycoins",t)},get arrows(){return e.arrows},get ammocount(){return e.ammocount},get sidekick(){return e.sidekick},set sidekick(t){if(t!==null&&typeof t!="object")return;e.sidekick=t},get strafelock(){return e.strafeLock},set strafelock(t){e.strafeLock=t?!0:!1},get tiletype(){return e.tileType},get ispvp(){return e.ispvp},get ghost(){return e.ghost},get guest(){return e.guest},get platform(){return Config_Extern?Config_Extern.platform:"unknown"},get screensize(){if(!e.game.camera||!e.game.renderer)return;return[Math.floor(e.game.camera.gridW*e.game.renderer.tilesize),Math.floor(e.game.camera.gridH*e.game.renderer.tilesize)]},invitetotrade:function(t){e.game.client&&e.game.client.sendPMAction("invitetotrade",{userid:t})},identify:function(t){e.game.identifyByType(t)},triggerserver:function(t){e.game.client&&e.game.client.sendNPCTrigger({type:"player"},"script",{action:t,params:Array.prototype.slice.call(arguments,1)})},getmenuscript:function(t){var n=e.game.scriptmanager.getMenuButtonNPCById(t);return n?n.getScriptObject():null},scheduleevent:function(t,n){e.scheduleTimeout("script:"+n,t*1e3,!1,{params:Array.prototype.slice.call(arguments,2)})},cancelevents:function(t){e.removeScheduledTimeout("script:"+t)},settimeout:function(t){e.scheduleTimeout("script:timeout",t*1e3)},sleep:function(t){e.game.scriptmanager.nextSleep={npc:e,delay:t*1e3}}}}return this.scriptObject}});return n}),define("client",["character","player","newnpc"],function(e,t,n){var r=Class.extend({init:function(e,t){this.connection=null,this.serverurl=e,this.game=t,this.initPing(),this.handlers=[],this.handlers[Types.Messages.SYSTEM]=this.receiveSystem,this.handlers[Types.Messages.WELCOME]=this.receiveWelcome,this.handlers[Types.Messages.ATTACK]=this.receiveAttack,this.handlers[Types.Messages.SPAWN]=this.receiveSpawn,this.handlers[Types.Messages.DESPAWN]=this.receiveDespawn,this.handlers[Types.Messages.PROJECTILE]=this.receiveProjectile,this.handlers[Types.Messages.MOVEXX]=this.receiveMoveXX,this.handlers[Types.Messages.MAPSTREAM]=this.receiveMapStream,this.handlers[Types.Messages.HEALTH]=this.receiveHealth,this.handlers[Types.Messages.CHAT]=this.receiveChat,this.handlers[Types.Messages.WEATHER]=this.receiveWeather,this.handlers[Types.Messages.SCORES]=this.receiveScores,this.handlers[Types.Messages.TELEPORT]=this.receiveTeleport,this.handlers[Types.Messages.DAMAGE]=this.receiveDamage,this.handlers[Types.Messages.MODALMESSAGE]=this.receiveModalMessage,this.handlers[Types.Messages.LIST]=this.receiveList,this.handlers[Types.Messages.HP]=this.receiveMaxHitPoints,this.handlers[Types.Messages.MAPMOVE]=this.receiveMapmove,this.handlers[Types.Messages.GENERALMESSAGE]=this.receiveGeneralMessage,this.handlers[Types.Messages.OBJECTDATA]=this.receiveObjectData,this.handlers[Types.Messages.MAPINFO]=this.receiveMapInfo,this.handlers[Types.Messages.AUDIO]=this.receiveAudio,this.handlers[Types.Messages.PROFILE]=this.receiveProfile,this.handlers[Types.Messages.ASKBUYITEM]=this.receiveAskBuyItem,this.handlers[Types.Messages.INVENTORY]=this.receiveInventory,this.handlers[Types.Messages.CLANACTION]=this.receiveClanAction,this.handlers[Types.Messages.SHORTMESSAGE]=this.receiveShortMessage,this.handlers[Types.Messages.PM]=this.receivePM,this.handlers[Types.Messages.NOTIFICATION]=this.receiveNotification,this.handlers[Types.Messages.BUILDINFO]=this.receiveBuildInfo,this.handlers[Types.Messages.MYHOUSES]=this.receiveMyHouses,this.handlers[Types.Messages.FURNITUREINFO]=this.receiveFurnitureInfo,this.handlers[Types.Messages.SELLITEMS]=this.receiveSellItems,this.handlers[Types.Messages.MAPMARKERS]=this.receiveMapMarkers,this.handlers[Types.Messages.PING]=this.receivePing,this.handlers[Types.Messages.PONG]=this.receivePong,this.handlers[Types.Messages.FRIENDS]=this.receiveFriends,this.handlers[Types.Messages.WINNER]=this.receiveWinner,this.handlers[Types.Messages.CONSOLECHAT]=this.receiveConsoleChat,this.handlers[Types.Messages.HOUSEINFO]=this.receiveHouseInfo,this.handlers[Types.Messages.UPLOADACTION]=this.receiveUploadAction,this.handlers[Types.Messages.ADMININVENTORY]=this.receiveAdminInventory,this.handlers[Types.Messages.BUYCOINS]=this.receiveBuyCoins,this.handlers[Types.Messages.ITEMDATA]=this.receiveItemData,this.handlers[Types.Messages.PROJECTILEINFO]=this.receiveProjectileInfo,this.handlers[Types.Messages.USERPMS]=this.receiveUserPMs,this.handlers[Types.Messages.LISTMESSAGES]=this.receiveMessageList,this.handlers[Types.Messages.EVENTINFO]=this.receiveEventInfo,this.handlers[Types.Messages.SHOWURL]=this.receiveShowURL,this.handlers[Types.Messages.FOCUS]=this.receiveFocus,this.handlers[Types.Messages.SHOWVS]=this.receiveShowVS,this.handlers[Types.Messages.SHOWVSCLANS]=this.receiveShowVSClans,this.handlers[Types.Messages.SHOWVSWINNER]=this.receiveShowVSWinner,this.handlers[Types.Messages.SHOWVSCLANWINNER]=this.receiveShowVSClanWinner,this.handlers[Types.Messages.STORYACTION]=this.receiveStoryAction,this.handlers[Types.Messages.TRADEACTION]=this.receiveTradeAction,this.handlers[Types.Messages.NPCTRIGGER]=this.receiveNPCTrigger,this.handlers[Types.Messages.IDENTIFY]=this.receiveIdentify,this.handlers[Types.Messages.CLIENTCLASS]=this.receiveClientClass,this.handlers[Types.Messages.PLAYERANIS]=this.receivePlayerAnis,this.handlers[Types.Messages.MENUBUTTONS]=this.receiveMenuButtons,this.handlers[Types.Messages.AMBIENTCOLOR]=this.receiveAmbientColor,this.handlers[Types.Messages.MAILINGACTION]=this.receiveMailingAction,this.handlers[Types.Messages.PATHMESSAGE]=this.receivePathMessage,this.handlers[Types.Messages.GETPATH]=this.receivePath,this.handlers[Types.Messages.PAYSESSION]=this.receivePaySession,this.handlers[Types.Messages.ACCOUNTINFO]=this.receiveAccountInfo,this.handlers[Types.Messages.PAYPACKAGES]=this.receivePaymentPackages,this.handlers[Types.Messages.STEAMPAYMENT]=this.receiveSteamPayment,this.handlers[Types.Messages.FILEMODTIME]=this.receiveFileModTime,this.handlers[Types.Messages.CLANPMS]=this.receiveClanPMs},initPing:function(){this.pinginterval=1e4,this.lastping={id:0,time:Date.now()-this.pinginterval*.9},this.nextpingid=1,this.lastpingtime=0,this.showping=!1},connect:function(){var e=this;e.wasconnected=!1,this.connectionTime=Date.now(),gui.setUnload(function(){e.connection&&e.connection.close()}),window.MozWebSocket?this.connection=new MozWebSocket(atob(this.serverurl)):this.connection=new WebSocket(atob(this.serverurl)),this.connection.onopen=function(t){e.wasconnected=!0},this.connection.onmessage=function(t){switch(t.data){case"go":e.sendHandShake();break;case"timeout":e.isTimeout=!0;break;case"nogameserver":e.isNoGameServer=!0;break;default:t.data.substr(0,4)=="[go,"&&(e.sendHandShake(),t.data="["+t.data.substr(4)),e.receiveMessage(t.data)}},this.connection.onerror=function(t){window.console&&console.log("Connection error"),e.logError("Connection error: "+t.data)},this.connection.onclose=function(t){window.console&&console.log("Connection closed"),e.game.player&&e.game.player.die();var n,r=!0;e.isTimeout?n="You have been disconnected for being inactive for too long":e.isNoGameServer?n="The game server is currently down. Please try later":e.wasconnected?(n="The connection to "+e.game.app.config.gamename+" has been lost",r=!1):n="The connection to "+e.game.app.config.gamename+" couldn't be established.",r&&e.logError("Disconnected: "+n+" (code: "+t.code+", reason: "+t.reason+")"),e.game.onDisconnect(n)}},logError:function(e){if(atob(this.serverurl).indexOf("127.0.0.1")>=0)return;var t=Date.now(),n=this.connectionTime?t-this.connectionTime:-1;gui.callURL("errorlog2.php",{message:e.substring(0,2e3),time:n})},sendHandShake:function(){window.console&&console.log("Connecting to server");if(!this.game.player)return;var e=this.game.storage.getCookie(),t=this.game.storage.getCookie2();this.game.started=!0,this.sendMessage([Types.Messages.HELLO,e,this.game.player.name,t?t:"",this.game.app.language,Config_Extern&&Config_Extern.platform?Config_Extern.platform:"unknown"]),this.game.shop.hasExternInterfaceVersion(1.2)&&this.game.shop.sendCookie(e,t)},sendMessage:function(e){this.connection.readyState===1&&this.connection.send(JSON.stringify(e))},receiveMessage:function(e){var t;try{t=JSON.parse(e)}catch(n){this.logError("Syntax error: "+n+", data: "+e);return}if(t instanceof Array){var r=t[0];if(r instanceof Array){var i=this;_.each(t,function(e){var t=e[0];i.handlers[t]&&i.handlers[t].call(i,e)})}else this.handlers[r]&&this.handlers[r].call(this,t)}},receiveSystem:function(e){switch(e[1]){case"go":this.sendHandShake();break;case"timeout":this.isTimeout=!0;break;case"nogameserver":this.isNoGameServer=!0}},receiveWelcome:function(e){var t=this.game.player;if(!t)return;var n=e[7]&&e[7].ghost;n||this.game.finishedIdentify(),e[7]&&e[7].ghostcanplay?gui.addClass("body","ghostcanplay"):gui.removeClass("body","ghostcanplay"),e[7]&&e[7].guest?gui.addClass("body","guestmode"):gui.removeClass("body","guestmode"),this.game.scriptmanager.onConnected(),t.game=this.game,t.id=e[1],t.isDead=!1,this.game.playerId=t.id,this.game.mapmanager.loadMap(e[2],e[3]),t.setGridPosition(e[4],e[5]),t.setMaxHitPoints(e[6],!0),t.setExtendedData(e[7]),this.game.resetCamera(),this.game.renderer.camera.sendScreenSize(!0),this.game.addEntity(t),this.game.storage.setPlayerName(t.name),this.game.shop.sendConnectedToServer(),Config_Extern&&this.game.shop.requestPushNotifications(),this.game.hasNeverStarted&&this.game.start(),this.game.onEnteredMap(e[2],e[3],null),this.game.filemanager.resendShowConsole(),this.game.tradingmanager.handleTradeAction("stoptrade")},receiveAttack:function(e){var t=this.game.getEntityById(e[1]);if(!t)return;this.game.player&&this.game.player.checkBeingHurt(t)},receiveSpawn:function(e){var r=this.game.getEntityById(e[1]);r||(e[2]==Types.Entities.PLAYER?r=new t(this.game,e[1],Types.Entities.PLAYER):r=new n(this.game,e[1])),r.setExtendedData(e[5]),r.setGridPosition(e[3],e[4]),r!=this.game.player&&!this.game.entityIdExists(r.id)&&(r.idle(),this.game.addEntity(r))},receiveDespawn:function(t){var n=this.game.getEntityById(t[1]);if(!n)return;n instanceof e&&t[2]?n.die(t.length>=4?t[3]:null):this.game.removeEntity(n)},receiveHealth:function(e){var t=this.game.player;t&&t.updateHitPoints(e[1],e[2],e.length>=4?e[3]:null)},receiveChat:function(e){var t=this.game.getEntityById(e[1]);t&&(t.chat=e[2],t.showChat(t.chat))},receiveWeather:function(e){this.game.animationmanager.setWeather(e[1])},receiveScores:function(e){this.game.menu.setPlayerScores(e[1],e[2],e[3])},receiveTeleport:function(e){var t=this.game.getEntityById(e[1]);if(t&&!this.game.mapmanager.isOutOfBounds(parseInt(e[2]),parseInt(e[3]))){var n=t.dir;t.setGridPosition(e[2],e[3]),t.onHasMoved(),t.setOrientation(n),t==this.game.player&&e.length>=5&&this.game.player.handleTeleport(e[4])}e[1]==this.game.playerId&&this.game.resetCamera()},receiveDamage:function(e){var t=this.game.getEntityById(e[1]);t&&t.updateDamage(e[2],e.length>=4&&e[3]?e[3]:"inflicted",e.length>=6?e[4]:null,e.length>=6?e[5]:null)},receiveModalMessage:function(e){this.game.menu.showModalMessage(e[1],e[2],e.length>=4?e[3]:null)},receiveList:function(e){e.shift();var n=_.pluck(this.game.entities,"id"),r=_.intersection(n,e),i=_.difference(e,r),s=this;this.game.removeObsoleteEntities(_.reject(this.game.entities,function(e){return _.include(r,e.id)||e instanceof t})),_.size(i)>0&&this.sendWho(i),this.game.npcsFinishedLoading||(this.game.npcsFinishedLoading=!0,this.game.checkHideStartScreen())},receiveMaxHitPoints:function(e){this.game.player&&this.game.player.setMaxHitPoints(e[1],!1)},receiveMapmove:function(e){if(e[1]!=this.game.playerId)return;var t=this.game.getEntityById(e[1]);if(!t)return;var n=this.game.mapmanager.currentmap,r=n?{x:t.gridX,y:t.gridY,map:n.mapname,template:n.templatename}:null;t.idle(),this.game.removeEntity(t),this.game.mapmanager.loadMap(e[4],e[5]),t.setGridPosition(e[2],e[3]),this.game.addEntity(t),this.game.resetCamera(),this.game.onEnteredMap(e[4],e[5],r),t.resyncMoveXX(),this.game.lastdoor=null},receiveGeneralMessage:function(e){this.game.showGeneralMessage(e[1],e.length>=3?e[2]:null)},receiveObjectData:function(e){var t;typeof e[1]=="string"&&e[1].indexOf(Types.IDPrefix.MAP)==0?t=this.game.mapmanager.getMap(e[1].substring(1)):t=this.game.getEntityById(e[1]),t&&t.setExtendedData(e[2])},receiveMapInfo:function(e){this.game.minimap.setMapInfo(e[1])},receiveAudio:function(e){var t=this.game.getEntityById(e[1]);t&&this.game.renderer.camera.isVisible(t)&&this.game.sounds.play(e[2])},receiveProfile:function(e){this.game.menu.playerprofiledata=e[1],this.game.menu.showMenuByName("profile",!0)},receiveAskBuyItem:function(e){this.game.shop.askBuyItem(e[1])},receiveInventory:function(e){this.game.menu.addInventoryItems(e[1],e.length>=3?e[2]:null)},receiveClanAction:function(e){this.game.menu.handleClanAction(e[1],e[2])},receiveShortMessage:function(e){this.game.showShortMessage(e[1],e.length>=3?e[2]:null)},receivePM:function(e){this.game.showPMButton(e[1],e[2],e[3],e[4],e[5],e[6])},receiveNotification:function(e){this.game.showNotification(e[1],e[2],e[3],e[4],e[5],e[6])},receiveBuildInfo:function(e){this.game.menu.showBuildInfo(e[1])},receiveMyHouses:function(e){this.game.menu.setMyHouses(e[1])},receiveFurnitureInfo:function(e){this.game.filemanager.showEditFurniture(e[1])},receiveSellItems:function(e){this.game.shop.showSellItems(e[1])},receiveProjectile:function(e){var t=Math.min(250,e.length>=8?e[7]:0)+Math.min(250,this.lastpingtime);this.game.mapmanager.currentmap&&this.game.mapmanager.currentmap.projectiles.createProjectile(e[1],e[2],e[3],e[4],e[5],e[6],t,!1)},receiveMapMarkers:function(e){this.game.menu.handleMapMarkers(e[1])},receivePing:function(e){this.sendMessage([Types.Messages.PONG,e[1],this.lastpingtime])},receivePong:function(e){var t=e[1];if(!this.lastping||t!=this.lastping.id)return;this.lastpingtime=Date.now()-this.lastping.time,this.showping&&this.game.showPing(this.lastpingtime)},receiveMoveXX:function(t){var n=this.game.getEntityById(t[1]);n&&n instanceof e&&n.moveXX(t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12])},receiveMapStream:function(e){var t=this.game.mapmanager.currentmap;t&&t.mapname==e[1]&&t.addStreamData(e[2])},receiveFriends:function(e){this.game.menu.showFriends(e[1])},receiveWinner:function(e){this.game.minimap.drawWinner(e[1],e[2])},receiveConsoleChat:function(e){this.game.filemanager.addConsoleText(e[2])},receiveHouseInfo:function(e){this.game.menu.showEditHouse(e[1])},receiveUploadAction:function(e){this.game.menu.handleUploadAction(e[1],e[2])},receiveAdminInventory:function(e){this.game.menu.handleAdminInventory(e[1],e[2])},receiveBuyCoins:function(e){this.game.shop.showBuyCoinsDialog("clientbuycoins",e[1])},receiveItemData:function(e){if(!this.game.player)return;this.game.player.setItemData(e[1],e[2])},receiveProjectileInfo:function(e){this.game.projectileInfo=e[1]},receiveUserPMs:function(e){this.game.menu.setUserPMs(e[1],e[2])},receiveMessageList:function(e){this.game.menu.showMessageList(e[1],!1,0)},receiveEventInfo:function(e){this.game.menu.showEventInfo(e[1])},receiveShowURL:function(e){this.game.shop.showURL(e[1],e[2])},receiveFocus:function(e){this.game.player&&this.game.player.setFocus(e[1],e[2])},receiveShowVS:function(e){this.game.showVS(e[1],e[2])},receiveShowVSClans:function(e){this.game.showVSClans(e[1],e[2])},receiveShowVSWinner:function(e){this.game.showVSWinner(e[1],e[2])},receiveShowVSClanWinner:function(e){this.game.showVSClanWinner(e[1])},receiveStoryAction:function(e){this.game.storymanager.handleStoryAction(e[1],e[2])},receiveTradeAction:function(e){this.game.tradingmanager.handleTradeAction(e[1],e[2])},receiveNPCTrigger:function(e){var t=e[1];if(typeof t=="object")switch(t.type){case"player":r=this.game.player;break;case"weapon":r=this.game.player.weaponnpc;break;case"npc":r=this.game.getEntityById(t.id);break;case"menu":r=this.game.scriptmanager.getMenuButtonNPCById(t.id)}else var r=this.game.getEntityById(t);r&&(r instanceof n||t["type"]=="player")&&(r.handleTrigger(e[2],e.length>=4?e[3]:null),typeof t=="object"&&t.type=="menu"&&this.game.menu.addMenuScriptBackButton(null,t.id))},receiveIdentify:function(e){this.game.receivedIdentifyInfo(e[1],e[2])},receiveClientClass:function(e){this.game.scriptmanager.setClientClass(e[1],e[2])},receivePlayerAnis:function(e){this.game.animationmanager.setPlayerAnis(e[1])},receiveMenuButtons:function(e){this.game.scriptmanager.setMenuButtons(e[1])},receiveAmbientColor:function(e){this.game.renderer.context.setAmbientColor(e[1],e[2],e[3])},receiveMailingAction:function(e){this.game.menu.handleMailingAction(e[1],e[2])},receivePathMessage:function(e){this.game.filemanager.handlePathMessage(e[1],e[2])},receivePath:function(e){var t=e[1],n=e[2],r=e.length>=4?e[3]:t.substring(t.length-1)=="/"?"folder":"text",i=e.length>=5?e[4]:null,s=e.length>=6?e[5]:null;switch(r){case"folder":this.game.filemanager.setFileTreeFolder("filebrowsertree",t,n,i);break;default:e[1].indexOf("editorconfig.json")>=0?this.game.filemanager.setEditorConfig(t,n):this.game.filemanager.showFileTreeContent(t,n,r,i,s)}},receivePaySession:function(e){this.game.shop.handlePaySession(e[1],e[2])},receiveAccountInfo:function(e){this.game.menu.handleAccountInfo(e[1])},receivePaymentPackages:function(e){this.game.shop.showBuyCoinsDialog_Step2(this.game.shop.loadInAppFromMenu,e[1])},receiveSteamPayment:function(e){this.game.shop.openSteamPaymentURL(e[2],e[3],e[4],e[5])},receiveFileModTime:function(e){this.game.animationmanager.onFileUpdate(e[1],e[2])},receiveClanPMs:function(e){this.game.menu.setClanPMs(e[1],e[2])},sendMapMove:function(e,t,n){this.sendMessage([Types.Messages.MAPMOVE,e,t,n])},sendAttack:function(){this.sendMessage([Types.Messages.ATTACK,-1])},sendHurt:function(e){this.sendMessage([Types.Messages.HURT,e.id])},sendHurtProjectile:function(e,t){this.sendMessage([Types.Messages.HURTPROJECTILE,e,t])},sendChat:function(e){this.sendMessage([Types.Messages.CHAT,e])},sendWho:function(e){e.unshift(Types.Messages.WHO),this.sendMessage(e)},sendPayment:function(e,t,n,r,i){this.sendMessage([Types.Messages.PAYMENT2,e,Math.floor(t),""+n,r,i])},sendBuildObject:function(e){this.sendMessage([Types.Messages.BUILDOBJECT,e])},sendNPCTrigger:function(e,t,n){this.sendMessage([Types.Messages.NPCTRIGGER,e,t,n])},sendRequestPlayerProfile:function(e){this.sendMessage([Types.Messages.GETPROFILE,e.id])},sendBuyItem:function(e){this.sendMessage([Types.Messages.BUYITEM,e])},sendRevive:function(e){this.sendMessage([Types.Messages.REVIVE,e])},sendShare:function(e,t){this.sendMessage([Types.Messages.SHARED,e,t])},sendPlaceObject:function(e){this.sendMessage([Types.Messages.PLACEOBJECT,e])},sendPushToken:function(e){this.sendMessage([Types.Messages.PUSHTOKEN,e])},sendGetInventory:function(){this.sendMessage([Types.Messages.GETINVENTORY])},sendUseInventory:function(e,t){this.sendMessage([Types.Messages.USEINVENTORY,e,t])},sendClanAction:function(e,t){this.sendMessage([Types.Messages.CLANACTION,e,t])},sendGoToHouse:function(e,t){this.sendMessage([Types.Messages.GOTOHOUSE,e,t])},sendRequestDBPlayerProfile:function(e){this.sendMessage([Types.Messages.GETPROFILEDB,e])},sendGetMyHouses:function(){this.sendMessage([Types.Messages.GETMYHOUSES])},sendPMAction:function(e,t){this.sendMessage([Types.Messages.PMACTION,e,t])},sendSellItem:function(e,t){this.sendMessage([Types.Messages.SELLITEM,e,t])},sendGetMapMarkers:function(e){this.sendMessage([Types.Messages.GETMAPMARKERS,e])},sendProjectile:function(e,t,n,r,i){this.sendMessage([Types.Messages.PROJECTILE,e,Math.floor(t*100)/100,Math.floor(n*100)/100,Math.floor(r*100)/100,Math.floor(i*1e3)/1e3])},sendPing:function(){if(this.lastping&&this.game.currentTime<this.lastping.time+this.pinginterval)return;var e=this.nextpingid++;this.lastping={id:e,time:Date.now()},this.sendMessage([Types.Messages.PING,e,this.lastpingtime])},sendMoveXX:function(e,t,n,r,i,s,o,u){var a=[Types.Messages.MOVEXX,e,Math.floor(t*100)/100,Math.floor(n*100)/100,Math.floor(r*100)/100,i],f=this.game.player?this.game.player.attachInfo:null;if(s!=0||o!=0||u!=0||f){a.push(s),a.push(o);if(u!=0||f)a.push(Math.floor(u*100)/100),f&&f.object&&(a.push(f.id),a.push(Math.floor((t-f.object.gridX)*100)/100),a.push(Math.floor((n-f.object.gridY)*100)/100))}this.sendMessage(a)},sendAni:function(e){this.sendMessage([Types.Messages.ANI,e])},sendSetSettings:function(e){this.sendMessage([Types.Messages.SETSETTINGS,e])},sendConsoleChat:function(e,t){this.sendMessage([Types.Messages.CONSOLECHAT,e,t])},sendRemoveSidekicks:function(){this.sendMessage([Types.Messages.REMOVESIDEKICKS])},sendKickVisitors:function(){this.sendMessage([Types.Messages.KICKVISITORS])},sendIsTalking:function(e){this.sendMessage([Types.Messages.ISTALKING,e?1:0])},sendSaveStatus:function(e,t){this.sendMessage([Types.Messages.SAVESTATUS,e,t])},sendUnlockStatus:function(e){this.sendMessage([Types.Messages.UNLOCKSTATUS])},sendUploadAction:function(e,t){this.sendMessage([Types.Messages.UPLOADACTION,e,t])},sendGetAdminInventory:function(e){this.sendMessage([Types.Messages.ADMININVENTORY,parseInt(e)])},sendTrackAction:function(e,t,n){this.sendMessage([Types.Messages.TRACKACTION,e,t,n])},sendLike:function(e,t){this.sendMessage([Types.Messages.LIKE,e,t?1:0])},sendGetScores:function(e,t){this.sendMessage([Types.Messages.SCORES,e,t])},sendHotkey:function(e,t){this.sendMessage([Types.Messages.HOTKEY,e,t])},sendEventInfo:function(e){this.sendMessage([Types.Messages.EVENTINFO,e])},sendStoryAction:function(e,t){this.sendMessage([Types.Messages.STORYACTION,e,t])},sendTradeAction:function(e,t){this.sendMessage([Types.Messages.TRADEACTION,e,t])},sendIdentify:function(e,t){this.sendMessage([Types.Messages.IDENTIFY,e,t])},sendGetClientClasses:function(e){this.sendMessage([Types.Messages.CLIENTCLASS,e])},sendAddNPC:function(e){this.sendMessage([Types.Messages.ADDNPC,e])},sendLagLog:function(e,t,n,r){this.sendMessage([Types.Messages.LAGLOG,e,t,n,r])},sendGetPath:function(e){this.sendMessage([Types.Messages.GETPATH,e])},sendPaySession:function(e,t){this.sendMessage([Types.Messages.PAYSESSION,e,t])},sendSetPath:function(e,t,n){this.sendMessage([Types.Messages.SETPATH,e,t,n])},sendLog:function(e,t){this.sendMessage([Types.Messages.CLIENTLOG,e,t])},sendGetAccountInfo:function(){this.sendMessage([Types.Messages.ACCOUNTINFO])},sendGetPaymentPackages:function(e,t){this.sendMessage([Types.Messages.PAYPACKAGES,e,t?t:0])},sendSteamPayment:function(e,t,n){this.sendMessage([Types.Messages.STEAMPAYMENT,e,t,n])},sendGetFileModTime:function(e){this.sendMessage([Types.Messages.FILEMODTIME,e])},sendDeleteAccount:function(){this.sendMessage([Types.Messages.DELETEACCOUNT])},sendScreenSize:function(e,t){this.sendMessage([Types.Messages.SCREENSIZE,e,t])}});return r}),define("sounds",[],function(){var e=Class.extend({init:function(e){this.game=e,this.currentmusic=null,this.scriptmusic=null,this.initAudioContext(),this.preloadSounds()},preloadSounds:function(){if(!this.audiocontext)return;this.soundNamesPreload=["hit1"];var e=this;_.each(e.soundNamesPreload,function(t){e.loadContextBuffer(t)})},unlockSounds:function(){this.play("hit1",!0),this.currentmusic&&(this.currentmusic=null,this.updateMusic(!0))},initAudioContext:function(){this.contextbuffers={};try{window.AudioContext?this.audiocontext=new AudioContext:this.audiocontext=new webkitAudioContext,this.audiocontext&&(window.console&&console.log("Initialized audio"),this.audiocontext.createGain&&(this.audiogainnode=this.audiocontext.createGain(),this.audiogainnode&&(this.audiogainnode.connect(this.audiocontext.destination),this.audiogainnode.gain.value=this.game.settings.sfxvol||1)))}catch(e){window.console&&console.log("Audio Context API is not supported in this browser, using audio-tag"),this.audiocontext=null}},loadContextBuffer:function(e,t){if(!e||e.length<=0||e=="null")return;var n=this.game.filespath+"sounds/"+e+".wav",r=new XMLHttpRequest;r.open("GET",n,!0),r.responseType="arraybuffer";var i=this;r.onload=function(){i.audiocontext.decodeAudioData(r.response,function(n){if(!n){window.console&&console.log("Error decoding audio file data: "+e);return}i.contextbuffers[e]=n,t&&i.playBuffer(n)},function(t){window.console&&console.log("Error decoding audio data: "+e,t)})},r.onerror=function(){window.console&&console.log("Error loading audio data: "+e)},r.send()},play:function(e,t){if(!e||e.length<=0)return;if(this.game.settings.soundsoff||"sfxvol"in this.game.settings&&this.game.settings.sfxvol<=0||!this.audiocontext)return;if(!this.game.gameVisible)return;if(!t&&this.audiocontext.state=="suspended")return;var n=this.contextbuffers[e];n?this.playBuffer(n):this.loadContextBuffer(e,!0)},playBuffer:function(e){var t=this.audiocontext.createBufferSource();t.buffer=e,t.connect(this.audiogainnode?this.audiogainnode:this.audiocontext.destination),t.start?t.start(0):t.noteOn&&t.noteOn(0)},updateVolume:function(){this.audiogainnode&&(this.audiogainnode.gain.value=this.game.settings.sfxvol||1),this.game.unlockedsounds&&this.musicHandle&&(this.musicHandle.volume=this.game.settings.musvol||1)},setScriptMusic:function(e){if(e==this.scriptmusic)return;var t=this.game.mapmanager.currentmap;if(!t)return;this.scriptmusic=e,this.scriptmusicmap=t.templatename,this.updateMusic(!1)},updateMusic:function(e){if(this.game.settings.musicoff||"musvol"in this.game.settings&&this.game.settings.musvol<=0||!this.game.unlockedsounds)return;if(this.doPlayOnInteraction&&e&&this.musicHandle){this.doPlayOnInteraction=!1,this.musicHandle.play(),this.game.renderer.isMobile||(this.musicHandle.volume=0),this.fadeMusic(2);return}var t=null,n=this.game.mapmanager.currentmap;n&&this.game.player&&(this.scriptmusic&&(this.scriptmusicmap==n.templatename?t=this.scriptmusic:this.scriptmusic=null),t||(this.game.app.config.music&&n.templatename==this.game.app.config.defaultmapname?this.game.player.isInRectangle({x:96,y:80,w:68,h:86})||(t=this.game.app.config.music):t=n.getMusic(this.game.player.gridX,this.game.player.gridY)));if(t==this.currentmusic)return;if(!t){this.stopMusic();return}this.playMusicOrPlaylist(t)},stopMusic:function(){if(this.musicHandle){var e=this;this.fadeMusic(-2.5,function(){e.musicHandle.pause(),e.musicHandle=null})}this.currentmusic=null,this.doPlayOnInteraction=!1},playMusicOrPlaylist:function(e){this.currentmusic=e;if(e.indexOf(".m3u")>=0&&!(window.navigator&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome"))){var t=this;gui.ajax(e,!1,function(n){var r=n.replace(/^.*#.*$|#EXTM3U|#EXTINF:/mg,"").split("\n");if(r.length<=0){window.console&&console.log("Error playlist is empty: "+e,n);return}t.playMusic(r[0])},function(t,n,r){window.console&&console.log("Error loading playlist: "+e)});return}this.playMusic(e)},playMusic:function(e){if(this.musicHandle){var t=this;this.fadeMusic(-2,function(){t.musicHandle&&t.musicHandle.pause(),t.playMusic_NoCheck(e)});return}this.playMusic_NoCheck(e)},playMusic_NoCheck:function(e){this.doPlayOnInteraction=!1,this.musicHandle=document.createElement("audio");if(!this.musicHandle)return;var t=this;this.musicHandle.addEventListener("error",function(n){window.console&&console.log("Error: "+e+" could not be loaded"),t.musicHandle=null},!1),this.musicHandle.addEventListener("canplaythrough",function(e){t.musicHandle&&(t.musicHandle.removeEventListener("canplaythrough",arguments.callee,!1),t.doPlayOnInteraction=!0)},!1),this.musicHandle.preload="auto",this.musicHandle.autobuffer=!0,this.musicHandle.loop=!0,this.musicHandle.addEventListener("ended",function(){t.musicHandle.play()},!1),this.musicHandle.src=e.indexOf("://")>=0?e:this.game.filespath+"music/"+e,this.musicHandle.load()},fadeMusic:function(e,t){if(!this.musicHandle)return;var n=this.game.settings.musvol||1;if(this.game.renderer.isMobile){this.musicHandle.volume=e>0?n:0,t&&t();return}this.clearFadeMusic();var r=this,i=this.game.minFrameTime/1e3/e;this.musicFadeInterval=setInterval(function(){if(!r.musicHandle){r.clearFadeMusic();return}var s=r.musicHandle.volume+i;(e>0?s<n:s>0)?r.musicHandle.volume=s:(r.musicHandle.volume=e>0?n:0,r.clearFadeMusic(),t&&t())},this.game.minFrameTime)},clearFadeMusic:function(){this.musicFadeInterval&&(clearInterval(this.musicFadeInterval),delete this.musicFadeInterval)}});return e}),define("menu",[],function(){var e=Class.extend({init:function(e){this.game=e,this.currentPopupType=null,this.mailingMenus=["mailing","mailingnew"],XMLHttpRequest.prototype.sendAsBinary===undefined&&(XMLHttpRequest.prototype.sendAsBinary=function(e){var t=Array.prototype.map.call(e,function(e){return e.charCodeAt(0)&255});this.send((new Uint8Array(t)).buffer)})},getItemsPerPage:function(){return 24},showPopUp:function(e){e=e||{};var t=(translate(e.title)||"").replace("<br>",""),n=e.popupType||"",r=e.width||600,i=e.height||400,s=this.game.app.config.enablenewgui,o=e.id||"newpopup",u=e.backgroundid||"modal_background";n&&this.getCurrentMenu()==n&&this.closePopUpNow(n);var a=document.createElement("div");a.id=u;var f=gui.getDom("gamecontainer");f.appendChild(a);var l=document.createElement("div");l.id=o,l.className="windowborder",l.style.width=r+"px",l.style.height=i+"px",this.checkPopupZoom(f,l,r+128,i+128),f.appendChild(l),o=="newpopup"&&(this.currentPopupType=n);var c=document.createElement("div");c.className="titletext",t.length>=20&&(c.style.fontSize="30px"),e.titleCallback&&(gui.setClick(c,e.titleCallback),c.style.cursor="pointer"),c.innerHTML=t,l.appendChild(c);if(e.showbadge){var h=document.createElement("div");h.className="gameadminbadge",l.appendChild(h)}if(!e.hideclosebutton){var p=document.createElement("div");p.className="closebutton",p.id="closebutton";var d=this;e.closeCallback?gui.setClick(p,e.closeCallback):gui.setClick(p,function(e){d.closePopUp()});var v=document.createElement("div");v.className="closebuttonimage",p.appendChild(v),l.appendChild(p)}var m=document.createElement("div");return m.id="newpopup_dialog",m.style.position="absolute",m.style.left=s&&!e.noborders?"24px":"0px",m.style.top="60px",m.style.width=s&&!e.noborders?"calc(100% - 24px)":"100%",m.style.height=i+32+(e.noborders?8:0)+"px",m.style.maxHeight="calc(100% - "+(s?60:46)+"px)",m.style.overflow=e.overlap?"initial":"hidden",l.appendChild(m),gui.animate(a,1,"fast"),gui.animate(l,1,"normal"),gui.animate(p,1,"normal"),m},checkPopupZoom:function(e,t,n,r){if(!this.game.renderer.hasWebGL())return;var i=gui.getWidth(e),s=gui.getHeight(e),o=Math.min(i/n,s/r);if(o>=1)return;t.style.transform="scale("+o+")",t.style.maxWidth="none",n>i?t.style.transformOriginX="0":t.style.transformOriginX=Math.floor(n/2)+"px"},closePopUp:function(e){this.game.tradingmanager.checkStopTradeOnMenuClose(),gui.animate("modal_background",0,"normal",function(){gui.remove("modal_background"),e&&e()}),gui.animate("newpopup",0,"fast",function(){gui.remove("newpopup")}),this.currentPopupScript=null},closePopUpNow:function(e){this.game.tradingmanager.checkStopTradeOnMenuClose(e),gui.stop("modal_background",!0,!0),gui.remove("modal_background"),gui.stop("newpopup",!0,!0),gui.remove("newpopup"),this.currentPopupScript=null},showWaitingScreen:function(e,t){var n=this.showPopUp({title:e,hideclosebutton:!0,popupType:"waitingscreen"});n.innerHTML='<div style="font-size:24px;"><br><br><br><center>'+t+'<br><br><img src="'+this.game.filespath+'gui/bbuilder_spinner.gif"></center>'+"</div>",this.addMainBackButton(n)},showModalMessage:function(e,t,n){this.closePopUpNow();var r=this.showPopUp({title:n?translate(n):"",hideclosebutton:!t,popupType:"modalmessage",width:440,height:240});r.innerHTML='<div style="font-size:24px; margin: auto 0 auto 0;"><center>'+translate(e)+"</center></div>"},showAlert:function(e,t){var n=this,r=this.showPopUp({title:t?translate(t):"",popupType:"alert",width:400,height:200,backgroundid:"alertwindow_background",id:"alertwindow",closeCallback:function(){n.closeAlert()}});r.innerHTML='<div class="scrollable" style="font-size:24px;position:absolute;left:0px;top:0px;bottom:0px;right:0px;"><center>'+translate(e)+"</center></div>",r.appendChild(this.createButton("OK",{x:132,bottom:10,w:200,h:40},function(e){n.closeAlert()})),gui.getDom("alertwindow_background").style.zIndex=1200,gui.getDom("alertwindow").style.zIndex=1201},closeAlert:function(){gui.remove("alertwindow_background"),gui.remove("alertwindow")},addMenuButtons:function(e,t,n){if(!this.game.scriptmanager.serverMenuButtons)return;this.setMenuData(t,n);for(var r in this.game.scriptmanager.serverMenuButtons){var i=this.game.scriptmanager.serverMenuButtons[r];if(i["menu"]!=t)continue;if(i.conditions&&i.conditions.length>0){var s=!0;for(var o in i.conditions){var u=i.conditions[o],a=u.indexOf("!")==0,f=a?u.substr(1).trim():u,l=f.indexOf("<");if(l>=0){var c=f.substr(l+1).trim();f=f.substr(0,l).trim();var h=this.getButtonCondition(n,f);if(a?h<c:h>=c){s=!1;break}continue}var l=f.indexOf(">");if(l>=0){var c=f.substr(l+1).trim();f=f.substr(0,l).trim();var h=this.getButtonCondition(n,f);if(a?h>c:h<=c){s=!1;break}continue}var h=this.getButtonCondition(n,f);if(a?h:!h){s=!1;break}}if(!s)continue}e.push(this.getMenuButtonItem(i,n))}},setMenuData:function(e,t){if(!t)return;switch(e){case"profilemore":case"adminactions":this.playerprofiledata=t;break;case"clans":this.joinedclans=t;break;case"manageclan":case"claninfo":this.selectedclan=t}},getButtonCondition:function(e,t){switch(t){case"facebook":return this.isFacebook();case"filereader":return window.FileReader;case"ios":return Config_Extern&&Config_Extern["platform"]=="iphone";case"android":case"steam":return Config_Extern&&Config_Extern["platform"]==t;case"mobile":return this.game.renderer.isMobile;case"adminlevel":case"ghost":case"guest":case"onlinetime":return this.game.player[t];default:return e?e[t]:null}},getMenuButtonItem:function(e,t){this.game.scriptmanager.requestScriptClasses(e.scriptclasses);var n=this,r={serverButton:e,image:e.image,text:e.text,help:e.help,callback:function(r){n.runMenuScript(e,t)||n.showMenuByName(e.buttonid,!1)}};return this.game.player&&this.game.player.isGameAdmin()&&(r.rightcallback=function(t,r,i){n.openMenuScript(e,t.target,r,i)}),r},runMenuScript:function(e,t){var n=this.game.scriptmanager.getMenuButtonNPC(e);if(!n)return!1;var r=this.getCurrentMenu();r=="scriptgui"&&(r=e.menu),this.closePopUpNow();var i;if(t)i=[t];else switch(e.buttonid){case"map":i=[this.markerdata];break;case"profile":case"profilemore":case"adminactions":i=[this.playerprofiledata];break;case"clans":i=[this.joinedclans];break;case"manageclan":case"claninfo":i=[this.selectedclan];break;default:i=[null]}return i.push(e.buttonid),i.push(r),this.game.scriptmanager.runScript(n,this.game.player,"activated",i),this.addMenuScriptBackButton(r,e.buttonid),gui.isVisible("newpopup")&&(this.currentPopupScript=e.buttonid),!0},openMenuScript:function(e,t,n,r){var i=gui.getOffset(t),s=e.scriptclasses&&e.scriptclasses.length>0,o=this;this.game.filemanager.showRightClickMenu(i.left+n,i.top+r,[s?"Show Script":"Show Button Config"],null,function(){o.openMenuScript2(e)})},openMenuScript2:function(e){e.scriptclasses&&e.scriptclasses.length>0?this.game.filemanager.loadAndShowClass(e.scriptclasses[0]):this.game.filemanager.loadAndShowButtonConfig()},addMenuScriptBackButton:function(e,t){if(!gui.isVisible("newpopup"))return;var n=gui.find("newpopup",".backbutton");if(n&&n.length>0)return;var r=gui.getDom("newpopup_dialog");if(!r)return;if(["profile","profilemore"].indexOf(t)>=0&&this.profilebackcallback){this.addBackButton(r,"Go back",this.profilebackcallback),delete this.profilebackcallback,gui.hide("closebutton");return}if(e)switch(e){case"adminactions":this.addAdminActionsBackButton(r);break;case"adminmenu":this.addAdminBackButton(r);break;case"claninfo":this.addClanInfoBackButton(r);break;case"clans":this.addClansBackButton(r);break;case"manageclan":this.addManageClansBackButton(r);break;case"profilemore":this.addProfileMoreBackButton(r);break;case"offmenu":break;default:this.addMainBackButton(r)}},showMenuByName:function(e,t,n){this.setMenuData(e,n);if(t&&this.game.scriptmanager.serverMenuButtons)for(var r in this.game.scriptmanager.serverMenuButtons){var i=this.game.scriptmanager.serverMenuButtons[r];if(i["buttonid"]==e&&this.runMenuScript(i))return}var s=this.getCurrentMenu();this.closePopUpNow();switch(e){case"adminactions":this.showPlayerAdminOptions();return;case"adminmenu":this.showAdminMenu();return;case"files":this.game.filemanager.showFileBrowser();return;case"claninfo":this.showClanInfo();return;case"clans":this.showClansMenu(!this.joinedclans||s=="mainmenu");return;case"inventory":this.showInventory(!0,!s);return;case"main":this.showMainMenu();return;case"manageclan":this.showManageClan();return;case"map":this.showOldMap();return;case"profile":this.showPlayerProfile();return;case"profilemore":this.showProfileMore();return;case"adminconsole":this.game.filemanager.showConsole();return;case"accountinfo":this.game.player&&this.game.player.guest?this.showMenuByName("register",!0):this.showAccountInfo(!0);return;case"register":this.showRegister();return;case"friends":this.showFriends(null,!0,0);return;case"settings":this.showSettings();return;case"uploadgraphic":this.showUploadGraphic();return;case"checkuploads":this.showUploadAdminMenu(!0,null);return;case"uploadshopitem":this.showUploadShopItem();return;case"mailing":this.showMailingMenu(!0);return;case"about":this.showAbout();return;case"privacy":this.showPrivacyPolicy();return;case"searchitem":this.showSearchItem(!1);return;case"housemenu":this.showHouseMenu(!0);return;case"joinedclans":this.showJoinedClans();return;case"createclan":this.showCreateClan();return;case"clanscores":this.showClanScores(!0);return;case"playerscores":this.showPlayerScores(!0);return;case"searchclans":this.showSearchClans();return;case"clanshelp":this.showClansHelp();return;case"writeclanmessage":this.writeClanMessage();return;case"messagelist":this.showMessageList(null,!0,0);return;case"homemenu":this.showHomeMenu();return;case"confirmlogout":this.showConfirmLogout();return;case"deleteaccount":this.showDeleteMenu();return;case"buycoins":this.game.shop.showBuyCoinsDialog(s,null);return;case"discord":this.game.shop.showURL(this.game.app.config.forumurl,"inside");return;case"furnitureshops":this.game.shop.showFurnitureShops();return;case"news":this.game.storymanager.showStoryPlayList(null,"news");return;case"guide":this.game.storymanager.showStoryPlayList(null,"guide");return;case"stories":this.game.storymanager.showStoryMenu({forceload:!0,offset:0});return;case"invitefriends":this.inviteFriends();return;case"gamead":this.showGameAd(this.game.app.config.gameads[0]);return;case"invitetotrade":this.inviteToTrade();return;case"invitetospar":this.showSparTypes();return;case"invitetohouse":this.inviteToHouse();return;case"recruit":this.recruitToClan();return;case"adminactions":this.showPlayerAdminOptions();return;case"profilestories":this.game.storymanager.showStoryPlayList(null,"profile",this.playerprofiledata.userid);return;case"visithouse":this.visitPlayerHouse();return;case"managepet":this.showSidekickOptions();return;case"block":this.blockProfile();return;case"unblock":this.unblockProfile();return;case"translatechat":this.translateChatText();return;case"viewclan":this.selectClanForName(this.playerprofiledata.clanname);return}},showMainMenu:function(){var e=this.showPopUp({title:this.game.app.config.gamename+" Menu",popupType:"mainmenu"}),t=[];this.addMenuButtons(t,"main"),this.addMenuItemsToDialog(e,t);if(this.game.player&&this.game.player.isGameAdmin()){var n=this.game.app.config.enablenewgui,r=this;e.parentNode.appendChild(this.createButton("Admin",{right:n?20:0,bottom:n?10:-18,w:145,h:40},function(e){r.closePopUpNow(),r.showAdminMenu()},!0))}},showAdminMenu:function(){var e=this.showPopUp({title:this.game.app.config.gamename+" Admin Menu",popupType:"adminmenu"}),t=this,n=[{help:"Console",image:"bbuilder_newbutton_admins.png",text:"Console",callback:function(e){t.closePopUpNow(),t.game.filemanager.showConsole()}},{help:"Access files on the server, requires rights",image:"bbuilder_newbutton_files.png",text:"File Browser",callback:function(e){t.closePopUpNow(),t.game.filemanager.showFileBrowser()}},{help:"Approve or reject graphics uploaded by players",image:"bbuilder_newbutton_edituploads.png",text:"Check Uploads",callback:function(e){t.closePopUpNow(),t.showUploadAdminMenu(!0)}}];this.game.app.config.adminfilesurl&&n.push({help:"Manage game files on gitlab",image:"bbuilder_newbutton_files.png",text:"Gitlab Files",callback:function(e){t.game.shop.showURL(t.game.app.config.adminfilesurl,"outside")}}),this.game.app.config.adminconfigurl&&n.push({help:"Manage configuration and items on gitlab",image:"bbuilder_newbutton_config.png",text:"Config",callback:function(e){t.game.shop.showURL(t.game.app.config.adminconfigurl,"outside")}}),this.game.app.config.adminmapsurl&&n.push({help:"Manage maps on gitlab",image:"bbuilder_newbutton_maps.png",text:"Maps",callback:function(e){t.game.shop.showURL(t.game.app.config.adminmapsurl,"outside")}}),this.game.app.config.adminscriptsurl&&n.push({help:"Manage scripts on gitlab",image:"bbuilder_newbutton_scripts.png",text:"Scripts",callback:function(e){t.game.shop.showURL(t.game.app.config.adminscriptsurl,"outside")}}),n.push({help:"Upload & configure new items",image:"bbuilder_newbutton_uploads.png",text:"Upload Item",callback:function(e){t.closePopUpNow(),t.showUploadShopItem()}}),n.push({help:"Send announcements via push notifications",image:"bbuilder_newbutton_mailings.png",text:"Push Announcement",callback:function(e){t.closePopUpNow(),t.showMailingMenu(!0)}}),this.addMenuButtons(n,"admin"),this.addMenuItemsToDialog(e,n),this.addMainBackButton(e)},getMenuItemForGameAd:function(e){var t=this;return{help:e.hint,image:e.icon,text:e.shortname,callback:function(n){t.closePopUpNow(),t.showGameAd(e)}}},showGameAd:function(e){if(!e)return;var t=this.showPopUp({title:e.name,hideclosebutton:!0,popupType:"gamead"});this.showGameAdInContainer(t,e,!1),this.addMainBackButton(t)},showGameAdInContainer:function(e,t,n){if(!e||!t)return;this.gamead=t;var r="";n||(r+='<div style="font-size:24px; margin: auto 0 auto 0;">'),r+='<img src="'+t.icon+'" style="float:left; margin-right:'+(n?5:20)+'px;">',n&&(r+="Also check out:<br>"),r+=t.description,n||(r+="</div>"),e.innerHTML=r;var i=this;e.appendChild(this.createButton(this.game.renderer.isMobile?"Download":"Play",n?{x:140,y:160,w:240,h:60}:{x:220,y:270,w:240,h:60},function(e){i.downloadGameForAd()}))},downloadGameForAd:function(){if(!this.gamead)return;if(Config_Extern)switch(Config_Extern.platform){case"iphone":this.game.shop.sendOpenAppStore(this.gamead.appstoreid);return;case"android":this.game.shop.showURL(this.gamead.links.Android,"inside");return;case"web":case"steam":this.game.shop.showURL(this.gamead.links.web,"inside");return}this.game.shop.showURL(this.gamead.links.Facebook,"inside")},showOwnProfile:function(){if(!this.game.player)return;this.closePopUp();var e=this;this.profilebackcallback=function(t){e.closePopUpNow(),e.showMainMenu()},this.game.client&&this.game.client.sendRequestPlayerProfile(this.game.player)},isFacebook:function(){return typeof FB!="undefined"},addMenuItemsToDialog:function(e,t,n){for(var r=0;r<t.length;r++){var i=t[r],s=document.createElement("div");i.cssid&&(s.id=i.cssid),s.className="menuitem"+(i.help?" tooltip":"")+(i.cssclass?" "+i.cssclass:"")+(i.selected?" selected":"")+(i.itemid=="fist"?" noanimation":""),i.help&&s.setAttribute("help",translate(i.help)),s.style.zIndex=100-r,n&&n.float&&(s.style.float=n.float),i.callback&&gui.setClick(s,i.callback,n&&n.notouch),i.rightcallback&&gui.setRightClick(s,i.rightcallback),s.appendChild(this.getImageDivForMenuItem(i));if(i.itemtype=="head"&&i.hat){var o={itemtype:"hat",hat:i.hat},u=this.getImageDivForMenuItem(o);u.style.top="-8px",s.appendChild(u)}if(i.badgeicon){var a=document.createElement("div");a.className="menubadge pixelimage",a.style.backgroundImage="url('"+i.badgeicon+"')",s.appendChild(a)}if(i.text){var f=document.createElement("div");f.className="menuitemtext",f.innerHTML=translate(i.text),i.textfont&&(f.style.font=i.textfont),s.appendChild(f)}if(i.subtitle){var f=document.createElement("div");f.className="menuitemsubtitle",f.innerHTML=translate(i.subtitle),s.appendChild(f)}if(i.stats){var f=document.createElement("div");f.className="menuitemstats",f.innerHTML=i.stats,s.appendChild(f)}e.appendChild(s)}t&&t.length>18&&e.style.top=="60px"&&!this.game.app.config.enablenewgui&&(e.style.top="30px",e.style.height="100%")},createMenuContainer:function(e,t){var n=document.createElement("div");n.style.position="absolute",n.style.left=t.x+"px";if(t.y!=undefined||t.top!=undefined)n.style.top=(t.y!=undefined?t.y:t.top)+"px";return t.bottom!=undefined&&(n.style.bottom=t.bottom+"px"),n.style.width=typeof t.w=="string"?t.w:t.w+"px",t.h!=undefined&&(n.style.height=typeof t.h=="string"?t.h:t.h+"px"),e.appendChild(n),n},getImageDivForMenuItem:function(e){var t=document.createElement("div");t.className="menuitemimage"+(e.itemtype?" menuitem"+e.itemtype:"")+(e.itemcssclass?" "+e.itemcssclass:"");if(e.itemtype){t.style.backgroundImage="url('"+this.getImageForItem(e)+"')",t.style.clip=this.getImageClipForItem(e),t.style.backgroundSize="auto",t.style.backgroundPosition="0px 0px";switch(e.itemtype){case"furniture":case"food":case"loot":case"mushroom":case"valentingem":case"candy":case"egg":t.style.backgroundSize="contain",t.style.backgroundPosition="center";break;case"body":case"head":case"armor":t.style.left="24px",t.style.top="8px";break;case"hat":case"mask":t.style.left="24px",t.style.top="2px";break;case"bow":t.style.left="32px",t.style.top="-16px",t.style.width="64px",t.style.height="96px";break;case"weapon":case"weaponskin":e["weapontype"]=="gun"||e.icon||e.image?(t.style.backgroundPosition="center",t.style.width="100%",t.style.height="72px"):(t.style.left="8px",t.style.top="16px",t.style.width="80px",t.style.height="32px");break;case"mount":t.style.backgroundSize="contain",t.style.width="100%",t.style.height="72px",t.style.clip="auto"}}else{var n=e.image&&e.image.indexOf("/")>=0?e.image:this.game.filespath+"gui/"+(e.image?e.image:"bbuilder_newbutton_default.png");t.style.backgroundImage="url('"+n+"')"}return t},getHTMLFromItemsWithOffset:function(e){var t="";for(var n in e){var r=e[n];t+='<img draggable="false" ondragstart="return false;" src="'+this.getImageForItem(r)+'" style="'+"position:absolute; left:"+r.x+"px; top:"+r.y+"px; "+"clip: "+this.getImageClipForItem(r)+'" class="pixelimage">'}return t},getHTMLFromItemsInFlow:function(e,t){var n="";for(var r in e){var i=e[r];n+='<img draggable="false" ondragstart="return false;" src="'+this.getImageForItem(i)+'" style="'+"position:absolute; "+(t?"left":"margin-left")+":"+i.x+"px; "+(t?"top":"margin-top")+":"+i.y+"px; "+"clip: "+this.getImageClipForItem(i)+'" class="pixelimage">'}return n},getImageForItem:function(e){var t=this.game.animationmanager;return e.itemtype=="armor"?t.getPathForDefault("BODY")+e.armor:e.itemtype=="head"?t.getPathForDefault("HEAD")+e.head:e.itemtype=="hat"?t.getPathForDefault("HAT")+e.hat:e.itemtype=="mask"?t.getPathForDefault("MASK")+e.mask:e.itemtype=="bow"?t.getPathForDefault("BOW")+e.bow:e.itemtype=="shield"?t.getPathForDefault("SHIELD")+e.shield:e.itemtype=="mount"&&["car"].indexOf(e.mounttype)>=0?t.getPathForDefault("MOUNT")+e.mount:e.itemtype=="weapon"&&e["weapontype"]!="gun"&&!e.icon&&!e.image?t.getPathForDefault(e["weapontype"]=="hammer"?"HAMMER":e["weapontype"]=="shovel"?"SHOVEL":"WEAPON")+(e.weaponimage||e.weapon):e.balloon?t.getPathForDefault("BALLOON")+e.balloon:this.game.filespath+"npcs/"+(e.icon||e.image)},getImageClipForItem:function(e){return["head","armor"].indexOf(e.itemtype)>=0?"rect(0px 48px 48px 0px)":["hat","mask"].indexOf(e.itemtype)>=0?"rect(0px 48px 72px 0px)":e.itemtype=="weapon"&&e["weapontype"]=="hammer"&&!e.icon&&!e.image?"rect(0px 52px 28px 0px)":e.itemtype=="weapon"&&e["weapontype"]=="shovel"&&!e.icon&&!e.image?"rect(0px 46px 17px 0px)":""},addBackButton:function(e,t,n){var r=document.createElement("div");r.className="backbutton gamewidebutton tooltip",r.setAttribute("help",translate(t)),gui.setClick(r,n),r.style.zIndex=101,e.parentNode.appendChild(r)},addMainBackButton:function(e){var t=this;this.addBackButton(e,"Go back to main menu",function(e){t.closePopUpNow(),t.showMainMenu()})},addAdminBackButton:function(e){var t=this;this.addBackButton(e,"Go back to the admin menu",function(e){t.closePopUpNow(),t.showAdminMenu()})},addProfileMoreBackButton:function(e){var t=this;this.addBackButton(e,"Go back to the player profile",function(e){t.showMenuByName("profilemore",!0)})},addAdminActionsBackButton:function(e){var t=this;this.addBackButton(e,"Go back to the admin actions",function(e){t.closePopUpNow(),t.showPlayerAdminOptions()})},createButton:function(e,t,n){var r=t.mobile&&this.game.renderer.isMobile?2:1,i;return t.help?(i=document.createElement("div"),i.innerHTML=translate(e),i.className="button tooltip",i.setAttribute("help",translate(t.help)),i.style.textAlign="center"):(i=document.createElement("input"),i.type="submit",i.value=translate(e),i.className="button"),t.classname&&(i.className=t.classname+" "+i.className),t.x!=undefined||t.left!=undefined?i.style.left=(t.x!=undefined?t.x:t.left)*r+"px":t.right!=undefined&&(i.style.right=t.right*r+"px"),t.y!=undefined||t.top!=undefined?i.style.top=(t.y!=undefined?t.y:t.top)*r+"px":t.bottom!=undefined&&(i.style.bottom=t.bottom*r+"px"),i.style.width=t.w*r+"px",i.style.height=t.h*r+"px",i.style.lineHeight=t.h*r-(t.help?0:6)+"px",i.style.zIndex=101,n&&gui.setClick(i,n),i},addWindowIcon:function(e,t){if(!t)return;var n=[{itemtype:"head",head:this.game.animationmanager.expandGameFilename("head",t.head)},{itemtype:"hat",hat:this.game.animationmanager.expandGameFilename("hat",t.hat)}];for(var r in n){var i=n[r];if(i[i.itemtype].length<=0)continue;var s=document.createElement("div");s.className="pixelimage",s.style.position="absolute",this.game.app.config.enablenewgui?(s.style.left="20px",s.style.top=""+(i.itemtype=="hat"?-6:10)+"px"):(s.style.left="-18px",s.style.top=""+(i.itemtype=="hat"?-28:-12)+"px"),s.style.width="48px",s.style.height="48px",s.style.backgroundImage="url('"+this.getImageForItem(i)+"')",s.style.clip=this.getImageClipForItem(i),s.style.pointerEvents="none",e.parentNode.appendChild(s)}},showPlayerProfile:function(){},showProfileMore:function(){},selectClanForName:function(e){this.game.client&&this.game.client.sendClanAction("getclaninfobyname",{name:e})},recruitToClan:function(){this.closePopUp(),this.game.client&&this.game.client.sendClanAction("recruit",{id:this.playerprofiledata.id})},inviteToTrade:function(){this.closePopUp(),this.game.client&&this.game.client.sendPMAction("invitetotrade",{userid:this.playerprofiledata.userid})},inviteToSpar:function(e){this.closePopUp(),this.game.client&&this.game.client.sendPMAction("invitetospar",{userid:this.playerprofiledata.userid,spartype:e})},inviteToHouse:function(){this.closePopUp(),this.game.client&&this.game.client.sendPMAction("invitetohouse",{id:this.playerprofiledata.id})},visitPlayerHouse:function(){this.closePopUp(),this.game.client&&this.game.client.sendPMAction("visithouse",{userid:this.playerprofiledata.userid})},showSidekickOptions:function(){var e=this.showPopUp({title:"Manage Pet",hideclosebutton:!0,popupType:"managesidekick"});e.innerHTML='<br><div style="font-size:24px;">'+translate("If you want that the pet is not following you anymore, then press on this button and it will be put in your inventory again.")+"</div>";var t=this;e.appendChild(this.createButton("Stop pet following you",{x:192,y:200,w:280,h:40},function(e){t.putSidekickInInventory()})),this.addBackButton(e,"Go back to the player profile",function(e){t.showMenuByName("profile",!0)})},putSidekickInInventory:function(){this.closePopUp(),this.game.client&&this.game.client.sendRemoveSidekicks()},makeTextDivAt:function(e,t,n,r,i,s,o,u){var a="<div "+(s?'id="'+s+'" ':"")+(o?'class="'+o+'" ':"")+(u?'help="'+translate(u)+'" ':"")+'style="position:absolute;';return n.x!=undefined||n.left!=undefined?a+="left:"+(n.x!=undefined?n.x:n.left)+"px;":n.right!=undefined&&(a+="right:"+n.right+"px;"),n.y!=undefined||n.top!=undefined?a+="top:"+(n.y!=undefined?n.y:n.top)+"px;":n.bottom!=undefined&&(a+="bottom:"+n.bottom+"px;"),a+="font-size:22px;"+(r?r:"")+'"><b>',a+=(i?e:"")+(t?' <img src="'+(t.indexOf("/")>=0?t:this.game.filespath+"gui/"+t)+'" style="vertical-align:middle;"> ':""),a+=(i?"":e)+"</b></div>\n",a},makeTextDivAtNew:function(e,t,n,r,i){var s="<div "+(i?'id="'+i+'" ':"")+(n?'class="'+n+'" ':"")+(r?'help="'+translate(r)+'" ':"")+">";return s+=(t?' <img src="'+(t.indexOf("/")>=0?t:this.game.filespath+"gui/"+t)+'" style="vertical-align:middle;"> ':"")+'<span class="profile_value">'+e+"</span></div>\n",s},makeProfileTextDivNew:function(e,t,n){return'<div class="profilefieldlabel'+(n?" "+n:"")+'">'+translate(e)+'<div class="profilefield">'+t+"</div></div>"},translateChatText:function(){var e=this.showPopUp({title:"Translate Chat",hideclosebutton:!0,popupType:"translatechat"}),t=this.playerprofiledata,n="<b>"+t.name+(t.chatlanguage?" ("+t.chatlanguage+")":"")+":</b><br><br>"+'<div style="color:lightblue;">'+t.chat+"</div><br><br>"+"<b>"+translate("Translated:")+"</b><br><br>"+'<div id="translatedchat" style="color:lightblue;"></div>';gui.setHTML(e,n),this.translateWithGoogle(gui.getDom("translatedchat"),t.chat,!0),this.addProfileMoreBackButton(e)},showSparTypes:function(){var e=this.showPopUp({title:"Choose a Spar",hideclosebutton:!0,popupType:"spartypes"}),t='<div style="position:absolute;width:100%;bottom:30px;height:40px;"><center>';t+=translate("Training only! Go to the spar arena to get spar wins."),t+="</center></div>",e.innerHTML=t;var n=this,r=[{help:"Invite to a mixed spar",image:"bbuilder_newbutton_mixspar.png",text:"All Weapons",callback:function(e){n.closePopUpNow(),n.inviteToSpar("mixed")}},{help:"Invite to a melee spar",image:"bbuilder_newbutton_invitespar.png",text:"Melee",callback:function(e){n.closePopUpNow(),n.inviteToSpar("melee")}}];this.playerprofiledata&&this.playerprofiledata.canbowspar&&r.push({help:"Invite to a bow spar",image:"bbuilder_newbutton_bow.png",text:"Bows",callback:function(e){n.closePopUpNow(),n.inviteToSpar("bow")}}),this.addMenuItemsToDialog(e,r),this.addProfileMoreBackButton(e)},showPlayerAdminOptions:function(){var e="Admin Actions"+(this.playerprofiledata?": "+this.playerprofiledata.name:""),t=this.showPopUp({title:e,hideclosebutton:!0,popupType:"adminactions"}),n=[],r=this;if(this.playerprofiledata){this.playerprofiledata.cansummon&&n.push({help:"Move the player to your position",image:"bbuilder_newbutton_summon.png",text:"Summon",callback:function(e){r.closePopUpNow(),r.adminActionOnPlayer("summon")}}),this.playerprofiledata.canwarpto&&n.push({help:"Move to the player",image:"bbuilder_newbutton_warpto.png",text:"Warpto",callback:function(e){r.closePopUpNow(),r.adminActionOnPlayer("warpto")}}),this.playerprofiledata.canunstick&&n.push({help:"Move the player back to start",image:"bbuilder_newbutton_unstick.png",text:"Unstick",callback:function(e){r.closePopUpNow(),r.adminActionOnPlayer("unstickplayer")}}),this.playerprofiledata.candisconnect&&n.push({help:"Disconnect the player",image:"bbuilder_newbutton_disconnect.png",text:"Disconnect",callback:function(e){r.closePopUpNow(),r.adminActionOnPlayer("disconnect")}}),this.playerprofiledata.canrefillarrows&&n.push({help:"Refill the arrows of the player",image:"bbuilder_newbutton_addarrows.png",text:"Refill Arrows",callback:function(e){r.closePopUpNow(),r.adminActionOnPlayer("refillarrows")}}),this.playerprofiledata.canrefillbombs&&!this.game.app.config.disablebombs&&n.push({help:"Refill the bombs of the player",image:"bbuilder_newbutton_addbombs.png",text:"Refill Bombs",callback:function(e){r.closePopUpNow(),r.adminActionOnPlayer("refillbombs")}}),this.playerprofiledata.canresetname&&n.push({help:"Reset the name of the player",image:"bbuilder_newbutton_resetname.png",text:"Reset Name",callback:function(e){r.closePopUpNow(),r.adminActionOnPlayer("resetname")}}),this.playerprofiledata.canresetstatus&&n.push({help:"Reset the status of the player",image:"bbuilder_newbutton_resetstatus.png",text:"Reset Status",callback:function(e){r.closePopUpNow(),r.adminActionOnPlayer("resetstatus")}}),this.playerprofiledata.canjail&&n.push({help:"Jail player",image:"bbuilder_newbutton_jail.png",text:"Jail",callback:function(e){r.closePopUpNow(),r.showJailOptions()}}),this.playerprofiledata.cantojail&&n.push({help:"Warp yourself to the jail",image:"bbuilder_newbutton_tojail.png",text:"Visit Jail",callback:function(e){r.closePopUpNow(),r.adminActionOnPlayer("tojail")}}),this.playerprofiledata.canaddcoins&&n.push({help:"Add Coins",image:"bbuilder_newbutton_buycoins.png",text:"Add Coins",callback:function(e){r.closePopUpNow(),r.showAddCoinsOptions()}}),this.playerprofiledata.canaddeventcoin&&n.push({help:"Add Event Coin/Gem",image:"bbuilder_newbutton_addeventcoin.png",text:"Event Coin",callback:function(e){r.closePopUpNow(),r.adminAddEventCoin()}}),this.playerprofiledata.canstealth&&n.push({help:"Stealth "+(this.game.player&&this.game.player.stealth?"Off":"On"),image:"bbuilder_newbutton_stealth.png",text:"Stealth "+(this.game.player&&this.game.player.stealth?"Off":"On"),callback:function(e){r.closePopUpNow(),r.stealthAction()}}),this.playerprofiledata.canstealthhigh&&n.push({help:"Stealth High",image:"bbuilder_newbutton_stealth.png",text:"Stealth High",callback:function(e){r.closePopUpNow(),r.stealthAction("high")}}),this.playerprofiledata.canviewinventory&&n.push({help:"Inspect Inventory",image:"bbuilder_newbutton_items.png",text:"Items",callback:function(e){r.closePopUpNow(),r.showAdminInventory(!0)}}),this.playerprofiledata.canviewtrades&&n.push({help:"List Trades",image:"bbuilder_newbutton_trade.png",text:"Trades",callback:function(e){r.closePopUpNow(),r.game.tradingmanager.showTradeHistory(null,!0,0,!0)}}),this.playerprofiledata.canlockitems&&n.push({help:"Lock Inventory & Trade",image:"bbuilder_newbutton_lockitems.png",text:"Lock Items",callback:function(e){r.closePopUpNow(),r.lockItems(!0)}}),this.playerprofiledata.canunlockitems&&n.push({help:"Unlock Inventory & Trade",image:"bbuilder_newbutton_unlockitems.png",text:"Unlock Items",callback:function(e){r.closePopUpNow(),r.lockItems(!1)}}),this.playerprofiledata.canresetstory&&n.push({help:"Remove the story from the profile",image:"bbuilder_newbutton_resetstory.png",text:"Reset Story",callback:function(e){r.closePopUpNow(),r.adminActionOnPlayer("resetstory")}}),this.playerprofiledata.caneditstories&&n.push({help:"Edit Stories",image:"bbuilder_newbutton_stories.png",text:"Stories",callback:function(e){r.closePopUpNow(),r.game.storymanager.showStoryMenu({forceload:!0,offset:0,userid:r.playerprofiledata.userid})}});if(this.playerprofiledata.canadmintag&&this.game.player){var i=this.game.player.clanname=="Admin"?"Clear Tag":"Set Admin Tag";n.push({help:i,image:"bbuilder_newbutton_admintag.png",text:i,callback:function(e){r.closePopUpNow(),r.setOrClearAdminTag()}})}}this.addMenuButtons(n,"adminactions",this.playerprofiledata),this.addMenuItemsToDialog(t,n),this.addProfileMoreBackButton(t)},adminActionOnPlayer:function(e){this.game.client&&this.playerprofiledata&&this.game.client.sendChat("/"+e+" "+this.playerprofiledata.userid)},lockItems:function(e){this.game.client&&this.playerprofiledata&&this.game.client.sendChat("/lockitems "+this.playerprofiledata.userid+" "+(e?"on":"off"))},stealthAction:function(e){this.game.client&&this.game.player&&(e||(e=this.game.player.stealth?"off":"on"),this.game.client.sendChat("/stealth "+e))},setOrClearAdminTag:function(){this.game.client&&this.game.player&&(this.game.player.clanname=="Admin"?this.game.client.sendChat("/cleartag"):this.game.client.sendChat("/settag Admin"))},showJailOptions:function(){var e=this.showPopUp({title:"Jail Player",hideclosebutton:!0,popupType:"jailoptions"}),t=this.playerprofiledata,n=t.injail,r=t.jailreason?t.jailreason:"Swearing and misbehaving",i=Math.max(0,t.jailtimeleft?t.jailtimeleft:3600),s;n?s=translate("This player is in jail. Update the jail reason and duration, or set to zero to unjail."):s=translate("Type the reason and duration (in seconds) for jailing the player. 1 Hour = 3600 Seconds.");var o=this;e.innerHTML='<div style="font-size:24px">'+s+"<br><br>\n"+'<form id="jailplayerform" name="jailplayerform" style="width:100%;">\n'+'<div style="position: absolute; left: 0px; top: 100px;">'+translate("Reason:")+"</div>"+'<textarea type="text" name="reason"'+' style="position: absolute; top: 100px; left: 160px; width:432px; height:160px">'+r+"</textarea>\n"+'<div style="position: absolute; left: 0px; top: 290px;">'+translate("Duration:")+"</div>"+'<input type="text" name="duration" style="position: absolute; top: 290px; left: 160px; width:432px; height:32px;" value="'+i+'">\n'+'<input type="submit" value="'+(n?translate("Update"):translate("Jail"))+'"'+' style="position: absolute; top: 340px; left: 270px; width: 200px; height: 40px;" class="inputbutton">\n'+"</form><div>";var u=gui.getDom("jailplayerform");u.onsubmit=function(e){return o.jailPlayer(),!1},this.addAdminActionsBackButton(e)},jailPlayer:function(){var e=document.jailplayerform.reason.value.trim().replace(/"/g,""),t=parseInt(document.jailplayerform.duration.value.trim());if(e.length<=0)return;if(t<=0&&!this.playerprofiledata.injail)return;this.closePopUp(),this.game.client&&this.playerprofiledata&&this.game.client.sendChat("/jail "+this.playerprofiledata.userid+" "+t+' "'+e+'"')},showAddCoinsOptions:function(){var e=this.showPopUp({title:"Add Coins to Player",hideclosebutton:!0,popupType:"addcoinstoplayer"}),t=[],n=[50,100,200,500];for(var r in n)t.push(this.getAdminAddCoinsMenuItem(n[r]));this.addMenuItemsToDialog(e,t),this.addAdminActionsBackButton(e)},getAdminAddCoinsMenuItem:function(e){var t=this;return{help:"Adds "+e+" coins",image:"bbuilder_newbutton_buycoins.png",text:"+"+e,textfont:"30px "+this.game.defaultfont,callback:function(n){t.closePopUpNow(),t.addCoinsToPlayer(e)}}},addCoinsToPlayer:function(e){this.closePopUp(),this.game.client&&this.playerprofiledata&&this.game.client.sendChat("/addcoins "+this.playerprofiledata.userid+" "+e)},adminAddEventCoin:function(){this.closePopUp(),this.game.client&&this.playerprofiledata&&this.game.client.sendChat("/addeventcoin "+this.playerprofiledata.userid)},showAdminInventory:function(e){e&&this.game.client&&this.game.client.sendGetAdminInventory(this.playerprofiledata.userid);var t=this.showPopUp({title:translate("Inventory of %s",[this.playerprofiledata.name]),hideclosebutton:!0,popupType:"admininventory"}),n=[];for(var r in this.admininventory){var i=this.admininventory[r];if(i.hideininventory)continue;var s=this.getItemCategory(i);n.indexOf(s)<0&&n.push(s)}n.sort();var o=[];for(var r in n)o.push(this.createAdminCategoryMenuItem(n[r]));this.addMenuItemsToDialog(t,o),this.addAdminActionsBackButton(t)},handleAdminInventory:function(e,t){if(!this.playerprofiledata||e!=this.playerprofiledata["userid"])return;this.admininventory=t,this.sortInventoryItems(this.admininventory,!0),this.showAdminInventory(!1)},createAdminCategoryMenuItem:function(e){var t=this,n=this.getNameForCategory(e);return{text:n,help:translate("View the %s!",[translate(n)]),callback:function(n){t.closePopUpNow(),t.showAdminCategory(e)},image:"bbuilder_folder_"+e+".png"}},showAdminCategory:function(e,t){var n=this.showPopUp({title:this.getNameForCategory(e),hideclosebutton:!0,popupType:"admincategory",overlap:!0}),r=this.getItemsPerPage();t||(t=0);var i=0;for(var s in this.admininventory){var o=this.admininventory[s];if(o.hideininventory||this.getItemCategory(o)!=e)continue;i++}var u=this,a=[];for(var s in this.admininventory){var o=this.admininventory[s];if(o.hideininventory||this.getItemCategory(o)!=e)continue;this.extendAdminItemMenuItem(o),a.push(o)}a.sort();var f=a.length;f>r&&(a=a.slice(t,t+r)),this.addMenuItemsToDialog(n,a),f>r&&(t>0&&n.parentNode.appendChild(this.createButton("Prev",this.getPrevButtonPosition(),function(n){u.showAdminCategory(e,Math.max(0,t-r))})),f>t+r&&n.parentNode.appendChild(this.createButton("Next",this.getNextButtonPosition(),function(n){u.showAdminCategory(e,t+r)}))),this.addBackButton(n,"Go back to categories",function(e){u.closePopUpNow(),u.showAdminInventory(!1)})},getPrevButtonPosition:function(){var e=this.game.app.config.enablenewgui;return{right:80,y:e?7:-8,w:80,h:40}},getNextButtonPosition:function(){var e=this.game.app.config.enablenewgui;return{right:0,y:e?7:-8,w:80,h:40}},extendAdminItemMenuItem:function(e){var t=this;e.text=(e.nr&&e.nr>1?e.nr+" x ":"")+e.name,e.help=e.text,!this.playerprofiledata.canrefundupload||e["itemid"].indexOf("headc")!=0&&e["itemid"].indexOf("bodyc")!=0&&e["itemid"].indexOf("hatc")!=0?this.playerprofiledata.canremoveitem&&(e.callback=function(n){t.closePopUpNow(),t.showRemoveItemScreen(e)},e.help=translate("Remove %s",[e.name])):(e.callback=function(n){t.closePopUpNow(),t.showRefundItemScreen(e)},e.help=translate("Refund %s",[e.name])),e.rightcallback=function(n,r,i){t.openItemConfig(e,n.target,r,i)},this.prepareItemAttributes(e)},showRefundItemScreen:function(e){var t=this.showPopUp({title:"Refund Upload",hideclosebutton:!0,popupType:"refundupload"}),n="Do you want to refund the "+this.getItemCategory(e)+" with name "+e.name+" for "+this.playerprofiledata.name+" ("+this.playerprofiledata.userid+")?";n+=this.getSmallCharacterPreview(e["itemtype"]=="armor"?e.armor:this.playerprofiledata.armor,e["itemtype"]=="head"?e.head:this.playerprofiledata.head,e["itemtype"]=="hat"?e.hat:e["itemtype"]=="head"?null:this.playerprofiledata.hat,e["itemtype"]=="mask"?e.mask:this.playerprofiledata.mask,260,120),t.innerHTML=n;var r=this,i=e["itemid"].indexOf("hatc")==0?e.itemid.substr(4):e.itemid.substr(5);i.substr(-3)=="gif"&&(i=i.substr(0,i.length-3)),t.appendChild(this.createButton("Refund",{x:232,y:300,w:200,h:40},function(e){r.closePopUp(),r.game.client.sendChat("/refundupload "+r.playerprofiledata.userid+" "+i)}));var r=this;this.addBackButton(t,"Go back to items",function(t){r.closePopUpNow(),r.showAdminCategory(r.getItemCategory(e),0)})},showRemoveItemScreen:function(e){var t=this.showPopUp({title:"Remove Item",hideclosebutton:!0,popupType:"removeitem"}),n="Do you want to remove the "+this.getItemCategory(e)+" with name "+e.name+" ("+e.itemid+") for "+this.playerprofiledata.name+" ("+this.playerprofiledata.userid+")?",r=this.getImageForItem(e),i=this.getImageClipForItem(e);n+='<img src="'+r+'" style="position:absolute;left:300px;top:100px;clip:'+i+';" />',t.innerHTML=n;var s=this;t.appendChild(this.createButton("Remove",{x:232,y:300,w:200,h:40},function(t){s.closePopUp(),s.game.client.sendChat("/removeitem "+s.playerprofiledata.userid+" "+e.itemid)}));var s=this;this.addBackButton(t,"Go back to items",function(t){s.closePopUpNow(),s.showAdminCategory(s.getItemCategory(e),0)})},showAccountInfo:function(e){e&&this.game.client&&this.game.client.sendGetAccountInfo();var t=this.game.app.config.enabledeletemenu&&Config_Extern&&Config_Extern["platform"]=="iphone",n=this.showPopUp({title:"Account Info",hideclosebutton:!0,popupType:"accountinfo"}),r="";if(this.accountinfo){r+='<div style="position:absolute; padding:20px; left:0px;top:180px;width:100%;">',r+="<font color=lime>"+translate("Profile id:")+"</font> "+this.accountinfo.userid+"<br>\n",r+=translate("You have played %s.",["<font color=lime>"+this.accountinfo.onlinetimestr+"</font>"])+"<br>\n";if(this.accountinfo.logintype&&this.accountinfo["logintype"]!="cookie"){var i=this.accountinfo.logintype;if(this.accountinfo["logintype"]=="cognito"){i=translate("New Sign-In");var s=this.accountinfo.loginusername;s&&s.indexOf("facebook_")==0?i+=" (Facebook)":s&&s.indexOf("google_")==0?i+=" (Google)":s&&s.indexOf("apple_")==0&&(i+=" (Apple)")}r+=translate("You are logged in with %s.",["<font color=lime>"+i+"</font>"])+"<br>\n",this.accountinfo.loginemail&&(r+=translate("Your e-mail is %s.",["<font color=lime>"+this.accountinfo.loginemail+"</font>"])+"<br>\n");if(!t){var o="support@iappsbeats.com";r+=translate("Contact %s for account deletion.",[o])+"<br>\n"}}else r+="You are not registered.<br>\n";r+="</div>"}else r+="<br><center><i>Loading...</i></center>";n.innerHTML=r;if(this.accountinfo){var u=this,a=[{help:"See your own profile (or click on yourself)!",image:"bbuilder_newbutton_profile.png",text:"Profile",callback:function(e){u.closePopUpNow(),u.showOwnProfile()}},{help:"Get support on Discord!",image:"bbuilder_newbutton_forum.png",text:"Discord",callback:function(e){u.game.shop.showURL(u.game.app.config.forumurl,"inside")}},{help:"Privacy Policy",image:"bbuilder_newbutton_about.png",text:"Privacy Policy",callback:function(e){u.closePopUpNow(),u.showPrivacyPolicy()}}],f=this.accountinfo["logintype"]!="device"&&this.accountinfo["logintype"]!="cookie"&&Config_Extern&&(Config_Extern["platform"]=="web"||Config_Extern["platform"]=="steam"||Config_Extern.version>=3);t&&this.accountinfo["logintype"]!="cookie"&&a.push({help:"Delete Account",image:"bbuilder_newbutton_logout.png",text:"Delete",callback:function(e){u.closePopUpNow(),u.showDeleteMenu()}}),f&&a.push({help:"Logout From Account",image:"bbuilder_newbutton_logout.png",text:"Logout",callback:function(e){u.closePopUpNow(),u.showConfirmLogout()}});var l=this.createMenuContainer(n,{x:t?60:120,y:20,w:t?600:480,h:180});this.addMenuItemsToDialog(l,a)}this.addMainBackButton(n)},handleAccountInfo:function(e){this.accountinfo=e,this.showAccountInfo(!1)},showRegister:function(){var e=this.showPopUp({title:"Register",popupType:"register"})},showFriends:function(e,t,n){var r=this.getItemsPerPage();e?this.friendsdata=e:(!this.friendsdata||t)&&this.game.client&&this.game.client.sendPMAction("getfriends",{offset:n?n:0,limit:r});var i;if(this.friendsdata&&this.friendsdata.canpage&&(this.friendsdata.offset>0||this.friendsdata.friends&&this.friendsdata.friends.length>=r)){var s=this.friendsdata?1+Math.floor(this.friendsdata.offset/r):1;i=translate("Friends")+": "+translate("Page %s",[s])}else this.friendsdata&&this.friendsdata.nick?i=translate("Search")+": "+this.friendsdata.nick:i="Friends";var o=this.showPopUp({title:i,hideclosebutton:!0,popupType:"friends",overlap:!0});if(this.friendsdata&&this.friendsdata.friends&&this.friendsdata.friends.length>0){var u=[];for(var a in this.friendsdata.friends)u.push(this.getFriendMenuItem(this.friendsdata.friends[a]));this.addMenuItemsToDialog(o,u)}else this.friendsdata&&this.friendsdata.offset==0&&(o.innerHTML='<div style="font-size:24px"><br><br><center>'+(this.friendsdata.nick?translate("No players with that nick found."):translate("There are no friends yet. Tap on players and make them your friends!"))+"<br><div>");var f=this;this.friendsdata&&this.friendsdata.canpage&&(this.friendsdata.offset>0&&o.parentNode.appendChild(this.createButton("Prev",this.getPrevButtonPosition(),function(e){f.showFriends(null,!0,f.friendsdata.offset-r)})),this.friendsdata.friends&&this.friendsdata.friends.length>=r&&o.parentNode.appendChild(this.createButton("Next",this.getNextButtonPosition(),function(e){f.showFriends(null,!0,f.friendsdata.offset+r)})));var l=this.game.app.config.enablenewgui;o.parentNode.appendChild(this.createButton("Search",{right:l?20:0,bottom:l?10:-18,w:145,h:40},function(e){f.closePopUpNow(),f.showSearchPlayer()},!0)),this.addMainBackButton(o)},getFriendMenuItem:function(e){var t=e.name.substring(0,25);if(!this.friendsdata.nick){var n=t.indexOf("(");n>=0&&(t=t.substring(0,n).trim())}var r=this;return{text:t,itemtype:"head",head:this.game.animationmanager.expandGameFilename("head",e.head),hat:this.game.animationmanager.expandGameFilename("hat",e.hat),mask:this.game.animationmanager.expandGameFilename("mask",e.mask),cssclass:"menuitemsmall",help:translate("View profile of %s!",[t]),callback:function(t){r.closePopUpNow(),r.showClanMemberProfile(e.userid,function(e){r.closePopUpNow(),r.showFriends()})},badgeicon:e.isonline?this.game.filespath+"gui/bbuilder_onlineindicator.png":null}},addFriend:function(){this.closePopUp(),this.game.client&&this.game.client.sendPMAction("addfriend",{userid:this.playerprofiledata.userid})},removeFriend:function(){this.closePopUp(),this.game.client&&this.game.client.sendPMAction("removefriend",{userid:this.playerprofiledata.userid})},blockProfile:function(){this.closePopUp(),this.game.client&&this.game.client.sendPMAction("blockuser",{userid:this.playerprofiledata.userid})},unblockProfile:function(){this.closePopUp(),this.game.client&&this.game.client.sendPMAction("unblockuser",{userid:this.playerprofiledata.userid})},showSearchPlayer:function(){var e=this.showPopUp({title:"Search for Players",hideclosebutton:!0,popupType:"searchplayer"}),t=this;e.innerHTML='<div style="font-size:24px"><br><center><form id="searchplayerform" name="searchplayerform" style="width:100%;">\n'+translate("Nick Name:")+' <input type="text" id="searchplayernickname" name="searchplayernickname" style="width:360px; height:32px;" value="">\n'+'<input type="submit" value="'+translate("Search")+'" class="inputbutton">\n'+"</form>"+"<br>"+translate("Search for a player - type the nick name or partial nick name.")+"</center>\n"+"</div>";var n=gui.getDom("searchplayerform");n.onsubmit=function(e){return t.searchPlayer(),!1},this.addBackButton(e,"Go back to the friends list",function(e){t.closePopUpNow(),t.showFriends()}),gui.focus("searchplayernickname")},searchPlayer:function(){var e=document.searchplayerform.searchplayernickname.value.trim();if(e.length<=0)return;this.closePopUpNow(),this.showFriends(),this.game.client&&this.game.client.sendPMAction("searchplayers",{nick:e})},inviteFriends:function(){if(!this.isFacebook())return;FB.ui({method:"apprequests",message:this.game.app.config.invitemessage},this.inviteCallback)},inviteCallback:function(e){},showSettings:function(){var e=["Graphics","Interface","Music","Invitations"];this.game.renderer.isMobile||e.push("Keyboard"),this.settingscategory===undefined&&(this.settingscategory=e[0]);var t=this.showPopUp({title:translate("Settings")+": "+translate(this.settingscategory),hideclosebutton:!0,popupType:"settings"}),n=[{id:"gamezoom",category:"Graphics",title:"Game zoom",type:"range",min:.4,max:2.5},{id:"fps20",category:"Graphics",title:"Limit fps"},{id:"smallsync",category:"Graphics",title:"Only show players near you"},{id:"sortbytime",category:"Interface",title:"Sort items by time"},{id:"buttonzoom",category:"Interface",title:"Button zoom",type:"range",min:.5,max:2},{id:"notranslate",category:"Interface",title:"Turn off translation"},{id:"soundsoff",category:"Music",title:"Turn off sound effects"},{id:"sfxvol",category:"Music",title:"Sound volume",type:"range",min:.1,max:1},{id:"musicoff",category:"Music",title:"Turn off music"},{id:"musvol",category:"Music",title:"Music volume",type:"range",min:.1,max:1},{id:"nohouseinvites",category:"Invitations",title:"No house invitations"},{id:"noclaninvites",category:"Invitations",title:"No clan invitations"},{id:"nosparinvites",category:"Invitations",title:"No spar invitations"},{id:"notradeinvites",category:"Invitations",title:"No trade invitations"},{id:"nolikemsg",category:"Invitations",title:"No like notifications"},{id:"nopmnotification",category:"Invitations",title:"No PM notifications"},{id:"nopvpwarning",category:"Invitations",title:"No PvP warnings"}];this.game.app.config.primaryweapon=="sword"&&n.push({id:"hidesidekicks",category:"Graphics",title:"Hide pets which follow other players"}),n.push({id:"noweather",category:"Graphics",title:"Hide weather/snow"}),n.push({id:"nodaynight",category:"Graphics",title:"No day-night cycle"}),this.game.app.config.enablehitbox&&n.push({id:"hitbox",category:"Graphics",title:"Draw Hit Box/Circle"}),this.game.app.config.enable3dmode&&n.push({id:"mode3d",category:"Graphics",title:"3D Mod (Experimental)"}),this.game.app.config.font&&n.push({id:"newfont",category:"Graphics",title:"New text font"}),(this.game.renderer.isMobile||this.game.settings.buttonspacing)&&n.push({id:"buttonspacing",category:"Interface",title:"Add button spacing"}),n.push({id:"hidehome",category:"Interface",title:"Hide the home button"}),n.push({id:"hideminimap",category:"Interface",title:"Hide the minimap (on right side)"}),n.push({id:"noministories",category:"Interface",title:"No guide videos on mini map"}),n.push({id:"hidenames",category:"Interface",title:"Hide player names (show with N key)"}),n.push({id:"noingametv",category:"Music",title:"No TV videos"});var r=this,i=t;for(var s in e)t.appendChild(this.getCategoryButton(s,e[s]));i=this.createMenuContainer(t,{x:0,top:60,w:640,bottom:0}),gui.addClass(i,"scrollable");var o="";o+='<form name="settingsform" style="width:100%;">\n';var u=0;for(var s in n){var a=n[s];if(a.category!=this.settingscategory)continue;if(["sfxvol","musvol"].indexOf(a.id)>=0&&Config_Extern&&Config_Extern["platform"]=="iphone")continue;var f=this.game.settings[a.id];!f&&a.id=="gamezoom"&&(f=this.game.renderer.zoom),a.type=="range"&&(u+=15,f||(f=1)),o+='<div style="position: absolute; top: '+u+'px; left: 20px; height: 40px;">'+(a.type=="range"?'<input type="range" id="checkbox'+a.id+'" name="'+a.id+'" min="'+a.min+'" max="'+a.max+'" step="0.05" value="'+f+'"'+' style="width:360px; margin-right:20px;">'+'<label id="label'+a.id+'">'+translate(a.title)+" "+f+"</label>":'<label style="white-space: nowrap; cursor:pointer;"><input type="checkbox" id="checkbox'+a.id+'" name="'+a.id+'" '+(f?"checked":"")+">"+translate(a.title)+"</label>")+"</div><br>",u+=a.type=="range"?60:40}if(this.settingscategory=="Keyboard"){var l=0;for(var c in this.game.defaultKeySettings){var h=this.game.defaultKeySettings[c],p=this.game.settings.keys&&this.game.settings.keys[c]?this.game.settings.keys[c]:h,d=c;this.game.app.config.primaryweapon!="gun"&&h.altTitle&&(d=h.altTitle);var v=Math.floor(l/4),m=l%4;o+='<label for="KeySetting'+c+'" style="position:absolute;left:'+(m*160+5)+"px;top:"+(v*40+8)+"px;"+' width:80px;display:inline-block;font-size:14px;">'+translate(d)+"</label>"+'<input type="text" name="'+c+'" id="KeySetting'+c+'" value="'+p.n+'"'+' style="position:absolute;left:'+(m*160+80)+"px;top:"+v*40+'px;width:75px;height:30px;font-size:15px;text-align:center;">',l++}}o+="</form>";var g=document.createElement("div");g.innerHTML=o,i.appendChild(g);for(var s in n){var a=n[s];if(a.category==this.settingscategory){var y=gui.getDom("checkbox"+a.id);y&&(a.type=="range"?y.oninput=this.getRangeSettingFunction(a):y.onchange=function(e){r.onCheckboxSettingsChange(e.target)})}}if(this.settingscategory=="Keyboard"){for(var c in this.game.defaultKeySettings){var b=gui.getDom("KeySetting"+c);b&&(b.onclick=function(e){e.target.value=translate("Press Key!"),e.target.style.backgroundColor="lime"},b.onkeydown=this.onKeySettingKey(b,c),b.onblur=this.onKeySettingBlur(b,c))}i.appendChild(this.createButton("Reset",{right:0,bottom:20,w:132,h:40},function(e){r.game.settings.keys&&(delete r.game.settings.keys,r.game.onSettingsChanged(!0),r.showSettings())}))}this.addMainBackButton(t)},onKeySettingKey:function(e,t){var n=this;return function(e){switch(e.which){case 27:gui.blur(e.target);break;case 46:n.clearKeySetting(t),n.game.onSettingsChanged(!0),gui.blur(e.target);break;default:if(t=="Emoticon"&&[16,17,18].indexOf(e.which)<0)return!1;n.setKeySetting(t,e.which,e.key),n.game.onSettingsChanged(!0),gui.blur(e.target)}return!1}},clearKeySetting:function(e){this.game.settings.keys||(this.game.settings.keys={}),this.game.settings.keys[e]={k:null,n:""}},setKeySetting:function(e,t,n){n=n?n.trim():String.fromCharCode(t),n.length<=0&&t==32?n="Space":n.length==1&&n.toUpperCase().length==1&&(n=n.toUpperCase());var r=this.game.defaultKeySettings[e];t==r.k&&n==r.n?(this.game.settings.keys&&this.game.settings.keys[e]&&delete this.game.settings.keys[e],this.game.settings.keys&&Object.keys(this.game.settings.keys).length<=0&&delete this.game.settings.keys):(this.game.settings.keys||(this.game.settings.keys={}),this.game.settings.keys[e]={k:t,n:n});for(var i in this.game.defaultKeySettings)if(i!=e&&this.game.getKeyForAction(i)==t){this.clearKeySetting(i);var s=gui.getDom("KeySetting"+i);s&&(s.value="")}},onKeySettingBlur:function(e,t){var n=this;return function(e){e.target.value=n.game.getKeyNameForAction(t),e.target.style.backgroundColor="white"}},getCategoryButton:function(e,t){var n=this;return this.createButton(t,{x:e*132,y:0,w:132,h:40},function(e){n.settingscategory=t,n.showSettings()})},getRangeSettingFunction:function(e){var t=this;return function(n){t.onRangeSettingsChange(n.target,e)}},onRangeSettingsChange:function(e,t){var n=e.value?e.value:1;n!=1||e.name=="gamezoom"?(this.game.settings[e.name]=n,this.game.onSettingsChanged(!0)):(delete this.game.settings[e.name],this.game.onSettingsChanged(!0));var r=gui.getDom("label"+e.name);r&&(r.innerHTML=translate(t.title)+" "+n)},onCheckboxSettingsChange:function(e){e.checked&&!this.game.settings[e.name]?(this.game.settings[e.name]=!0,this.game.onSettingsChanged(!0)):!e.checked&&this.game.settings[e.name]&&(delete this.game.settings[e.name],this.game.onSettingsChanged(!0))},showUploadGraphic:function(){this.uploaddata=null;var e=this.showPopUp({title:"Upload Custom Graphic",hideclosebutton:!0,popupType:"uploadgraphic"});this.addUploadHTML(e,this.game.app.config.uploadavailabletypes,!0);var t=this,n=this.createButton("Upload",{x:405,y:300,w:180,h:40},function(e){t.closePopUpNow(),t.showWaitingScreen("Upload Graphic",translate("Uploading the graphic...")),t.uploaddata&&t.game.client&&t.game.client.sendUploadAction("upload",t.uploaddata)});n.id="characteruploadbutton",n.style.display="none",e.appendChild(n),this.addMainBackButton(e)},addUploadHTML:function(e,t,n){var r='<div id="characterfiledrop" class="uploadstitched" style="position:absolute; width:300px; height:300px;">    <p id="characterfilestatus" class="uploaddroptext">'+(this.game.renderer.isMobile?"":translate("Drop files here!"))+"</p>"+'    <canvas id="charactercanvas" width=160 height=160 style="width:300px;height:300px;"></canvas>'+"</div>"+'<div style="position:absolute; bottom:27px; width: 360px; height:30px; text-align: center;">'+'    <select name="CustomType" id="CharacterCustomTypeField" style="width:80px;">';for(var i in t)r+="<option"+(t[i]=="HEAD"?" selected":"")+">"+t[i]+"</option>";r+='    </select>    <input type="file" name="Custom" id="CharacterCustomField" style="display:none;">    <label for="CharacterCustomField" style="cursor:pointer; width:120px;"><u>'+translate("Or choose a file")+"</u></label>"+"</div>",n&&(r+='<div id="characteruploadtext1" style="position:absolute; left: 360px; top:20px; width: 300px; height: 300px; ">'+translate("Choose a file and preview it on the character on the left side. Click inside the preview to change the direction of the character.<br>Supported graphic types: %s",[t])+"</div>"+'<div id="characteruploadtext2" style="display: none; position:absolute; left: 360px; top:20px; width: 300px; height: 300px; ">'+translate("You are uploading:<br>- A %s<br>- %s bytes<br>- Cost: %s<br>After uploading an admin will check and approve it.",['<span id="characteruploadtype">Hat</span>','<span id="characteruploadsize">20000</span>','<span id="characteruploadprice">1000 Coins</span>'])+"<br>"+"</div>"),e.innerHTML=r;var s=gui.getDom("characterfiledrop"),o=this.game.storymanager.drawStoryInCanvas("charactercanvas",s,{type:"game",data:[{ani:"player_walk",head:this.game.player.head,hat:this.game.player.hat,mask:this.game.player.mask,armor:this.game.player.armor}]});this.configureGraphicUploadActions(s,gui.getDom("CharacterCustomField"),gui.getDom("CharacterCustomTypeField"),o.player)},handleUploadAction:function(e,t){switch(e){case"uploadsuccess":this.game.showGeneralMessage(t.message),this.isShowingUploadMenu()&&this.closePopUpNow();break;case"uploadfailed":this.getCurrentMenu()=="uploadshopitem"?this.showAlert(t.message,"Upload"):(this.game.showGeneralMessage(t.message),this.isShowingUploadMenu()&&this.closePopUpNow());break;case"uploadid":this.updateUploadItemID(t);break;case"playerupload":this.isShowingUploadMenu()&&(this.closePopUpNow(),this.showUploadAdminMenu(!1,t));break;case"adminerror":this.game.showGeneralMessage(t.message),t.close&&(this.closePopUpNow(),this.showAdminMenu())}},isShowingUploadMenu:function(){var e=this.getCurrentMenu();return e&&(e=="waitingscreen"||e.indexOf("upload")>=0)},configureGraphicUploadActions:function(e,t,n,r){var i=function(e){return e.preventDefault&&e.preventDefault(),!1};e.addEventListener("dragover",i),e.addEventListener("dragenter",i);var s=this;e.addEventListener("drop",function(e){e=e||window.event,e.preventDefault&&e.preventDefault();var t=e.dataTransfer.files;for(var n=0;n<t.length;n++){var i=t[n],o=new FileReader;o.onload=function(e){s.replaceCharacterImage(r,s.getGraphicType(i.name),i.name,e.target.result)},o.readAsDataURL(i)}return!1}),t.addEventListener("change",function(e){if(t.files.length<=0)return;var i=t.files[0],o=new FileReader;return o.onload=function(e){s.replaceCharacterImage(r,n.value,i.name,e.target.result)},o.readAsDataURL(i),!0}),t.addEventListener("click",function(){this.value=""},!1)},replaceCharacterImage:function(e,t,n,r){var i=gui.getDom("characterfilestatus");if(!t){i&&(i.innerHTML=translate("Unknown File Type"));return}if(this.getCurrentMenu()!="uploadshopitem"&&this.game.app.config.uploadavailabletypes.indexOf(t)<0){i&&(i.innerHTML=translate("Unsupported File Type"));return}var s=n.indexOf(".gif")>=0,o=t=="HAT"?this.game.app.config.uploadpricehat:t=="HEAD"?this.game.app.config.uploadpricehead:this.game.app.config.uploadpricebody;this.uploaddata={type:t,filename:n,data:r.substring(r.indexOf(",")+1,r.length),price:typeof o=="string"?o:o+(s?this.game.app.config.giftopprice:0)+" Coins"},this.uploaddata.size=atob(this.uploaddata.data).length;var u=document.createElement("img");u.src=r;var a={filename:n,image:u};if(s)try{var f=r.substring(r.indexOf(",")+1,r.length),l=atob(f);this.game.renderer.loadGifData(a,l)}catch(c){}var h=e.game.animationmanager,p=h.getPathForDefault(t)+h.expandGameFilename(t.toLowerCase()+(t!="BODY"?"s":""),e[t=="BODY"?"armor":t.toLowerCase()]);e.game.renderer.customtextures[p]=a,i&&(i.innerHTML=t+":<br>"+n),this.getCurrentMenu()=="uploadshopitem"?this.configureUploadShopItemButton():this.configureUploadDataButton(),t=="BOW"&&e.dir==Types.Orientations.DOWN&&(e.dir=Types.Orientations.UP)},configureUploadDataButton:function(){var e=1e5,t=!1,n=gui.getDom("characteruploadtype");n&&(n.innerHTML=this.uploaddata.type+(this.uploaddata.filename.indexOf(".gif")>=0?" gif":"")),n=gui.getDom("characteruploadsize"),n&&(n.innerHTML=this.uploaddata.size,this.uploaddata.size>e?(t=!0,n.style.color="red"):n.style.color="white"),n=gui.getDom("characteruploadprice"),n&&(n.innerHTML=this.uploaddata.price);var r=gui.getDom("characteruploadbutton");r&&(r.style.display=t?"none":"block"),n=gui.getDom("characteruploadtext1"),n&&(n.style.display="none"),n=gui.getDom("characteruploadtext2"),n&&(n.style.display="block")},getGraphicType:function(e){return e.indexOf("head")>=0?"HEAD":e.indexOf("body")>=0?"BODY":e.indexOf("hat")>=0?"HAT":e.indexOf("mask")>=0?"MASK":e.indexOf("sword")>=0||e.indexOf("dagger")>=0||e.indexOf("blade")>=0?"WEAPON":e.indexOf("bow")>=0?"BOW":e.indexOf("shield")>=0?"SHIELD":null},showUploadAdminMenu:function(e,t){e&&this.game.client&&this.game.client.sendUploadAction("getupload",{}),t&&(this.playerupload=t);var n=this.showPopUp({title:"Check Uploads",hideclosebutton:!0,popupType:"checkuploads"}),r='<div style="font-size:24px;">';if(this.playerupload){var i=this.playerupload.type;r+='<div style="width: 380px;">',r+=translate("Player:")+" "+this.playerupload.name+" ("+this.playerupload.userid+")<br>",r+=translate("Type:")+" "+i+"<br>",r+=translate("Uploaded: %s ago",[this.playerupload.uploadtime])+"<br>";if(this.playerupload.exists){var s=this.playerupload.exists;r+=translate("Previously uploaded by: %s (%s) %s ago",[s.name,s.userid,s.uploadtime])+" ("+(s.status==1?translate("approved"):s.status==2?translate("rejected"):s.status==3?translate("refunded"):translate("waiting in queue"))+")<br>"}r+="</div>",r+=this.getSmallCharacterPreview(i=="BODY"?this.playerupload.filename:"clotharmor",i=="HEAD"?this.playerupload.filename:"head1",i=="HAT"?this.playerupload.filename:null,i=="MASK"?this.playerupload.filename:null,100,150),r+="</div>";var o=this.game.animationmanager,u=o.getPathForDefault(i)+this.playerupload.filename;r+='<div style="position:absolute;left:400px;top:60px;">',this.game.renderer.isMobile||(r+='<a href="'+u+'" target="_blank" style="color:white;">Open File</a><br>'),r+='<img src="'+u+'"></div>',r+='<div style="position:absolute;left:0px;top:300px;width:360px;height:50px;">'+translate("Reason:")+" "+'<select name="RejectReason" id="RejectReasonField" style="width:160px;">'+'    <option value="copyright" '+(this.playerupload.exists?"":"selected")+">"+translate("Copyright")+"</option>"+'    <option value="quality">'+translate("Bad quality")+"</option>"+'    <option value="transparency">'+translate("Missing Transparency")+"</option>"+'    <option value="exists" '+(this.playerupload.exists?"selected":"")+">"+translate("Already existing")+"</option>"+'    <option value="hatonhead">'+translate("No hats on head")+"</option>"+'    <option value="invalid">'+translate("Invalid")+"</option>"+"</select></div>"}else r+="Loading...";r+="</div>",n.innerHTML=r;if(this.playerupload){var a=this;n.parentNode.appendChild(this.createButton("Next",this.getNextButtonPosition(),function(e){a.game.client.sendUploadAction("getupload",{fileid:a.playerupload.fileid})})),n.appendChild(this.createButton("View Profile",{x:468,y:0,w:200,h:40},a.getClanMemberCallback(a.playerupload.userid,function(e){a.closePopUpNow(),a.showUploadAdminMenu(!1)})));var f=gui.getDom("RejectReasonField");n.appendChild(this.createButton("Reject",{x:82,y:350,w:200,h:40},function(e){a.closePopUpNow(),a.showWaitingScreen("Rejecting Graphic","Rejecting the graphic..."),a.game.client&&a.game.client.sendUploadAction("reject",{fileid:a.playerupload.fileid,reason:f.value})})),n.appendChild(this.createButton("Approve",{x:382,y:350,w:200,h:40},function(e){a.closePopUpNow(),a.showWaitingScreen("Approving Graphic","Approving the graphic..."),a.game.client&&a.game.client.sendUploadAction("approve",{fileid:a.playerupload.fileid})}))}this.addAdminBackButton(n)},showUploadShopItem:function(){var e=this.showPopUp({title:"Upload & Configure Shop Item",hideclosebutton:!0,popupType:"uploadshopitem"});this.addUploadHTML(e,["HAT","MASK","HEAD","BODY","WEAPON","BOW"],!1),this.shopitemfields={itemtype:{row:0,title:"Type:","default":""},itemid:{row:1,title:"ID:","default":""},filename:{row:2,title:"File:","default":""},name:{row:3,title:"Name:","default":""},description:{row:4,title:"Text:","default":""},price:{row:5,title:"Price:","default":""},level:{row:6,title:"Level:","default":""}};var t='<div id="uploaditemform" style="display:none;position:absolute;left:370px;top:10px;right:0px;">\n';for(var n in this.shopitemfields){var r=this.shopitemfields[n],i=r.row*40;t+='<label id="label'+n+'" style="position:absolute;left:0px;top:'+i+'px;width:90px;height:24px">'+translate(r.title)+"</label>\n",t+='<input type="text" id="edit'+n+'" name="edit'+n+'"'+' style="position:absolute;left:90px;top:'+i+'px;right:0px;height:28px">\n'}t+="</div>\n";var s=document.createElement("div");s.innerHTML=t,e.appendChild(s);var o=this,u=this.createButton("Upload",{x:405,y:320,w:180,h:40},function(e){if(o.uploaddata&&o.game.client){o.uploaddata.item||(o.uploaddata.item={});for(var t in o.shopitemfields){var n=o.shopitemfields[t];o.uploaddata.item[t]=gui.getDom("edit"+t).value}o.game.client.sendUploadAction("uploaditem",o.uploaddata)}});u.id="itemuploadbutton",u.style.display="none",e.appendChild(u),this.addAdminBackButton(e)},configureUploadShopItemButton:function(){var e=1e5,t=this.uploaddata.size>e,n=gui.getDom("itemuploadbutton");n&&(n.style.display=t?"none":"block");var r=gui.getDom("uploaditemform");r&&(r.style.display=t?"none":"block");var i=this.game.player.name.substring(0,25),s=i.indexOf("(");s>=0&&(i=i.substring(0,s).trim()),this.shopitemfields.itemtype.default=this.uploaddata.type.toLowerCase(),this.shopitemfields.itemid.default=this.uploaddata.type.toLowerCase()+"1",this.shopitemfields.filename.default=this.uploaddata.filename,this.shopitemfields.name.default=this.uploaddata.type.substr(0,1).toUpperCase()+this.uploaddata.type.substr(1).toLowerCase()+"1",this.shopitemfields.description.default="Drawn by "+i+".",this.shopitemfields.price.default="800";for(var o in this.shopitemfields){var u=this.shopitemfields[o],a=gui.getDom("edit"+o),f=gui.getDom("label"+o);if(!a||!f)continue;o=="level"?this.uploaddata.type=="WEAPON"?(a.value=12,a.style.display="block",f.style.display="block"):(a.value="",a.style.display="none",f.style.display="none"):a.value=u.default}this.game.client&&this.game.client.sendUploadAction("getuploadid",{type:this.uploaddata.type,filename:this.uploaddata.filename})},updateUploadItemID:function(e){e.itemid&&(this.shopitemfields.itemid.default=e.itemid,gui.getDom("edititemid").value=e.itemid),e.filename&&(this.shopitemfields.filename.default=e.filename,gui.getDom("editfilename").value=e.filename),e.name&&(this.shopitemfields.name.default=e.name,gui.getDom("editname").value=e.name)},getSmallCharacterPreview:function(e,t,n,r,i,s){html='<div style="width:300px; height:100px;'+(i!=undefined&&s!=undefined?"position:absolute;left:"+i+"px;top:"+s+"px;":"")+'">';var o={itemtype:"armor",armor:this.game.animationmanager.expandGameFilename("body",e)};return html+='<img draggable="false" ondragstart="return false;" src="'+this.getImageForItem(o)+'" style="'+'position:absolute;left:0px;top:35px;clip: rect(0px 144px 48px 0px);">',o={itemtype:"head",head:this.game.animationmanager.expandGameFilename("head",t)},html+='<img draggable="false" ondragstart="return false;" src="'+this.getImageForItem(o)+'" style="'+'position:absolute;left:0px;top:10px;clip: rect(0px 144px 48px 0px);">',n&&(o={itemtype:"hat",hat:n},html+='<img draggable="false" ondragstart="return false;" src="'+this.getImageForItem(o)+'" style="'+'position:absolute;left:0px;top:-6px;clip: rect(0px 144px 72px 0px);">'),r&&(o={itemtype:"mask",mask:r},html+='<img draggable="false" ondragstart="return false;" src="'+this.getImageForItem(o)+'" style="'+'position:absolute;left:0px;top:-6px;clip: rect(0px 144px 72px 0px);">'),html+="</div>",html},showMailingMenu:function(e){if(e){this.game.client&&this.game.client.sendPMAction("getmailings",{}),this.mailinginterval&&clearInterval(this.mailinginterval);var t=this;this.mailinginterval=setInterval(function(){var e=t.getCurrentMenu();if(t.mailingMenus.indexOf(e)<0){clearInterval(t.mailinginterval),t.mailinginterval=null;return}e=="mailing"&&t.game.client.sendPMAction("getmailings",{})},1e4)}var n=this.showPopUp({title:"Push Announcement",hideclosebutton:!0,popupType:"mailing"}),r="";if(this.mailinginfo&&this.mailinginfo.mailings&&this.mailinginfo.mailings.length>0){r+="Previous Announcements:<br><br>";for(var i=0;i<this.mailinginfo.mailings.length;i++){var s=this.mailinginfo.mailings[i],o;s.senderlook&&s.senderlook.head&&(o=[{x:-4,y:-4,itemtype:"head",head:this.game.animationmanager.expandGameFilename("head",s.senderlook.head)}],s.senderlook.hat&&o.push({x:-4,y:-20,itemtype:"hat",hat:this.game.animationmanager.expandGameFilename("hat",s.senderlook.hat)})),r+='<div style="height:48px;pointer-events:none;'+(s.status==1?"color:lime;":"")+"width:100%;position:absolute;top:"+(56+i*52)+'px;">'+'<div style="float:left;"><b>'+s.timestr+" ago:</b></div> "+(o?this.getHTMLFromItemsInFlow(o):"")+'<div style="margin-left:48px;float:left;">'+s.title.substring(0,25).trim()+"</div>"+'<div style="width:130px;float:right;margin-right:50px;text-align:right;">'+(s.status==1?s.success+s.failed+"/"+s.tokennr:s.tokennr+" Pl")+"</div> "+"</div>"}}else r="There are no previous announcements. Start a new announcement!";n.innerHTML=r;if(this.mailinginfo){var t=this;this.mailinginfo.cancreate?n.appendChild(this.createButton("New Announcement",{x:212,y:300,w:240,h:40},function(e){t.closePopUpNow(),t.showNewMailingMenu()})):this.mailinginfo.canstop&&n.appendChild(this.createButton("Stop",{x:232,y:300,w:200,h:40},function(e){t.stopMailing()}))}this.addAdminBackButton(n)},showNewMailingMenu:function(){var e=this.showPopUp({title:"New Announcement",hideclosebutton:!0,popupType:"mailingnew"}),t=this,n='<div style="font-size:24px">'+translate("Enter a title and message to send an announcement via push notification. You can use emojis.")+"<br><br>\n"+'<form id="createmailingform" name="createmailingform" style="width:100%;">\n'+'<div style="position: absolute; left: 0px; top: 100px;">'+translate("Title:")+"</div>"+'<input type="text" name="title" style="position: absolute; top: 100px; left: 160px; width:432px; height:32px;" value="">\n'+'<div style="position: absolute; left: 0px; top: 150px;">'+translate("Message:")+"</div>"+'<textarea type="text" name="text"'+' style="position: absolute; top: 150px; left: 160px; width:432px; height:160px"></textarea>\n'+'<input type="submit" value="'+translate("Create Announcement")+'"'+' style="position: absolute; top: 340px; left: 250px; width: 240px; height: 40px;" class="inputbutton">\n'+"</form><div>";e.innerHTML=n;var r=gui.getDom("createmailingform");r.onsubmit=function(e){return t.createMailing(),!1},this.addBackButton(e,"Go back",function(e){t.closePopUpNow(),t.showMailingMenu(!1)})},createMailing:function(){var e=document.createmailingform.title.value.trim(),t=document.createmailingform.text.value.trim();if(e.length<=0||t.length<=0)return;this.game.client&&this.game.client.sendPMAction("startmailing",{title:e,text:t}),this.closePopUpNow(),this.showMailingMenu(!0)},stopMailing:function(){this.game.client&&this.game.client.sendPMAction("stopmailing",{newsletter:this.mailinginfo.mailings[0].newsletter})},handleMailingAction:function(e,t){switch(e){case"mailinginfo":this.mailinginfo=t,this.mailingMenus.indexOf(this.getCurrentMenu())>=0&&(this.closePopUpNow(),this.showMailingMenu(!1));break;case"newmailing":this.closePopUpNow(),this.showMailingMenu(!0);break;case"message":case"error":this.showAlert(t.message,"Notifications")}},showAbout:function(){var e=this.showPopUp({title:"About "+this.game.app.config.gamename,hideclosebutton:!0,popupType:"about"}),t='<div style="font-size:24px;">'+this.game.app.config.aboutme+"</div>";e.innerHTML=t,this.addMainBackButton(e)},showPrivacyPolicy:function(){var e=this.showPopUp({title:"Privacy Policy",hideclosebutton:!0,popupType:"privacy"}),t="<div style=\"font-size:24px; position:absolute; left:0px; top:0px; width:100%; height:100%;\" class=\"scrollable\"><style>#ppBody{    font-size:15pt;    width:100%;    margin:0 auto;    text-align:justify;}#ppHeader{    font-family:verdana;    font-size:21pt;    width:100%;    margin:0 auto;}</style><div id='ppHeader'>iAppsBeats Privacy Policy</div><div id='ppBody'><div style='clear:both;height:10px;'></div><div style='font-style:italic;'>(scroll down for more)</div><div style='clear:both;height:10px;'></div><div class='innerText'>This privacy policy has been compiled to better serve those who are concerned with how their 'Personally Identifiable Information' (PII) is being used online. PII, as described in US privacy law and information security, is information that can be used on its own or with other information to identify, contact, or locate a single person, or to identify an individual in context. Please read our privacy policy carefully to get a clear understanding of how we collect, use, protect or otherwise handle your Personally Identifiable Information in accordance with our website and apps.<br></div><span id='infoCo'></span><br><div class='grayText'><strong>What personal information do we collect from the people that visit our blog, website or app?</strong></div><br /><div class='innerText'>When registering on our site or apps, as appropriate, you may be asked to enter your name, email address, game profile or other details to help you with your experience.</div><br><div class='grayText'><strong>When do we collect information?</strong></div><br /><div class='innerText'>We collect information from you when you register on our site or apps or enter information on our site or app.</div><br><div class='grayText'><strong>How do we use your information? </strong></div><br /><div class='innerText'> We may use the information we collect from you when you register, make a purchase, sign up for our newsletter, respond to a survey or marketing communication, surf the website, or use certain other site or app features in the following ways:<br><br></div><div class='innerText'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>&bull;</strong> To personalize your experience and to allow us to deliver the type of content and product offerings in which you are most interested.</div><div class='innerText'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>&bull;</strong> To allow us to better service you in responding to your customer service requests.</div><span id='infoPro'></span><br><div class='grayText'><strong>How do we protect your information?</strong></div><br /><div class='innerText'>Our website is scanned on a regular basis for security holes and known vulnerabilities in order to make your visit to our site as safe as possible.</div><div class='innerText'>An external PCI compliant payment gateway handles all CC transactions.<br><br></div><div class='innerText'>Your personal information is contained behind secured networks and is only accessible by a limited number of persons who have special access rights to such systems, and are required to keep the information confidential. In addition, all sensitive/credit information you supply is encrypted via Secure Socket Layer (SSL) technology. </div><br><div class='innerText'>We implement a variety of security measures when a user enters, submits, or accesses their information to maintain the safety of your personal information.</div><br><div class='innerText'>All transactions are processed through a gateway provider and are not stored or processed on our servers.</div><span id='coUs'></span><br><div class='grayText'><strong>How can you request deletion of your data?</strong></div><br /><div class='innerText'>Send an e-mail to support@iappsbeats.com.<br><br></div><div class='grayText'><strong>Do we use 'cookies'?</strong></div><br /><div class='innerText'>Yes. Cookies are small files that a site or its service provider transfers to your computer's hard drive through your Web browser (if you allow) that enables the site's or service provider's systems to recognize your browser and capture and remember certain information. For instance, we use cookies to help us remember and process the items in your shopping cart. They are also used to help us understand your preferences based on previous or current site activity, which enables us to provide you with improved services. We also use cookies to help us compile aggregate data about site traffic and site interaction so that we can offer better site experiences and tools in the future.</div><div class='innerText'><br><strong>We use cookies to:</strong></div><div class='innerText'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>&bull;</strong> Understand and save user's preferences for future visits.</div><div class='innerText'><br>You can choose to have your computer warn you each time a cookie is being sent, or you can choose to turn off all cookies. You do this through your browser settings. Since browser is a little different, look at your browser's Help Menu to learn the correct way to modify your cookies.<br></div><div class='innerText'><br><strong>If users disable cookies in their browser:</strong></div><br><div class='innerText'>If you turn cookies off it will turn off some of the features of the site.</div><span id='trDi'></span><br><div class='grayText'><strong>Third-party disclosure</strong></div><br /><div class='innerText'>We do not sell, trade, or otherwise transfer to outside parties your personally identifiable information unless we provide you with advance notice. This does not include website hosting partners and other parties who assist us in operating our website, conducting our business, or servicing you, so long as those parties agree to keep this information confidential. We may also release your information when we believe release is appropriate to comply with the law, enforce our site policies, or protect ours or others' rights, property, or safety.</div><span id='trLi'></span><br><div class='grayText'><strong>Third-party links</strong></div><br /><div class='innerText'><i>YouTube</i><br>Our website uses plugins from YouTube, which is operated by Google. The operator of the pages is YouTube LLC, 901 Cherry Ave., San Bruno, CA 94066, USA.If you visit one of our pages featuring a YouTube plugin, a connection to the YouTube servers is established. Here the YouTube server is informed about which of our pages you have visited.If you're logged in to your YouTube account, YouTube allows you to associate your browsing behavior directly with your personal profile. You can prevent this by logging out of your YouTube account.YouTube is used to help make our website appealing. This constitutes a justified interest pursuant to GDPR.Further information about handling user data, can be found in the data protection declaration of YouTube under https://www.google.de/intl/de/policies/privacy.<br><br><i>Facebook Connect and Google Sign-In</i><br>You can log-in to our site using sign-in services such as Facebook Connect and Google-Sign-In. These services will authenticate your identity and provide you the option to share certain personal information with us such as your name and email address to personilize the game experience.<br><br>We receive following information from Facebook when you choose to login by Facebook:<ul><li>Your name</li><li>Your e-mail address</li><li>Your gender</li><li>Your language</li></ul>When you authenticate with Google Sign-In, we will receive following info about you:<ul><li>Your name</li><li>Your e-mail address</li><li>Your language</li></ul>Your data is used in following ways:<br><ul><li>Name: when registering, your first name will be used as your name in the game. You can change it at any time by using the /setname command.</li><li>E-Mail: the e-mail address is used to identify your account. We will send a new password to that e-mail if requested.</li><li>Gender: the gender (if provided) is used to intialize your character with a male or female look, but can be changed in the game.</li><li>Language: the language is used to show you translated text in your language.</li></ul>You can request the deletion of your data by sending an e-mail to support@iappsbeats.com.<br></div><span id='gooAd'></span><br><div class='blueText'><strong>Google Advertising</strong></div><br /><div class='innerText'>Google's advertising requirements can be summed up by Google's Advertising Principles. They are put in place to provide a positive experience for users. https://support.google.com/adwordspolicy/answer/1316548?hl=en <br></div><div class='innerText'>We have not enabled Google AdSense on our site but we may do so in the future.</div><span id='calOppa'></span><br><div class='blueText'><strong>California Online Privacy Protection Act</strong></div><br /><div class='innerText'>CalOPPA is the first state law in the nation to require commercial websites and online services to post a privacy policy.  The law's reach stretches well beyond California to require any person or company in the United States (and conceivably the world) that operates websites collecting Personally Identifiable Information from California consumers to post a conspicuous privacy policy on its website stating exactly the information being collected and those individuals or companies with whom it is being shared. -  See more at: http://consumercal.org/california-online-privacy-protection-act-caloppa/#sthash.0FdRbT51.dpuf<br></div><div class='innerText'><br><strong>According to CalOPPA, we agree to the following:</strong><br></div><div class='innerText'>Users can visit our site anonymously.</div><div class='innerText'>Once this privacy policy is created, we will add a link to it on our home page or as a minimum, on the first significant page after entering our website.<br></div><div class='innerText'>Our Privacy Policy link includes the word 'Privacy' and can easily be found on the page specified above.</div><div class='innerText'><br>You will be notified of any Privacy Policy changes:</div><div class='innerText'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>&bull;</strong> On our Privacy Policy Page<br></div><div class='innerText'>Can change your personal information:</div><div class='innerText'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>&bull;</strong> By logging in to your account</div><div class='innerText'><br><strong>How does our site handle Do Not Track signals?</strong><br></div><div class='innerText'>We honor Do Not Track signals and Do Not Track, plant cookies, or use advertising when a Do Not Track (DNT) browser mechanism is in place. </div><div class='innerText'><br><strong>Does our site allow third-party behavioral tracking?</strong><br></div><div class='innerText'>It's also important to note that we do not allow third-party behavioral tracking</div><span id='coppAct'></span><br><div class='blueText'><strong>COPPA (Children Online Privacy Protection Act)</strong></div><br /><div class='innerText'>When it comes to the collection of personal information from children under the age of 13 years old, the Children's Online Privacy Protection Act (COPPA) puts parents in control.  The Federal Trade Commission, United States' consumer protection agency, enforces the COPPA Rule, which spells out what operators of websites and online services must do to protect children's privacy and safety online.<br><br></div><div class='innerText'>We do not specifically market to children under the age of 13 years old.</div><span id='ftcFip'></span><br><div class='blueText'><strong>Fair Information Practices</strong></div><br /><div class='innerText'>The Fair Information Practices Principles form the backbone of privacy law in the United States and the concepts they include have played a significant role in the development of data protection laws around the globe. Understanding the Fair Information Practice Principles and how they should be implemented is critical to comply with the various privacy laws that protect personal information.<br><br></div><div class='innerText'><strong>In order to be in line with Fair Information Practices we will take the following responsive action, should a data breach occur:</strong></div><div class='innerText'>We will notify the users via in-site notification</div><div class='innerText'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>&bull;</strong> Within 30 business day</div><div class='innerText'><br>We also agree to the Individual Redress Principle which requires that individuals have the right to legally pursue enforceable rights against data collectors and processors who fail to adhere to the law. This principle requires not only that individuals have enforceable rights against data users, but also that individuals have recourse to courts or government agencies to investigate and/or prosecute non-compliance by data processors.</div><span id='canSpam'></span><br><div class='blueText'><strong>CAN SPAM Act</strong></div><br /><div class='innerText'>The CAN-SPAM Act is a law that sets the rules for commercial email, establishes requirements for commercial messages, gives recipients the right to have emails stopped from being sent to them, and spells out tough penalties for violations.<br><br></div><div class='innerText'><strong>We collect your email address in order to:</strong></div><div class='innerText'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>&bull;</strong> Send information, respond to inquiries, and/or other requests or questions</div><div class='innerText'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>&bull;</strong> Process orders and to send information and updates pertaining to orders.</div><div class='innerText'><br><strong>To be in accordance with CANSPAM, we agree to the following:</strong></div><div class='innerText'><strong><br>If at any time you would like to unsubscribe from receiving future emails, you can email us at</strong></div> and we will promptly remove you from <strong>ALL</strong> correspondence.</div><br><span id='ourCon'></span><br><div class='blueText'><strong>Contacting Us</strong></div><br /><div class='innerText'>If there are any questions regarding this privacy policy, you may contact us using the information below.<br><br></div><div class='innerText'>support@iappsbeats.com</div><div class='innerText'><br>Last Edited on 2021-11-23</div></div></div>";e.innerHTML=t;var n=this;this.addBackButton(e,"Go back to account menu",function(e){n.closePopUpNow(),n.showAccountInfo(!1)})},showInventory:function(e,t){this.inventoryfromgame=t,e&&this.game.client&&this.game.client.sendGetInventory(),this.game.app.config.enablebackpackani&&this.game.player&&this.game.player.canSetAnimation()&&this.game.player.getAnimation()!="backpack_search"&&this.game.player.stopAndAnimate("backpack_open");var n=this.inventoryitemset?translate("Event Items")+" - "+this.inventoryitemset:translate("Item Folders");!this.inventoryitemset&&!this.game.renderer.isMobile&&(n+=" ("+this.game.getKeyNameForAction("Items")+" "+translate("key")+")");var r=this.showPopUp({title:n,hideclosebutton:!t,popupType:"inventory"}),i=[],s=this.game.app.config.disableitemcategories||[];for(var o in this.inventoryitems){var u=this.inventoryitems[o];if(u.hideininventory)continue;var a=this.getItemCategory(u);i.indexOf(a)<0&&s.indexOf(a)<0&&i.push(a)}i.sort();var f=[];for(var o in i)f.push(this.createCategoryMenuItem(i[o]));this.addMenuItemsToDialog(r,f);var l=this.game.app.config.enablenewgui,c=this;this.inventoryitems&&r.parentNode.appendChild(this.createButton("Search",{right:l?20:0,bottom:l?10:-18,w:145,h:40},function(e){c.closePopUpNow("searchitem"),c.showSearchItem(!1)},!0)),r.parentNode.appendChild(this.createButton("Trades",{x:l?20:0,bottom:l?10:-18,w:145,h:40},function(e){c.closePopUpNow("tradehistory"),c.game.tradingmanager.showTradeHistory(null,!0,0)},!0)),t||this.addMainBackButton(r)},getItemCategory:function(e,t){return t&&["weaponskin","food","mount"].indexOf(e.itemtype)>=0?"weapon":!t&&e["itemtype"]=="weapon"&&["script","torch","tool"].indexOf(e.weapontype)>=0&&e.level<=1?"tool":!t&&e["itemtype"]=="weapon"&&["item","morph"].indexOf(e.weapontype)>=0?e.weapontype:e["itemtype"]=="furniture"&&e["furnituretype"]=="pet"?"pet":["egg","candy","valentingem","itembox","currency","ghostcoin","ec"].indexOf(e.itemtype)>=0?"valuable":e["itemtype"]=="quest"&&this.game.app.config.primaryweapon!="gun"?"valuable":e.itemtype},createCategoryMenuItem:function(e){var t=this,n=this.getNameForCategory(e);return{text:n,help:translate("View your %s!",[translate(n)]),callback:function(n){t.closePopUpNow("category");var r=0;t.game.player&&["head","hat","mask","armor","weapon"].indexOf(e)>=0&&(r=t.game.player[e]),t.showCategory({category:e,offset:r,fromhotkey:!1},!1)},image:"bbuilder_folder_"+e+".png"}},createSearchCategoryMenuItem:function(e,t){var n=this,r=this.getNameForCategory(e);return{text:r,help:translate("View your %s!",[translate(r)]),callback:function(r){n.closePopUpNow("itemsearchresult"),n.showItemsBySearch("category:"+e,0,t)},image:"bbuilder_folder_"+e+".png"}},showSearchItem:function(e){this.showsearchfortrade=e,!this.inventoryitems&&this.game.client&&this.game.client.sendGetInventory();var t=this.showPopUp({title:"Search for Items",hideclosebutton:!0,popupType:"searchitem"}),n=this;t.innerHTML='<div style="font-size:24px"><br><center><form id="searchitemform" name="searchitemform" style="width:100%;">\n'+translate("Name:")+' <input type="text" id="searchitemname" name="searchitemname" style="width:360px; height:32px;" value="">\n'+'<input type="submit" value="'+translate("Search")+'" class="inputbutton"></center>\n'+"</form>\n"+"<br><center>"+translate("Search for an item - type the name or partial name.")+"\n"+"<br>"+translate("or show items of following types:")+"</center></div>";var r=gui.getDom("searchitemform");r.onsubmit=function(t){return n.searchItem(e),!1};var i=[],s=this.game.app.config.searchcategories;if(s&&s.length>0){var o=e?[]:this.game.app.config.disableitemcategories||[];for(var u in this.inventoryitems){var a=this.inventoryitems[u];if(a.hideininventory)continue;var f=this.getItemCategory(a);i.indexOf(f)<0&&o.indexOf(f)<0&&s.indexOf(f)>=0&&i.push(f)}}i.sort();var l=[];for(var u in i)l.push(this.createSearchCategoryMenuItem(i[u],e));var c=this.createMenuContainer(t,{x:0,y:220,w:640,h:160});this.addMenuItemsToDialog(c,l),e?this.addBackButton(t,"Go back to trading",function(e){n.game.tradingmanager.showTradeMenu(n.game.tradingmanager.tradeinfo)}):this.addBackButton(t,"Go back to categories",function(e){n.closePopUpNow("inventory"),n.showInventory(!1,n.inventoryfromgame)}),gui.focus("searchitemname")},searchItem:function(e){var t=document.searchitemform.searchitemname.value.trim();if(t.length<=0)return;this.closePopUpNow("itemsearchresult"),this.showItemsBySearch(t,0,e)},addClansBackButton:function(e){var t=this;this.addBackButton(e,"Go back to the clans menu",function(e){t.closePopUpNow(),t.showClansMenu(!1)})},addManageClansBackButton:function(e){var t=this;this.addBackButton(e,"Go back to manage the clan",function(e){t.closePopUpNow(),t.showManageClan()})},addClanInfoBackButton:function(e){var t=this;this.addBackButton(e,"Go back to view the clan",function(e){t.closePopUpNow(),t.showClanInfo()})},getNameForCategory:function(e){switch(e){case"adventgift":return"Advent Calendar";case"armor":return"Clothes";case"food":return this.game.app.config.primaryweapon=="gun"?"Food+Heal":"Food";case"bow":case"bomb":return this.game.app.config.disablebombs?"Bows":"Bows+Bombs";case"furniture":return"Furniture";case"tool":return"Tools+Music";case"weaponskin":return"Skins";case"mount":return this.game.app.config.primaryweapon=="gun"?"Mounts+Cars":"Mounts";default:return e?e.charAt(0).toUpperCase()+e.substring(1)+"s":"Category"}},addInventoryItems:function(e,t){this.inventoryitems=e,this.inventoryitemset=t,this.sortInventoryItems(this.inventoryitems,!this.game.settings.sortbytime);switch(this.getCurrentMenu()){case"inventory":this.closePopUpNow("inventory"),this.showInventory(!1,this.inventoryfromgame);break;case"category":this.closePopUpNow("category"),this.showCategory(this.inventoryCategory,!1);break;case"searchitem":this.closePopUpNow("searchitem"),this.showSearchItem(this.showsearchfortrade)}},sortInventoryItems:function(e,t){e.sort(function(e,n){return e.price<n.price?-1:e.price>n.price?1:t&&e.name<n.name?-1:t&&e.name>n.name?1:0})},showCategory:function(e,t){var n=e.fromhotkey?translate("Item for Hotkey")+" "+e.fromhotkey:this.getNameForCategory(e.category);!e.fromhotkey&&this.inventoryitemset&&(n+=" "+translate("(Event: %s)",[this.inventoryitemset]));var r=this.showPopUp({title:n,hideclosebutton:!e.fromhotkey,popupType:"category",overlap:!0}),i=this.getItemsPerPage();e.offset||(e.offset=0),this.inventoryCategory=e,(t||!this.inventoryitems)&&this.game.client&&this.game.client.sendGetInventory();var s=0;if(this.inventoryitems){for(var o in this.inventoryitems){var u=this.inventoryitems[o];if(u.hideininventory||this.getItemCategory(u,e.fromhotkey)!=e.category)continue;typeof e.offset=="string"&&(u["itemid"]==e.offset||u[e.category]==e.offset)&&(e.offset=Math.floor(s/i)*i),s++}typeof e.offset=="string"&&(e.offset=0)}var a="";s<=12&&(a+=this.getCategoryHelp(e.category)),r.innerHTML=a;var f=[];for(var o in this.inventoryitems){var u=this.inventoryitems[o];if(u.hideininventory||this.getItemCategory(u,e.fromhotkey)!=e.category)continue;this.extendItemMenuItem(u,!1),f.push(u)}var l=this;e.category=="bow"&&this.game.app.config.primaryweapon!="gun"&&!this.game.app.config.disablebombs&&f.splice(0,0,{callback:function(e){l.closePopUpNow(),l.game.client.sendUseInventory("bomb","equip")},text:"Bombs",help:"Equip Bombs!",image:"bbuilder_icon_menubomb.png"});var c=f.length;c>i&&(f=f.slice(e.offset,e.offset+i)),this.addMenuItemsToDialog(r,f);if(c>i){var h=this.game.app.config.enablenewgui;e.offset>0&&r.parentNode.appendChild(this.createButton("Prev",{x:e.fromhotkey?h?490:468:h?540:508,y:h?7:-8,w:80,h:40},function(e){l.inventoryCategory.offset=Math.max(0,l.inventoryCategory.offset-i),l.showCategory(l.inventoryCategory,!1)})),c>e.offset+i&&r.parentNode.appendChild(this.createButton("Next",{x:e.fromhotkey?h?570:548:h?625:588,y:h?7:-8,w:80,h:40},function(e){l.inventoryCategory.offset+=i,l.showCategory(l.inventoryCategory,!1)}))}e.fromhotkey||this.addBackButton(r,"Go back to categories",function(e){l.closePopUpNow("inventory"),l.showInventory(!1,l.inventoryfromgame)})},getCategoryHelp:function(e){var t='<div style="position:absolute;width:100%;bottom:30px;height:40px;"><center>';switch(e){case"armor":case"hat":case"mask":t+=translate("Choose an item to wear!");break;case"furniture":t+=translate("Choose a furniture to drop!");break;case"pet":t+=translate("Choose a pet to place!");break;case"head":t+=translate("Choose a look to apply!");break;case"food":t+=translate("Choose an item to eat or drink!");break;case"adventgift":case"valuable":case"loot":case"nitro":case"mushroom":return"";case"bow":t+=translate("Choose an item to equip or unequip!");break;default:t+=translate("Choose an item to equip!")}return t+="</center></div>",t},extendItemMenuItem:function(e,t){var n=this;e.callback=function(r){t?(n.closePopUpNow("trade"),"nr"in e&&e["nr"]!=1?n.game.tradingmanager.showChangeTradeItem(e,!0):n.game.tradingmanager.addTradeItem(e.itemid,1)):(n.closePopUpNow(),n.inventoryCategory.fromhotkey?n.game.addHotkey(n.inventoryCategory.fromhotkey,e):n.game.client.sendUseInventory(e.itemid,"equip"))},e.text=(e.nr&&e.nr>1?e.nr+" x ":"")+e.name,e["itemtype"]=="weapon"&&["sword","script"].indexOf(e.weapontype)>=0&&e.level>1&&(e.stats="lvl "+e.level);switch(e.itemtype){case"mushroom":e.help=translate("%s, sell at mushroom shop",[e.text]);break;case"trash":e.help=translate("%s, sell at recycling center shop",[e.text]);break;case"loot":e.help=translate("%s, sell at loot shop",[e.text]);break;case"valentingem":case"candy":case"nitro":case"egg":e.help=translate("%s, use this to buy special items",[e.text]);break;case"adventgift":e.help=e.name;break;default:e.help=translate("Equip/Use %s!",[e.name])}this.game.player&&this.game.player.isGameAdmin()&&(e.rightcallback=function(t,r,i){n.openItemConfig(e,t.target,r,i)}),this.prepareItemAttributes(e)},prepareItemAttributes:function(e){e.image=e.image,e.itemtype=e.itemtype,e.hat=e.hat,e.mask=e.mask,e.head=e.head,e.bow=e.bow,e.armor=e.armor,e.weapon=e.weapon,e.mount=e.mount,e.shield=e.shield},openItemConfig:function(e,t,n,r){var i=gui.getOffset(t),s=this;this.game.filemanager.showRightClickMenu(i.left+n,i.top+r,["Edit Item Config"],null,function(){s.game.filemanager.loadAndShowItemConfig(e)})},showItemsBySearch:function(e,t,n){var r=e&&e.indexOf("category:")==0?e.substring("category:".length):null,i=translate("Item Search:")+" "+(r?this.getNameForCategory(r):e),s=this.showPopUp({title:i,hideclosebutton:!0,popupType:"itemsearchresult",overlap:!0});this.inventoryCategory={category:"search",offset:t,fromhotkey:!1};var o=this.getItemsPerPage();t||(t=0);var u=this,a=[];for(var f in this.inventoryitems){var l=this.inventoryitems[f];if(l.hideininventory&&(!n||!l.allowtrade))continue;if(r){if(this.getItemCategory(l)!=r)continue}else if((!l.name||l.name.toLowerCase().indexOf(e.toLowerCase())<0)&&l.itemid.indexOf(e.toLowerCase())<0)continue;this.extendItemMenuItem(l,n),a.push(l)}var c=a.length;c>0?(c>o&&(a=a.slice(t,t+o)),this.addMenuItemsToDialog(s,a)):s.innerHTML='<div style="font-size:24px"><br><br><center>'+translate("No items with that name found.")+"<br><div>";if(c>o){var h=this.game.app.config.enablenewgui;t>0&&s.parentNode.appendChild(this.createButton("Prev",{x:h?540:508,y:h?7:-8,w:80,h:40},function(r){u.showItemsBySearch(e,Math.max(0,t-o),n)})),c>t+o&&s.parentNode.appendChild(this.createButton("Next",{x:h?625:588,y:h?7:-8,w:80,h:40},function(r){u.showItemsBySearch(e,t+o,n)}))}this.addBackButton(s,"Go back to search",function(e){u.closePopUpNow("searchitem"),u.showSearchItem(n)})},handleMapMarkers:function(e){if(!e)return;this.receivedmapmarkers||(this.receivedmapmarkers={}),this.receivedmapmarkers[e.map]=e,e.islive&&(this.markerdata=e,this.showMenuByName("map",!0))},showMapAndLoad:function(){this.game.client&&this.game.mapmanager.currentmap&&this.game.client.sendGetMapMarkers(this.game.mapmanager.currentmap.mapname),this.showMenuByName("map",!0)},showOldMap:function(){},addMapMarkers:function(e,t){var n=this.game.animationmanager,r=t.width,i=t.height,s=t.offsetx?t.offsetx:0,o=t.offsety?t.offsety:0,u=this.game.app.config.markerpos,a=gui.getWidth(e),f=t["map"]=="main"?gui.getHeight(e):a*i/r;for(var l in t.markers){var c=t.markers[l],h=Math.floor((c.x-s)*a/r),p=Math.floor((c.y-o)*f/i),d=null;c.icon&&(d=document.createElement("div"),d.style.backgroundImage="url('"+n.getPathForDefault("ICON")+c.icon+"')",d.style.backgroundSize="contain",d.style.backgroundRepeat="no-repeat",d.style.position="absolute",d.style.left=Math.max(0,h-16)+"px",d.style.top=Math.max(0,p-16)+"px",d.style.width="32px",d.style.height="32px",d.style.pointerEvents="none",c.blink&&(d.style.animation="blink .75s steps(1) infinite"),e.appendChild(d));if(c.building&&u&&u[c.building]){h=u[c.building].x,p=u[c.building].y;var v=document.createElement("div");v.style.backgroundImage="url('"+this.game.filespath+"gui/bbuilder_mapownerback.png')",v.style.backgroundSize="160px 72px",v.style.position="absolute",v.style.left=h-78+"px",v.style.top=p-48+"px",v.style.width="160px",v.style.height="72px",e.appendChild(v),d&&(d=d.cloneNode(!1),d.style.left=h-28+"px",d.style.top=p-32+"px",d.style.width="48px",d.style.height="48px",e.appendChild(d))}e.appendChild(this.getMapPin(h,p,c.text,"pin"))}for(var l in t.friends){var m=t.friends[l];this.addMapPlayerIcon(e,t,m)}this.game.player&&this.game.player.head&&this.game.mapmanager.currentmap.mapname==t["map"]&&this.addMapPlayerIcon(e,t,this.game.player)},getMapPin:function(e,t,n,r){var i=document.createElement("div");return i.className=r,i.style.left=e+"px",i.style.top=t+"px",i.style.zIndex=t,i.style.pointerEvents="none",i.innerHTML=translate(n),i},addMapPlayerIcon:function(e,t,n){var r=t.width,i=t.height,s=t.offsetx?t.offsetx:0,o=t.offsety?t.offsety:0,u=gui.getWidth(e),a=gui.getHeight(e),f=t["map"]=="main"?a:u*i/r,l=Math.floor(((n.gridX?n.gridX:n.x)-s)*u/r-24),c=Math.floor(((n.gridY?n.gridY:n.y)-o)*f/i-24),h={itemtype:"head",head:this.game.animationmanager.expandGameFilename("head",n.head)},p=document.createElement("img");p.style.clip=this.getImageClipForItem(h),p.style.position="absolute",p.style.left=l+"px",p.style.top=c+"px",p.style.zIndex=c+36,p.src=this.getImageForItem(h),e.appendChild(p);if(n.hat){h={itemtype:"hat",hat:this.game.animationmanager.expandGameFilename("hat",n.hat)};var d=document.createElement("img");d.style.clip=this.getImageClipForItem(h),d.style.position="absolute",d.style.left=l+"px",d.style.top=c-16+"px",d.style.zIndex=c+37,d.src=this.getImageForItem(h),e.appendChild(d)}n==this.game.player&&t["map"]!="main"&&(e.scrollTop=Math.max(0,Math.min(Math.floor(c-a/2),f-a)))},showHouseMenu:function(e){e&&this.game.client&&this.game.client.sendGetMyHouses();var t=this.showPopUp({title:"Your House",hideclosebutton:!0,popupType:"housemenu"}),n="";n+='<div style="font-size:24px">',e?n+="<br><i>"+translate("Loading your house info...")+"</i>":n+=translate('Build a house, add furniture and decoration and invite your friends! You can go to your land, place houses of different colors and styles and decorate them. If you have a house then click on the "Visit"-button to jump there.'),n+="</div>";for(var r=0;r<3;r++){var i=this.myhouseinfo&&r<this.myhouseinfo.houses.length&&this.myhouseinfo.houses[r].canvisit?this.myhouseinfo.houses[r]:null;n+=this.getBuildInfoBlock(34+200*r,122,i?{itemid:i.housetype,image:i.image}:null,1+r,"buildblock"+(1+r))}var s=this.myhouseinfo&&this.myhouseinfo.houses.length>0;s&&(n+='<label style="position:absolute; bottom:57px;"><input type="checkbox" id="checkboxhouseopen" name="houseopen"'+(this.game.settings.houseopen?" checked":"")+">"+translate("Open Houses to Visitors")+"</label>\n"),t.innerHTML=n;if(s){var o=gui.getDom("checkboxhouseopen");o.onchange=function(e){u.onCheckboxSettingsChange(e.target)}}for(var r=0;r<3;r++)t.appendChild(this.getHouseMenuButton(r,"buildblock"+(1+r)));var u=this,a=this.game.app.config.enablenewgui;t.appendChild(this.createButton("Build or Visit House",{right:a?20:0,bottom:5,w:280,h:40},function(e){u.closePopUpNow(),u.showChooseHouseLand()})),s&&t.appendChild(this.createButton("Kick Visitors",{x:0,bottom:5,w:280,h:40},function(e){u.kickVisitorsFromHouse()})),this.addMainBackButton(t)},getHouseMenuButton:function(e,t){var n=this,r,i;if(this.myhouseinfo&&e<this.myhouseinfo.houses.length){var s=this.myhouseinfo.houses[e];s.canvisit?(r="Visit",i=function(t){n.closePopUpNow(),n.goToHouse(1+e)}):(r="Place",i=function(e){n.closePopUpNow(),n.showChooseHouseLand()})}else r="Build",i=function(e){n.closePopUpNow(),n.showChooseHouseLand()};return gui.getDom(t).onclick=i,this.createButton(r,{x:72+e*200,y:265,w:120,h:40},i)},getBuildInfoBlock:function(e,t,n,r,i){var s="<div";i&&(s+=' id="'+i+'"'),s+=' style="position:absolute;left:'+e+"px;top:"+t+"px;width:192px;height:160px;",i&&(s+="cursor:pointer;");var o=this.game.app.config.enablenewgui;if(o)s+='background:#001020; border-radius:32px;">';else{var u=n&&n.itemid&&n.itemid.indexOf("ladder")>=0?"bbuilder_castlebackground.png":"bbuilder_housemenuland.png";s+="background:url("+this.game.filespath+"gui/"+u+');background-size:contain;">'}if(n){var a=this.game.animationmanager;n.image?s+='<div style="position:absolute;left:0px;top:22px;width:100%;height:128px;background:url('+this.game.filespath+"npcs/"+n.image+') no-repeat center;background-size:contain;"></div>':n.itemid&&n.itemid.indexOf("house")==0&&(s+='<div style="position:relative;left:28px;top:27px;width:156px;height:125px;background:url('+a.getPathForDefault("IMAGE")+'bbuilder_defaulthouseshadow.png) no-repeat center;background-size:contain;"></div>',s+='<div style="position:absolute;left:14px;top:8px;width:160px;height:128px;background:url('+a.getPathForDefault("HOUSE")+"bbuilder_new"+n.itemid+'.png) no-repeat center;background-size:contain;"></div>')}return r&&(s+='<div style="position:absolute;left:10px;top:10px;width:32px;height:32px;background-color:white;border-radius:16px;color:black;text-shadow:none;">',s+="<center>"+r+"</center>",s+="</div>"),s+="</div>",s},setMyHouses:function(e){this.myhouseinfo=e,this.closePopUpNow(),this.showHouseMenu(!1)},goToHouse:function(e){this.game.player&&this.game.client&&this.game.client.sendGoToHouse(this.game.player.id,e)},kickVisitorsFromHouse:function(){this.closePopUpNow(),this.game.client&&this.game.client.sendKickVisitors()},showChooseHouseLand:function(){var e=this.showPopUp({title:"Choose Land",hideclosebutton:!0,popupType:"choosehouseland"}),t="",n=!this.game.app.config.disableclanland&&this.game.player&&this.game.player.clanname,r=n?54:204;t+='<div style="font-size:24px">'+(n?translate("You can build houses either on your own land or on the land of your clan. Click on one of the buttons to jump to your land."):translate("You can build a house on your house land. Click on the button to jump there."))+"</div>",t+='<div id="chooseplayerland" style="position:absolute;left:'+r+'px;top:95px;width:256px;height:256px;cursor:pointer;">'+'<img src="'+this.game.filespath+'gui/bbuilder_playerland1.png"></div>',n&&(t+='<div id="chooseclanland" style="position:absolute;left:354px;top:95px;width:256px;height:256px;cursor:pointer;"><img src="'+this.game.filespath+'gui/bbuilder_clanland1.png"></div>'),e.innerHTML=t;var i=this,s=function(e){i.closePopUp(),i.game.client.sendMapMove("playerland:self",64,64)};gui.getDom("chooseplayerland").onclick=s,e.appendChild(this.createButton("On Your Land",{x:r+28,y:300,w:200,h:40},s)),n&&(s=function(e){i.closePopUp(),i.game.client.sendMapMove("clanland:self",64,64)},gui.getDom("chooseclanland").onclick=s,e.appendChild(this.createButton("On Clan Land",{x:382,y:300,w:200,h:40},s))),this.addBackButton(e,"Go back to the house menu",function(e){i.closePopUpNow(),i.showHouseMenu(!1)})},showBuildInfo:function(e){e&&(this.buildinfo=e);if(!this.buildinfo)return;var t=this.buildinfo.buildtype,n="Build "+t.charAt(0).toUpperCase()+t.substring(1),r=this.showPopUp({title:n,popupType:"buildinfo"}),i="<div><center>"+translate("Choose a %s to build here!",[t])+"</center></div>";i+='<div id="buildinfolist" class="scrollable" style="position:absolute;left:0px;top:50px;bottom:10px;right:0px;">';for(var s in this.buildinfo.objects){var o=this.buildinfo.objects[s];i+='<a href="javascript:void(0)" class="gamelink" id="buildlink'+o.itemid+'">';var u=20+200*(s%3),a=Math.floor(s/3)*180;i+=this.getBuildInfoBlock(u,a,o),i+='<div style="position:absolute;left:'+u+"px;top:"+(a+132)+'px;width:192px;height:30px;"><center>',this.buildinfo.isfree||o.price==0&&!o.pricestring?i+="<i>"+translate("Free")+"</i>":o.pricestring?i+="<i>"+o.pricestring+"</i>":i+='<img src="'+this.game.filespath+'gui/bbuilder_icon_coin.png"> '+o.price,i+="</center></div>",i+="</a>"}i+="</div>",r.innerHTML=i;for(var s in this.buildinfo.objects){var o=this.buildinfo.objects[s],f=this.buildinfo.isfree?0:o.pricestring?o.pricestring:o.price,l=gui.getDom("buildlink"+o.itemid);l.onclick=this.getBuildConfirmCallback(o.itemid,f)}},getBuildConfirmCallback:function(e,t){var n=this;return function(r){n.closePopUpNow(),n.showBuildInfoConfirm(e,t)}},showBuildInfoConfirm:function(e,t){var n=this.buildinfo.buildtype,r;for(var i in this.buildinfo.objects)if(this.buildinfo.objects[i].itemid==e){r=this.buildinfo.objects[i];break}if(!r)return;var s=this.showPopUp({title:"Confirm Build",hideclosebutton:!0,popupType:"confirmbuildinfo"}),o='<div style="font-size:30px"><center>'+translate("Do you want to build this %s?",[n])+(t?"<br>"+(typeof t=="string"?translate("It costs %s.",[t]):translate("It costs %d coins.",[t])):"")+"</center></div>";o+=this.getBuildInfoBlock(232,100,r),s.innerHTML=o;var u=this;s.appendChild(this.createButton("Build",{x:232,y:300,w:200,h:40},function(t){u.closePopUp(),u.game.client.sendBuildObject(e)})),this.addBackButton(s,"Go back to the build list",function(e){u.closePopUpNow(),u.showBuildInfo()})},showClansMenu:function(e){e&&this.game.client&&this.game.client.sendClanAction("getjoinedclans",{});var t=this.showPopUp({title:"Clans",hideclosebutton:!0,popupType:"clans"}),n=this,r=[{help:"Click to see a list of all clans you joined",image:"bbuilder_newbutton_joinedclans.png",text:"Joined Clans",callback:function(e){n.closePopUpNow(),n.showJoinedClans()}},{help:"See top stats and ranks of clans",image:"bbuilder_newbutton_scores.png",text:"Scores",callback:function(e){n.closePopUpNow(),n.showClanScores(!0)}},{help:"Search for a clan by name",image:"bbuilder_newbutton_search.png",text:"Search",callback:function(e){n.closePopUpNow(),n.showSearchClans()}},{help:"Click to see information and tips about clans",image:"bbuilder_newbutton_help.png",text:"Help",callback:function(e){n.closePopUpNow(),n.showClansHelp()}}];this.managedclan?r.unshift({help:"Manage your clan!",image:this.managedclan.logo&&this.managedclan.logo.length>0?this.game.filespath+this.managedclan.logo:"bbuilder_newbutton_clans.png",text:"Manage Clan",callback:function(e){n.closePopUpNow(),n.showManageClan()}}):r.unshift({help:"Create a clan and rule the world!",image:"bbuilder_newbutton_clans.png",text:"Create Clan",callback:function(e){n.closePopUpNow(),n.showCreateClan("")}}),this.addMenuButtons(r,"clans",this.joinedclans),this.addMenuItemsToDialog(t,r),this.addMainBackButton(t)},showCreateClan:function(e){var t=this.showPopUp({title:"Create Clan",hideclosebutton:!0,popupType:"createclan"}),n=this;t.innerHTML='<div style="font-size:24px"><br><center><form id="createclanform" name="createclanform" style="width:100%;">\n'+translate("Clan Name:")+' <input type="text" id="createclanname" name="createclanname" style="width:360px; height:32px;" value="'+(e?e:"")+'">\n'+'<input type="submit" value="'+translate("Create")+'" class="inputbutton">\n'+"</form>"+"<br>"+translate("Create a clan! It costs %d coins to create a clan.",[this.game.app.config.clancreateprice])+"</center>\n"+"</div>";var r=gui.getDom("createclanform");r.onsubmit=function(e){return n.createClan(),!1},this.addClansBackButton(t),gui.focus("createclanname")},createClan:function(){var e=document.createclanform.createclanname.value.trim();if(e.length<=0)return;this.closePopUpNow(),this.showWaitingScreen("Create Clan","Creating the clan..."),this.game.client&&this.game.client.sendClanAction("createclan",{name:e})},showManageClan:function(){this.clanviewtype="manageclan";var e=this.managedclan?(this.game.player&&this.game.player.isGameAdmin()?this.managedclan.clanid+": ":"")+(this.managedclan.logo&&this.managedclan.logo.length>0?'<img src="'+this.game.filespath+this.managedclan.logo+'" height=48 style="vertical-align:middle;">':"")+this.managedclan.name:"Manage Clan",t=this.showPopUp({title:e,hideclosebutton:!0,popupType:"manageclan"}),n="";if(this.managedclan){this.selectedclan=this.managedclan;var r=new Date(this.managedclan.created),i=this.managedclan.jointime?new Date(this.managedclan.jointime):null;n+='<div class="clan_founded"><b>'+translate("Founded:")+'</b> <div class="clan_value">'+r.toLocaleDateString()+"</div>"+"</div>",i&&(n+='<div class="clan_jointime"><b>'+translate("Joined:")+'</b> <div class="clan_value">'+i.toLocaleDateString()+"</div>"+"</div>"),n+='<div class="clan_basetime"><b>'+translate("Castle:")+'</b> <div class="clan_value">'+this.minutesToString(this.managedclan.castle)+"</div><br>"+"</div>",n+='<div class="clan_kills"><b>'+translate("Kills:")+'</b> <div class="clan_value">'+(this.managedclan.kills||0)+"</div>"+"</div>",n+='<div class="clan_spar"><b>'+translate("Spars:")+'</b> <div class="clan_value">'+(this.managedclan.sparwins||0)+"</div>"+"</div>",n+='<div class="clan_members"><b>'+translate("Members:")+'</b> <div class="clan_value">'+(this.managedclan.membercount||0)+"</div>"+"</div>",n+=this.buildClanNewsBlock(this.managedclan.news,!0),this.managedclan.logo&&this.managedclan.logo.length>0&&(n+='<img src="'+this.game.filespath+this.managedclan.logo+'" class="clan_logo">')}else n+='<div style="font-size:24px"><br><br><center>'+translate("You have not created a clan yet")+"<br>"+"<div>";t.innerHTML=n;var s=this.game.app.config.enablenewgui;if(this.managedclan){var o=this;t.appendChild(this.createButton("Edit",{classname:"clan_editnews"},function(e){o.closePopUpNow(),o.showEditNews()},!0)),this.game.player&&(this.game.player.name.indexOf("("+this.selectedclan.name+")")>=0?t.parentNode.appendChild(this.createButton("Clear Tag",{classname:"clan_settag"},function(e){o.closePopUpNow(),o.clearTag()})):t.parentNode.appendChild(this.createButton("Set Tag",{classname:"clan_settag"},function(e){o.closePopUpNow(),o.setTag()}))),t.appendChild(this.createButton("Show",{classname:"clan_showmembers"},function(e){o.closePopUpNow(),o.showClanMembers(!0)}));var u=this.createMenuContainer(t,{x:0,bottom:0,w:640,h:120}),a=[{image:"bbuilder_newbutton_rename.png",text:"Rename",callback:function(e){o.closePopUpNow(),o.showRenameClan("")}}];this.addMenuButtons(a,"manageclan",this.selectedclan),this.addMenuItemsToDialog(u,a,{"float":"right"})}this.addClansBackButton(t)},setTag:function(){this.game.client&&this.game.client.sendClanAction("settag",{clanid:this.selectedclan.clanid}),this.showClansMenu(!1)},clearTag:function(){this.game.client&&this.game.client.sendClanAction("cleartag",{}),this.showClansMenu(!1)},showEditNews:function(){if(!this.selectedclan)return;var e=this.showPopUp({title:translate("Edit News of %s",[this.selectedclan.name]),hideclosebutton:!0,popupType:"editclannews"}),t=this.selectedclan.news;t&&t.replaceAll&&(t=t.replaceAll("<br>","\n").replaceAll("<hr>","<hr>\n"));var n=this;e.innerHTML='<div style="font-size:24px"><br>'+translate("News:")+"<br>\n"+'<form id="editnewsform" action="" name="editnewsform" style="width:100%;">\n'+'<textarea type="text" id="editnewsnews" name="editnewsnews"'+' style="position: absolute; top: 20px; left: 160px; width:432px; height:160px">'+t+"</textarea>\n"+'<br><input type="submit" value="'+translate("Update")+'"'+' style="position: absolute; top: 200px; left: 270px; width: 200px; height: 40px;" class="inputbutton">\n'+"</form><div>";var r=gui.getDom("editnewsform");r.onsubmit=function(e){return n.setNews(),!1},this.addManageClansBackButton(e),gui.focus("editnewsnews")},setNews:function(){var e=document.editnewsform.editnewsnews.value.trim();e.replaceAll&&(e=e.replaceAll("<br>\n","<br>").replaceAll("<hr>\n","<hr>").replaceAll("\n","<br>")),this.closePopUpNow(),this.showWaitingScreen(translate("Edit News of %s",[this.selectedclan.name]),translate("Updating the news...")),this.game.client&&this.game.client.sendClanAction("setnews",{clanid:this.selectedclan.clanid,news:e})},showClanMembers:function(e){if(!this.selectedclan)return;e&&this.game.client&&this.game.client.sendClanAction("getclanmembers",{clanid:this.selectedclan.clanid});var t=this.showPopUp({title:translate("Members of %s",[this.selectedclan.name]),hideclosebutton:!0,popupType:"clanmembers"});if(this.clanmembers){var n=[];for(var r in this.clanmembers)n.push(this.getClanMemberMenuItem(this.clanmembers[r]));this.addMenuItemsToDialog(t,n)}this.clanviewtype=="manageclan"?this.addManageClansBackButton(t):this.addClanInfoBackButton(t)},getClanMemberMenuItem:function(e){var t=e.name.substring(0,25),n=t.indexOf("(");n>=0&&(t=t.substring(0,n).trim());var r=this;return{text:t,itemtype:"head",head:this.game.animationmanager.expandGameFilename("head",e.head),hat:this.game.animationmanager.expandGameFilename("hat",e.hat),mask:this.game.animationmanager.expandGameFilename("mask",e.mask),help:translate("View profile of %s!",[t]),callback:function(t){r.getClanMemberInfo(e.userid)},badgeicon:e.isonline?this.game.filespath+"gui/bbuilder_onlineindicator.png":null}},getClanMemberInfo:function(e){this.game.client&&this.game.client.sendClanAction("getmemberinfo",{clanid:this.selectedclan.clanid,userid:e})},showClanMemberInfo:function(){if(!this.clanmemberinfo)return;var e=this.clanmemberinfo.name,t=e.indexOf("(");t>=0&&(e=e.substring(0,t).trim());var n=this.showPopUp({title:e,hideclosebutton:!0,popupType:"clanmemberinfo"}),r=[{x:300,y:10,itemtype:"head",head:this.game.animationmanager.expandGameFilename("head",this.clanmemberinfo.head)}];this.clanmemberinfo.hat&&r.push({x:300,y:-6,itemtype:"hat",hat:this.game.animationmanager.expandGameFilename("hat",this.clanmemberinfo.hat)}),this.clanmemberinfo.mask&&r.push({x:300,y:-6,itemtype:"mask",mask:this.game.animationmanager.expandGameFilename("mask",this.clanmemberinfo.mask)});var i=this.getHTMLFromItemsWithOffset(r),s=this.clanmemberinfo.rights?this.clanmemberinfo.rights:"",o=s.indexOf("l")>=0;o&&(i+='<div style="position:absolute; left:32px; top:65px;"><b>'+translate("Is the leader!")+"</b></div>");var u=this.clanmemberinfo.jointime?new Date(this.clanmemberinfo.jointime):null;i+='<div style="position:absolute; left:32px; top:105px;"><b>'+translate("Joined %s:",[this.clanmemberinfo.clanname])+"</b> "+u.toLocaleDateString()+"</div>",i+='<div style="position:absolute; left:32px; top:145px; right:0px;">'+translate("Rank:")+" ",this.clanmemberinfo.caneditrank?i+='<input type="text" name="clanrankfield" id="clanrankfield" style="position: absolute; width:480px; height:30px; right:32px;" value="'+this.clanmemberinfo.rank+'">':i+=this.clanmemberinfo.rank&&this.clanmemberinfo.rank.length>0?this.clanmemberinfo.rank:"-",i+="</div>",i+='<div style="position:absolute; left:32px; top:190px;">',i+="<b>"+translate("Rights:")+"</b> ",o?i+=translate("All (recruit members, kick members, edit news, ranks)"):(i+='<form name="rightsform" style="width:100%;">\n',i+='<label><input type="checkbox" id="checkboxrecruit" name="recruit"'+(s.indexOf("r")>=0?" checked":"")+(this.clanmemberinfo.caneditrights?"":' disabled="disabled"')+">"+translate("Recruit members")+"</label> ",i+='<label><input type="checkbox" id="checkboxkick" name="kick"'+(s.indexOf("k")>=0?" checked":"")+(this.clanmemberinfo.caneditrights?"":' disabled="disabled"')+">"+translate("Kick members")+"</label> ",i+='<label><input type="checkbox" id="checkboxnews" name="news"'+(s.indexOf("n")>=0?" checked":"")+(this.clanmemberinfo.caneditrights?"":' disabled="disabled"')+">"+translate("Edit news")+"</label>",i+='<label><input type="checkbox" id="checkboxranks" name="ranks"'+(s.indexOf("a")>=0?" checked":"")+(this.clanmemberinfo.caneditrights?"":' disabled="disabled"')+">"+translate("Edit ranks")+"</label>",i+="</form>"),i+="</div>",n.innerHTML=i;var a=this;if(this.clanmemberinfo.caneditrights){var f=["checkboxrecruit","checkboxkick","checkboxnews","checkboxranks"];for(var t in f){var l=gui.getDom(f[t]);l.onchange=function(e){a.onMemberRightsChange(e.target)}}}this.clanmemberinfo.caneditrank&&(gui.getDom("clanrankfield").onkeydown=function(e){e.which==13&&gui.blur("clanrankfield")},gui.getDom("clanrankfield").onblur=function(e){a.updateClanMemberRank()}),this.clanmemberinfo.cankick&&n.appendChild(this.createButton("Kick Member",{x:32,y:300,w:195,h:40},function(e){a.closePopUpNow(),a.showKickClanMember()})),this.clanmemberinfo.cantransferleadership&&n.appendChild(this.createButton("Make Leader",{x:232,y:300,w:200,h:40},function(e){a.closePopUpNow(),a.showTransferClanLeader()})),n.appendChild(this.createButton("View Profile",{x:437,y:300,w:195,h:40},a.getClanMemberCallback(this.clanmemberinfo.userid,function(e){a.closePopUpNow(),a.showClanMemberInfo()}))),this.addBackButton(n,"Go back to the member list",function(e){a.closePopUpNow(),a.showClanMembers(!1)})},updateClanMemberRank:function(){var e=gui.getDom("clanrankfield").value.trim();e!=this.clanmemberinfo.rank&&(this.clanmemberinfo.rank=e,this.game.client&&this.game.client.sendClanAction("setmemberrank",{clanid:this.clanmemberinfo.clanid,userid:this.clanmemberinfo.userid,rank:e}))},onMemberRightsChange:function(e){var t=this.clanmemberinfo.rights?this.clanmemberinfo.rights:"",n=e.name=="recruit"?"r":e.name=="kick"?"k":e.name=="ranks"?"a":"n",r=t.indexOf(n);e.checked?r<0&&(t+=n):r>=0&&(t=t.substring(0,r)+t.substring(r+1)),this.clanmemberinfo.rights=t,this.game.client&&this.game.client.sendClanAction("setmemberrights",{userid:this.clanmemberinfo.userid,rights:t})},showKickClanMember:function(){var e=this.showPopUp({title:"Kick Clan Member",hideclosebutton:!0,popupType:"kickclanmember"});e.innerHTML='<div style="font-size:24px"><br><center>'+translate("Do you really want to kick this member from your clan?")+"</center><div>";var t=this;e.appendChild(this.createButton("Kick Member",{x:232,y:250,w:200,h:40},function(e){t.kickClanMember()})),this.addBackButton(e,"Go back to view the member info",function(e){t.closePopUpNow(),t.showClanMemberInfo()})},kickClanMember:function(){this.closePopUpNow(),this.showWaitingScreen("Kick Member","Kicking the member..."),this.game.client&&this.game.client.sendClanAction("removemember",{clanid:this.selectedclan.clanid,userid:this.clanmemberinfo.userid})},showTransferClanLeader:function(){var e=this.showPopUp({title:"Make Clan Leader",hideclosebutton:!0,popupType:"transferclanleader"});e.innerHTML='<div style="font-size:24px"><br><center>'+translate("Do you really want to transfer the leadership of your clan to the member '%s'? This action cannot be undone.",[this.clanmemberinfo.name])+"</center><div>";var t=this;e.appendChild(this.createButton("Make Leader",{x:232,y:250,w:200,h:40},function(e){t.transferClanLeadership()})),this.addBackButton(e,"Go back to view the member info",function(e){t.closePopUpNow(),t.showClanMemberInfo()})},transferClanLeadership:function(){this.closePopUpNow(),this.showWaitingScreen("Make Clan Leader","Transfering the clan leadership..."),this.game.client&&this.game.client.sendClanAction("transferleadership",{userid:this.clanmemberinfo.userid})},showRenameClan:function(e){var t=this.showPopUp({title:"Rename Clan",hideclosebutton:!0,popupType:"renameclan"}),n=this;t.innerHTML='<div style="font-size:24px"><br><center>'+translate("Rename your clan: it costs %d coins to rename your clan.",[this.game.app.config.clanrenameprice])+"</center><br><br>\n"+'<center><form id="renameclanform" name="renameclanform" style="width:100%;">\n'+translate("New Name:")+' <input type="text" name="clanname" style="width:360px; height:32px;" value="'+e+'">\n'+'<input type="submit" value="'+translate("Rename")+'" class="inputbutton"></center>\n'+"</form><div>";var r=gui.getDom("renameclanform");r.onsubmit=function(e){return n.renameClan(),!1},this.addManageClansBackButton(t)},renameClan:function(){var e=document.renameclanform.clanname.value.trim();if(e.length<=0)return;this.closePopUpNow(),this.showWaitingScreen("Rename Clan","Renaming the clan..."),this.game.client&&this.game.client.sendClanAction("renameclan",{name:e})},showDisbandClan:function(){var e=this.showPopUp({title:"Disband Clan",hideclosebutton:!0,popupType:"disbandclan"});e.innerHTML='<div style="font-size:24px"><br><center>'+translate("Disbanding means that the clan, its allies and members are removed without a way to restore it. You can also rename it or transfer the leadership to someone else. When you disband your clan, you will receive %d coins back.",[this.game.app.config.clandisbandbonus])+"</center><div>";var t=this;e.appendChild(this.createButton("Disband Clan",{x:232,y:280,w:200,h:40},function(e){t.disbandClan()})),this.addManageClansBackButton(e)},disbandClan:function(){this.closePopUpNow(),this.showWaitingScreen("Disbanding Clan","Disbanding the clan..."),this.game.client&&this.game.client.sendClanAction("disbandclan",{})},showJoinedClans:function(){this.clanlisttype="joinedclans";var e=this.showPopUp({title:"Joined Clans",hideclosebutton:!0,popupType:"joinedclans"});if(this.joinedclans&&this.joinedclans.length>0){var t=[];for(var n in this.joinedclans)t.push(this.getJoinedClanMenuItem(this.joinedclans[n],n));this.addMenuItemsToDialog(e,t)}else{var r='<br><a href="javascript:void(0)" class="gamelink" id="createclanlink"><img src="'+this.game.filespath+'gui/bbuilder_newbutton_clans.png" width=64 height=64>',i="</a>";e.innerHTML='<div style="font-size:24px"><br><br><center>'+translate("You have not joined any clans yet<br>You can be recruited by other clan owners or%s Create a clan%s.",[r,i])+"</center>"+"<div>";var s=this,o=gui.getDom("createclanlink");o.onclick=function(e){s.closePopUp(),s.showCreateClan()}}this.addClansBackButton(e)},getJoinedClanMenuItem:function(e,t){var n=this;return{text:e.name,image:e.logo&&e.logo.length>0?this.game.filespath+e.logo:"bbuilder_newbutton_clans.png",help:translate("View clan %s!",[e.name]),callback:function(e){n.closePopUpNow(),n.selectJoinedClan(t)}}},selectJoinedClan:function(e){this.selectedclan=this.joinedclans[e],this.showClanInfo()},showClanInfo:function(){if(!this.selectedclan)return;this.clanviewtype="claninfo";var e=this.showPopUp({title:(this.game.player&&this.game.player.isGameAdmin()?this.selectedclan.clanid+": ":"")+(this.selectedclan.logo&&this.selectedclan.logo.length>0?'<img src="'+this.game.filespath+this.selectedclan.logo+'" height=48 style="vertical-align:middle;">':"")+this.selectedclan.name,hideclosebutton:!0,popupType:"claninfo"}),t="",n=new Date(this.selectedclan.created),r=this.selectedclan.jointime?new Date(this.selectedclan.jointime):null,i=this.selectedclan.leadernick||"unknown",s=i.indexOf("(");s>=0&&(i=i.substring(0,s).trim()),t+='<div class="clan_leader"><b>'+translate("Leader:")+'</b> <div class="clan_value">'+'<a id="leadernicklink" href="javascript:void(0)" class="gamelink">'+i+"</a></div>"+"</div>",t+='<div class="clan_founded"><b>'+translate("Founded:")+'</b> <div class="clan_value">'+n.toLocaleDateString()+"</div>"+"</div>",r&&(t+='<div class="clan_jointime"><b>'+translate("Joined:")+'</b> <div class="clan_value">'+r.toLocaleDateString()+"</div>"+"</div>"),t+='<div class="clan_basetime"><b>'+translate("Castle:")+'</b> <div class="clan_value">'+this.minutesToString(this.selectedclan.castle)+"</div><br>"+"</div>",t+='<div class="clan_kills"><b>'+translate("Kills:")+'</b> <div class="clan_value">'+(this.selectedclan.kills||0)+"</div>"+"</div>",t+='<div class="clan_spar"><b>'+translate("Spars:")+'</b> <div class="clan_value">'+(this.selectedclan.sparwins||0)+"</div>"+"</div>",t+='<div class="clan_members"><b>'+translate("Members:")+'</b> <div class="clan_value">'+(this.selectedclan.membercount||0)+"</div>"+"</div>",t+=this.buildClanNewsBlock(this.selectedclan.news,!1),this.selectedclan.logo&&this.selectedclan.logo.length>0&&(t+='<img src="'+this.game.filespath+this.selectedclan.logo+'" class="clan_logo">'),e.innerHTML=t;var o=this;try{if(this.selectedclan.leader&&this.selectedclan.leadernick){var u=gui.getDom("leadernicklink");gui.setClick(u,o.getClanMemberCallback(o.selectedclan.leader,function(e){o.closePopUpNow(),o.showClanInfo()}))}if(this.game.player){this.selectedclan.rights&&(this.selectedclan.rights.indexOf("l")>=0||this.selectedclan.rights.indexOf("n")>=0)&&e.appendChild(this.createButton("Edit",{classname:"clan_editnews"},function(e){o.closePopUpNow(),o.showEditNews()},!0));var a=this.game.app.config.enablenewgui;this.game.player.name.indexOf("("+this.selectedclan.name+")")>=0?e.parentNode.appendChild(this.createButton("Clear Tag",{classname:"clan_settag"},function(e){o.closePopUpNow(),o.clearTag()})):this.selectedclan.ismember&&e.parentNode.appendChild(this.createButton("Set Tag",{classname:"clan_settag"},function(e){o.closePopUpNow(),o.setTag()}));var f=[];this.selectedclan.ismember&&!(this.selectedclan.rights&&this.selectedclan.rights.indexOf("l")>=0)&&f.push({image:"bbuilder_newbutton_leave.png",text:"Leave",callback:function(e){o.closePopUpNow(),o.showConfirmLeaveClan()}}),this.addMenuButtons(f,"claninfo",this.selectedclan);if(f.length>0){var l=this.createMenuContainer(e,{x:0,bottom:0,w:640,h:120});this.addMenuItemsToDialog(l,f,{"float":"right"})}}this.selectedclan.membercount>0&&e.appendChild(this.createButton("Show",{classname:"clan_showmembers"},function(e){o.closePopUpNow(),o.showClanMembers(!0)}))}catch(c){}switch(this.clanlisttype){case"searchedclans":this.addBackButton(e,"Go back to the search results",function(e){o.closePopUpNow(),o.showSearchedClans()});break;case"clanscores":this.addBackButton(e,"Go back to the scores",function(e){o.closePopUpNow(),o.showClanScores(!1)});break;case"playerprofile":this.addBackButton(e,"Go back to the player profile",function(e){o.showMenuByName("profile",!0)});break;default:this.addBackButton(e,"Go back to the clan list",function(e){o.closePopUpNow(),o.showJoinedClans()})}},getClanMemberCallback:function(e,t){var n=this;return function(r){n.closePopUpNow(),n.showClanMemberProfile(e,t)}},showClanMemberProfile:function(e,t){this.profilebackcallback=t,this.game.client&&this.game.client.sendRequestDBPlayerProfile(e)},showConfirmLeaveClan:function(){var e=this.showPopUp({title:"Leave Clan",hideclosebutton:!0,popupType:"leaveclan"});e.innerHTML='<div style="font-size:24px"><br><center>'+translate("Do you really want to leave the clan?")+" ("+this.selectedclan.name+")"+"</center><div>";var t=this;e.appendChild(this.createButton("Leave",{x:232,y:280,w:200,h:40},function(e){t.leaveClan()})),this.addClanInfoBackButton(e)},leaveClan:function(){this.closePopUpNow(),this.showWaitingScreen("Leaving Clan","Leaving the clan..."),this.game.client&&this.game.client.sendClanAction("leaveclan",{clanid:this.selectedclan.clanid})},buildClanNewsBlock:function(e,t){return'<div class="clan_news">'+(t?"<i><center>"+translate("Clan News")+"</center></i>":"")+"<br>"+e+"</div>"},showClanScores:function(e){this.currentclanscoretype||(this.currentclanscoretype="castle"),e&&this.game.client&&this.game.client.sendClanAction("getscores",{type:this.currentclanscoretype}),this.clanlisttype="clanscores";var t=this.showPopUp({title:"Clan Scores",hideclosebutton:!0,popupType:"clanscores"}),n='<div id="clanscorestext" class="scrollable" style="position:absolute;left:0px;top:50px;bottom:10px;right:0px;">';n+=this.getScoreHTML(this.currentclanscoretype,this.clanscores),n+="</div>",t.innerHTML=n;if(this.clanscores&&this.clanscores.length>0)for(var r in this.clanscores){var i=gui.getDom("playerscorelink"+r);i&&(i.onclick=this.getClanScoreLinkCallback(r))}var s=this;t.appendChild(this.createButton("Castles",{x:125,y:0,w:140,h:40},function(e){s.switchClanScoreType("castle")})),t.appendChild(this.createButton("Kills",{x:265,y:0,w:140,h:40},function(e){s.switchClanScoreType("kills")})),t.appendChild(this.createButton("Spar",{x:405,y:0,w:140,h:40},function(e){s.switchClanScoreType("spar")})),this.addClansBackButton(t)},getClanScoreLinkCallback:function(e){var t=this;return function(n){t.selectClanForScorePlace(e)}},minutesToString:function(e){if(!e)return"-";var t=Math.floor(e/60),n="";return t>0&&(n+=t+"h",e-=t*60),e>0&&(n+=(n.length>0?" ":"")+e+"m"),n.length<=0&&(n="-"),n},switchClanScoreType:function(e){if(this.currentclanscoretype==e)return;this.currentclanscoretype=e,this.closePopUpNow(),this.showClanScores(!0)},selectClanForScorePlace:function(e){var t=this.clanscores[e].clanid;this.game.client&&this.game.client.sendClanAction("getclaninfo",{clanid:t})},showPlayerScores:function(e){this.currentplayerscoretype||(this.currentplayerscoretype={type:"kills",days:1}),e&&this.game.client&&this.game.client.sendGetScores(this.currentplayerscoretype.type,this.currentplayerscoretype.days);var t=this.showPopUp({title:"Player Scores",hideclosebutton:!0,popupType:"playerscores"}),n='<div id="playerscorestext" class="scrollable" style="position:absolute;left:0px;top:50px;bottom:10px;right:0px;">';n+=this.getScoreHTML(this.currentplayerscoretype.type,this.playerscores),n+="</div>",t.innerHTML=n;if(this.playerscores&&this.playerscores.length>0)for(var r in this.playerscores){var i=gui.getDom("playerscorelink"+r);i.onclick=this.getPlayerScoreLinkCallback(r)}var s=this;t.appendChild(this.createButton("Kills",{x:0,y:0,w:100,h:40},function(e){s.switchPlayerScoreType("kills")})),t.appendChild(this.createButton("Mob-Kills",{x:100,y:0,w:120,h:40},function(e){s.switchPlayerScoreType("mobkills")})),t.appendChild(this.createButton("Spar",{x:220,y:0,w:100,h:40},function(e){s.switchPlayerScoreType("spar")})),t.appendChild(this.createButton("Today",{right:225,y:0,w:75,h:40},function(e){s.switchPlayerScoreDays(1)})),t.appendChild(this.createButton("Week",{right:150,y:0,w:75,h:40},function(e){s.switchPlayerScoreDays(7)})),t.appendChild(this.createButton("Month",{right:75,y:0,w:75,h:40},function(e){s.switchPlayerScoreDays(30)})),t.appendChild(this.createButton("Total",{right:0,y:0,w:75,h:40},function(e){s.switchPlayerScoreDays(1e6)})),this.addMainBackButton(t)},getScoreHTML:function(e,t){var n="";if(t&&t.length>0){var r=e=="kills"?translate("Kills"):e=="mobkills"?translate("Mob-Kills"):e=="castle"?translate("Castle Time"):translate("Spar");n+='<div style="position:absolute;text-align:center;left:232px;width:200px;top:-2px;height:30px;pointer-events:none;">'+r+"</div>",n+='<div style="height:160px;overflow:hidden;position:relative;pointer-events:none;">';for(var i=0;i<3&&i<t.length;i++){var s=t[i],o=e=="castle"?this.minutesToString(s.score):s.score,u=i==0?250:i==1?20:460,a=i==0?0:20;if(s.logo)n+='<img src="'+this.game.filespath+s.logo+'" height=48 style="position:absolute;height:120px;left:'+(u+44)+"px;top:"+(a+20)+'px;">';else if(s.data&&s.data.head){var f=[{x:20+u/2,y:a/2+16,itemtype:"head",head:this.game.animationmanager.expandGameFilename("head",s.data.head)}];s.data.hat&&f.push({x:20+u/2,y:a/2,itemtype:"hat",hat:this.game.animationmanager.expandGameFilename("hat",s.data.hat)}),n+='<div class="pixelimage" style="-ms-transform:scale(2); -webkit-transform:scale(2); transform:scale(2); position:absolute;">',n+=this.getHTMLFromItemsWithOffset(f),n+="</div>"}n+='<div style="position:absolute;left:'+(u+20)+"px;top:"+(a+30)+'px;font-size:44px;font-style:italic;"><b>'+(1+i)+".</b></div>",n+='<div style="position:absolute;left:'+(u+120)+"px;top:"+(a+86)+'px;font-size:32px;">'+o+"</div>",n+='<a href="javascript:void(0)" class="gamelink" id="playerscorelink'+i+'"'+' style="position:absolute;left:'+(u-34)+"px;top:"+(a+110)+'px;width:240px;height:36px; text-align:center; overflow:hidden;pointer-events:auto;">'+s.name.substring(0,25).trim()+"</a>"}n+="</div><hr>";for(var i=3;i<t.length;i++){var s=t[i],o=e=="castle"?this.minutesToString(s.score):s.score,f;s.data&&s.data.head&&(f=[{x:-4,y:-4,itemtype:"head",head:this.game.animationmanager.expandGameFilename("head",s.data.head)}],s.data.hat&&f.push({x:-4,y:-20,itemtype:"hat",hat:this.game.animationmanager.expandGameFilename("hat",s.data.hat)})),n+='<div style="height:48px;pointer-events:none;"><div style="width:60px;float:left;margin-left:20px;text-align:center;font-size:36px;line-height:30px;"><b>'+(1+(i|0))+".</b></div> "+(f?this.getHTMLFromItemsInFlow(f):"")+'<a href="javascript:void(0)" class="gamelink" id="playerscorelink'+i+'" style="margin-left:46px;pointer-events:auto;">'+s.name.substring(0,25).trim()+"</a>"+'<div style="width:'+(e=="castle"?180:140)+'px;float:right;margin-right:50px;text-align:right;font-size:32px;">'+o+"</div> "+"</div>"}}else n+='<div style="font-size:24px">  <br><br><center>'+translate("There are no scores yet")+"<br>"+"</div>";return n},getPlayerScoreLinkCallback:function(e){var t=this;return function(n){t.selectPlayerForScorePlace(e)}},selectPlayerForScorePlace:function(e){if(!this.game.client)return;var t=this;this.closePopUpNow(),this.profilebackcallback=function(e){t.closePopUpNow(),t.showPlayerScores(!1)};var n=this.playerscores[e].userid;this.game.client.sendRequestDBPlayerProfile(n)},switchPlayerScoreType:function(e){if(this.currentplayerscoretype.type==e)return;this.currentplayerscoretype.type=e,this.closePopUpNow(),this.showPlayerScores(!0)},switchPlayerScoreDays:function(e){if(this.currentplayerscoretype.days==e)return;this.currentplayerscoretype.days=e,this.closePopUpNow(),this.showPlayerScores(!0)},setPlayerScores:function(e,t,n){this.playerscores=n,this.getCurrentMenu()=="playerscores"&&(this.closePopUpNow(),this.showPlayerScores(!1))},showSearchClans:function(){var e=this.showPopUp({title:"Search Clans",hideclosebutton:!0,popupType:"searchclans"}),t=this;e.innerHTML='<div style="font-size:24px"><center><form id="searchclanform" name="searchclanform">\n'+translate("Clan Name:")+' <input type="text" id="searchclanname" name="searchclanname" style="height: 32px;">\n'+'<input type="submit" value="'+translate("Search")+'" class="inputbutton"></center>\n'+"</form><div>";var n=gui.getDom("searchclanform");n.onsubmit=function(e){return t.searchClan(),!1},this.addClansBackButton(e),gui.focus("searchclanname")},searchClan:function(){var e=document.searchclanform.searchclanname.value.trim();if(e.length<=0)return;this.closePopUpNow(),this.showWaitingScreen("Search Clan","Searching for clans..."),this.game.client&&this.game.client.sendClanAction("searchclan",{name:e})},showSearchedClans:function(){this.clanlisttype="searchedclans";var e=this.showPopUp({title:"Search Result",hideclosebutton:!0,popupType:"searchedclans"});if(this.searchedclans&&this.searchedclans.length>0){var t=[];for(var n in this.searchedclans)t.push(this.getSearchClanMenuItem(this.searchedclans[n].name,n));this.addMenuItemsToDialog(e,t)}else e.innerHTML='<div style="font-size:24px"><br><br><center>'+translate("No clans with that name found!")+"<br>"+"<div>";var r=this;this.addBackButton(e,"Go back to the search screen",function(e){r.closePopUpNow(),r.showSearchClans()})},getSearchClanMenuItem:function(e,t){var n=this;return{text:e,image:"bbuilder_newbutton_clans.png",help:translate("View clan %s!",[e]),callback:function(e){n.closePopUpNow(),n.selectSearchedClan(t)}}},selectSearchedClan:function(e){var t=this.searchedclans[e].clanid;this.game.client&&this.game.client.sendClanAction("getclaninfo",{clanid:t})},showClansHelp:function(){var e=this.showPopUp({title:"Clans Help",hideclosebutton:!0,popupType:"clanshelp"});e.innerHTML='<div style="font-size:24px;">'+translate("Clans are groups of players who wear the same clan tag in their name and are protected against team kills:")+"<br><br>"+"&bull; "+translate("Creating a clan costs %d coins",[this.game.app.config.clancreateprice])+"<br>"+"&bull; "+translate("A clan can have up to <b>%d</b> members",[this.game.app.config.clanmemberlimit])+"<br>"+"&bull; "+translate("The clan leader can recruit new members")+"<br>"+"&bull; "+translate("You can identify members of a clan by seeing the clan tag at the end of the name like this: Willy (Hero Clan)")+"<br>"+"&bull; "+translate("Members of the same clan are protected against <b>swords</b> and <b>bombs</b> of team members")+"<br>"+"&bull; "+translate("Each clan has its own <b>clan island</b> where members can build houses")+"<br>"+"</div>",this.addClansBackButton(e)},handleClanAction:function(e,t){switch(e){case"joinedclans":this.setJoinedClans(t);break;case"searchclans":this.setSearchClans(t);break;case"scores":this.setClanScores(t);break;case"claninfo":this.setClanInfo(t);break;case"clanmembers":this.setClanMembers(t);break;case"memberinfo":this.setClanMemberInfo(t);break;case"createclanfailed":case"renameclanfailed":case"disbandclanfailed":case"setnewsfailed":case"leaveclanfailed":case"removememberfailed":case"transferleadershipfailed":this.game.showGeneralMessage(t.message);if(this.isShowingClansMenu()){this.closePopUpNow();switch(e){case"createclanfailed":this.showCreateClan(t.name);break;case"renameclanfailed":this.showRenameClan(t.name);break;case"disbandclanfailed":this.showDisbandClan();break;case"leaveclanfailed":this.showClanInfo();break;case"setnewsfailed":this.showManageClan();break;case"removememberfailed":case"transferleadershipfailed":this.showClanMemberInfo()}}break;case"createclansuccess":case"renameclansuccess":case"disbandclansuccess":case"leaveclansuccess":case"settagsuccess":case"settagfailed":case"cleartagsuccess":case"setnewssuccess":case"removemembersuccess":case"transferleadershipsuccess":case"setmemberranksuccess":case"setmemberrankfailed":case"setmemberrightssuccess":case"setmemberrightsfailed":this.game.showGeneralMessage(t.message)}},setJoinedClans:function(e){this.joinedclans=e,this.checkHaveManagedClan(),this.isShowingClansMenu()&&(this.closePopUpNow(),this.showClansMenu(!1))},setSearchClans:function(e){this.searchedclans=e,this.isShowingClansMenu()&&(this.closePopUpNow(),this.showSearchedClans())},setClanScores:function(e){this.clanscores=e,this.isShowingClansMenu()&&(this.closePopUpNow(),this.showClanScores(!1))},setClanInfo:function(e){this.selectedclan=e,this.closePopUpNow(),this.showClanInfo()},setClanMembers:function(e){this.clanmembers=e,this.isShowingClansMenu()&&(this.closePopUpNow(),this.showClanMembers(!1))},setClanMemberInfo:function(e){this.clanmemberinfo=e,this.isShowingClansMenu()&&(this.closePopUpNow(),this.showClanMemberInfo())},getCurrentMenu:function(){return gui.isVisible("newpopup")?this.currentPopupType:null},isShowingClansMenu:function(){var e=this.getCurrentMenu();return e&&(e=="waitingscreen"||e.indexOf("clan")>=0)},checkHaveManagedClan:function(){this.managedclan=null;for(var e in this.joinedclans){var t=this.joinedclans[e];if(t.rights.indexOf("l")>=0){this.managedclan=t;break}}},showPM:function(e,t){this.closePopUpNow();if(e.type=="console"){!gui.isVisible("adminconsole")&&this.game.client&&(this.game.filemanager.showConsole(),this.game.filemanager.addConsoleText(e.message));return}this.displaypm=e;var n;switch(e.type){case"invitation":e.data&&(e.data.storyid||e.data.mapmarkers)?n=e.message:n="Invitation";break;case"clanmessage":n=e.senderlook.name;var r=n.indexOf("(");r>=0&&(n=n.substring(0,r).trim()),n=translate("Clan Message by %s",[n]);break;default:n=e.senderlook.name}var i=this.game.app.config.enablenewgui,s=400,o=240,u,a=!1;e.data&&e.data.storyid?(u="story",o=440+(i?10:0)):e.data&&e.data.mapmarkers&&(u="map",s=600,o=400,a=!0);var f;if(e.senderid){var l=this;f=function(n){l.closePopUpNow(),l.showClanMemberProfile(e.senderid,function(e){l.closePopUpNow(),l.showPM(l.displaypm,t)})}}var c=this.showPopUp({title:n,titleCallback:f,closeCallback:t,width:s,height:o,popupType:"pm",showbadge:i&&e.senderlook.isadmin,noborders:a});switch(u){case"story":this.game.client&&this.game.client.sendStoryAction("get",{id:e.data.storyid,target:"pm"}),c.innerHTML=this.game.storymanager.getStoryHTML("pmstorycanvas",20,i?10:0);break;case"map":c.innerHTML='<div id="pmmapimage" class="bigmapimage"></div>',e.data.mapmarkers.width&&this.addMapMarkers(gui.getDom("pmmapimage"),e.data.mapmarkers);break;default:c.innerHTML='<div style="font-size:24px;"><br><div id="pmcontent" class="scrollable" style="position:absolute; left:0;top:0;right:0;bottom:64px;padding: 12px 0px;"><div class="pmcontenttext" style="pointer-events:none;'+(e.type=="invitation"?"text-align:center;":"")+'">'+e.message+"</div>"+(e.originalMessage?e.originalMessage!=e.message?'<div class="pmtranslated">'+translate("Original:")+" "+e.originalMessage+"</div>":"":'<div class="pmtranslate">'+translate("Translate")+"</div>")+"</div></div>"}e.senderlook.head&&this.addWindowIcon(c,e.senderlook);var i=this.game.app.config.enablenewgui,h=140,p=40,d=(s+64)/2,v=i?12:22,l=this;if(e.type=="invitation")c.appendChild(this.createButton("👍"+translate("Yes"),{x:d-h-5,bottom:v,w:h,h:p},function(t){l.closePopUp(),l.game.acceptInvitation(e,!0)})),c.appendChild(this.createButton("No",{x:d+5,bottom:v,w:h,h:p},function(t){l.game.acceptInvitation(e,!1),l.closePM()}));else{var m=e.senderid>0||e.data&&e.data.replyid;m&&c.appendChild(this.createButton("Reply",{x:d-h-5,bottom:v,w:h,h:p},function(n){l.writePMAsReply(e,t)},!0));if(t)c.appendChild(this.createButton("Close",{x:m?d+5:d-h/2,bottom:v,w:h,h:p},function(e){l.closePopUpNow(),t()},!0));else{var g=this.game.pms&&this.game.pms.length>0;c.appendChild(this.createButton(g?"Next":"Close",{x:m?d+5:d-h/2,bottom:v,w:h,h:p},function(e){l.closePM()},!0))}}e&&e.senderid&&this.game.client&&(e.type=="clanmessage"?this.game.client.sendPMAction("getclanmessages",{}):e.id!=0&&this.game.client.sendPMAction("getusermessages",{userid:e.senderid})),gui.setChildClick(c,".pmtranslate",function(e){l.translatePM(e)})},translatePM:function(e){if(!e||!e.target||!e.target.parentNode)return;var t=e.target.parentNode.querySelector(".pmcontenttext");if(!t)return;gui.removeClass(e.target,"pmtranslate"),gui.addClass(e.target,"pmtranslated"),this.translateWithGoogle(e.target,t.textContent,!0)},translateWithGoogle:function(e,t,n){if(!e)return;if(!t&&e){var r=gui.getDom(e);r&&(t=r.innerHTML)}if(!t||t.length<=0)return;n&&gui.setHTML(e,'<img src="'+this.game.filespath+'gui/bbuilder_spinner_translate.gif">'),this.game.getGoogleTranslation(t,function(t){gui.setHTML(e,t),typeof e=="object"&&e.style&&(e.style.pointerEvents="none")},function(){gui.setHTML(e,"<i>translation failed</i>")})},setUserPMs:function(e,t){this.getCurrentMenu()=="pm"&&this.displaypm&&this.displaypm.senderid==e&&this.addMessagesToPM(t)},setClanPMs:function(e,t){this.getCurrentMenu()=="pm"&&this.displaypm&&this.displaypm.type=="clanmessage"&&this.addMessagesToPM(t)},addMessagesToPM:function(e){var t="";for(var n in e){var r=e[n];t.length>0&&(t+="<hr>");if(n>0||r.time>=3600||r.me){var i=r.me?translate("You"):r.senderlook?r.senderlook.name:this.displaypm.senderlook?this.displaypm.senderlook.name:translate("Other"),s=i.indexOf("(");s>=0&&(i=i.substring(0,s).trim()),t+=translate("%s (%s ago):",[i,r.timestr])+"<br>"}r.text==this.displaypm.originalMessage?t+='<div><div class="pmcontenttext" style="pointer-events:none;">'+this.displaypm.message+"</div>"+(this.displaypm.originalMessage!=this.displaypm.message?'<div class="pmtranslated">'+translate("Original:")+" "+this.displaypm.originalMessage+"</div>":""):t+='<div><div class="pmcontenttext" style="pointer-events:none;">'+r.text+"</div>"+'<div class="pmtranslate">'+translate("Translate")+"</div></div>"}gui.setChildHTML("newpopup","#pmcontent",t);var o=this;gui.setChildClick("newpopup",".pmtranslate",function(e){o.translatePM(e)})},closePM:function(e){this.closePopUpNow();var t=this.game.pms&&this.game.pms.length>0;t&&this.game.showNextPM()},writePMAsReply:function(e,t){if(!e)return;e.type=="clanmessage"?this.writeClanMessage():this.writePM(e.senderid,e.senderlook.name+(e.senderlook.isonline?"":" (offline)"),e.data&&e.data.replyid?e.data.replyid:null,t)},writePM:function(e,t,n,r){if(this.game.shop.hasExternInterfaceVersion(1.1)&&Config_Extern["platform"]=="iphone"){this.game.shop.sendOpenTextField("pm:"+e,"","");return}this.closePopUpNow();var i=this.showPopUp({title:"Write Message",width:400,height:240,popupType:"writepm"});i.innerHTML='<div style="font-size:24px;">'+translate("To %s:",[t])+'<form name="writepmform" style="width:100%;">\n'+'<textarea type="text" id="writepmmessage" name="writepmmessage" style="width:432px;height:160px;" class="scrollable"></textarea>\n'+"</form></div>";var s=this;i.appendChild(this.createButton("Send",{x:87,y:208,w:140,h:40},function(t){s.sendPM(e,n,r)})),i.appendChild(this.createButton("Cancel",{x:237,y:208,w:140,h:40},function(e){r?(s.closePopUpNow(),r()):s.closePopUp()})),gui.focus("writepmmessage")},sendPM:function(e,t,n){if(!document.writepmform)return;var r=document.writepmform.writepmmessage;if(!r||!r.value)return;var i=r.value.trim();if(i.length<=0)return;i.length>1024&&(i=i.substring(0,1024)),this.game.client&&this.game.client.sendPMAction("sendpm",{userid:e,message:i,replyid:t}),n?(this.closePopUpNow(),n()):this.closePopUp()},writeClanMessage:function(){if(this.game.shop.hasExternInterfaceVersion(1.1)&&Config_Extern["platform"]=="iphone"){this.game.shop.sendOpenTextField("clanmessage","",""),gui.blur("clanchatbutton");return}this.closePopUpNow();var e=this.showPopUp({title:"Write Clan Message",width:400,height:240,popupType:"writeclanmessage"});e.innerHTML='<div style="font-size:24px;">'+translate("To your clan %s:",[this.game.player?" "+this.game.player.clanname:""])+'<form name="writeclanmessageform" style="width:100%;">\n'+'<textarea type="text" id="writeclanmessage" name="writeclanmessage" style="width:432px;height:160px;"></textarea>\n'+"</form></div>";var t=this;e.appendChild(this.createButton("Send",{x:87,y:208,w:140,h:40},function(e){t.sendClanMessage()})),e.appendChild(this.createButton("Cancel",{x:237,y:208,w:140,h:40},function(e){t.closePopUp()})),gui.focus("writeclanmessage")},sendClanMessage:function(){var e=document.writeclanmessageform.writeclanmessage.value.trim();if(e.length<=0)return;e.length>1024&&(e=e.substring(0,1024)),this.closePopUp(),this.game.client&&this.game.client.sendPMAction("sendclanmessage",{message:e})},showMessageList:function(e,t,n){var r=this.getItemsPerPage();e?this.messagelist=e:(!this.messagelist||t)&&this.game.client&&this.game.client.sendPMAction("listmessages",{}),this.messagelistOffset=n;var i;if(this.messagelist&&this.messagelist.length>r){var s=1+Math.floor(n/r);i=translate("Messages")+": "+translate("Page %s",[s])}else i="Messages";var o=this.showPopUp({title:i,hideclosebutton:!0,popupType:"messagelist",overlap:!0});if(this.messagelist&&this.messagelist.length>0){var u=[];for(var a=n;a<n+r&&a<this.messagelist.length;a++)u.push(this.getPMMenuItem(this.messagelist[a]));this.addMenuItemsToDialog(o,u)}else this.messagelist&&n==0&&(o.innerHTML='<div style="font-size:24px"><br><br><center>'+translate("There are no messages. Tap on players and click on PM to message them!")+"<br><div>");var f=this;this.messagelist&&this.messagelist.length>r&&(n>0&&o.parentNode.appendChild(this.createButton("Prev",this.getPrevButtonPosition(),function(e){f.showMessageList(null,!1,n-r)})),this.messagelist&&this.messagelist.length>n+r&&o.parentNode.appendChild(this.createButton("Next",this.getNextButtonPosition(),function(e){f.showMessageList(null,!1,n+r)}))),this.addMainBackButton(o)},getPMMenuItem:function(e){var t=e.senderlook.name.substring(0,25),n=t.indexOf("(");n>=0&&(t=t.substring(0,n).trim());var r=this;return{text:t,itemtype:"head",head:this.game.animationmanager.expandGameFilename("head",e.senderlook.head),hat:this.game.animationmanager.expandGameFilename("hat",e.senderlook.hat),mask:this.game.animationmanager.expandGameFilename("mask",e.senderlook.mask),cssclass:"menuitemsmall",help:translate("View Messages of %s!",[t]),callback:function(t){e.isread=!0,r.removeFromPMButton(e),r.showPM(e,function(){r.closePopUpNow(),r.showMessageList(null,!1,r.messagelistOffset)})},badgeicon:e.isread?null:this.game.filespath+"gui/bbuilder_newindicator.png"}},removeFromPMButton:function(e){if(!this.game.pms)return;var t=this.game.pms.length;for(var n=this.game.pms.length-1;n>=0;n--){var r=this.game.pms[n];r.type==e.type&&r.senderid==e.senderid&&r.id==e.id&&this.game.pms.splice(n,1)}var i=this.game.pms.length;i<=0?gui.fadeOut("pmbutton"):i!=t&&gui.setChildHTML("pmbutton","div.pmbadge",i)},showHomeMenu:function(){var e=this.showPopUp({title:translate("Go Back Home"),width:400,height:240,popupType:"homemenu"}),t=translate("If you are lost somewhere or just want to go back to the start, then click on this button!")+"<br><br>";if(this.game.mapmanager.currentmap){var n,r=this.game.mapmanager.currentmap.templatename;r.indexOf("playerland")==0?n="on your house land":r.indexOf("clanland")==0?n="on your clan land":r==this.game.app.config.defaultmapname?n="on the main land":r.indexOf("inside")==0&&(n="in a house"),n&&(t+=translate("You are currently %s.",[translate(n)])+"<br>")}t+="<i>"+translate("You can also type <b>/unstick</b>")+"</i>",e.innerHTML=t;var i=this;e.appendChild(this.createButton("Go Back",{x:142,bottom:0,w:180,h:40},function(e){i.closePopUp(),i.game.client&&i.game.client.sendMapMove("unstick",0,0)}))},showEditHouse:function(e){this.edithouse=e;var t=this.showPopUp({title:"Edit House",popupType:"edithouse"}),n=this,r=translate('You can remove the house from your land by clicking on the "Remove from Land" button.<br><br>This is not destroying the house however, you can place it anytime at other places on your land and it will keep all of its furniture.'),i=340;"name"in this.edithouse&&(r+='<div style="position:absolute;top:'+i+'px;">',r+='<form id="houseoptions" name="houseoptions" style="width:100%;">\n',r+=translate("Name:")+' <input type="text" name="name" style="width:400px; height:32px;" value="'+this.edithouse.name+'">\n'+'<input type="submit" value="'+translate("Update")+'" class="inputbutton"></center>\n',r+="</form></div>",i+=40),t.innerHTML=r;if("name"in this.edithouse){var s=gui.getDom("houseoptions");s.onsubmit=function(e){return n.updateHouseName(),!1}}t.appendChild(this.createButton("Remove from Land",{x:212,y:220,w:240,h:40},function(e){n.removeHouseFromLand()}))},updateHouseName:function(){var e=document.houseoptions.name.value.trim();this.edithouse.name=e,this.closePopUp(),this.game.client&&this.game.client.sendNPCTrigger(this.edithouse.id,"setoptions",{name:e})},removeHouseFromLand:function(){this.closePopUp(),this.game.client&&this.game.client.sendNPCTrigger(this.edithouse.id,"delete",{})},showEventInfo:function(e){this.eventinfo=e;var t=this.showPopUp({title:"Edit Event",popupType:"editevent"}),n="<center>";e.canevent?(n+='<label style="cursor:pointer;"><input type="checkbox" id="checkboxeventactive" name="eventactive" '+(e.active?"checked":"")+">Activate PK Event</label>",e.active&&(n+="<hr>",n+='<h1 style="text-transform: uppercase;">'+this.game.mapmanager.currentmap.mapname+"</h1><br>",n+='<label style="cursor:pointer;"><input type="checkbox" id="checkboxignoretags" name="ignoretags" '+(e.ignoretags?"checked":"")+">Ignore clan tags</label><br>",n+='<label style="cursor:pointer;"><input type="checkbox" id="checkboxwarpdead" name="warpdead" '+(e.warpdead?"checked":"")+">Warp out when killed</label><br>")):(e.ismainmap&&(n+="This is the main map, spar events cannot be hold on this map yet.<br>"),e.zonename&&(n+="This is battle zone / base "+e.zonename+".<br>")),n+="</center>",t.innerHTML=n;if(e.canevent){var r=this,i=gui.getDom("checkboxeventactive");i.onchange=function(e){r.onActivatePKEvent(e.target)},e.active&&(e.pk?t.appendChild(this.createButton("Stop PK",{x:212,y:320,w:240,h:40},function(e){r.stopPKEvent()})):t.appendChild(this.createButton("Start PK!",{x:212,y:320,w:240,h:40},function(e){r.startPKEvent()})),i=gui.getDom("checkboxignoretags"),i.onchange=function(e){r.onToggleIgnoreTags(e.target)},i=gui.getDom("checkboxwarpdead"),i.onchange=function(e){r.onToggleWarpDead(e.target)},t.appendChild(this.createButton("Remove Players",{x:27,y:230,w:200,h:40},function(e){r.removePKEventPlayers()})),t.appendChild(this.createButton("Invite Players",{x:237,y:230,w:200,h:40},function(e){r.invitePKEventPlayers()})),t.appendChild(this.createButton("Invite Clans",{x:447,y:230,w:200,h:40},function(e){r.showEventClanInvite()})))}},onActivatePKEvent:function(e){e.checked?(this.eventinfo={active:!0,pk:!1,ignoretags:!0,warpdead:!0},this.closePopUp(),this.game.client&&this.game.client.sendEventInfo(this.eventinfo)):(this.eventinfo={active:!1},this.closePopUp(),this.game.client&&this.game.client.sendEventInfo(this.eventinfo))},onToggleIgnoreTags:function(e){this.eventinfo.ignoretags=e.checked?!0:!1,this.closePopUp(),this.game.client&&this.game.client.sendEventInfo(this.eventinfo)},onToggleWarpDead:function(e){this.eventinfo.warpdead=e.checked?!0:!1,this.closePopUp(),this.game.client&&this.game.client.sendEventInfo(this.eventinfo)},startPKEvent:function(){this.eventinfo.pk=!0,this.closePopUp(),this.game.client&&this.game.client.sendEventInfo(this.eventinfo)},stopPKEvent:function(){this.eventinfo.pk=!1,this.closePopUp(),this.game.client&&this.game.client.sendEventInfo(this.eventinfo)},removePKEventPlayers:function(){this.game.client&&this.game.client.sendEventInfo({removeplayers:!0})},invitePKEventPlayers:function(){this.game.client&&this.game.client.sendEventInfo({inviteplayers:!0})},showEventClanInvite:function(){this.closePopUpNow();var e=this.showPopUp({title:"Invite Clans",popupType:"inviteeventclans"}),t=this;e.innerHTML='<div style="font-size:24px"><br><center>Type the clan names to invite, comma-separated.</center><br><br>\n<center><form id="inviteclansform" name="inviteclansform" style="width:100%;">\n'+translate("Clans:")+' <input type="text" id="inviteclannames" name="inviteclannames" style="width:360px; height:32px;" >\n'+'<input type="submit" value="'+translate("Invite")+'" class="inputbutton"></center>\n'+"</form><div>";var n=gui.getDom("inviteclansform");n.onsubmit=function(e){return t.inviteEventClans(),!1},this.addBackButton(e,"Go back to the events screen",function(e){t.closePopUpNow(),t.showEventInfo(t.eventinfo)}),gui.focus("inviteclannames")},inviteEventClans:function(){var e=document.inviteclansform.inviteclannames.value.trim();if(e.length<=0)return;this.closePopUp(),this.game.client&&this.game.client.sendEventInfo({inviteclans:e})},showDeleteMenu:function(){var e=this.showPopUp({title:"Delete Account",hideclosebutton:!0,popupType:"deleteaccount"});e.innerHTML='<div style="font-size:24px"><br><center>'+translate("You can delete your account for removing all associated login information and to remove your game progress.")+"<br><br>"+translate("Note: all your items, coins and clan memberships will be removed.")+'<br><br><div style="color:red;font-style:italic;">'+translate("Warning: This cannot be undone.")+"</div>"+"</center><div>";var t=this;e.appendChild(this.createButton("Delete Account",{x:220,bottom:0,w:200,h:40},function(e){t.closePopUpNow(),t.showDeleteConfirm()})),this.addBackButton(e,"Go back to account menu",function(e){t.closePopUpNow(),t.showAccountInfo(!1)})},showDeleteConfirm:function(){var e=this.showPopUp({title:"Confirm Account Deletion",width:400,height:240,popupType:"deleteconfirm"});e.innerHTML='<div style="font-size:24px"><br><center>'+translate("Do you really want to delete your account?")+"</center><div>";var t=this;e.appendChild(this.createButton("Confirm Deletion",{x:120,bottom:0,w:200,h:40},function(e){t.deleteAccount()}))},deleteAccount:function(){this.game.client&&this.game.client.sendDeleteAccount(),this.logoutFromAccount(!0)},showConfirmLogout:function(){var e=this.showPopUp({title:"Logout From Account",width:400,height:240,popupType:"confirmlogout"});e.innerHTML='<div style="font-size:24px"><br><center>'+translate("Do you really want to logout from your account? (you will need to login again to play)")+"</center><div>";var t=this;e.appendChild(this.createButton("Logout",{x:142,y:200,w:200,h:40},function(e){t.logoutFromAccount(!1)}))},logoutFromAccount:function(e){if(!e&&!(this.game.player&&!this.game.player.ghost&&Config_Extern))return;this.closePopUpNow(),this.game.storage.resetData(),this.game.storage.save(),Config_Extern["platform"]=="web"||Config_Extern["platform"]=="steam"?this.game.app.reconnect():this.game.shop.logoutToStart()}});return e}),define("shop",[],function(){var e=Class.extend({init:function(e){this.game=e,this.gamecontainerURL="file://";var t=this;window.addEventListener("message",function(e){t.gamecontainerURL=e.origin,t.handleContainerMessage(e)})},showBuyCoinsDialog:function(e,t){this.loadInAppFromMenu=e,this.loadInAppQuantity=t,this.game.client&&this.game.client.sendGetPaymentPackages(Config_Extern?Config_Extern.platform:"web",t)},showBuyCoinsDialog_Step2:function(e,t){this.game.client&&this.game.client.sendTrackAction("showdialog","buycoins",e=="buyitem"&&this.buyitemdata?this.buyitemdata.itemid:e);var n=Config_Extern&&["web","facebook"].indexOf(Config_Extern.platform)>=0,r=n&&this.game.app.config.enablepaypal;this.game.menu.closePopUpNow();var i=this.game.menu.showPopUp({title:"Shop",hideclosebutton:e=="buyitem"||e=="mainmenu",popupType:"coinspackages"}),s="";e=="buyitem"?s=translate("You need more coins for that. Choose one of the following packages!"):e=="clientbuycoins"?s=translate("Choose one of the following packages!")+" "+translate("Thanks! :-)"):(s=translate("Choose one of the following packages to get coins for weapons, outfits or houses!"),s+=" "+translate("Thanks! :-)")),n&&(s+='<div id="webpaymentcontainer" style="position:absolute;left:360px;top:80px;right:10px;bottom:10px;overflow:auto;"></div>'),i.innerHTML=s;var o=[];for(var u in t)o.push(this.getCoinsMenuItem(t[u]));var a=this.game.menu.createMenuContainer(i,{x:0,y:r?80:100,w:r?360:664,h:300});this.game.menu.addMenuItemsToDialog(a,o);switch(e){case"buyitem":var f=this;this.game.menu.addBackButton(i,"Go back to buy the item",function(e){f.game.menu.closePopUpNow(),f.askBuyItem()});break;case"mainmenu":this.game.menu.addMainBackButton(i)}if(r&&!window.paypal){var l=document.createElement("script");l.src="https://www.paypal.com/sdk/js?client-id="+this.game.app.config.paypalclientid,l.setAttribute("merchant-id",this.game.app.config.paypalmerchantid),document.head.appendChild(l)}},getCoinsMenuItem:function(e){if(this.infoFromStore&&e.ios){var t=this.infoFromStore[e.ios.toLowerCase()];t&&(e.price=t.price,e.localprice=t.localprice)}var n=this,r=Config_Extern&&["web","facebook"].indexOf(Config_Extern.platform)>=0,i=r&&this.game.app.config.enablepaypal,s=e.coins>0?translate("%d Coins",[e.coins]):translate(e.shortname),o=translate("Get %s!",[s]);return e.localprice&&(s+='<br><span style="color:lightgreen;">'+e.localprice+"</span>"),{text:s,image:e.image?e.image:"bbuilder_newbutton_buycoins.png",help:o,textfont:(i?"22px":"30px")+" "+this.game.defaultfont,cssclass:"menuitemlarge",callback:function(t){n.startBuyCoinsPackage(e,1,t.target)}}},startBuyCoinsPackage:function(e,t,n){if(this.game.app.config.allowfakepurchase){this.game.registerPayment("fake",1,"fake","fake",e.ios),this.game.menu.closePopUpNow();return}if(Config_Extern)switch(Config_Extern.platform){case"iphone":this.game.client&&this.game.client.sendTrackAction("purchase","iphone",e.ios),this.game.app.config.showiospurchasewaiting&&(this.game.menu.closePopUpNow(),this.showPurchaseWaitingScreen()),this.buyInAppItem(e.ios);return;case"android":this.game.client&&this.game.client.sendTrackAction("purchase","android",e.ios),this.buyInAppItemWithPayload(e.ios.toLowerCase(),this.hash(64));return;case"web":case"facebook":this.game.app.config.enablepaypal&&window.paypal?this.startBuyWithPaypal(e,n):this.game.app.config.enablestripe&&this.game.client&&this.game.player.adminlevel>=9&&this.startBuyWithStripe(e,n);return;case"steam":if(window.electron&&this.game.client){this.game.menu.closePopUpNow();var r=this;window.electron.on("onSteamPurchase2",function(e,t){t&&r.game.client.sendSteamPayment("finalize",""+t.orderId,"")}),this.game.client.sendSteamPayment("init",""+window.electron.steamId,e.ios)}return}if(typeof FB=="undefined")return;this.lastFacebookPaymentURL=e.productid,this.game.client&&this.game.client.sendTrackAction("purchase","facebook",e.productid);var r=this;FB.ui({method:"pay",action:"purchaseitem",product:e.productid,request_id:this.hash(64),quantity:t},function(e){r.verifyFacebookPayment(e)})},showPurchaseWaitingScreen:function(){var e=this.game.menu.showPopUp({title:"Initiating Purchase...",popupType:"purchasewaiting"});e.innerHTML="<br><br><center><b>Please wait! Contacting App Store to initiate the purchase...</b></center>";var t=this;this.game.menu.addBackButton(e,"Go back to buy the item",function(e){t.game.menu.closePopUpNow(),t.showBuyCoinsDialog(t.loadInAppFromMenu,t.loadInAppQuantity)})},openSteamPaymentURL:function(e,t,n,r){var i=e+(e.indexOf("?")>=0?"&":"?")+"returnurl=steam";if(window.electron){var s=this;window.electron.on("onSteamPurchase",function(e,n){s.game.client.sendSteamPayment("finalize",""+t,"")}),window.electron.openInBrowserWindow(i)}else this.showURL(i)},verifyFacebookPayment:function(e){if(!e){this.game.menu.showAlert("There was an error processing your payment. Please try again!","Shop");return}if(e.error_code){e.error_code!=1383010&&this.game.menu.showAlert("There was an error processing your payment."+e.error_message+" Error code:"+e.error_code,"Shop");return}this.game.registerPayment("facebook",e.quantity,e.payment_id,e.signed_request,this.lastFacebookPaymentURL)},hash:function(e){return typeof e=="number"&&e===parseInt(e,10)&&(e=(new Array(e+1)).join("x")),e.replace(/x/g,function(){var e=Math.round(Math.random()*61)+48;return e=e>57?e+7>90?e+13:e+7:e,String.fromCharCode(e)})},startBuyWithPaypal:function(e,t){this.game.client&&this.game.client.sendTrackAction("purchase","web",e.ios),t&&gui.setChildClass(t.parentNode,"selected",".menuitem",t),gui.setHTML("webpaymentcontainer","");var n=this;paypal.Buttons({style:{height:45,color:"blue",shape:"pill",label:"pay"},createOrder:function(t,n){return n.order.create({purchase_units:[{reference_id:e.ios,amount:{value:""+e.price},description:e.coins<=0?e.name||e.shortname:e.coins+" Coins"}],application_context:{shipping_preference:"NO_SHIPPING"}})},onApprove:function(t,r){n.game.registerPayment("paypal",1,t.orderID,JSON.stringify(t),e.ios),n.game.menu.closePopUpNow()},onError:function(e){window.console&&console.log("Paypal error:",e),n.game.menu.gui.showAlert("There was a problem with Paypal. Please try again later.","Shop")}}).render("#webpaymentcontainer")},startBuyWithStripe:function(e,t){t&&gui.setChildClass(t.parentNode,"selected",".menuitem",t),this.stripeWindow=window.open("","_blank","toolbar=0,location=0,menubar=0,scrollbars=yes,modal=yes,width=1000,height=700");if(!this.stripeWindow)return;var n=this.stripeWindow.document.body;n.innerHTML="<br><br><center><b>Loading...</b></center>",this.game.client.sendPaySession("stripe",e.ios)},handlePaySession:function(e,t){switch(e){case"stripe":this.stripeWindow&&(this.stripeWindow.location=t)}},askBuyItem:function(e){if(!this.game.player)return;this.game.menu.getCurrentMenu()=="buyitem"&&this.game.menu.closePopUpNow(),e&&(this.buyitemdata=e);var t=this.game.menu.showPopUp({title:this.buyitemdata.name+(this.game.player.isGameAdmin()||this.game.player.isEventAdmin()?" ("+this.buyitemdata.itemid+")":""),height:340,popupType:"buyitem"}),n=this.buyitemdata.price&&this.buyitemdata["price"]!=0,r=this.buyitemdata.pricestring?this.buyitemdata.pricestring:this.buyitemdata.currency&&this.buyitemdata["currency"]=="eggs"?this.buyitemdata.price+" eggs":this.buyitemdata.currency&&this.buyitemdata["currency"]=="eventgem"?this.buyitemdata.price+" event gems":this.buyitemdata.price+" coins",i=this.game.menu.getImageForItem(this.buyitemdata),s=this.game.menu.getImageClipForItem(this.buyitemdata);s=s.length>0?"position:absolute;"+(this.buyitemdata["itemtype"]=="mount"?"left:-32px;top:-40px;":this.buyitemdata["itemtype"]=="hat"?"left:0px;top:-28px;":["head","armor"].indexOf(this.buyitemdata.itemtype)>=0?"left:0px;top:-10px;":"left:0px;top:0px;")+"clip:"+s+";":"margin-top:16px; max-height:76px;";var o=this.buyitemdata["itemtype"]!="mount"||this.buyitemdata["mounttype"]!="car",u="";this.buyitemdata["itemtype"]=="weapon"&&this.buyitemdata.level&&this.buyitemdata.level>1&&(u+=translate("Weapon Level %d",[this.buyitemdata.level])),this.buyitemdata.clanname&&(u=this.addToDescription(u,translate("Only for %s members",[this.buyitemdata.clanname]))),this.buyitemdata["itemtype"]=="armor"&&this.buyitemdata.level&&this.buyitemdata.level>1&&(u=this.addToDescription(u,translate("Armor Level %d",[this.buyitemdata.level]))),this.buyitemdata.description&&(u=this.addToDescription(u,translate(this.buyitemdata.description))),u.length<=0&&(u=this.addToDescription(u,this.buyitemdata.name));var a=translate("Price:")+" "+r,f=this.buyitemdata.price&&parseInt(this.buyitemdata.price)>0&&this.buyitemdata["currency"]!="eggs"&&this.buyitemdata["currency"]!="eventgem"&&this.game.player.coins<this.buyitemdata.price,l=f?this.buyitemdata.price-this.game.player.coins:0;f&&(a+='<br><div style="color:lime;font:italic 18px '+this.game.defaultfont+';">'+translate("You need %d more coins",[l])+"</div>");var c="";c+='<div class="pixelimage" style="position:absolute;top:40px;'+(o?"left:180px; width:180px; -ms-transform:scale(3); -webkit-transform:scale(3); transform:scale(3);":"")+'"><img src="'+i+'" style="'+s+'"></div>',c+='<div style="position:absolute;left:200px;top:20px;width:400px;"><div class="pmcontenttext">'+u+"</div>"+'<div class="pmtranslate" style="font-size: 22px;">'+translate("Translate")+"</div>© iAppsBeats LTD</div>",!this.buyitemdata.isdisplay&&(n||this.buyitemdata.minkills||this.buyitemdata.minsparwins||this.buyitemdata.minonlinetime)&&(c+='<div style="position:absolute;left:200px;top:240px;width:240px;'+(a.length>80?"font-size:50%;":a.length>60?"font-size:66%;":a.length>40?"font-size:80%;":"")+'">'+a+"</div>"),t.innerHTML=c;var h=this;gui.setChildClick(t,".pmtranslate",function(e){h.game.menu.translatePM(e)}),["head","hat","armor","mask"].indexOf(this.buyitemdata.itemtype)>=0&&(line=document.createElement("div"),line.innerHTML=this.game.menu.getSmallCharacterPreview(this.buyitemdata.armor?this.buyitemdata.armor:this.game.player.armor,this.buyitemdata.head?this.buyitemdata.head:this.game.player.head,this.buyitemdata.hat,this.buyitemdata.mask,0,150),line.style.pointerEvents="none",t.appendChild(line)),this.buyitemdata.isdisplay||this.addBigButton(t,484,220,null,"bbuilder_newbutton_buy.png",'<div style="position:absolute;font-size:30px;top:30px;width:100%;text-align:center;">'+(n?translate("Buy"):translate("Get"))+"</div>","",function(e){h.game.menu.closePopUpNow(),f?h.showBuyCoinsDialog("buyitem",l):h.game.client.sendBuyItem({itemid:h.buyitemdata.itemid,replyid:h.buyitemdata.replyid,count:1})});if(!this.buyitemdata.isdisplay&&this.game.client){var p="buyitem_"+(f?"paymoney":n?this.buyitemdata["curreny"]=="eggs"?"payeggs":"paycoins":"free");this.game.client.sendTrackAction("showdialog",p,this.buyitemdata.itemid)}},addToDescription:function(e,t){return e.length>0&&(e.substring(e.length-1)=="."?e+=" ":e+=", "),e+t},addBigButton:function(e,t,n,r,i,s,o,u){var a=this,f=document.createElement("div");f.className="itembuybutton"+(r?" tooltip":""),f.style.backgroundImage="url('"+this.game.filespath+"gui/"+i+"')",f.style.left=t+"px",f.style.top=n+"px",r&&f.setAttribute("help",r),gui.setClick(f,u,!0),e.appendChild(f),f.innerHTML="<center>"+s+'<div style="position:absolute;left:-200px;top:100px;width:496px;font-size:30px;">'+(r?r:"")+o+"</div></center>"},showSellItems:function(e){this.sellitems=e,this.game.menu.getCurrentMenu()=="sellitems"&&this.game.menu.closePopUpNow();var t=this.game.menu.showPopUp({title:"💰"+translate("Sell items")+"💰",popupType:"sellitems"}),n="";n+='<div style="position:absolute;width:100%;bottom:30px;height:40px;"><center>',n+=translate("Choose an item to sell!"),n+="</center></div>",t.innerHTML=n;if(this.sellitems.length>0){var r=[];for(var i in this.sellitems)r.push(this.getSellItemMenuItem(this.sellitems[i],i));this.game.menu.addMenuItemsToDialog(t,r,{notouch:!0})}else{var n="<br><br><center>"+translate("You don't have any items yet to sell here.")+"</center>";t.innerHTML=n}},getSellItemMenuItem:function(e,t){var n=this;return e.help=translate("Sell %d x %s!",[e.nr,e.name]),e.callback=function(e){n.game.menu.closePopUpNow(),n.sellItem(t)},e.text="<font color=lime>$"+e.price+"</font> "+e.name+"s",e},sellItem:function(e){var t=this.sellitems[e];this.game.menu.closePopUp(),this.game.client.sendSellItem(t.itemid,t.nr)},showFurnitureShops:function(){var e=this.game.menu.showPopUp({title:"Visit Furniture Shops",popupType:"furnitureshops"}),t=this,n=[{help:"General furniture shop with beds, chairs, tables",image:"bbuilder_newbutton_furniture2.png",text:"Furniture",callback:function(e){t.game.menu.closePopUpNow(),t.goToShopHouse("inside_av_furnitureshop",14,10)}},{help:"Pet shop",image:"bbuilder_newbutton_pets.png",text:"Pets",callback:function(e){t.game.menu.closePopUpNow(),t.goToShopHouse("inside_av_petshop",19,24)}},{help:"Nature shop",image:"bbuilder_newbutton_trees.png",text:"Nature",callback:function(e){t.game.menu.closePopUpNow(),t.goToShopHouse("inside_av_natureshop",15,16)}}];this.game.menu.addMenuItemsToDialog(e,n)},goToShopHouse:function(e,t,n){this.game.menu.closePopUp(),this.game.client.sendMapMove(e,t,n),this.game.sounds.play("teleport")},sendMessageToGameContainer:function(e,t){if(!Config_Extern||!window.parent)return;var n={type:e,data:t};window.parent.postMessage(n,this.gamecontainerURL=="null"?"*":this.gamecontainerURL)},handleContainerMessage:function(e){switch(e.data.type){case"boughtitem":this.game.app.config.showiospurchasewaiting&&this.game.menu.closePopUpNow();var t=e.data.data.order,n=Config_Extern&&Config_Extern.platform?Config_Extern.platform:"iphone";this.game.registerPayment(n,1,t.transaction.id,t.transaction.receipt,t.id);break;case"faileditem":this.game.app.config.showiospurchasewaiting&&(this.game.menu.closePopUpNow(),this.loadInAppFromMenu&&this.showBuyCoinsDialog(this.loadInAppFromMenu,this.loadInAppQuantity));break;case"inapppurchaseinfo":var r=e.data.data;this.infoFromStore||(this.infoFromStore={}),this.infoFromStore[r.sku.toLowerCase()]=r;break;case"gameoptions":Config_Extern=e.data.data,this.game&&this.game.app.tryStartGame();break;case"receivedpushtoken":this.game&&this.game.client.sendPushToken(e.data.data.token);break;case"textfieldclosed":var i=e.data.data.purpose,s=e.data.data.text;if(this.game&&this.game.client&&s&&s.length>0){var o=Date.now();if(!this.lastchat||!this.lastchattime||o>this.lastchattime+200){this.lastchat=s,this.lastchattime=o,s.length>1024&&(s=s.substring(0,1024));if(i.indexOf("pm:")==0)this.game.client.sendPMAction("sendpm",{userid:parseInt(i.substring(3)),message:s});else switch(i){case"chat":this.game.player&&this.game.say(s,!0);break;case"clanmessage":this.game.client.sendPMAction("sendclanmessage",{message:s})}}}this.game.client.sendIsTalking(!1)}},requestPushNotifications:function(){this.hasExternInterfaceVersion(1.1)&&this.sendMessageToGameContainer("requestpushnotifications")},hasExternInterfaceVersion:function(e){return Config_Extern&&Config_Extern.version&&Config_Extern.version>=e},logoutFromFacebook:function(){this.sendMessageToGameContainer("logoutfromfacebook")},logoutToStart:function(){this.game.client.connection&&this.game.client.connection.close(),this.sendMessageToGameContainer("logouttostart")},sendConnectedToServer:function(){this.hasExternInterfaceVersion(1.1)&&this.sendMessageToGameContainer("connectedtoserver")},sendNameUpdated:function(e){this.hasExternInterfaceVersion(1.1)&&this.sendMessageToGameContainer("nameupdated",{name:e})},sendOpenTextField:function(e,t,n){this.sendMessageToGameContainer("opentextfield",{purpose:e,text:t,keyboardtype:n})},sendFinishTransaction:function(e){this.sendMessageToGameContainer("finishtransaction",{transactionid:e})},sendCookie:function(e,t){this.sendMessageToGameContainer("logincookies",{cookie:e,cookie2:t})},buyInAppItemWithPayload:function(e,t){this.sendMessageToGameContainer("buyinappitemwithpayload",{sku:e,payload:t})},buyInAppItem:function(e){this.sendMessageToGameContainer("buyinappitem",{sku:e})},sendOpenURL:function(e,t){this.sendMessageToGameContainer("openurl",{url:e,target:t})},showURL:function(e,t){this.hasExternInterfaceVersion(2.3)&&Config_Extern.platform!="web"&&Config_Extern.platform!="steam"?this.sendOpenURL(e,t):window.open(e,"_blank")},sendOpenAppStore:function(e){this.sendMessageToGameContainer("openappstore",{id:e})},shareMessenger:function(){this.sendMessageToGameContainer("sharemessenger")},shareFacebook:function(e){this.sendMessageToGameContainer("sharefacebook",{url:e})},identifyExternal:function(e){this.sendMessageToGameContainer("identify",{type:e})},identifyErrorExternal:function(e){this.sendMessageToGameContainer("identifyerror",{error:e})}});return e}),define("storymanager",["animationmanager","character","renderer","newmap","newnpc"],function(e,t,n,r,i){var s=Class.extend({init:function(e){this.game=e,this.playbackfps=20},showStoryMenu:function(e){var t=10;e&&e.stories?(this.stories=e.stories,this.storieseoffset=e.offset?e.offset:0):(e&&e.forceload&&this.game.client&&this.game.player&&(this.game.client.sendStoryAction("list",e.userid?{userid:e.userid}:{}),this.storyuserid=e.userid?e.userid:null),e&&e.offset!==undefined&&(this.storiesoffset=e.offset));var n=this.game.menu.showPopUp({title:"Stories"+(this.storyuserid?" of Player "+this.storyuserid:""),hideclosebutton:!0,popupType:"storylist"});n.innerHTML="";if(this.stories&&this.stories.length>0){var r=[];for(var i=this.storiesoffset;i<this.stories.length&&i<this.storiesoffset+t;i++)r.push(this.getStoryMenuItem(this.stories[i],!1));var s=this.game.menu.createMenuContainer(n,{x:0,y:120,w:664,h:280});s.className="storymenu",this.game.menu.addMenuItemsToDialog(s,r)}var o=this;this.storyuserid||(n.appendChild(this.game.menu.createButton("Create Story",{x:127,y:40,w:200,h:40},function(e){o.game.menu.closePopUpNow(),o.showStoryInterface()})),n.appendChild(this.game.menu.createButton("Youtube / Insta",{x:337,y:40,w:200,h:40},function(e){o.game.menu.closePopUpNow(),o.showCreateYoutubeStory()}))),this.stories&&(this.storiesoffset>0&&n.parentNode.appendChild(this.game.menu.createButton("Prev",this.game.menu.getPrevButtonPosition(),function(e){o.showStoryMenu({offset:o.storiesoffset-t})})),this.stories.length>this.storiesoffset+t&&n.parentNode.appendChild(this.game.menu.createButton("Next",this.game.menu.getNextButtonPosition(),function(e){o.showStoryMenu({offset:o.storiesoffset+t})}))),this.storyuserid?this.game.menu.addAdminActionsBackButton(n):this.game.menu.addMainBackButton(n)},getStoryMenuItem:function(e,t){var n=this,r=t&&this.playlist.indexOf(e)==this.playlistselected;return{cssid:"menustory"+e.id,cssclass:r?"selectedstory":"",itemcssclass:e["type"]!="game"?"storymenuimage":"",text:e.title,subtitle:translate("%s ago",[e.timestr]),itemtype:e["type"]=="game"?"head":null,head:e["type"]=="game"?this.game.animationmanager.expandGameFilename("head",e.look.head):null,hat:e["type"]=="game"?this.game.animationmanager.expandGameFilename("hat",e.look.hat):null,mask:e["type"]=="game"?this.game.animationmanager.expandGameFilename("mask",e.look.mask):null,image:e["type"]=="youtube"?"youtube_social_squircle_red.png":["instagram","facebook","twitch","tiktok"].indexOf(e.type)>=0?e.type+"_logo.png":null,help:"View Story",callback:function(r){t?n.game.client.sendStoryAction("get",{id:e.id,target:"playlist"}):(n.game.menu.closePopUpNow(),n.showStory(e,!0))}}},showCreateYoutubeStory:function(){var e=this.game.menu.showPopUp({title:"Create Youtube / Insta Story",hideclosebutton:!0,popupType:"createyoutubestory"}),t='<div style="font-size:24px"><br>'+translate("Enter a youtube video, instagram post or Facebook post url to show in your story. Only public and suitable content.")+"<br>\n"+'<label style="position:absolute;top:200px;width:100%">URL:'+'<input type="text" id="editstoryurl" name="editstoryurl"'+' style="position:absolute;left:80px;width:572px;height:32px;font-size:18px;" value=""></label>'+"<div>";e.innerHTML=t;var n=this,r=this.game.menu.createButton("Create Story",{x:275,y:276,w:200,h:40},function(e){n.createYoutubeStory()},!0);r.id="playlistwaypointsbutton",e.appendChild(r),gui.focus("editstoryurl"),this.game.menu.addMainBackButton(e)},createYoutubeStory:function(){var e=gui.getDom("editstoryurl");if(!e)return;var t=e.value.trim();if(!t||t.length<=0)return;var n=this.game.player,r={map:this.game.mapmanager.currentmap.mapname,template:this.game.mapmanager.currentmap.templatename,length:10,data:[{ani:n.getAnimation(!0),armor:n.armor,dir:n.dir,hat:n.hat,head:n.head,mask:n.mask,name:n.name,weapon:n.weapon,x:n.gridX,y:n.gridY}]};if(t.indexOf("youtu")>=0){var i=this.getYoutubeIDFromURL(t);if(!i)return;r.type="youtube",r.data[0].youtube=i,r.data[0].chat="Youtube"}else if(t.indexOf("instagram")>=0){var i=this.getInstagramIDFromURL(t);if(!i)return;r.type="instagram",r.data[0].instagram=i,r.data[0].chat="Instagram"}else if(t.indexOf("tiktok.com")>=0){var i=this.getTiktokIDFromURL(t);if(!i)return;r.type="tiktok",r.data[0].tiktok=i,r.data[0].chat="Tiktok"}else{if(!(t.indexOf("facebook.com/")>=0))return;var i=this.getFacebookIDFromURL(t);if(!i)return;r.type="facebook",r.data[0].facebook=i,r.data[0].chat="Facebook"}this.game.menu.closePopUpNow(),this.recording=r,this.showStoryPublish()},getYoutubeIDFromURL:function(e){if(!e)return e;var t;return(t=e.match(/(\?|&)v=([^&#]+)/))?t.pop():(t=e.match(/(\.be\/)+([^\/]+)/))?t.pop():(t=e.match(/(\embed\/)+([^\/]+)/))?t.pop().replace("?rel=0",""):e&&e.length<16?e:null},getInstagramIDFromURL:function(e){if(!e)return e;var t;return(t=e.match(/(p|reel|tv)\/(.*?)\/(.*)$/))?t[2].replace("/embed",""):e&&e.length<16?e:null},getTiktokIDFromURL:function(e){if(!e)return e;var t;return(t=e.match(/(v|video|embed)\/([\d]*)?/))?(console.log("tiktok:",t),t[2]):e&&e.length<16?e:e},getFacebookIDFromURL:function(e){if(!e)return e;var t;return(t=e.match(/(facebook\.com\/)+([^?]+)/))?encodeURIComponent(t.pop()):null},showStoryPlayList:function(e,t,n){!e&&t&&this.game.client&&this.game.client.sendStoryAction("listlocation",{location:t,userid:n}),this.playlist=e,t&&(this.playlistname=t);var r=this.playlistname=="news"?"News Stories":this.playlistname=="guide"?"Guides":"Playlist "+this.playlistname,i=this.game.menu.showPopUp({title:r,hideclosebutton:!0,popupType:"playlist"}),s=this.playlistname=="news"&&this.game.app.config.facebookpage,o=this;if(this.playlist){var u=this.getStoryHTML("playlistcanvas",0,10);u+='<label style="position:absolute;left:420px;top:8px;right:10px;text-align:center;">'+(this.playlistname=="guide"?translate("Next Guides"):this.playlistname=="news"?translate("Next News"):translate("Next Stories"))+"</label>\n",i.innerHTML=u;if(this.playlist.length>0){this.playlistprevbutton=this.game.menu.createButton("Prev",{right:120,y:s?320:undefined,bottom:s?undefined:5,w:110,h:40},function(e){o.scrollPlayList(!1)}),this.playlistnextbutton=this.game.menu.createButton("Next",{right:0,y:s?320:undefined,bottom:s?undefined:5,w:110,h:40},function(e){o.scrollPlayList(!0)}),i.appendChild(this.playlistprevbutton),i.appendChild(this.playlistnextbutton),this.addShareButtons(i,{showshare:!0,showwaypoints:!0,showedit:!0,showpm:this.game.player&&this.game.player.adminlevel,hideinitial:!0});var a=this.game.menu.createMenuContainer(i,{x:420,y:40,w:260,h:260});a.id="playlistcontainer",a.className="storymenu",this.playlistoffset=0,this.playlistselected=0,this.playliststoriesperpage=4,this.updatePlayListItems(),this.game.client.sendStoryAction("get",{id:this.playlist[this.playlistselected].id,target:"playlist"})}}else i.innerHTML="<center><i>Loading...</i></center>";s&&i.appendChild(this.game.menu.createButton("News on Facebook",{right:0,bottom:5,w:230,h:40},function(e){o.game.shop.showURL(o.game.app.config.facebookpage,"inside")}));if(this.game.player&&this.game.player.isGameAdmin()){var f=this.game.app.config.enablenewgui;i.parentNode.appendChild(this.createButton("Add",{right:0,y:f?7:-8,w:80,h:40},function(e){o.game.menu.closePopUpNow(),o.showStoryMenu({forceload:!0,offset:0})}))}this.playlistname=="profile"?this.addBackButton(i,"Go back to the player profile",function(e){o.game.menu.showMenuByName("profile",!0)}):this.game.menu.addMainBackButton(i)},updatePlayListItems:function(){if(!this.playlist)return;var e=[];for(var t=this.playlistoffset;t<this.playlist.length&&t<this.playlistoffset+this.playliststoriesperpage;t++)e.push(this.getStoryMenuItem(this.playlist[t],!0));var n=gui.getDom("playlistcontainer");n&&(n.innerHTML="",this.game.menu.addMenuItemsToDialog(n,e)),this.playlistoffset+this.playliststoriesperpage<this.playlist.length?gui.show(this.playlistnextbutton):gui.hide(this.playlistnextbutton),this.playlistoffset>0?gui.show(this.playlistprevbutton):gui.hide(this.playlistprevbutton)},editPlayListStory:function(){this.showStory(this.displayedstory,!0,!0)},scrollPlayList:function(e){if(!this.playlist)return;e?this.playlistoffset+this.playliststoriesperpage<this.playlist.length&&(this.playlistoffset+=this.playliststoriesperpage,this.updatePlayListItems()):this.playlistoffset>0&&(this.playlistoffset=Math.max(0,this.playlistoffset-this.playliststoriesperpage),this.updatePlayListItems())},showPlayListStory:function(e){this.displayedstory=e;if(!e)return;var t=this.playlistselected>=this.playlistoffset&&this.playlistselected<this.playlistoffset+this.playliststoriesperpage;for(var n in this.playlist){var r=this.playlist[n];if(r["id"]==e["id"]){this.playlistselected=parseInt(n);break}}var i=this.playlistselected>=this.playlistoffset&&this.playlistselected<this.playlistoffset+this.playliststoriesperpage;if(t||i)this.playlistoffset=Math.floor(this.playlistselected/this.playliststoriesperpage)*this.playliststoriesperpage,this.updatePlayListItems();gui.setChildHTML("newpopup","div.titletext",e.title),this.playlistgame&&this.stopDrawStoryInCanvas(this.playlistgame),this.playlistgame=this.drawStoryInCanvas("playlistcanvas",null,e),e.canedit?gui.show("editstorybutton"):gui.hide("editstorybutton"),e["type"]=="game"&&e.data?(gui.show("storywaypointsbutton"),gui.show("storysharefbbutton"),gui.show("storysharetwbutton")):(gui.hide("storywaypointsbutton"),gui.hide("storysharefbbutton"),gui.hide("storysharetwbutton"))},switchToNextNewsStory:function(){if(!this.playlist||this.playlist.length<=1||!this.game.client)return!1;var e=this.playlistselected+1;e>=this.playlist.length&&(e=0),this.game.client.sendStoryAction("get",{id:this.playlist[e].id,target:"playlist"})},showStoryInterface:function(){gui.show("recordinterface"),gui.show("recordstartbutton"),gui.hide("recordstopbutton")},closeRecordStory:function(){this.isRecording=!1,gui.hide("recordinterface"),gui.removeClass("recordborder","recording")},startRecordStory:function(){if(!this.game.player)return;gui.hide("recordstartbutton"),gui.show("recordstopbutton"),gui.addClass("recordborder","recording"),this.recordingStringAttr=["name","chat","armor","head","hat","mask","weapon","bow","mount","shield","arg1","arg2","arg3","arg4","arg5","arg6","arg7","arg8","arg9","sidekick"],this.recordingAttr=this.recordingStringAttr.concat(["x","y","ani","dir","speed","angle","weaponimage","bowimage","mountimage","shieldimage","zoom"]);var e=this.game.player,t=this.getRecordingState(this.game.player,!0);this.recording={type:"game",state:t,stateFrame:0,stateTime:0,totalFrame:0,action:null,length:0,tilesRectangle:this.getVisibleRectangle(),data:[t],newmap:this.game.mapmanager.currentmap,map:this.game.mapmanager.currentmap.mapname,template:this.game.mapmanager.currentmap.templatename},this.isRecording=!0},getRecordingState:function(e,t){var n={x:Math.floor(e.gridX*100)/100,y:Math.floor(e.gridY*100)/100,ani:e.getAnimation(!0),dir:e.dir,speed:e.currentSpeed,zoom:e.zoom};for(var r in this.recordingStringAttr){var s=this.recordingStringAttr[r];e[s]&&e[s].length>0&&(n[s]=e[s])}e.weaponimage&&e["weaponimage"]!=this.game.animationmanager.expandGameFilename("sword",e["weapon"])&&(n.weaponimage=e.weaponimage),e.bowimage&&e["bowimage"]!=this.game.animationmanager.expandGameFilename("bow",e["bow"])&&(n.bowimage=e.bowimage),e.mountimage&&e["mountimage"]!=this.game.animationmanager.expandGameFilename("mount",e["mount"])&&(n.mountimage=e.mountimage),e.shieldimage&&e["shieldimage"]!=this.game.animationmanager.expandGameFilename("shield",e["shield"])&&(n.shieldimage=e.shieldimage),e.angle&&e.angle!=0&&(n.angle=Math.floor(e.angle*100)/100);if(t){var o=this.getVisibleRectangle(),u=this.game.renderer,a={gridX:Math.floor(o.x/u.tilesize),gridY:Math.floor(o.y/u.tilesize),gridW:Math.ceil((o.w+16)/u.tilesize),gridH:Math.ceil(o.h+16)/u.tilesize},f=this;this.game.forEachVisibleEntityByDepth(a,function(e){if(!(e instanceof i))return;var t=null;e.image&&e.image.length>0?t={id:e.id,image:e.image}:e.animationInfo.animation&&(t={id:e.id,ani:e.animationInfo.animation});if(!t)return;for(var r in f.recordingAttr){var s=f.recordingAttr[r];e[s]&&(s!="zoom"||e[s]!=1)&&(t[s]=e[s=="x"?"gridX":s=="y"?"gridY":s])}n.objects||(n.objects=[]),n.objects.push(t)})}return n},updateRecordStory:function(){if(!this.isRecording||!this.game.player)return;if(this.game.mapmanager.currentmap.mapname!=this.recording.map||this.recording.length>=300){this.stopRecordStory();return}var e=this.recording.data[this.recording.data.length-1],t=this.getRecordingState(this.game.player,!0);"objects"in t&&(this.addObjectsToFirstFrame(t.objects),delete t.objects);var n,r=0;for(var i in this.recordingAttr){var s=this.recordingAttr[i];t[s]!=this.recording.state[s]&&(n||(n={}),n[s]=t[s],r++)}this.recording.action&&(n||(n={}),n.action=this.recording.action,this.recording.action=null,r++),this.recording.sound&&(n||(n={}),n.sound=this.recording.sound,this.recording.sound=null,r++),n&&this.recording.data.length>1&&r==1&&("x"in n&&"x"in e&&!("y"in e)?(e.x=n.x,n=null,this.recording.stateFrame=0):"y"in n&&"y"in e&&!("x"in e)&&(e.y=n.y,n=null,this.recording.stateFrame=0)),n&&this.recording.data.length>1&&r==2&&"x"in n&&"y"in n&&"x"in e&&"y"in e&&(e.x=n.x,e.y=n.y,n=null,this.recording.stateFrame=0),n&&(this.recording.stateFrame>=2&&(e.pause=(e.pause?e.pause:0)+this.recording.stateTime),this.recording.data.push(n),this.recording.stateFrame=0,this.recording.stateTime=0),this.recording.state=t;if(n||!this.game.player.talk&&!this.game.menu.getCurrentMenu())this.recording.stateFrame++,this.recording.stateTime+=this.game.frameTimeS,this.recording.totalFrame++,this.recording.length+=this.game.frameTimeS;this.expandTilesRectangle()},addObjectsToFirstFrame:function(e){if(this.recording.data.length<=0)return;var t=this.recording.data[0];if(!("objects"in t)){t.objects=e;return}var n=[];for(var r in t.objects)n.push(t.objects[r].id);for(var r in e){var i=e[r];n.indexOf(i.id)<0&&t.objects.push(i)}},addRecordAction:function(e,t){if(!this.isRecording)return;if(e=="shoot"){this.recording.action=e;var n=this.game.mapmanager.currentmap,r=n.projectiles.getProjectileSound(t);r&&(this.recording.sound=r)}},getRecordingTiles:function(){var e=this.game.renderer,t=this.recording.newmap,n=this.recording.tilesRectangle,r={header:{offsetx:n.x,offsety:n.y,width:n.w,height:n.h,layers:[],properties:{}},zones:[]},i=t.getUsedLayers(n);for(var s in i){var o=i[s],u=Math.floor(n.x/o.tilewidth),a=Math.floor(n.y/o.tileheight),f={layer:o.layer,offsetx:u*o.tilewidth,offsety:a*o.tileheight,width:Math.ceil((n.x+n.w)/o.tilewidth)-u,height:Math.ceil((n.y+n.h)/o.tileheight)-a,tilewidth:o.tilewidth,tileheight:o.tileheight,tilesinrow:o.tilesinrow,tileset:o.tilesetbase,tilesetwidth:o.tilesetwidth};o.collision&&(f.collision=o.collision),o.drawover&&(f.drawover=o.drawover),o.water&&(f.water=o.water);var l={layer:o.layer,x:0,y:0,w:f.width,h:f.height,tiles:new Array(f.width*f.height)},c=null,h=null,p=null,d=null;for(var v=0;v<l.w;v++)for(var m=0;m<l.h;m++){var g=u+v-Math.floor(o.offsetx/o.tilewidth)+(a+m-Math.floor(o.offsety/o.tileheight))*o.width,y=g>=0&&g<o.tiles.length&&o.tiles[g]!=undefined?o.tiles[g]:-1;l.tiles[v+m*l.w]=y,y>=0&&(c==null?(c=h=v,p=d=m):(c=Math.min(v,c),p=Math.min(m,p),h=Math.max(v,h),d=Math.max(m,d)))}if(c==null)continue;if(c>0||p>0||h+1<l.width||d+1<l.height){var b=h+1-c,w=d+1-p,E={layer:o.layer,x:0,y:0,w:b,h:w,tiles:new Array(b*w)};for(var v=0;v<b;v++)for(var m=0;m<w;m++)E.tiles[v+m*b]=l.tiles[c+v+(p+m)*l.w];l=E,f.offsetx+=c*o.tilewidth,f.offsety+=p*o.tilewidth,f.width=b,f.height=w}r.header.layers.push(f),r.zones.push(l)}return r},expandTilesRectangle:function(){var e=this.recording.tilesRectangle,t=this.getVisibleRectangle();this.recording.tilesRectangle={x:Math.min(e.x,t.x),y:Math.min(e.y,t.y),w:Math.max(e.x+e.w,t.x+t.w)-Math.min(e.x,t.x),h:Math.max(e.y+e.h,t.y+t.h)-Math.min(e.y,t.y)}},getVisibleRectangle:function(){var e=this.game.player,t=256,n=32;return{x:Math.floor((e.x-t/2-n)/16)*16,y:Math.floor((e.y-t/2-n)/16)*16,w:t+n*2,h:t+n*2}},stopRecordStory:function(){if(!this.isRecording)return;this.isRecording=!1;if(this.recording.stateFrame>=2){var e=this.recording.data[this.recording.data.length-1];e.pause=(e.pause?e.pause:0)+this.recording.stateTime}this.recording.length=Math.floor((this.recording.length+this.game.frameTimeS)*100)/100,this.recording.tiles=this.getRecordingTiles(),gui.hide("recordinterface"),gui.removeClass("recordborder","recording"),this.showStoryPublish()},showStoryPublish:function(){var e=this.game.menu.showPopUp({title:"Publish Story",popupType:"publishstory"}),t=(this.recording.length?this.recording.length:2)+" s",n=this.getStoryHTML("publishcanvas",0,10);n+='<label style="position:absolute;left:420px;top:10px;right:10px;">'+translate("Title:")+"</label>\n",n+='<input type="text" id="editstorytitle" name="editstorytitle" style="position:absolute;left:420px;top:50px;right:10px;height:32px;">\n',this.recording["type"]=="game"&&(n+='<label style="position:absolute;left:420px;top:100px;right:10px;">⏰ '+t+"</label>\n");var r=[{id:"public",name:"Public",checked:!0},{id:"profile",name:"Profile",checked:!1},{id:"showattop",name:"At top",checked:!1}];for(var i in r){var s=r[i];n+='<label style="position:absolute; left:420px; top:'+(150+35*i)+'px; right: 10px;"><input type="checkbox"'+' id="checkboxpublish'+s.id+'" name="checkboxpublish'+s.id+'" '+(s.checked?" checked":"")+(s.id=="profile"&&this.recording["type"]!="game"?" disabled":"")+">"+translate(s.name)+"</label>\n"}this.recording["type"]=="game"&&(n+='<label style="position:absolute;left:420px;top:265px;right:10px;font-size:20px;">'+translate("This saves it to your stories. Object movements, projectiles and players are not recorded yet.")+"</label>"),e.innerHTML=n,gui.getDom("editstorytitle").value=this.suggestRecordingTitle(),this.drawStoryInCanvas("publishcanvas",null,this.recording);var o=this;e.appendChild(this.game.menu.createButton("Publish",{x:434,bottom:5,w:230,h:40},function(e){o.publishStory(),o.game.menu.closePopUpNow()})),this.recording["type"]=="game"&&this.game.player&&this.game.player.isGameAdmin()&&e.appendChild(this.game.menu.createButton("🗒",{x:355,y:365,w:38,h:38},function(e){o.showStoryWaypoints(o.recording.data)}))},suggestRecordingTitle:function(){for(var e in this.recording.data){var t=this.recording.data[e];if("chat"in t&&t.chat.length>0)return t.chat.substr(0,250)}var n=this.game.mapmanager.currentmap;return n&&n.isSpar()?"Spar":n&&n.isEvent()?"Event":this.game.player&&this.game.player.weaponData&&(!this.game.player.weaponData.weapontype||this.game.player.weaponData["weapontype"]!="sword")?this.game.player.weaponData.name:"My Story"},publishStory:function(){if(!this.game.client||!this.recording||!this.recording.data)return;var e=gui.getDom("editstorytitle").value.trim();this.game.client.sendStoryAction("publish",{title:e,type:this.recording.type,length:this.recording.length,data:this.recording.data,tiles:this.recording.tiles,"public":gui.getDom("checkboxpublishpublic").checked,inprofile:gui.getDom("checkboxpublishprofile").checked,showattop:gui.getDom("checkboxpublishshowattop").checked})},showStory:function(e,t,n){this.displayedstory=e,t&&this.game.client&&this.game.client.sendStoryAction("get",{id:e.id,target:"story"}),t&&(this.displayedstroyfromlist=n);var r=this.game.menu.showPopUp({title:e.title+" ("+e.id+")",hideclosebutton:!0,popupType:"story"}),i=this;if(e.data&&e.data.length>0){var s=this.getStoryHTML("storycanvas",0,10);s+='<label style="position:absolute;left:420px;top:10px;right:10px;">'+translate("Title:")+"</label>\n",s+='<input type="text" id="editstorytitle" name="editstorytitle" style="position:absolute;left:420px;top:50px;right:10px;height:32px;" value="'+e.title+'">\n',e["type"]=="game"&&(s+='<div style="position:absolute;left:420px;top:100px;right:10px;height:40px;">⏰ '+e.length+"s</div>");var o=[{id:"public",name:"Public",checked:e["public"]},{id:"profile",name:"Profile",checked:e.inprofile},{id:"news",name:"News",checked:e["location"]=="news"},{id:"guide",name:"Guide",checked:e["location"]=="guide"},{id:"showattop",name:"At top",checked:e.showattop}];for(var u in o){var a=o[u];if(!e["can"+a.id])continue;s+='<label style="position:absolute; left:420px; top:'+(150+35*u)+'px; right: 10px;"><input type="checkbox"'+' id="checkboxstory'+a.id+'" name="checkboxstory'+a.id+'" '+(a.checked?" checked":"")+">"+translate(a.name)+"</label>\n"}r.innerHTML=s,this.addShareButtons(r,{showshare:e["type"]=="game",showwaypoints:e["type"]=="game"&&e.data,showpm:this.game.player&&this.game.player.adminlevel});for(var u in o){var a=o[u],f=gui.getDom("checkboxstory"+a.id);f&&(f.onchange=function(e){i.onStoryCheckbox(e.target)})}gui.getDom("editstorytitle").onkeydown=function(e){e.which==13&&gui.blur("editstorytitle")},gui.getDom("editstorytitle").onblur=function(e){i.updateStoryTitle()},this.drawStoryInCanvas("storycanvas",null,e)}else r.innerHTML="<i>Loading...</i>";e.candelete&&r.appendChild(this.createButton("Delete",{x:449,bottom:5,w:200,h:40},function(e){i.game.menu.closePopUpNow(),i.showConfirmDeleteStory()})),this.displayedstroyfromlist?this.game.menu.addBackButton(r,"Go back to the playlist",function(){i.game.menu.closePopUpNow(),i.showStoryPlayList(i.playlist)}):this.game.menu.addBackButton(r,"Go back to story list",function(){i.game.menu.closePopUpNow(),i.showStoryMenu()})},addShareButtons:function(e,t){var n=this;if(t.showshare&&this.game.app.config.enablesharebutton){var r=this.game.menu.createButton("",{x:355,y:365,w:38,h:38},function(e){n.shareStoryFaceBook(n.displayedstory.hash)});r.id="storysharefbbutton",r.style.backgroundColor="transparent",r.style.backgroundImage="url("+this.game.filespath+"gui/bbuilder_share_facebook.png)",r.style.backgroundSize="contain",r.style.border="none",e.appendChild(r),t.hideinitial&&gui.hide(r)}if(t.showwaypoints&&this.game.player&&this.game.player.isGameAdmin()){var i=this.game.menu.createButton("🗒  ",{x:275,y:365,w:38,h:38},function(e){n.showStoryWaypoints(n.displayedstory.data)});i.id="storywaypointsbutton",e.appendChild(i),t.hideinitial&&gui.hide(i)}if(t.showedit){var i=this.game.menu.createButton("✏️",{x:355,y:325,w:38,h:38,help:"Edit Story"},function(e){n.closePopUpNow(),n.editPlayListStory()},!0);i.id="editstorybutton",e.appendChild(i),t.hideinitial&&gui.hide(i)}if(t.showpm){var i=this.game.menu.createButton("📣",{x:355,y:285,w:38,h:38,help:"Send as PM to All"},function(e){n.closePopUpNow(),n.sendServerStory(n.displayedstory.id)},!0);i.id="sendserverstorybutton",e.appendChild(i)}},sendServerStory:function(e){this.game.client&&this.game.client.sendChat("/serverstory "+e)},shareStoryFaceBook:function(e){var t=this.game.app.config.storyshareurl+e;if(this.game.shop.hasExternInterfaceVersion(2.7)&&Config_Extern["platform"]=="iphone"){this.game.shop.shareFacebook(t);return}var n="https://www.facebook.com/dialog/share?app_id=1202613603185807&href="+encodeURIComponent(t);this.game.shop.showURL(n,"inside")},showPublishedStoryShare:function(e){var t=this.game.menu.showPopUp({title:"Share Story Video",popupType:"sharepublishedstory",width:440,height:240}),n="<center>"+translate("Your story has been published! Story-ID: %d",[e.id])+"</center>";t.innerHTML=n;var r=this;t.appendChild(this.game.menu.createButton("Share on Facebook",{x:102,y:75,w:300,h:45},function(t){r.shareStoryFaceBook(e.hash)})),t.appendChild(this.game.menu.createButton("Show My Stories",{x:102,y:135,w:300,h:45},function(e){r.closePopUpNow(),r.showStoryMenu({forceload:!0,offset:0})}))},showStoryWaypoints:function(e){if(!e||e.length<=0)return;var t=JSON.parse(JSON.stringify(e));for(var n in t)delete t[n].objects;var r=this.game.filemanager.showResizableWindow({title:"Waypoints"});r.innerHTML='<form id="editwaypointsform" name="editwaypointsform" style="width:100%;height:100%;">\n<textarea id="editwaypointsscript" name="editwaypointsscript" type="text" style="width:100%;height:100%;font-size:17px;" class="scrollable">'+JSON.stringify(t).replace(/},{/g,"},\n  {").replace("[{","[\n  {").replace("}]","}\n]")+"</textarea>\n"+"</form>"+'<label style="position:absolute; left:175px; bottom:-30px; pointer-events:none; color:white;">or copy to Tiled and scripts</label>';var i=this,s=this.createButton("Add as NPC",{x:5,y:360,w:160,h:26},function(e){i.addWaypointsAsNPC(t),gui.remove(r.parentNode)});s.style.top="initial",s.style.bottom="-33px",r.appendChild(s)},addWaypointsAsNPC:function(){var e=document.editwaypointsform.editwaypointsscript.value.trim(),t={script:"function onCreated() {\n    this.waypoints = "+e+";\n}\n"};this.game.client&&this.game.client.sendAddNPC(t),this.game.menu.closePopUpNow()},updateStoryTitle:function(){if(!this.displayedstory||!this.game.client)return;var e=gui.getDom("editstorytitle").value.trim();e!=this.displayedstory["title"]&&(this.displayedstory.title=e,this.game.client.sendStoryAction("settitle",{id:this.displayedstory.id,title:e}),gui.setChildHTML("newpopup","div.titletext",this.displayedstory.title+" ("+this.displayedstory.id+")"))},showProfileStory:function(e){var t=gui.getDom("profilecharacter");if(!t)return;var n=this.game.menu.playerprofiledata;if(e&&e.replacelook&&e.data&&e.data.length>=1&&n){var r=["head","armor","hat","mask","bow","shield"];for(var i in r)e.data[0][r[i]]=n[r[i]]}t.style.cssText="position:absolute;left:164px;top:35px;",t.innerHTML='<canvas id="profilecanvas" width=160 height=160 style="width:320px;height:320px;"></canvas>';var s=this.drawStoryInCanvas("profilecanvas",null,e);s&&(s.isDrawingNames=function(){return!1})},showPMStory:function(e){var t=this.game.menu.displaypm;if(t&&t.data&&e&&e.data&&e.data.length>=1)for(var n in t.data)e.data[0][n]=t.data[n];this.drawStoryInCanvas("pmstorycanvas",null,e),t&&t.type!="invitation"&&t.senderlook.name=="Server"&&gui.setChildHTML("newpopup","div.titletext",e.title)},showMinimapStory:function(e){if(this.game.minimap.showingStory)return;this.game.minimap.onStoryStarted(e),this.drawStoryInCanvas("minimapcanvas",null,e)},getStoryHTML:function(e,t,n){var r="";return r+='<div id="'+e+'container" class="storycanvas" style="display:inline-block; overflow:hidden; '+"position:absolute;left:"+t+"px;top:"+n+'px;width:400px;height:400px;">',r+='  <canvas id="'+e+'back" style="width:500px;height:500px;" width=320 height=320></canvas>',r+='  <div id="'+e+'embed" style="width:100%; height:100%;"></div>',r+="</div>",r+='<canvas id="'+e+'" style="position:absolute;'+"left:"+(t+4)+"px;top:"+(n+4)+'px;width:400px;height:400px;" width=256 height=256></canvas>',r+='<img id="'+e+'logo" src="'+this.game.filespath+'gui/bbuilder_logosingle.png" style="position:absolute;left:'+(t+10)+"px;top:"+(n+350)+'px;" height=40>',r},getYoutubeStoryHTML:function(e,t){if(!this.game.app.config.story||!t)return"";var n=this.game.app.config.story[e+"link"];return n?translate(n,[t]):""},onStoryCheckbox:function(e){if(!this.displayedstory||!this.game.client)return;switch(e.name){case"checkboxstorypublic":this.game.client.sendStoryAction("setpublic",{id:this.displayedstory.id,"public":e.checked});break;case"checkboxstoryprofile":this.game.client.sendStoryAction("showinprofile",{id:this.displayedstory.id,inprofile:e.checked});break;case"checkboxstorynews":this.game.client.sendStoryAction("setlocation",{id:this.displayedstory.id,location:e.checked?"news":"profile"}),e.checked&&(gui.getDom("checkboxstoryguide").checked=!1);break;case"checkboxstoryguide":this.game.client.sendStoryAction("setlocation",{id:this.displayedstory.id,location:e.checked?"guide":"profile"}),e.checked&&(gui.getDom("checkboxstorynews").checked=!1);break;case"checkboxstoryshowattop":this.game.client.sendStoryAction("setshowattop",{id:this.displayedstory.id,showattop:e.checked})}},showConfirmDeleteStory:function(){var e=this.showPopUp({title:"Delete Story",hideclosebutton:!0,popupType:"deletestory"});e.innerHTML='<div style="font-size:24px"><br><br><center>'+translate("Do you really want to delete the story '%s'?",[this.displayedstory.title])+"</center><div>";var t=this;e.appendChild(this.createButton("Delete",{x:232,y:280,w:200,h:40},function(e){t.game.menu.closePopUpNow(),t.deleteStory()})),this.game.menu.addBackButton(e,"Go back to the story",function(){t.game.menu.closePopUpNow(),t.showStory(t.displayedstory,!1)})},deleteStory:function(){this.displayedstory&&this.game.client&&this.game.client.sendStoryAction("delete",{id:this.displayedstory.id,sendlist:!0})},drawStoryInCanvas:function(e,t,n){var r=gui.getDom(e),i=gui.getDom(e+"back"),s=gui.getDom(e+"embed"),o=gui.getDom(e+"logo");if(n&&n["type"]!="game"&&n.data&&n.data.length>0){r&&(r.style.display="none"),i&&(i.style.display="none"),o&&(o.style.display="none"),s&&(s.style.display="block",s.innerHTML=this.getYoutubeStoryHTML(n.type,n.data[0][n.type]));return}s&&(s.style.display="none",s.innerHTML="");if(!r)return null;r.style.display="block",o&&(o.style.display="block"),i&&(i.style.display="block");var u=this.setupGameEnvironmentForStory(n,r,i),a=this.updateStoryInCanvas(n,u);return t?this.addStoryCharacterClickDir(u.player,t):a&&r&&!this.game.minimap.canvas&&this.addStoryPauseClick(a,r),u},stopDrawStoryInCanvas:function(e){e.renderer.canvas=null,e.renderer.backcanvas=null},setupGameEnvironmentForStory:function(t,r,i){var s={isstory:!0,app:{config:this.game.app.config},filespath:this.game.filespath,currentTime:Date.now(),frameTimeS:1/this.playbackfps,minFrameTime:1e3/this.playbackfps,gameVisible:!0,sounds:this.game.sounds,settings:this.game.settings,alltranslations:this.game.alltranslations,entities:{},mapmanager:{drawTiles:function(){this.currentmap.drawTiles()},getMapTileSize:function(){return this.currentmap?this.currentmap.getFirstLayerTileSize():32}},getTimeHash:function(){return 2},getFilenameWithHash:function(e){return e+(e.indexOf("?")<0?"?t=2":"")},getUrlVars:function(e){return{}},isDrawingNames:function(){return!0},getClanFromName:this.game.getClanFromName,forEachVisibleEntityByDepth:this.game.forEachVisibleEntityByDepth,getGoogleTranslation:this.game.getGoogleTranslation};return s.renderer=new n(s,r,i,!1),s.animationmanager=new e(s),this.setupPlayerForStory(t,s),this.setupObjectsForStory(t,s),this.setupTilesForStory(t,s),s.renderer.zoom=gui.getWidth(r)/r.width,s.renderer.rescale(),s},setupTilesForStory:function(e,t){if(!t.renderer.backcanvas)return;if(!e.tiles||typeof e["tiles"]!="object"||!("header"in e.tiles)){var n=t.renderer.context.backcontext;n&&n.clearRect(0,0,n.canvas.width,n.canvas.height);return}var i=new r(t,e.map,e.template);i.addStreamData(e.tiles),t.mapmanager.currentmap=i,i.isHouseInside=function(){return!0},i.getCenterView=function(){return!0}},setupObjectsForStory:function(e,t){var n=e.data[0];if(!("objects"in n)||n.objects.length<=0)return;for(var r in n.objects){var s=n.objects[r];entity=new i(t,s.id),entity.setExtendedData(s),entity.setGridPosition(s.x,s.y),entity.idle(),t.entities[s.id]=entity}},setupPlayerForStory:function(e,n){var r=e.data[0],i=new t(n,1,Types.Entities.MISC);n.player=i,r&&"x"in r&&"y"in r?i.setGridPosition(r.x,r.y):i.setGridPosition(n.renderer.canvas.width/2/n.renderer.tilesize,n.renderer.canvas.height/2/n.renderer.tilesize),this.copyPlayAttrFromWaypoint(i,r,!0)},copyPlayAttrFromWaypoint:function(e,t,n){var r=["name","head","armor","hat","mask","dir","angle","zoom","chat","weapon","weaponimage","bow","bowimage","mount","shield","shieldimage","sidekick","arg1","arg2","arg3","arg4","arg5","arg6","arg7","arg8","arg9"];for(var i in r){var s=r[i];t[s]&&(e[s]=t[s])}"chat"in t&&e.showEmoticon(e.chat),n&&("x"in t||"y"in t)&&e.setGridPosition("x"in t?t.x:e.gridX,"y"in t?t.y:e.gridY),"ani"in t&&e.animate(t.ani)},updateStoryInCanvas:function(e,t){var n={target:e.target,points:e.data,currentPoint:0,currentPointFrame:1,speed:e.data[0].speed?parseFloat(e.data[0].speed):5};s&&clearInterval(s);var r=this,i=!0,s=setInterval(function(){var e=t.renderer;if(!e.canvas||e.canvas.getBoundingClientRect().width<=0){clearInterval(s);return}t.currentTime=Date.now(),e.backcanvas&&e.updateTiles(),e.camera.lookAt(t.player),e.context.setupForRender(),e.backcanvas&&e.drawEntities(),t.player.prepareDrawAnimation(),t.player.drawName();if(t.player.currentAnimation){var o=e.context.setupObjXForm(t.player.x+e.tilesize/2,t.player.y+e.tilesize-4,t.player.zoom);t.player.currentAnimation.drawAnimation(t.player,t.player.animationInfo),n.paused||t.player.onAnimate(),o&&e.context.restoreObjXForm(o)}t.player.emoticonfile?t.player.drawEmoticon():t.player.chat&&t.player.drawChat(),e.context.cleanUpRender(),i=r.moveToNextWaypoint(n,t)},t.minFrameTime);return n},moveToNextWaypoint:function(e,t){if(!e)return!1;if(e.paused)return!1;var n=e.points[e.currentPoint];if("x"in n||"y"in n){var r={x:"x"in n?n.x-t.player.gridX:0,y:"y"in n?n.y-t.player.gridY:0},i=Math.sqrt(r.x*r.x+r.y*r.y);if(i>=1/64){var s=Math.min(t.frameTimeS*e.speed,i);return t.player.setGridPosition(t.player.gridX+r.x*s/i,t.player.gridY+r.y*s/i),!0}}if("pause"in n){var o=Math.min(n.pause,5);o<2&&this.game.menu.getCurrentMenu()=="playlist"&&e.currentPoint==e.points.length-1&&(o=2);if(e.currentPointFrame*t.frameTimeS<o)return e.currentPointFrame++,!1}if(e.currentPoint<e.points.length-1)e.currentPoint++;else{if(this.game.menu.getCurrentMenu()=="playlist"&&this.switchToNextNewsStory())return e.paused=!0,!1;if(e.target=="minimap")return t.renderer.canvas=null,this.game.minimap.onStoryFinished(),!1;e.currentPoint=0}return e.currentPointFrame=1,n=e.points[e.currentPoint],this.copyPlayAttrFromWaypoint(t.player,n,e.currentPoint==0),"speed"in n&&(e.speed=n.speed),"sound"in n&&this.game.sounds.play(n.sound),!0},addStoryCharacterClickDir:function(e,t){gui.setClick(t,function(t,n,r){var i=n-170,s=r-170,o=Math.abs(i)>Math.abs(s)?i>0?Types.Orientations.RIGHT:Types.Orientations.LEFT:s>0?Types.Orientations.DOWN:Types.Orientations.UP;e.dir=o})},addStoryPauseClick:function(e,t){var n=this;gui.setClick(t,function(){e.paused=!e.paused})},handleStoryAction:function(e,t){switch(e){case"stories":this.showStoryMenu({stories:t});break;case"story":var n=t.target?t.target:this.game.menu.getCurrentMenu();switch(n){case"playerprofile":this.showProfileStory(t);break;case"playlist":this.showPlayListStory(t);break;case"story":this.showStory(t,!1);break;case"pm":this.showPMStory(t);break;case"minimap":this.showMinimapStory(t)}break;case"published":this.game.app.config.enablesharebutton&&t&&"hash"in t&&t["type"]=="game"?this.showPublishedStoryShare(t):this.showStoryMenu({forceload:!0,offset:0});break;case"locationstories":this.showStoryPlayList(t,null)}}});return s}),define("filemanager",[],function(){var e=Class.extend({init:function(e){this.game=e,this.createFileName="*new*",this.autoOpen=[]},showConsole:function(){if(!this.game.client)return;this.game.client.sendConsoleChat("followchannel","chat");if(gui.exists("adminconsole")){gui.show("adminconsole");return}var e=this.showResizableWindow({title:"Admin Console"});e.parentNode.id="adminconsole";var t=document.createElement("div");t.id="adminconsoletext",t.className="adminconsoletext",e.parentNode.appendChild(t);var n=document.createElement("div");n.className="adminconsoleinputcontainer",e.parentNode.appendChild(n);var r=document.createElement("input");r.className="adminconsoleinput",r.type="text",n.appendChild(r);var i=this;e.appendChild(this.game.menu.createButton("Files",{right:46,top:-26,w:100,h:26,mobile:!0},function(e){i.showFileBrowser()})),r.onkeydown=function(e){if(e.which==13){e.preventDefault();var n=this.value.trim();this.value="";switch(n){case"/clear":t.innerHTML="";break;default:i.game&&i.game.client&&n.length>0&&i.game.client.sendConsoleChat("chat",n)}}},this.game.renderer.isMobile||gui.focus(r);var s=gui.find(e.parentNode,"div.resizablewindowclose");s&&s.length>0&&gui.setClick(s[0],function(){gui.hide(e.parentNode),i.game&&i.game.client&&i.game.client.sendConsoleChat("unfollowchannel","chat")})},resendShowConsole:function(){if(!this.game.client)return;gui.isVisible("adminconsole")&&this.game.client.sendConsoleChat("followchannel","chat")},addConsoleText:function(e){gui.appendAndScroll("adminconsoletext",e,!0)},handlePathMessage:function(e,t){this.game.menu.showAlert(t,"File Browser")},showRightClickMenu:function(e,t,n,r,i){var s='<div class="contextmenucontainer" style="left:'+e+"px;top:"+t+'px;">';for(var o=0;o<n.length;o++)s+='<div id="openmenuscript'+o+'" class="contextmenu">'+translate(n[o])+"</div>";s+="</div>";var u=document.createElement("div");u.className="contextmenu_background",u.innerHTML=s,gui.getDom(r||"gamecontainer").appendChild(u);var a=this;gui.setClick(u,function(){gui.remove(u)});for(var o=0;o<n.length;o++)gui.setClick("openmenuscript"+o,this.getRightClickMenuAction(u,i,o))},getRightClickMenuAction:function(e,t,n){return function(){gui.remove(e),t(n)}},loadAndShowClass:function(e){this.showFileBrowser(),this.game.client&&(this.openPaths(["/Scripts/","/Scripts/clientclasses/"]),this.game.client.sendGetPath("/Scripts/clientclasses/"+e+".js"))},loadAndShowButtonConfig:function(e){this.showFileBrowser(),this.game.client&&(this.openPaths(["/Config/"]),this.game.client.sendGetPath("/Config/menubuttons.json"))},loadAndShowItemConfig:function(e){this.showFileBrowser();if(this.game.client){var t="/Config/items/"+(e.itemtype=="armor"?"body":e.itemtype)+"/";this.openPaths(["/Config/","/Config/items/",t]),this.game.client.sendGetPath(t+e.itemid+".json")}},openPaths:function(e){for(var t in e){var n=e[t],r=gui.find("filebrowsertree","[data-path='"+n+"']");if(r&&r.length>0){if(gui.hasClass(r[0],"active"))continue;gui.addClass(r[0],"active"),gui.addClass(r[0].parentElement.querySelector(".foldertitle"),"active")}else this.autoOpen.indexOf(n)<0&&this.autoOpen.push(n);this.game.client&&this.game.client.sendGetPath(n)}},showFileBrowser:function(){if(!this.game.player||!this.game.player.isGameAdmin())return;if(gui.isVisible("filebrowsertree"))return;var e=this.showResizableWindow({title:"File Browser",width:532,height:320});e.style.background="white",e.style.display="flex",e.innerHTML='<div id="filebrowsertree" style="width:'+(this.game.renderer.isMobile?25:40)+'%;display:flex;min-width:50px;overflow:auto;">'+'<ul class="tree active" data-path="/"></ul>'+"</div>"+'<div id="filebrowserresizer" style="background-color:darkgreen;cursor:ew-resize;height:100%;width:4px;"></div>'+'<div id="filebrowserview" style="flex:1;display:flex;min-width:50px;">'+"</div>";var t={name:"/",nodes:[{name:"Config/"},{name:"Files/"},{name:"Scripts/"},{name:"Maps/"},{name:"Admins/"},{name:"DB/"}]};this.setFileTreeFolder(e.children[0],"/",t,""),this.addResizer(e);var n=this,r=this.game.menu.createButton("💾 "+translate("Update"),{right:24,bottom:-33,w:140,h:26,mobile:!0},function(e){n.updateFileTreeContent(e.target)});r.id="filebrowsersave",r.style.display="none",e.appendChild(r);var i=this.game.menu.createButton(translate("Ani Editor"),{right:178,bottom:-33,w:140,h:26,mobile:!0},function(e){n.showAnimationEditor(e.target)});i.id="filebrowseranieditor",i.style.display="none",e.appendChild(i);var s=this.game.menu.createButton("➕"+translate("Add"),{left:8,bottom:-33,w:140,h:26,mobile:!0},function(e){n.addNewFileWithEditor(e.target)});s.id="filebrowseradd",s.style.display="none",e.appendChild(s);var o=gui.getDom("filebrowsertree");this.addUpload(o),this.addRightClickFileMenu(o,e),e.parentNode&&(e.parentNode.onmouseup=function(e){n.scripteditors&&n.filescriptid&&n.scripteditors[n.filescriptid]&&n.scripteditors[n.filescriptid].resize()})},addUpload:function(e){var t=function(e){return e.preventDefault&&e.preventDefault(),!1};e.addEventListener("dragover",t),e.addEventListener("dragenter",t);var n=this;e.addEventListener("drop",function(e){e=e||window.event,e.preventDefault&&e.preventDefault();var t=e.dataTransfer.files;for(var r=0;r<t.length;r++){var i=t[r],s=new FileReader;s.onload=n.getUploadHandler(i),s.readAsDataURL(i)}return!1})},getUploadHandler:function(e){var t=this;return function(n){if(!t.selectedfolder)return;var r=n.target.result;if(!r)return;r=r.substring(r.indexOf(",")+1),window.console&&console.log("Filebrowser upload: "+t.selectedfolder+e.name+", length "+atob(r).length),t.game.client.sendSetPath(t.selectedfolder+e.name,r,"base64")}},addRightClickFileMenu:function(e,t){var n=this;gui.setRightClick(e,function(e,r,i){var s=document.elementFromPoint(e.pageX,e.pageY);if(!s)return;switch(s.className){case"filetitle":var o=s.parentElement.parentElement;if(o&&o.dataset&&o.dataset.rights&&o.dataset.rights.indexOf("w")>=0){var u=o.dataset.path+s.innerText;if(u.indexOf("/Files/")==0||u.indexOf("/Maps/")==0||u.indexOf("/Config/")==0||u.indexOf("/Scripts/")==0){var a=["💾 "+translate("Download")+" "+s.innerText];(u.indexOf("/Files/")==0||u.indexOf("/Maps/")==0&&o.dataset.path!="/Maps/")&&a.push("❌ "+translate("Delete")+" "+s.innerText),n.showRightClickMenu(r,i,a,t,function(e){switch(e){case 0:n.game.client&&(n.downloadpath=u,n.game.client.sendGetPath(u));break;case 1:n.game.client.sendSetPath(u,"","text")}})}}break;case"foldertitle":}})},addResizer:function(e){var t=gui.getDom("filebrowserresizer");if(!t)return;var n=t.previousElementSibling,r=t.nextElementSibling,i=0,s=0,o=0,u=function(e){i=e.clientX,s=e.clientY,o=n.getBoundingClientRect().width,document.addEventListener("mousemove",a),document.addEventListener("mouseup",f)},a=function(e){n.style.width=(o+e.clientX-i)*100/t.parentNode.getBoundingClientRect().width+"%",n.style.userSelect="none",n.style.pointerEvents="none",r.style.userSelect="none",r.style.pointerEvents="none"},f=function(){n.style.removeProperty("user-select"),n.style.removeProperty("pointer-events"),r.style.removeProperty("user-select"),r.style.removeProperty("pointer-events"),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",f)};t.addEventListener("mousedown",u)},setFileTreeFolder:function(e,t,n,r){var i=gui.find(e,"ul[data-path='"+t+"']");i&&i.length>0&&n&&(i[0].innerHTML=this.getFileNodeHTML(t,n.nodes),this.handleFileNodeClicks(i[0],t,r)),this.setFolderButtonFlags(t,r)},setFolderButtonFlags:function(e,t){this.selectedfolder=e,t&&t.indexOf("w")>=0&&(["/Admins/","/DB/"].indexOf(e)>=0||e.indexOf("/Config/items/")==0&&e!="/Config/items/"||e.indexOf("/Files/")==0&&e!="/Files/"||e.indexOf("/Maps/")==0)?gui.show("filebrowseradd"):gui.hide("filebrowseradd")},getFileNodeHTML:function(e,t){var n="";if(t)for(var r=0;r<t.length;r++){var i=t[r],s="rights"in i&&i.rights.indexOf("r")<0?"lightgray":"black",o=this.autoOpen.indexOf(e+i.name),u=o>=0;u&&this.autoOpen.splice(o,1);if(i["name"].substr(i["name"].length-1)=="/")n+='<li><span class="foldertitle'+(u?" active":"")+'" style="color:'+s+';">'+i.name.substring(0,i.name.length-1)+"</span>",n+='<ul class="tree'+(u?" active":"")+'" data-path="'+e+i.name+'">',n+=this.getFileNodeHTML(e+i.name,i.nodes),n+="</ul></li>";else{var a=i.name.lastIndexOf("."),f=a>=0&&["css","gif","jpg","jpeg","json","mov","mp3","mp4","png","psd","ttf","txt","wav","zip"].indexOf(i.name.substring(a+1))>=0?i.name.substring(a+1):null;n+='<li><span class="filetitle" style="color:'+s+";"+(f?"background-image:url("+this.game.filespath+"gui/bbuilder_fileicon_"+f+".png);":"")+'">'+i.name+"</span></li>"}}return n},handleFileNodeClicks:function(e,t,n){e.dataset.rights=n;var r=this;gui.setChildClick(e,".foldertitle",function(e){var i=e.target.parentElement.querySelector(".tree");gui.hasClass(e.target,"active")?(gui.removeClass(e.target,"active"),gui.removeClass(i,"active")):(gui.addClass(e.target,"active"),gui.addClass(i,"active"),i.dataset.loaded||(i.dataset.loaded=!0,r.game.client&&r.game.client.sendGetPath(i.dataset.path))),i.dataset.rights?r.setFolderButtonFlags(i.dataset.path,i.dataset.rights):r.setFolderButtonFlags(t,n)}),gui.setChildClick(e,".filetitle",function(e){var i=e.target.parentElement.parentElement;r.game.client&&r.game.client.sendGetPath(i.dataset.path+e.target.innerText),i.dataset.rights?r.setFolderButtonFlags(i.dataset.path,i.dataset.rights):r.setFolderButtonFlags(t,n)})},showFileTreeContent:function(e,t,n,r,i){this.filetreecontentpath=e,this.scripteditors&&this.filescriptid&&(delete this.scripteditors[this.filescriptid],delete this.filescriptid);if(this.downloadpath){if(this.downloadpath==e){delete this.downloadpath,this.saveDownload(e,t,n);return}delete this.downloadpath}var s=gui.getDom("filebrowserview");s.parentNode&&s.parentNode.parentNode&&gui.setChildAttribute(s.parentNode.parentNode,"div.resizablewindowtitle","title","File Browser - "+e);if(e.indexOf("/Admins/")==0){this.showFileInJSONEditor(s,e,t,r,this.getAdminInfoConfig(!1));return}if(e.indexOf("/DB/")==0){this.showFileInJSONEditor(s,e,t,r,this.getDBInfoConfig());return}var o=e.lastIndexOf("."),u=o>=0?e.substring(o+1):null;switch(u){case"json":e.indexOf("/Config/items/")==0&&e.indexOf("editorconfig.json")<0?this.showFileInJSONEditor(s,e,t,r,this.requestEditorConfig(e)):this.showFileInScriptEditor(s,t,r);return;case"js":case"bani":this.showFileInScriptEditor(s,t,r,u=="bani");return;case"png":case"jpg":case"jpeg":case"gif":if(n=="base64"){s.innerHTML='<div style="overflow:auto;width:100%;height:100%;"><img src="data:image/'+u+";base64,"+t+'" style="max-width:100%; max-height:100%;"></div>',this.setFilesButtonFlags("");return}break;case"md":case"txt":case"css":default:if(n=="text"){s.innerHTML='<textarea type="text" style="width:100%;height:100%;overflow:auto;border:0; padding:0; resize:none; font-size:17px;" class="scrollable">'+t+"</textarea>",this.setFilesButtonFlags(r);return}}i?this.showFileInJSONEditor(s,e,i,null,this.getFileInfoConfig()):s.innerHTML="<i>Preview not possible</i>",this.setFilesButtonFlags(""),this.filetreecontentpath=null},saveDownload:function(e,t,n){if(!t||t.length<=0){this.handlePathMessage(e,"File cannot be downloaded (empty or too large)!");return}var r=e.substring(e.lastIndexOf("/")+1),i=e.lastIndexOf("."),s=i>=0?e.substring(i+1):null,o="text/plain";switch(s){case"png":case"jpeg":case"gif":o="image/"+s;break;case"jpeg":o="image/jpeg";break;case"js":o="application/javascript";break;case"json":o="application/"+s}var u=new Blob([n=="base64"?Uint8Array.from(atob(t),function(e){return e.charCodeAt(0)}):t],{type:o}),a=window.URL.createObjectURL(u),f=document.createElement("a");f.href=a,f.download=r,f.click(),window.URL.revokeObjectURL(a)},showFileInJSONEditor:function(e,t,n,r,i){e.innerHTML='<div id="jsoneditor" style="overflow:auto;padding:8px;width:100%;background-color: rgb(238, 238, 238);"></div>',this.loadJSONEditorLib(function(){var t=e.children[0],r=new JSONEditor(t,{disable_collapse:!0,disable_array_reorder:!0,disable_array_delete_last_row:!0,theme:"spectre",schema:i});r.setValue(typeof n=="string"?JSON.parse(n):n),t.jsoneditor=r}),this.setFilesButtonFlags(r)},showFileInScriptEditor:function(e,t,n,r){this.nextscriptid||(this.nextscriptid=1);var i=this.nextscriptid++;this.scripteditors||(this.scripteditors={}),e.innerHTML='<div contenteditable id="npcscriptfield'+i+'" style="width:100%;height:100%;"></div>';var s=this;this.loadScriptEditorLib(function(){s.onLoadedScriptEditor(i,t,null)}),this.filescriptid=i,this.setFilesButtonFlags(n),r?(this.dataforanieditor=t,gui.show("filebrowseranieditor")):gui.hide("filebrowseranieditor")},setFilesButtonFlags:function(e){e&&e.indexOf("w")>=0?gui.show("filebrowsersave"):gui.hide("filebrowsersave"),gui.hide("filebrowseranieditor")},updateFileTreeContent:function(e){var t=this.filetreecontentpath;if(!t)return;var n=t,r=t.substring(0,t.lastIndexOf("/")+1),i=e.parentNode.children[2].children[0],s;if(i.id=="jsoneditor"){var o=i.jsoneditor.getValue();s=JSON.stringify(o,null,4),r=="/Admins/"?o.userid&&o.userid>=1&&o.adminlevel&&o.adminlevel>=1&&(n=r+o.userid+" (lvl "+o.adminlevel+")"):r=="/DB/"?o.name&&o.name.length>0&&(n=r+o.name):r.indexOf("/Config/items/")==0&&o.itemid&&o.itemid.length>0&&(n=r+o.itemid+".json")}else i.id.indexOf("npcscriptfield")==0&&this.filescriptid?s=this.scripteditors[this.filescriptid].getValue():i.type=="textarea"&&(s=i.value);if(t.indexOf(this.createFileName)>=0){if(n==t)return;t=n}s&&this.game.client&&(this.game.client.sendSetPath(t,s,"text"),this.filetreecontentpath=n)},addNewFileWithEditor:function(e){if(!this.selectedfolder)return;var t=e.parentNode.children[2],n,r;if(this.selectedfolder.indexOf("/Admins/")==0)n={userid:null,adminlevel:1,commands:[],paths:[]},r=this.getAdminInfoConfig(!0);else if(this.selectedfolder.indexOf("/DB/")==0)n={name:"",columns:[]},r=this.getDBInfoConfig();else if(this.selectedfolder.indexOf("/Config/items/")==0)n={itemid:"",name:"",itemtype:"",price:0,description:""},r=this.requestEditorConfig(this.selectedfolder);else if(this.selectedfolder.indexOf("/Maps/")==0||this.selectedfolder.indexOf("/Files/")==0){var i=document.createElement("input");i.type="file",this.selectedfolder=="/Maps/"?i.accept="application/json":this.selectedfolder.indexOf("/Files/animations/")==0?i.accept=".bani":this.selectedfolder.indexOf("/Files/music/")==0?i.accept=".mp3":this.selectedfolder.indexOf("/Files/sounds/")==0?i.accept=".wav":this.selectedfolder.indexOf("/Files/css/")==0?i.accept=".css":this.selectedfolder.indexOf("/Files/fonts/")==0?i.accept=".ttf":i.accept="image/png,image/gif,image/jpeg";var s=this;i.addEventListener("change",function(e){if(i.files.length<=0)return;var t=i.files[0],n=new FileReader;return n.onload=s.getUploadHandler(t),n.readAsDataURL(t),gui.remove(i),!0}),i.style.display="none",t.appendChild(i),i.click();return}n&&r&&(this.filetreecontentpath=this.selectedfolder+this.createFileName,this.showFileInJSONEditor(t,this.filetreecontentpath,n,"rw",r))},showAnimationEditor:function(e){if(!this.dataforanieditor)return;var t=this,n="https://"+(window.location.host?window.location.host:"iappsbeats.com")+"/animations/index.html#avalonia",r=e.parentNode.children[2];r.innerHTML='<iframe id="animationeditor" src="'+n+'"'+' frameborder=0 allowfullscreen=true style="width:100%; height:100%;" sandbox="allow-same-origin allow-scripts allow-popups allow-forms"></iframe>';var i=document.getElementById("animationeditor");i.onload=function(){var e=setInterval(function(){if(!i.contentWindow.helper||!i.contentWindow.app)return;clearInterval(e);var n=typeof t.dataforanieditor=="string"?JSON.parse(t.dataforanieditor):t.dataforanieditor;n.online=!1;var r="[avalonia] internal";i.contentWindow.helper.ui.saveToLocal(r+".bani",n),i.contentWindow.app.run.loadLocal(r)},100)},this.setFilesButtonFlags("")},requestEditorConfig:function(e){var t=e.lastIndexOf("/"),n=e.substring(0,t+1);return this.cachedEditorConfigs||(this.cachedEditorConfigs={}),this.cachedEditorConfigs[n]?this.cachedEditorConfigs[n]:(this.cachedEditorConfigs[n]=this.getItemInfoConfig(),this.game.client&&this.game.client.sendGetPath(n+"editorconfig.json"),this.cachedEditorConfigs[n])},getItemInfoConfig:function(){return{title:"Item",type:"object",required:["itemid","name","itemtype","price"],properties:{itemid:{type:"string",minLength:2},name:{type:"string"},itemtype:{type:"string"},description:{type:"string"},price:{type:["number","object"]}}}},getAdminInfoConfig:function(e){return{title:"Admin Rights",type:"object",required:["userid","adminlevel"],properties:{userid:{type:"number",readonly:!e},adminlevel:{type:"number"},name:{type:"string",readonly:!0},updatetime:{type:"string",readonly:!0},commands:{type:"array",format:"table",title:"Commands",items:{type:"string",title:"command"}},paths:{type:"array",format:"table",title:"Access paths",items:{type:"string",title:"path"}}}}},getDBInfoConfig:function(){return{title:"Table Info",type:"object",options:{mode:"view"},required:["name","columns"],properties:{name:{type:"string",title:"table name",options:{inputAttributes:{placeholder:"New Table Name"}}},columns:{type:"array",readonly:!0,format:"table",title:"Columns",options:{compact:!0,disable_array_delete_all_rows:!0},items:{type:"object",properties:{name:{type:"string",title:"column name"},type:{type:"string"}}}},created:{type:"string"},tablerows:{type:"number",title:"number of rows (est.)"},datasize:{type:"number",title:"data size (bytes)"},indexsize:{type:"number",title:"index size (bytes)"}}}},getFileInfoConfig:function(){return{title:"File",type:"object",properties:{name:{type:"string",title:"File Name"},ext:{type:"string",title:"Extension"},size:{type:"number",title:"Size (bytes)"},created:{type:"string",title:"Created on"},updatetime:{type:"string",title:"Last Modified on"}}}},setEditorConfig:function(e,t){var n=e.lastIndexOf("/"),r=e.substring(0,n+1);this.cachedEditorConfigs||(this.cachedEditorConfigs={}),this.cachedEditorConfigs[r]=JSON.parse(t);var i=gui.getDom("jsoneditor");if(i&&i.jsoneditor){var s=i.jsoneditor.getValue();i.jsoneditor.destroy();var o=new JSONEditor(i,{disable_collapse:!0,disable_array_reorder:!0,disable_array_delete_last_row:!0,theme:"spectre",schema:this.cachedEditorConfigs[r]});o.setValue(s),i.jsoneditor=o}},loadJSONEditorLib:function(e){if(window.JSONEditor){e();return}document.head.innerHTML+='<link rel="stylesheet" href="'+this.game.filespath+'css/spectre.min.css">',require(["scripts/jsoneditor.min"],function(t){t?(window.JSONEditor=t.JSONEditor,e()):require(["scripts/jsoneditor.min"],function(t){window.JSONEditor=t.JSONEditor,e()})})},showEditFurniture:function(e){this.editfurniture=e,this.editnpcfields=this.editfurniture?this.editfurniture.editfields:null;var t="canscript"in this.editfurniture&&this.editfurniture.canscript,n=this.game.menu.showPopUp({title:t?"Edit Script NPC":"Edit Furniture",popupType:"editfurniture"}),r=this.editfurniture&&this.editfurniture.editdescription?translate(this.editfurniture.editdescription)+"<br><br>":"",i=this;if(t)this.editnpcfields||(this.editnpcfields=[]),this.addEditNPCAttributes(n,r),n.appendChild(this.game.menu.createButton("🗑 "+translate("Delete"),{x:0,bottom:10,w:195,h:40},function(e){i.deleteFurniture()})),n.appendChild(this.game.menu.createButton("✏️ "+translate("Edit Script"),{right:0,bottom:10,w:240,h:40},function(e){i.editNPCScript(!1)}));else{r.length<=0&&(r=translate('You can put the furniture back into your inventory by clicking on the "Put Back In Inventory" button.<br>To place it somewhere else, open your inventory menu (or press Q on PC), select the furniture folder, and click on the furniture object.')+"<br><br>"),this.editnpcfields||(this.editnpcfields=[]),this.addEditNPCAttributes(n,r);var s="addsidekick"in this.editfurniture;n.appendChild(this.game.menu.createButton("Put Back In Inventory",{x:s?87:212,bottom:5,w:240,h:40},function(e){i.deleteFurniture()})),s&&n.appendChild(this.game.menu.createButton("Let the pet follow you",{x:337,bottom:5,w:240,h:40},function(e){i.addSidekick()}))}},deleteFurniture:function(){this.game.menu.closePopUp(),this.game.client&&this.game.client.sendNPCTrigger(this.editfurniture.id,"delete",{})},addEditNPCAttributes:function(e,t){if(!this.editnpcfields||this.editnpcfields.length<=0){e.innerHTML=t;return}var t=t+'<div style="position:relative;">';t+='<form id="editnpcform" name="editnpcform" style="width:100%;">\n';var n=0;for(var r in this.editnpcfields){var i=this.editnpcfields[r];t+='<label style="position:absolute;top:'+n+"px;width:"+(i.checkbox?660:170)+'px;">',i.checkbox?t+='<input type="checkbox" name="editnpc'+i.name+'"'+(this.editfurniture&&this.editfurniture[i.name]?" checked":"")+(i.readonly?" disabled":"")+">"+translate(i.label):t+=translate(i.label)+'<input type="text" name="editnpc'+i.name+'"'+' style="position:absolute;left:170px;width:460px;height:32px;" value="'+(this.editfurniture&&this.editfurniture[i.name]?this.editfurniture[i.name]:"")+'"'+(i.readonly?" readonly":"")+">",t+="</label>\n",n+=40}t+='<br><input type="submit" value="💾 '+translate("Update")+'"'+' style="position: absolute; top:'+(n+5)+'px; left: 280px; width: 200px; height: 40px;" class="inputbutton">\n'+"</form><div>",e.innerHTML=t;var s=this,o=gui.getDom("editnpcform");o.onsubmit=function(e){return s.updateNPCAttributes(),!1}},updateNPCAttributes:function(){var e={};for(var t in this.editnpcfields){var n=this.editnpcfields[t],r=document.editnpcform["editnpc"+n.name];r&&(this.editfurniture[n.name]=e[n.name]=n.checkbox?r.checked:r.value.trim())}this.game.menu.closePopUp(),this.game.client&&this.game.client.sendNPCTrigger(this.editfurniture.id,"setoptions",e)},addSidekick:function(){this.game.menu.closePopUp(),this.game.client&&this.game.client.sendNPCTrigger(this.editfurniture.id,"addsidekick",{})},editNPCScript:function(e){var t=gui.getDom("newpopup"),n=gui.getWidth(t),r=gui.getHeight(t),i=gui.getPosition(t);this.game.menu.closePopUpNow();var s=this.showResizableWindow({title:e?"Client-Script":"Server-Script",left:i.left,top:i.top}),o=this.editfurniture.id;this.nextscriptid||(this.nextscriptid=1);var u=this.nextscriptid++,a=this.nextscriptid++,f,l;for(var c=0;c<=1;c++){var h=c==1,p=c==1?a:u,d=this.editfurniture[h?"clientscript":"script"];this.scripteditors||(this.scripteditors={}),scriptcontainer=this.game.menu.createMenuContainer(s,{x:0,y:0,w:"100%",h:"100%"}),scriptcontainer.id="scriptcontainer_"+p,scriptcontainer.style.display=e==h?"block":"none",scriptcontainer.innerHTML='<form name="npcscriptform" style="width:100%;height:100%;">\n<div contenteditable    id="npcscriptfield'+p+'" name="npcscriptfield'+p+'" style="width:100%;height:100%;text-shadow:none;"></div>'+"</form></div>";var v=this.getScriptUpdateButton(o,p,h);scriptcontainer.appendChild(v),h?l=v:f=v}var m=this;s.appendChild(this.game.menu.createButton("Server",{right:146,top:-26,w:100,h:26,mobile:!0},function(e){m.switchScriptServerClient(u,a,s,"Server-Script")})),s.appendChild(this.game.menu.createButton("Client",{right:46,top:-26,w:100,h:26,mobile:!0},function(e){m.switchScriptServerClient(a,u,s,"Client-Script")})),s.appendChild(this.game.menu.createButton("📚 "+translate("Docs"),{right:178,bottom:-33,w:140,h:26,mobile:!0},function(e){m.game.shop.showURL(m.game.app.config.docsurl,"inside")})),this.loadScriptEditorLib(function(){m.onLoadedScriptEditor(u,m.editfurniture.script,f),m.onLoadedScriptEditor(a,m.editfurniture.clientscript,l)}),s.parentNode.onmouseup=function(e){m.scripteditors[u]&&m.scripteditors[u].resize(),m.scripteditors[a]&&m.scripteditors[a].resize()},this.game.scriptmanager.runScript(this.game.player,this.game.player,"newscriptwindow",[s,this.editfurniture])},getScriptUpdateButton:function(e,t,n){var r=this,i="💾 "+translate("Update");return this.game.menu.createButton(i,{right:24,bottom:-33,w:140,h:26,mobile:!0},function(s){r.saveNPCScript(e,t,n),s.target&&(s.target.value=i)})},switchScriptServerClient:function(e,t,n,r){var i=gui.getDom("scriptcontainer_"+e);i&&(i.style.display="block"),i=gui.getDom("scriptcontainer_"+t),i&&(i.style.display="none"),n.parentNode&&gui.setChildAttribute(n.parentNode,"div.resizablewindowtitle","title",r)},showResizableWindow:function(e){e=e||{};var t=translate(e.title)||"",n=gui.getDom("gamecontainer"),r=document.createElement("div");r.className="resizablewindow",this.game.renderer.isMobile||(e.width&&(r.style.width=Math.min(e.width,n.offsetWidth)+"px"),e.height&&(r.style.height=Math.min(e.height,n.offsetHeight)+"px"),e.x!=undefined||e.left!=undefined?r.style.left=(e.x!=undefined?e.x:e.left)+"px":r.style.left="0px",e.y!=undefined||e.top!=undefined?r.style.top=(e.y!=undefined?e.y:e.top)+"px":r.style.top="0px"),n.appendChild(r);var i=document.createElement("div");i.className="resizablewindowtitle",i.setAttribute("title",t),this.game.renderer.isMobile||(i.onmousedown=function(e){var t=r.style.top.replace("px",""),n=r.style.left.replace("px",""),i=e.clientX-n,s=e.clientY-t;document.onmousemove=function(e){var t=e.clientX,n=e.clientY,o=t-i,u=n-s;r.style.left=o+"px",r.style.top=u+"px"},document.onmouseup=function(e){document.onmousemove=document.onmouseup=function(){}}}),r.appendChild(i);if(!e.hideclosebutton){var s=document.createElement("div");s.className="resizablewindowclose",gui.setClick(s,function(e){gui.remove(r)}),r.appendChild(s)}var o=document.createElement("div");return o.className="resizablewindowcontent",r.appendChild(o),o},saveNPCScript:function(e,t,n){var r=this.scripteditors[t].getValue();if(this.game.client){var i={};i[n?"clientscript":"script"]=r,this.game.client.sendNPCTrigger(e,"setoptions",i)}},loadScriptEditorLib:function(e){if(window.ace){e();return}var t=document.createElement("script");t.onload=function(){window.ace.require("ace/ext/language_tools"),e()},t.src="scripts/ace.js",document.head.appendChild(t)},onLoadedScriptEditor:function(e,t,n){var r=window.ace.edit("npcscriptfield"+e);r.getSession().setTabSize(4),r.setFontSize(this.game.renderer.isMobile?28:14),r.setOptions({enableSnippets:!1,enableBasicAutocompletion:[{getCompletions:function(e,t,n,r,i){i(null,[{value:"this",score:1,meta:"keyword"},{value:"var",score:1,meta:"keyword"},{value:"let",score:1,meta:"keyword"},{value:"return",score:1,meta:"keyword"},{value:"if",score:1,meta:"keyword"},{value:"else",score:1,meta:"keyword"},{value:"for",score:1,meta:"keyword"},{value:"in",score:1,meta:"keyword"},{value:"of",score:1,meta:"keyword"},{value:"while",score:1,meta:"keyword"},{value:"do",score:1,meta:"keyword"},{value:"throw",score:1,meta:"keyword"},{value:"continue",score:1,meta:"keyword"},{value:"break",score:1,meta:"keyword"},{value:"switch",score:1,meta:"keyword"},{value:"function",score:1,meta:"keyword"},{value:"onCreated()",score:.9,meta:"event"},{value:"onUpdated()",score:.9,meta:"event"},{value:"onTimeout()",score:.9,meta:"event"},{value:"onPlayerTouchsMe(player)",score:.8,meta:"event"},{value:"onPlayerSays(player)",score:.7,meta:"event"},{value:"onPlayerAttacks(player)",score:.6,meta:"event"},{value:"onMouseDown(player)",score:.8,meta:"event"}])}}],enableLiveAutocompletion:!0}),r.setValue(t?t:""),r.clearSelection(),r.getSession().setMode("ace/mode/javascript"),r.getSession().on("change",function(){n&&(n.value="💾 "+translate("Update")+"*")}),r.focus(),this.scripteditors[e]=r}});return e}),define("tradingmanager",[],function(){var e=Class.extend({init:function(e){this.game=e,this.trademenus=["trade","searchitem","itemsearchresult","changetradecoins","changetradeitem"],this.inventorymenus=["inventory","category"]},handleTradeAction:function(e,t){switch(e){case"starttrade":this.lastTradeUpdate=this.game.currentTime,delete this.game.menu.inventoryitems,this.showTradeMenu(t);break;case"stoptrade":if(!this.tradeinfo)return;this.tradeinfo=null,this.trademenus.indexOf(this.game.menu.getCurrentMenu())>=0&&this.game.menu.closePopUp();break;case"items":if(!this.tradeinfo)return;this.lastTradeUpdate=this.game.currentTime,this.tradeinfo.mode=t.mode,this.tradeinfo.items=t.items,this.tradeinfo.coins=t.coins,this.tradeinfo.otheritems=t.otheritems,this.tradeinfo.othercoins=t.othercoins,this.tradeinfo.chat=t.chat,this.showTradeMenu(this.tradeinfo);break;case"chat":if(!this.tradeinfo)return;this.tradeinfo.chat=this.tradeinfo.chat?this.tradeinfo.chat+t.text:t.text,gui.appendAndScroll("tradechattext",t.text,!0);break;case"history":this.showTradeHistory(t.trades,!1,t.offset);break;case"adminhistory":t["userid"]==this.game.menu.playerprofiledata["userid"]&&this.showTradeHistory(t.trades,!1,t.offset,!0)}},showTradeMenu:function(e){this.tradeinfo=e;if(!this.tradeinfo)return;this.tradehistoryIsAdmin=!1,this.game.menu.closePopUpNow("trade");var t=this.game.menu.showPopUp({title:translate("Trade with %s",[this.tradeinfo.name]),popupType:"trade"}),n=[];for(var r in this.tradeinfo.otheritems)n.push(this.getTradeItemForMenu(this.tradeinfo.otheritems[r],!1));this.tradeinfo.othercoins&&this.tradeinfo["othercoins"]!=0&&n.push(this.getTradeItemForMenu({image:"bbuilder_coin_big.png",name:"Coins",nr:this.tradeinfo.othercoins,itemid:"coins"},!1));var i=this.game.menu.createMenuContainer(t,{x:0,y:-4,w:500,h:200});n.length<6&&(i.innerHTML='<div class="tradeplayername">'+translate("Items of %s",[this.tradeinfo.name])+"</div>"),this.game.menu.addMenuItemsToDialog(i,n);var s=[];for(var r in this.tradeinfo.items)s.push(this.getTradeItemForMenu(this.tradeinfo.items[r],!0));this.tradeinfo.coins&&this.tradeinfo["coins"]!=0&&s.push(this.getTradeItemForMenu({image:"bbuilder_coin_big.png",name:"Coins",nr:this.tradeinfo.coins,itemid:"coins"},!0)),i=this.game.menu.createMenuContainer(t,{x:0,y:200,w:500,h:200}),s.length<6&&(i.innerHTML='<div class="tradeplayername">'+translate("Your items")+"</div>"),this.game.menu.addMenuItemsToDialog(i,s);var o=gui.getHeight(t),u=this.game.app.config.enablenewgui;i=this.game.menu.createMenuContainer(t,{x:500,y:0,w:140,h:o-(u?32:18)-120-15}),i.id="tradechat",i.innerHTML='<div id="tradechattext"></div><div id="tradechatinputcontainer">    <input id="tradechatinput" type="text" placeholder="Chat"></div>',gui.appendAndScroll("tradechattext",this.tradeinfo.chat,!1);var a=this;gui.getDom("tradechatinput").onkeydown=function(e){if(e.which==13){e.preventDefault();var t=this.value.trim();this.value="",a.game&&a.game.client&&t.length>0&&a.game.client.sendTradeAction("chat",{text:t})}},i=this.game.menu.createMenuContainer(t,{x:500,y:o-(u?32:18)-120,w:140,h:120}),i.id="tradebuttons";switch(this.tradeinfo.mode){case"askconfirm":i.appendChild(this.game.menu.createButton("Confirm Trade",{x:0,y:80,w:140,h:40},function(e){a.sendConfirmTrade()}));break;case"waitconfirm":i.innerHTML="<i>"+translate("Waiting for other side to confirm...")+"</i>";break;case"additems":if(s.length<8){var f=[{help:"Add Item",image:"bbuilder_newbutton_additem.png",cssclass:"tradebutton",callback:function(e){a.game.menu.closePopUpNow("searchitem"),a.game.menu.showSearchItem(!0)}}];this.game.app.config.disabletradecoins||f.push({help:"Add Coins",image:"bbuilder_newbutton_buycoins.png",cssclass:"tradebutton",callback:function(e){a.game.menu.closePopUpNow("changetradecoins"),a.showChangeTradeCoins()}}),this.game.menu.addMenuItemsToDialog(i,f)}i.appendChild(this.game.menu.createButton("Finish Trade",{x:0,y:80,w:140,h:40},function(e){a.sendFinishTrade()}))}},getTradeItemForMenu:function(e,t){e=JSON.parse(JSON.stringify(e)),this.game.menu.prepareItemAttributes(e),e.cssclass="tradeitem";var n=this;e["itemtype"]=="weapon"&&e["weapontype"]=="sword"&&e.level>1&&(e.stats="lvl "+e.level);var r=e.nr&&e.nr>1?e.nr:0;return r<=0&&e.itemid.indexOf("coin")>=0&&(r=1),e.text=e.help=(r>0?r+" x ":"")+e.name,t&&(e.badgeicon=this.game.filespath+"gui/bbuilder_settingsbadge.png",e.callback=function(t){n.showChangeTradeItem(e,!1)}),e.itemid!="coins"&&(this.tradehistoryIsAdmin||this.game.player&&this.game.player.isGameAdmin())&&(e.rightcallback=function(t,r,i){n.game.menu.openItemConfig(e,t.target,r,i)}),e},showChangeTradeCoins:function(){var e=this.game.menu.showPopUp({title:"Add or Remove Coins",hideclosebutton:!0,popupType:"changetradecoins"}),t=this;e.innerHTML='<div style="font-size:24px"><br><center>'+translate("Change the amount of coins you want to give away!")+"</center><br><br>\n"+'<center><form id="changecoinsform" name="changecoinsform" style="width:100%;">\n'+translate("Coins:")+' <input type="number" id="changecointsamount" name="changecoinsamount" style="width:360px; height:32px;" value="'+(this.tradeinfo?this.tradeinfo.coins:0)+'">\n'+'<input type="submit" value="'+translate("Update")+'" class="inputbutton"></center>\n'+"</form><div>";var n=gui.getDom("changecoinsform");n.onsubmit=function(e){return t.updateTradeCoins(),!1},this.game.menu.addBackButton(e,"Go back to trading",function(e){t.game.menu.closePopUpNow("trade"),t.showTradeMenu(t.tradeinfo)}),gui.focus("changecointsamount")},updateTradeCoins:function(){var e=parseInt(document.changecoinsform.changecointsamount.value.trim());if(e<0)return;if(this.tradeinfo){var t=this.tradeinfo.coins?this.tradeinfo.coins:0;this.game.client&&e!=t&&this.game.client.sendTradeAction("additem",{itemid:"coins",nr:e-t})}this.game.menu.closePopUpNow("trade"),this.showTradeMenu(this.tradeinfo)},showChangeTradeItem:function(e,t){this.game.menu.closePopUpNow("changetradeitem");var n=this.game.menu.showPopUp({title:"Add or Remove Item",hideclosebutton:!0,popupType:"changetradeitem"}),r=this;n.innerHTML='<div style="font-size:24px"><br><center>'+translate("Change how many of '%s' you want to give away!",[e.name])+"</center><br><br>\n"+'<center><form id="changeitemform" name="changeitemform" style="width:100%;">\n'+translate("Nr.:")+' <input type="number" id="changeitemamount" name="changeitemamount" style="width:360px; height:32px;" value="'+e.nr+'">\n'+'<input type="submit" value="'+translate("Update")+'" class="inputbutton"></center>\n'+"</form><div>";var i=gui.getDom("changeitemform");i.onsubmit=function(n){return r.updateTradeItem(e,t),!1},n.appendChild(this.game.menu.createButton("Delete",{x:180,y:200,w:195,h:40},function(n){r.deleteTradeItem(e,t)})),this.game.menu.addBackButton(n,"Go back to trading",function(e){r.game.menu.closePopUpNow("trade"),r.showTradeMenu(r.tradeinfo)})},updateTradeItem:function(e,t){var n=parseInt(document.changeitemform.changeitemamount.value.trim());if(n<0)return;var r=!t&&e.nr?e.nr:0;this.game.client&&n!=r&&this.game.client.sendTradeAction("additem",{itemid:e.itemid,nr:n-r}),this.game.menu.closePopUpNow("trade"),this.showTradeMenu(this.tradeinfo)},addTradeItem:function(e,t){this.game.client&&this.game.client.sendTradeAction("additem",{itemid:e,nr:t}),this.showTradeMenu(this.tradeinfo)},deleteTradeItem:function(e,t){!t&&this.game.client&&this.game.client.sendTradeAction("additem",{itemid:e.itemid,nr:e.nr?-e.nr:-1}),this.game.menu.closePopUpNow("trade"),this.showTradeMenu(this.tradeinfo)},sendFinishTrade:function(){if(!(this.tradeinfo.items&&this.tradeinfo.items.length>0)&&!(this.tradeinfo.coins&&this.tradeinfo.coins>0)&&!(this.tradeinfo.otheritems&&this.tradeinfo.otheritems.length>0)&&!(this.tradeinfo.othercoins&&this.tradeinfo.othercoins>0)){this.game.menu.showAlert("Add some items first!","Finish Trade");return}if(!this.lastTradeUpdate||this.game.currentTime<this.lastTradeUpdate+5e3){this.game.menu.showAlert("Wait a little bit before finishing!","Finish Trade");return}this.game.client&&this.game.client.sendTradeAction("finishtrade",{state:this.tradeinfo}),gui.setHTML("tradebuttons",translate("Waiting for other side to confirm..."))},sendConfirmTrade:function(){if(!this.lastTradeUpdate||this.game.currentTime<this.lastTradeUpdate+1e4){this.game.menu.showAlert("Wait a little bit before confirming!","Confirm Trade");return}this.game.client&&this.game.client.sendTradeAction("confirmtrade",{state:this.tradeinfo}),gui.setHTML("tradebuttons",translate("Confirming trade..."))},checkStopTradeOnMenuClose:function(e){this.tradeinfo&&this.trademenus.indexOf(this.game.menu.getCurrentMenu())>=0&&this.trademenus.indexOf(e)<0&&(this.tradeinfo=null,this.game.client&&this.game.client.sendTradeAction("stoptrade",{})),this.game.player&&this.game.player.canSetAnimation()&&(this.game.menu.getCurrentMenu()=="map"&&e!="map"&&this.game.player.stopAndAnimate("map_close"),this.game.app.config.enablebackpackani&&this.inventorymenus.indexOf(this.game.menu.getCurrentMenu())>=0&&this.inventorymenus.indexOf(e)<0&&this.game.player.stopAndAnimate("backpack_close"))},showTradeHistory:function(e,t,n,r){var i=this.game.menu.getItemsPerPage();e?this.tradehistory=e:(!this.tradehistory||t)&&this.game.client&&(r?this.game.client.sendTradeAction("adminhistory",{userid:this.game.menu.playerprofiledata.userid,offset:n,limit:i+1}):this.game.client.sendTradeAction("loadhistory",{offset:n,limit:i+1})),this.tradehistoryOffset=n,this.tradehistoryIsAdmin=r;var s=this.game.menu.showPopUp({title:"Trade History"+(r?" of "+this.game.menu.playerprofiledata.name:""),popupType:"tradehistory",hideclosebutton:!0,overlap:!0});if(this.tradehistory&&this.tradehistory.length>0){var o=[];for(var u=0;u<i&&u<this.tradehistory.length;u++)o.push(this.getTradeHistoryMenuItem(this.tradehistory[u]));this.game.menu.addMenuItemsToDialog(s,o)}else this.tradehistory&&n==0&&(s.innerHTML='<div style="font-size:24px"><br><br><center>'+(r?translate("There are no trades yet."):translate("There are no trades yet. Tap on players and invite them to trades!"))+"<br><div>");var a=this;n>0&&s.parentNode.appendChild(this.game.menu.createButton("Prev",this.game.menu.getPrevButtonPosition(),function(e){a.showTradeHistory(null,!0,n-i,r)})),this.tradehistory&&this.tradehistory.length>i&&s.parentNode.appendChild(this.game.menu.createButton("Next",this.game.menu.getNextButtonPosition(),function(e){a.showTradeHistory(null,!0,n+i,r)})),r?a.game.menu.addAdminActionsBackButton(s):this.game.menu.addBackButton(s,"Go back to items",function(e){a.game.menu.closePopUpNow("inventory"),a.game.menu.showInventory(!1,a.game.menu.inventoryfromgame)})},getTradeHistoryMenuItem:function(e){var t=e.otherlook.name.substring(0,25),n=t.indexOf("(");n>=0&&(t=t.substring(0,n).trim());var r=this;return{text:(e.time?e.time.substr(0,10)+":<br>":"")+t,itemtype:"head",head:this.game.animationmanager.expandGameFilename("head",e.otherlook.head),hat:this.game.animationmanager.expandGameFilename("hat",e.otherlook.hat),cssclass:"tradehistoryitem",help:translate("View Trade with %s!",[t]),callback:function(t){r.game.menu.closePopUpNow("tradedetails"),r.showTradeDetails(e)}}},showTradeDetails:function(e){var t=translate("Trade with %s",[e.otherlook.name]);this.game.player&&this.game.player.isGameAdmin()&&"otherid"in e&&(t+=" ("+e.otherid+")");var n=this.game.menu.showPopUp({title:t,popupType:"tradedetails",hideclosebutton:!0}),r=[];for(var i in e.otheritems)r.push(this.getTradeItemForMenu(e.otheritems[i],!1));e.othercoins&&e["othercoins"]!=0&&r.push(this.getTradeItemForMenu({image:"bbuilder_coin_big.png",name:"Coins",nr:e.othercoins,itemid:"coins"},!1));var s=this.game.menu.createMenuContainer(n,{x:0,y:-4,w:664,h:200});s.innerHTML='<div class="tradeplayername">'+translate("Items of %s",[e.otherlook.name])+"</div>",this.game.menu.addMenuItemsToDialog(s,r),r=[];for(var i in e.items)r.push(this.getTradeItemForMenu(e.items[i],!1));e.coins&&e["coins"]!=0&&r.push(this.getTradeItemForMenu({image:"bbuilder_coin_big.png",name:"Coins",nr:e.coins,itemid:"coins"},!1)),s=this.game.menu.createMenuContainer(n,{x:0,y:200,w:664,h:200}),s.innerHTML='<div class="tradeplayername">'+(this.tradehistoryIsAdmin?translate("Items of %s",[this.game.menu.playerprofiledata.name]):translate("Your items"))+"</div>",this.game.menu.addMenuItemsToDialog(s,r);var o=this;this.game.menu.addBackButton(n,"Go back to trades",function(e){o.game.menu.closePopUpNow("tradehistory"),o.showTradeHistory(null,!1,o.tradehistoryOffset,o.tradehistoryIsAdmin)})}});return e}),define("minimap",["player","newnpc","newmap"],function(e,t,n){var r=Class.extend({init:function(e,t,n){this.game=e,this.showingStory=null,this.context=t&&t.getContext?t.getContext("2d"):null,this.canvas=t,this.winnercontext=n&&n.getContext?n.getContext("2d"):null,this.winnercanvas=n,this.area=this.game.app.config.minimaparea,this.context.font="bold 14px Verdana",this.context.textAlign="center",this.context.fillStyle="#FFFFFF",this.context.strokeStyle="#373737",this.context.lineWidth=5},getWidth:function(){return this.canvas.width},getHeight:function(){return this.canvas.height},updateMarkerInfo:function(){if(!this.game.menu.receivedmapmarkers||!this.game.mapmanager.currentmap)return;var e=this.game.mapmanager.currentmap.mapname,t=this.game.menu.receivedmapmarkers[e];t||(e=this.game.mapmanager.getDefaultOutsideMap(),t=this.game.menu.receivedmapmarkers[e]);if(!t||!t.markers)return;this.currentmarkers=t},drawBackground:function(){if(!this.game.app.config.minimapdynamic||!this.game.player)return this.clear(),!0;var e=this.game.renderer.getImage(this.game.filespath+"gui/"+(this.currentmarkers.bigmap?this.currentmarkers.bigmap:"bbuilder_bigmap.jpg"),3e4);if(!e)return!1;var t=this.getWidth(),n=this.getHeight(),r,i=this.game.mapmanager.currentmap;if(i&&i.isLoaded&&i.mapname==this.currentmarkers["map"]){r={x:this.game.player.gridX,y:this.game.player.gridY};var s=t*this.currentmarkers.width/e.image.width,o=n*this.currentmarkers.height/e.image.height;this.area={x:Math.max(this.currentmarkers.offsetx,Math.min(this.game.player.gridX-s/2,this.currentmarkers.offsetx+this.currentmarkers.width-s)),y:Math.max(this.currentmarkers.offsety,Math.min(this.game.player.gridY-o/2,this.currentmarkers.offsety+this.currentmarkers.height-o)),w:s,h:o}}else r={x:this.area.x+this.area.w/2,y:this.area.y+this.area.h/2};var u=Math.max(0,Math.min((r.x-this.currentmarkers.offsetx)*e.image.width/this.currentmarkers.width-t/2,e.image.width-t)),a=Math.max(0,Math.min((r.y-this.currentmarkers.offsety)*e.image.height/this.currentmarkers.height-n/2,e.image.height-n));return this.context.drawImage(e.image,u,a,t,n,0,0,t,n),!0},cutOutCircle:function(){var e=this.getWidth(),t=this.getHeight();this.context.save(),this.context.globalCompositeOperation="destination-in",this.context.beginPath(),this.context.arc(e/2,t/2,e/2-9,0,2*Math.PI,!1),this.context.fill(),this.context.restore()},clear:function(){this.context.clearRect(0,0,this.getWidth(),this.getHeight())},drawPlayerCount:function(e,t){var n=this.game.getPlayerCountClock(e,t),r=Math.floor(this.getWidth()/2),i=23;this.context.strokeText(n,r,i+.5),this.context.fillText(n,r,i)},mapPosition:function(e,t){var n=this.getWidth(),r=this.getHeight(),i=(e.x-this.area.x)*n/this.area.w,s=(e.y-this.area.y)*r/this.area.h;return t?{x:Math.max(8,Math.min(i,n-8)),y:Math.max(8,Math.min(s,r-8))}:i>=0&&i<n&&s>=0&&s<r?{x:i,y:s}:null},drawPlayerDots:function(e){var t=this.game.renderer,n=t.getImage(this.game.filespath+"gui/bbuilder_playericon.png",3e4);if(!n)return;var r=0;for(var i in e){var s=this.mapPosition(e[i],!1);if(s){this.context.drawImage(n.image,Math.floor(s.x-7),Math.floor(s.y-7)),r++;if(t.isMobile&&r>=25)break}}},drawMyPlayerDot:function(){if(!this.game.player)return;var e=this.game.mapmanager.currentmap,t=e&&e.mapname==this.currentmarkers["map"];if(!t)return;var n=this.mapPosition({x:this.game.player.gridX,y:this.game.player.gridY},!0);if(!n)return;var r=this.game.renderer;if(this.game.app.config.minimaphead&&this.game.player){var i=r.getImage(this.game.animationmanager.getGraphic(this.game.player,"HEAD"),3e4);i&&this.context.drawImage(i.image,0,0,48,48,Math.floor(n.x-11),Math.floor(n.y-11),24,24)}else{var i=r.getImage(this.game.filespath+"gui/bbuilder_playericon.png",3e4);i&&this.context.drawImage(i.image,Math.floor(n.x-7),Math.floor(n.y-7))}var s=r.getImage(this.game.filespath+"gui/bbuilder_maparrow.png",3e4);s&&this.context.drawImage(s.image,Math.floor(n.x-9),Math.floor(n.y-25))},drawMapMarkers:function(){if(!this.currentmarkers.markers)return;var e=this.game.app.config.minimapdynamic,t=e?12:8;for(var n=0;n<this.currentmarkers.markers.length;n++){var r=this.currentmarkers.markers[n],i=this.mapPosition(r,!1);if(!i)continue;if(e){var s=translate(r.text);s&&s.length>0&&(this.context.strokeText(s,i.x,i.y+t+5.5),this.context.fillText(s,i.x,i.y+t+5))}if(r.icon){var o=this.game.renderer.getImage(this.game.animationmanager.getPathForDefault("ICON")+r.icon,3e4);o&&this.context.drawImage(o.image,i.x-t,i.y-t,t*2,t*2)}}},update:function(e){if(this.game.settings.hideminimap||this.showingStory)return;this.updateMarkerInfo();if(!this.currentmarkers)return;if(!this.checkNeedUpdate())return;try{if(!this.drawBackground()){this.lastdatasignature=null;return}this.mapinfo&&this.mapinfo.dots&&this.game.mapmanager.currentmap&&this.game.mapmanager.currentmap.mapname==this.game.mapmanager.getDefaultOutsideMap()&&this.drawPlayerDots(this.mapinfo.dots),this.drawMapMarkers(),this.drawMyPlayerDot(),this.game.app.config.minimapround&&this.cutOutCircle()}catch(t){this.game.client&&this.game.client.logError("Minimap error: "+t)}this.mapinfo&&this.mapinfo.count&&this.drawPlayerCount(this.mapinfo.count,this.mapinfo.hour)},checkNeedUpdate:function(){var e=this.game.renderer.camera,t=Math.floor(e.x/256)+"-"+Math.floor(e.y/256);return this.lastdatasignature==t?!1:(this.lastdatasignature=t,!0)},setMapInfo:function(e){this.lastdatasignature=null,this.mapinfo=e},drawWinner:function(e,t){if(!e||!t)return;this.winneruserid=e.userid;if(!this.tryDrawWinner(e,t)){var n=this,r=0;this.winnerinterval&&clearInterval(this.winnerinterval),this.winnerinterval=setInterval(function(){r++,(n.tryDrawWinner(e,t)||r>=10)&&clearInterval(n.winnerinterval)},500)}},tryDrawWinner:function(e,t){var n=this.game.animationmanager,r=this.game.renderer,i=r.getImage(n.getGraphic(e,"HEAD")),s=r.getImage(n.getGraphic(e,"HAT")),o=r.getImage(n.getGraphic(e,"MASK")),u=r.getImage(n.getGraphic(t,"HEAD")),a=r.getImage(n.getGraphic(t,"HAT")),f=r.getImage(n.getGraphic(t,"MASK")),l=r.getImage(n.getGraphic(e,"../gui/bbuilder_x_red.png")),c=e.icon?this.game.filespath+"npcs/"+e.icon:e.image?this.game.filespath+"npcs/"+e.image:n.getGraphic(e,e.weapontype=="script"?"WEAPON":e.weapontype.toUpperCase()),h=r.getImage(c);if(!i||!u||!l||e.hat&&e.hat.length>0&&!s||t.hat&&t.hat.length>0&&!a)return!1;gui.fadeIn("winnercanvas");var p=this.winnercontext;p.clearRect(0,0,this.winnercanvas.width,this.winnercanvas.height),p.drawImage(i.image,0,0,48,48,0,10,48,48),s&&p.drawImage(s.image,0,6,48,54,0,0,48,54),o&&p.drawImage(o.image,0,6,48,54,0,0,48,54),p.drawImage(u.image,0,0,48,48,70,10,48,48),a&&p.drawImage(a.image,0,6,48,54,70,0,48,54),f&&p.drawImage(f.image,0,6,48,54,70,0,48,54),p.drawImage(l.image,70,10),h&&(p.save(),p.translate(20,48),p.rotate(-Math.PI/4),p.drawImage(h.image,0,0),p.restore());var d=this;return this.winnerhidetimeout&&clearTimeout(this.winnerhidetimeout),this.winnerhidetimeout=setTimeout(function(){gui.fadeOut("winnercanvas")},5e3),!0},showStoryPM:function(e){return this.showingStory||!this.game.player||this.game.player.ghostBlocked()||!this.game.client||!e||!e.data||!e.data.storyid?!1:this.game.settings&&this.game.settings.noministories?!1:(this.storyPM=e,this.game.client.sendStoryAction("get",{id:e.data.storyid,target:"minimap"}),!0)},onClick:function(){this.showingStory?this.storyPM&&this.game.showSinglePM(this.storyPM):this.game.menu.showMapAndLoad()},onStoryStarted:function(e){this.showingStory=e,gui.show("minimapbackcontainer"),gui.show("minimap"),this.clear()},onStoryFinished:function(){this.showingStory=null,gui.hide("minimapbackcontainer"),this.game.settings.hideminimap&&gui.fadeOut("minimap")}});return r}),!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define("lib/acorn.min",["exports"],t):t((e=e||self).acorn={})}(this,function(e){"use strict";function c(e,t){for(var n=65536,r=0;r<t.length;r+=2){if((n+=t[r])>e)return!1;if((n+=t[r+1])>=e)return!0}}function h(e,t){return e<65?36===e:e<91||(e<97?95===e:e<123||(e<=65535?e>=170&&u.test(String.fromCharCode(e)):!1!==t&&c(e,f)))}function p(e,t){return e<48?36===e:e<58||!(e<65)&&(e<91||(e<97?95===e:e<123||(e<=65535?e>=170&&a.test(String.fromCharCode(e)):!1!==t&&(c(e,f)||c(e,l)))))}function v(e,t){return new d(e,{beforeExpr:!0,binop:t})}function b(e,t){return void 0===t&&(t={}),t.keyword=e,y[e]=new d(e,t)}function x(e,t){return 10===e||13===e||!t&&(8232===e||8233===e)}function A(e,t){return k.call(e,t)}function M(e){return new RegExp("^(?:"+e.replace(/ /g,"|")+")$")}function P(e,t){for(var n=1,r=0;;){S.lastIndex=r;var i=S.exec(e);if(!(i&&i.index<t))return new _(n,t-r);++n,r=i.index+i[0].length}}function B(e){var t={};for(var n in H)t[n]=e&&A(e,n)?e[n]:H[n];if(t.ecmaVersion>=2015&&(t.ecmaVersion-=2009),null==t.allowReserved&&(t.allowReserved=t.ecmaVersion<5),O(t.onToken)){var r=t.onToken;t.onToken=function(e){return r.push(e)}}return O(t.onComment)&&(t.onComment=function(e,t){return function(n,r,i,s,o,u){var a={type:n?"Block":"Line",value:r,start:i,end:s};e.locations&&(a.loc=new D(this,o,u)),e.ranges&&(a.range=[i,s]),t.push(a)}}(t,t.onComment)),t}function j(e,t){return 2|(e?4:0)|(t?8:0)}function U(){this.shorthandAssign=this.trailingComma=this.parenthesizedAssign=this.parenthesizedBind=this.doubleProto=-1}function rt(e,t,n,r){return e.type=t,e.end=n,this.options.locations&&(e.loc.end=r),this.options.ranges&&(e.range[1]=n),e}function vt(e){var t=dt[e]={binary:M(ft[e]+" "+lt),nonBinary:{General_Category:M(lt),Script:M(pt[e])}};t.nonBinary.Script_Extensions=t.nonBinary.Script,t.nonBinary.gc=t.nonBinary.General_Category,t.nonBinary.sc=t.nonBinary.Script,t.nonBinary.scx=t.nonBinary.Script_Extensions}function yt(e){return e<=65535?String.fromCharCode(e):(e-=65536,String.fromCharCode(55296+(e>>10),56320+(1023&e)))}function bt(e){return 36===e||e>=40&&e<=43||46===e||63===e||e>=91&&e<=94||e>=123&&e<=125}function wt(e){return e>=65&&e<=90||e>=97&&e<=122}function Et(e){return wt(e)||95===e}function St(e){return Et(e)||xt(e)}function xt(e){return e>=48&&e<=57}function Tt(e){return e>=48&&e<=57||e>=65&&e<=70||e>=97&&e<=102}function Nt(e){return e>=65&&e<=70?e-65+10:e>=97&&e<=102?e-97+10:e-48}function Ct(e){return e>=48&&e<=55}function At(e){return"function"!=typeof BigInt?null:BigInt(e.replace(/_/g,""))}function Ot(e){return e<=65535?String.fromCharCode(e):(e-=65536,String.fromCharCode(55296+(e>>10),56320+(1023&e)))}var t={3:"abstract boolean byte char class double enum export extends final float goto implements import int interface long native package private protected public short static super synchronized throws transient volatile",5:"class enum extends super const export import",6:"enum",strict:"implements interface let package private protected public static yield",strictBind:"eval arguments"},n="break case catch continue debugger default do else finally for function if return switch throw try var while with null true false instanceof typeof void delete new in this",r={5:n,"5module":n+" export import",6:n+" const class extends export import super"},i=/^in(stanceof)?$/,s="ªµºÀ-ÖØ-öø-ˁˆ-ˑˠ-ˤˬˮͰ-ʹͶͷͺ-ͽͿΆΈ-ΊΌΎ-ΡΣ-ϵϷ-ҁҊ-ԯԱ-Ֆՙՠ-ֈא-תׯ-ײؠ-يٮٯٱ-ۓەۥۦۮۯۺ-ۼۿܐܒ-ܯݍ-ޥޱߊ-ߪߴߵߺࠀ-ࠕࠚࠤࠨࡀ-ࡘࡠ-ࡪࢠ-ࢴࢶ-ࣇऄ-हऽॐक़-ॡॱ-ঀঅ-ঌএঐও-নপ-রলশ-হঽৎড়ঢ়য়-ৡৰৱৼਅ-ਊਏਐਓ-ਨਪ-ਰਲਲ਼ਵਸ਼ਸਹਖ਼-ੜਫ਼ੲ-ੴઅ-ઍએ-ઑઓ-નપ-રલળવ-હઽૐૠૡૹଅ-ଌଏଐଓ-ନପ-ରଲଳଵ-ହଽଡ଼ଢ଼ୟ-ୡୱஃஅ-ஊஎ-ஐஒ-கஙசஜஞடணதந-பம-ஹௐఅ-ఌఎ-ఐఒ-నప-హఽౘ-ౚౠౡಀಅ-ಌಎ-ಐಒ-ನಪ-ಳವ-ಹಽೞೠೡೱೲഄ-ഌഎ-ഐഒ-ഺഽൎൔ-ൖൟ-ൡൺ-ൿඅ-ඖක-නඳ-රලව-ෆก-ะาำเ-ๆກຂຄຆ-ຊຌ-ຣລວ-ະາຳຽເ-ໄໆໜ-ໟༀཀ-ཇཉ-ཬྈ-ྌက-ဪဿၐ-ၕၚ-ၝၡၥၦၮ-ၰၵ-ႁႎႠ-ჅჇჍა-ჺჼ-ቈቊ-ቍቐ-ቖቘቚ-ቝበ-ኈኊ-ኍነ-ኰኲ-ኵኸ-ኾዀዂ-ዅወ-ዖዘ-ጐጒ-ጕጘ-ፚᎀ-ᎏᎠ-Ᏽᏸ-ᏽᐁ-ᙬᙯ-ᙿᚁ-ᚚᚠ-ᛪᛮ-ᛸᜀ-ᜌᜎ-ᜑᜠ-ᜱᝀ-ᝑᝠ-ᝬᝮ-ᝰក-ឳៗៜᠠ-ᡸᢀ-ᢨᢪᢰ-ᣵᤀ-ᤞᥐ-ᥭᥰ-ᥴᦀ-ᦫᦰ-ᧉᨀ-ᨖᨠ-ᩔᪧᬅ-ᬳᭅ-ᭋᮃ-ᮠᮮᮯᮺ-ᯥᰀ-ᰣᱍ-ᱏᱚ-ᱽᲀ-ᲈᲐ-ᲺᲽ-Ჿᳩ-ᳬᳮ-ᳳᳵᳶᳺᴀ-ᶿḀ-ἕἘ-Ἕἠ-ὅὈ-Ὅὐ-ὗὙὛὝὟ-ώᾀ-ᾴᾶ-ᾼιῂ-ῄῆ-ῌῐ-ΐῖ-Ίῠ-Ῥῲ-ῴῶ-ῼⁱⁿₐ-ₜℂℇℊ-ℓℕ℘-ℝℤΩℨK-ℹℼ-ℿⅅ-ⅉⅎⅠ-ↈⰀ-Ⱞⰰ-ⱞⱠ-ⳤⳫ-ⳮⳲⳳⴀ-ⴥⴧⴭⴰ-ⵧⵯⶀ-ⶖⶠ-ⶦⶨ-ⶮⶰ-ⶶⶸ-ⶾⷀ-ⷆⷈ-ⷎⷐ-ⷖⷘ-ⷞ々-〇〡-〩〱-〵〸-〼ぁ-ゖ゛-ゟァ-ヺー-ヿㄅ-ㄯㄱ-ㆎㆠ-ㆿㇰ-ㇿ㐀-䶿一-鿼ꀀ-ꒌꓐ-ꓽꔀ-ꘌꘐ-ꘟꘪꘫꙀ-ꙮꙿ-ꚝꚠ-ꛯꜗ-ꜟꜢ-ꞈꞋ-ꞿꟂ-ꟊꟵ-ꠁꠃ-ꠅꠇ-ꠊꠌ-ꠢꡀ-ꡳꢂ-ꢳꣲ-ꣷꣻꣽꣾꤊ-ꤥꤰ-ꥆꥠ-ꥼꦄ-ꦲꧏꧠ-ꧤꧦ-ꧯꧺ-ꧾꨀ-ꨨꩀ-ꩂꩄ-ꩋꩠ-ꩶꩺꩾ-ꪯꪱꪵꪶꪹ-ꪽꫀꫂꫛ-ꫝꫠ-ꫪꫲ-ꫴꬁ-ꬆꬉ-ꬎꬑ-ꬖꬠ-ꬦꬨ-ꬮꬰ-ꭚꭜ-ꭩꭰ-ꯢ가-힣ힰ-ퟆퟋ-ퟻ豈-舘並-龎ﬀ-ﬆﬓ-ﬗיִײַ-ﬨשׁ-זּטּ-לּמּנּסּףּפּצּ-ﮱﯓ-ﴽﵐ-ﶏﶒ-ﷇﷰ-ﷻﹰ-ﹴﹶ-ﻼＡ-Ｚａ-ｚｦ-ﾾￂ-ￇￊ-ￏￒ-ￗￚ-ￜ",o="‌‍·̀-ͯ·҃-֑҇-ׇֽֿׁׂׅׄؐ-ًؚ-٩ٰۖ-ۜ۟-۪ۤۧۨ-ۭ۰-۹ܑܰ-݊ަ-ް߀-߉߫-߽߳ࠖ-࠙ࠛ-ࠣࠥ-ࠧࠩ-࡙࠭-࡛࣓-ࣣ࣡-ःऺ-़ा-ॏ॑-ॗॢॣ०-९ঁ-ঃ়া-ৄেৈো-্ৗৢৣ০-৯৾ਁ-ਃ਼ਾ-ੂੇੈੋ-੍ੑ੦-ੱੵઁ-ઃ઼ા-ૅે-ૉો-્ૢૣ૦-૯ૺ-૿ଁ-ଃ଼ା-ୄେୈୋ-୍୕-ୗୢୣ୦-୯ஂா-ூெ-ைொ-்ௗ௦-௯ఀ-ఄా-ౄె-ైొ-్ౕౖౢౣ౦-౯ಁ-ಃ಼ಾ-ೄೆ-ೈೊ-್ೕೖೢೣ೦-೯ഀ-ഃ഻഼ാ-ൄെ-ൈൊ-്ൗൢൣ൦-൯ඁ-ඃ්ා-ුූෘ-ෟ෦-෯ෲෳัิ-ฺ็-๎๐-๙ັິ-ຼ່-ໍ໐-໙༘༙༠-༩༹༵༷༾༿ཱ-྄྆྇ྍ-ྗྙ-ྼ࿆ါ-ှ၀-၉ၖ-ၙၞ-ၠၢ-ၤၧ-ၭၱ-ၴႂ-ႍႏ-ႝ፝-፟፩-፱ᜒ-᜔ᜲ-᜴ᝒᝓᝲᝳ឴-៓៝០-៩᠋-᠍᠐-᠙ᢩᤠ-ᤫᤰ-᤻᥆-᥏᧐-᧚ᨗ-ᨛᩕ-ᩞ᩠-᩿᩼-᪉᪐-᪙᪰-᪽ᪿᫀᬀ-ᬄ᬴-᭄᭐-᭙᭫-᭳ᮀ-ᮂᮡ-ᮭ᮰-᮹᯦-᯳ᰤ-᰷᱀-᱉᱐-᱙᳐-᳔᳒-᳨᳭᳴᳷-᳹᷀-᷹᷻-᷿‿⁀⁔⃐-⃥⃜⃡-⃰⳯-⵿⳱ⷠ-〪ⷿ-゙゚〯꘠-꘩꙯ꙴ-꙽ꚞꚟ꛰꛱ꠂ꠆ꠋꠣ-ꠧ꠬ꢀꢁꢴ-ꣅ꣐-꣙꣠-꣱ꣿ-꤉ꤦ-꤭ꥇ-꥓ꦀ-ꦃ꦳-꧀꧐-꧙ꧥ꧰-꧹ꨩ-ꨶꩃꩌꩍ꩐-꩙ꩻ-ꩽꪰꪲ-ꪴꪷꪸꪾ꪿꫁ꫫ-ꫯꫵ꫶ꯣ-ꯪ꯬꯭꯰-꯹ﬞ︀-️︠-︯︳︴﹍-﹏０-９＿",u=new RegExp("["+s+"]"),a=new RegExp("["+s+o+"]");s=o=null;var f=[0,11,2,25,2,18,2,1,2,14,3,13,35,122,70,52,268,28,4,48,48,31,14,29,6,37,11,29,3,35,5,7,2,4,43,157,19,35,5,35,5,39,9,51,157,310,10,21,11,7,153,5,3,0,2,43,2,1,4,0,3,22,11,22,10,30,66,18,2,1,11,21,11,25,71,55,7,1,65,0,16,3,2,2,2,28,43,28,4,28,36,7,2,27,28,53,11,21,11,18,14,17,111,72,56,50,14,50,14,35,349,41,7,1,79,28,11,0,9,21,107,20,28,22,13,52,76,44,33,24,27,35,30,0,3,0,9,34,4,0,13,47,15,3,22,0,2,0,36,17,2,24,85,6,2,0,2,3,2,14,2,9,8,46,39,7,3,1,3,21,2,6,2,1,2,4,4,0,19,0,13,4,159,52,19,3,21,2,31,47,21,1,2,0,185,46,42,3,37,47,21,0,60,42,14,0,72,26,230,43,117,63,32,7,3,0,3,7,2,1,2,23,16,0,2,0,95,7,3,38,17,0,2,0,29,0,11,39,8,0,22,0,12,45,20,0,35,56,264,8,2,36,18,0,50,29,113,6,2,1,2,37,22,0,26,5,2,1,2,31,15,0,328,18,190,0,80,921,103,110,18,195,2749,1070,4050,582,8634,568,8,30,114,29,19,47,17,3,32,20,6,18,689,63,129,74,6,0,67,12,65,1,2,0,29,6135,9,1237,43,8,8952,286,50,2,18,3,9,395,2309,106,6,12,4,8,8,9,5991,84,2,70,2,1,3,0,3,1,3,3,2,11,2,0,2,6,2,64,2,3,3,7,2,6,2,27,2,3,2,4,2,0,4,6,2,339,3,24,2,24,2,30,2,24,2,30,2,24,2,30,2,24,2,30,2,24,2,7,2357,44,11,6,17,0,370,43,1301,196,60,67,8,0,1205,3,2,26,2,1,2,0,3,0,2,9,2,3,2,0,2,0,7,0,5,0,2,0,2,0,2,2,2,1,2,0,3,0,2,0,2,0,2,0,2,0,2,1,2,0,3,3,2,6,2,3,2,3,2,0,2,9,2,16,6,2,2,4,2,16,4421,42717,35,4148,12,221,3,5761,15,7472,3104,541,1507,4938],l=[509,0,227,0,150,4,294,9,1368,2,2,1,6,3,41,2,5,0,166,1,574,3,9,9,370,1,154,10,176,2,54,14,32,9,16,3,46,10,54,9,7,2,37,13,2,9,6,1,45,0,13,2,49,13,9,3,2,11,83,11,7,0,161,11,6,9,7,3,56,1,2,6,3,1,3,2,10,0,11,1,3,6,4,4,193,17,10,9,5,0,82,19,13,9,214,6,3,8,28,1,83,16,16,9,82,12,9,9,84,14,5,9,243,14,166,9,71,5,2,1,3,3,2,0,2,1,13,9,120,6,3,6,4,0,29,9,41,6,2,3,9,0,10,10,47,15,406,7,2,7,17,9,57,21,2,13,123,5,4,0,2,1,2,6,2,0,9,9,49,4,2,1,2,4,9,9,330,3,19306,9,135,4,60,6,26,9,1014,0,2,54,8,3,82,0,12,1,19628,1,5319,4,4,5,9,7,3,6,31,3,149,2,1418,49,513,54,5,49,9,0,15,0,23,4,2,14,1361,6,2,16,3,6,2,1,2,4,262,6,10,9,419,13,1495,6,110,6,6,9,4759,9,787719,239],d=function(e,t){void 0===t&&(t={}),this.label=e,this.keyword=t.keyword,this.beforeExpr=!!t.beforeExpr,this.startsExpr=!!t.startsExpr,this.isLoop=!!t.isLoop,this.isAssign=!!t.isAssign,this.prefix=!!t.prefix,this.postfix=!!t.postfix,this.binop=t.binop||null,this.updateContext=null},m={beforeExpr:!0},g={startsExpr:!0},y={},w={num:new d("num",g),regexp:new d("regexp",g),string:new d("string",g),name:new d("name",g),eof:new d("eof"),bracketL:new d("[",{beforeExpr:!0,startsExpr:!0}),bracketR:new d("]"),braceL:new d("{",{beforeExpr:!0,startsExpr:!0}),braceR:new d("}"),parenL:new d("(",{beforeExpr:!0,startsExpr:!0}),parenR:new d(")"),comma:new d(",",m),semi:new d(";",m),colon:new d(":",m),dot:new d("."),question:new d("?",m),questionDot:new d("?."),arrow:new d("=>",m),template:new d("template"),invalidTemplate:new d("invalidTemplate"),ellipsis:new d("...",m),backQuote:new d("`",g),dollarBraceL:new d("${",{beforeExpr:!0,startsExpr:!0}),eq:new d("=",{beforeExpr:!0,isAssign:!0}),assign:new d("_=",{beforeExpr:!0,isAssign:!0}),incDec:new d("++/--",{prefix:!0,postfix:!0,startsExpr:!0}),prefix:new d("!/~",{beforeExpr:!0,prefix:!0,startsExpr:!0}),logicalOR:v("||",1),logicalAND:v("&&",2),bitwiseOR:v("|",3),bitwiseXOR:v("^",4),bitwiseAND:v("&",5),equality:v("==/!=/===/!==",6),relational:v("</>/<=/>=",7),bitShift:v("<</>>/>>>",8),plusMin:new d("+/-",{beforeExpr:!0,binop:9,prefix:!0,startsExpr:!0}),modulo:v("%",10),star:v("*",10),slash:v("/",10),starstar:new d("**",{beforeExpr:!0}),coalesce:v("??",1),_break:b("break"),_case:b("case",m),_catch:b("catch"),_continue:b("continue"),_debugger:b("debugger"),_default:b("default",m),_do:b("do",{isLoop:!0,beforeExpr:!0}),_else:b("else",m),_finally:b("finally"),_for:b("for",{isLoop:!0}),_function:b("function",g),_if:b("if"),_return:b("return",m),_switch:b("switch"),_throw:b("throw",m),_try:b("try"),_var:b("var"),_const:b("const"),_while:b("while",{isLoop:!0}),_with:b("with"),_new:b("new",{beforeExpr:!0,startsExpr:!0}),_this:b("this",g),_super:b("super",g),_class:b("class",g),_extends:b("extends",m),_export:b("export"),_import:b("import",g),_null:b("null",g),_true:b("true",g),_false:b("false",g),_in:b("in",{beforeExpr:!0,binop:7}),_instanceof:b("instanceof",{beforeExpr:!0,binop:7}),_typeof:b("typeof",{beforeExpr:!0,prefix:!0,startsExpr:!0}),_void:b("void",{beforeExpr:!0,prefix:!0,startsExpr:!0}),_delete:b("delete",{beforeExpr:!0,prefix:!0,startsExpr:!0})},E=/\r\n?|\n|\u2028|\u2029/,S=new RegExp(E.source,"g"),T=/[\u1680\u2000-\u200a\u202f\u205f\u3000\ufeff]/,N=/(?:\s|\/\/.*|\/\*[^]*?\*\/)*/g,C=Object.prototype,k=C.hasOwnProperty,L=C.toString,O=Array.isArray||function(e){return"[object Array]"===L.call(e)},_=function(e,t){this.line=e,this.column=t};_.prototype.offset=function(e){return new _(this.line,this.column+e)};var D=function(e,t,n){this.start=t,this.end=n,null!==e.sourceFile&&(this.source=e.sourceFile)},H={ecmaVersion:10,sourceType:"script",onInsertedSemicolon:null,onTrailingComma:null,allowReserved:null,allowReturnOutsideFunction:!1,allowImportExportEverywhere:!1,allowAwaitOutsideFunction:!1,allowHashBang:!1,locations:!1,onToken:null,onComment:null,ranges:!1,program:null,sourceFile:null,directSourceFile:null,preserveParens:!1},F=function(e,n,i){this.options=e=B(e),this.sourceFile=e.sourceFile,this.keywords=M(r[e.ecmaVersion>=6?6:"module"===e.sourceType?"5module":5]);var s="";if(!0!==e.allowReserved){for(var o=e.ecmaVersion;!(s=t[o]);o--);"module"===e.sourceType&&(s+=" await")}this.reservedWords=M(s);var u=(s?s+" ":"")+t.strict;this.reservedWordsStrict=M(u),this.reservedWordsStrictBind=M(u+" "+t.strictBind),this.input=String(n),this.containsEsc=!1,i?(this.pos=i,this.lineStart=this.input.lastIndexOf("\n",i-1)+1,this.curLine=this.input.slice(0,this.lineStart).split(E).length):(this.pos=this.lineStart=0,this.curLine=1),this.type=w.eof,this.value=null,this.start=this.end=this.pos,this.startLoc=this.endLoc=this.curPosition(),this.lastTokEndLoc=this.lastTokStartLoc=null,this.lastTokStart=this.lastTokEnd=this.pos,this.context=this.initialContext(),this.exprAllowed=!0,this.inModule="module"===e.sourceType,this.strict=this.inModule||this.strictDirective(this.pos),this.potentialArrowAt=-1,this.yieldPos=this.awaitPos=this.awaitIdentPos=0,this.labels=[],this.undefinedExports={},0===this.pos&&e.allowHashBang&&"#!"===this.input.slice(0,2)&&this.skipLineComment(2),this.scopeStack=[],this.enterScope(1),this.regexpState=null},I={inFunction:{configurable:!0},inGenerator:{configurable:!0},inAsync:{configurable:!0},allowSuper:{configurable:!0},allowDirectSuper:{configurable:!0},treatFunctionsAsVar:{configurable:!0}};F.prototype.parse=function(){var e=this.options.program||this.startNode();return this.nextToken(),this.parseTopLevel(e)},I.inFunction.get=function(){return(2&this.currentVarScope().flags)>0},I.inGenerator.get=function(){return(8&this.currentVarScope().flags)>0},I.inAsync.get=function(){return(4&this.currentVarScope().flags)>0},I.allowSuper.get=function(){return(64&this.currentThisScope().flags)>0},I.allowDirectSuper.get=function(){return(128&this.currentThisScope().flags)>0},I.treatFunctionsAsVar.get=function(){return this.treatFunctionsAsVarInScope(this.currentScope())},F.prototype.inNonArrowFunction=function(){return(2&this.currentThisScope().flags)>0},F.extend=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];for(var n=this,r=0;r<e.length;r++)n=e[r](n);return n},F.parse=function(e,t){return(new this(t,e)).parse()},F.parseExpressionAt=function(e,t,n){var r=new this(n,e,t);return r.nextToken(),r.parseExpression()},F.tokenizer=function(e,t){return new this(t,e)},Object.defineProperties(F.prototype,I);var q=F.prototype,R=/^(?:'((?:\\.|[^'\\])*?)'|"((?:\\.|[^"\\])*?)")/;q.strictDirective=function(e){for(;;){N.lastIndex=e,e+=N.exec(this.input)[0].length;var t=R.exec(this.input.slice(e));if(!t)return!1;if("use strict"===(t[1]||t[2])){N.lastIndex=e+t[0].length;var n=N.exec(this.input),r=n.index+n[0].length,i=this.input.charAt(r);return";"===i||"}"===i||E.test(n[0])&&!(/[(`.[+\-/*%<>=,?^&]/.test(i)||"!"===i&&"="===this.input.charAt(r+1))}e+=t[0].length,N.lastIndex=e,e+=N.exec(this.input)[0].length,";"===this.input[e]&&e++}},q.eat=function(e){return this.type===e&&(this.next(),!0)},q.isContextual=function(e){return this.type===w.name&&this.value===e&&!this.containsEsc},q.eatContextual=function(e){return!!this.isContextual(e)&&(this.next(),!0)},q.expectContextual=function(e){this.eatContextual(e)||this.unexpected()},q.canInsertSemicolon=function(){return this.type===w.eof||this.type===w.braceR||E.test(this.input.slice(this.lastTokEnd,this.start))},q.insertSemicolon=function(){if(this.canInsertSemicolon())return this.options.onInsertedSemicolon&&this.options.onInsertedSemicolon(this.lastTokEnd,this.lastTokEndLoc),!0},q.semicolon=function(){this.eat(w.semi)||this.insertSemicolon()||this.unexpected()},q.afterTrailingComma=function(e,t){if(this.type===e)return this.options.onTrailingComma&&this.options.onTrailingComma(this.lastTokStart,this.lastTokStartLoc),t||this.next(),!0},q.expect=function(e){this.eat(e)||this.unexpected()},q.unexpected=function(e){this.raise(null!=e?e:this.start,"Unexpected token")},q.checkPatternErrors=function(e,t){if(e){e.trailingComma>-1&&this.raiseRecoverable(e.trailingComma,"Comma is not permitted after the rest element");var n=t?e.parenthesizedAssign:e.parenthesizedBind;n>-1&&this.raiseRecoverable(n,"Parenthesized pattern")}},q.checkExpressionErrors=function(e,t){if(!e)return!1;var n=e.shorthandAssign,r=e.doubleProto;if(!t)return n>=0||r>=0;n>=0&&this.raise(n,"Shorthand property assignments are valid only in destructuring patterns"),r>=0&&this.raiseRecoverable(r,"Redefinition of __proto__ property")},q.checkYieldAwaitInDefaultParams=function(){this.yieldPos&&(!this.awaitPos||this.yieldPos<this.awaitPos)&&this.raise(this.yieldPos,"Yield expression cannot be a default value"),this.awaitPos&&this.raise(this.awaitPos,"Await expression cannot be a default value")},q.isSimpleAssignTarget=function(e){return"ParenthesizedExpression"===e.type?this.isSimpleAssignTarget(e.expression):"Identifier"===e.type||"MemberExpression"===e.type};var z=F.prototype;z.parseTopLevel=function(e){var t={};for(e.body||(e.body=[]);this.type!==w.eof;){var n=this.parseStatement(null,!0,t);e.body.push(n)}if(this.inModule)for(var r=0,i=Object.keys(this.undefinedExports);r<i.length;r+=1){var s=i[r];this.raiseRecoverable(this.undefinedExports[s].start,"Export '"+s+"' is not defined")}return this.adaptDirectivePrologue(e.body),this.next(),e.sourceType=this.options.sourceType,this.finishNode(e,"Program")};var W={kind:"loop"},X={kind:"switch"};z.isLet=function(e){if(this.options.ecmaVersion<6||!this.isContextual("let"))return!1;N.lastIndex=this.pos;var t=N.exec(this.input),n=this.pos+t[0].length,r=this.input.charCodeAt(n);if(91===r)return!0;if(e)return!1;if(123===r)return!0;if(h(r,!0)){for(var s=n+1;p(this.input.charCodeAt(s),!0);)++s;var o=this.input.slice(n,s);if(!i.test(o))return!0}return!1},z.isAsyncFunction=function(){if(this.options.ecmaVersion<8||!this.isContextual("async"))return!1;N.lastIndex=this.pos;var e=N.exec(this.input),t=this.pos+e[0].length;return!(E.test(this.input.slice(this.pos,t))||"function"!==this.input.slice(t,t+8)||t+8!==this.input.length&&p(this.input.charAt(t+8)))},z.parseStatement=function(e,t,n){var r,i=this.type,s=this.startNode();switch(this.isLet(e)&&(i=w._var,r="let"),i){case w._break:case w._continue:return this.parseBreakContinueStatement(s,i.keyword);case w._debugger:return this.parseDebuggerStatement(s);case w._do:return this.parseDoStatement(s);case w._for:return this.parseForStatement(s);case w._function:return e&&(this.strict||"if"!==e&&"label"!==e)&&this.options.ecmaVersion>=6&&this.unexpected(),this.parseFunctionStatement(s,!1,!e);case w._class:return e&&this.unexpected(),this.parseClass(s,!0);case w._if:return this.parseIfStatement(s);case w._return:return this.parseReturnStatement(s);case w._switch:return this.parseSwitchStatement(s);case w._throw:return this.parseThrowStatement(s);case w._try:return this.parseTryStatement(s);case w._const:case w._var:return r=r||this.value,e&&"var"!==r&&this.unexpected(),this.parseVarStatement(s,r);case w._while:return this.parseWhileStatement(s);case w._with:return this.parseWithStatement(s);case w.braceL:return this.parseBlock(!0,s);case w.semi:return this.parseEmptyStatement(s);case w._export:case w._import:if(this.options.ecmaVersion>10&&i===w._import){N.lastIndex=this.pos;var o=N.exec(this.input),u=this.pos+o[0].length,a=this.input.charCodeAt(u);if(40===a||46===a)return this.parseExpressionStatement(s,this.parseExpression())}return this.options.allowImportExportEverywhere||(t||this.raise(this.start,"'import' and 'export' may only appear at the top level"),this.inModule||this.raise(this.start,"'import' and 'export' may appear only with 'sourceType: module'")),i===w._import?this.parseImport(s):this.parseExport(s,n);default:if(this.isAsyncFunction())return e&&this.unexpected(),this.next(),this.parseFunctionStatement(s,!0,!e);var f=this.value,l=this.parseExpression();return i===w.name&&"Identifier"===l.type&&this.eat(w.colon)?this.parseLabeledStatement(s,f,l,e):this.parseExpressionStatement(s,l)}},z.parseBreakContinueStatement=function(e,t){var n="break"===t;this.next(),this.eat(w.semi)||this.insertSemicolon()?e.label=null:this.type!==w.name?this.unexpected():(e.label=this.parseIdent(),this.semicolon());for(var r=0;r<this.labels.length;++r){var i=this.labels[r];if(null==e.label||i.name===e.label.name){if(!(null==i.kind||!n&&"loop"!==i.kind))break;if(e.label&&n)break}}return r===this.labels.length&&this.raise(e.start,"Unsyntactic "+t),this.finishNode(e,n?"BreakStatement":"ContinueStatement")},z.parseDebuggerStatement=function(e){return this.next(),this.semicolon(),this.finishNode(e,"DebuggerStatement")},z.parseDoStatement=function(e){return this.next(),this.labels.push(W),e.body=this.parseStatement("do"),this.labels.pop(),this.expect(w._while),e.test=this.parseParenExpression(),this.options.ecmaVersion>=6?this.eat(w.semi):this.semicolon(),this.finishNode(e,"DoWhileStatement")},z.parseForStatement=function(e){this.next();var t=this.options.ecmaVersion>=9&&(this.inAsync||!this.inFunction&&this.options.allowAwaitOutsideFunction)&&this.eatContextual("await")?this.lastTokStart:-1;if(this.labels.push(W),this.enterScope(0),this.expect(w.parenL),this.type===w.semi)return t>-1&&this.unexpected(t),this.parseFor(e,null);var n=this.isLet();if(this.type===w._var||this.type===w._const||n){var r=this.startNode(),i=n?"let":this.value;return this.next(),this.parseVar(r,!0,i),this.finishNode(r,"VariableDeclaration"),(this.type===w._in||this.options.ecmaVersion>=6&&this.isContextual("of"))&&1===r.declarations.length?(this.options.ecmaVersion>=9&&(this.type===w._in?t>-1&&this.unexpected(t):e.await=t>-1),this.parseForIn(e,r)):(t>-1&&this.unexpected(t),this.parseFor(e,r))}var s=new U,o=this.parseExpression(!0,s);return this.type===w._in||this.options.ecmaVersion>=6&&this.isContextual("of")?(this.options.ecmaVersion>=9&&(this.type===w._in?t>-1&&this.unexpected(t):e.await=t>-1),this.toAssignable(o,!1,s),this.checkLVal(o),this.parseForIn(e,o)):(this.checkExpressionErrors(s,!0),t>-1&&this.unexpected(t),this.parseFor(e,o))},z.parseFunctionStatement=function(e,t,n){return this.next(),this.parseFunction(e,$|(n?0:J),!1,t)},z.parseIfStatement=function(e){return this.next(),e.test=this.parseParenExpression(),e.consequent=this.parseStatement("if"),e.alternate=this.eat(w._else)?this.parseStatement("if"):null,this.finishNode(e,"IfStatement")},z.parseReturnStatement=function(e){return this.inFunction||this.options.allowReturnOutsideFunction||this.raise(this.start,"'return' outside of function"),this.next(),this.eat(w.semi)||this.insertSemicolon()?e.argument=null:(e.argument=this.parseExpression(),this.semicolon()),this.finishNode(e,"ReturnStatement")},z.parseSwitchStatement=function(e){var t;this.next(),e.discriminant=this.parseParenExpression(),e.cases=[],this.expect(w.braceL),this.labels.push(X),this.enterScope(0);for(var n=!1;this.type!==w.braceR;)if(this.type===w._case||this.type===w._default){var r=this.type===w._case;t&&this.finishNode(t,"SwitchCase"),e.cases.push(t=this.startNode()),t.consequent=[],this.next(),r?t.test=this.parseExpression():(n&&this.raiseRecoverable(this.lastTokStart,"Multiple default clauses"),n=!0,t.test=null),this.expect(w.colon)}else t||this.unexpected(),t.consequent.push(this.parseStatement(null));return this.exitScope(),t&&this.finishNode(t,"SwitchCase"),this.next(),this.labels.pop(),this.finishNode(e,"SwitchStatement")},z.parseThrowStatement=function(e){return this.next(),E.test(this.input.slice(this.lastTokEnd,this.start))&&this.raise(this.lastTokEnd,"Illegal newline after throw"),e.argument=this.parseExpression(),this.semicolon(),this.finishNode(e,"ThrowStatement")};var V=[];z.parseTryStatement=function(e){if(this.next(),e.block=this.parseBlock(),e.handler=null,this.type===w._catch){var t=this.startNode();if(this.next(),this.eat(w.parenL)){t.param=this.parseBindingAtom();var n="Identifier"===t.param.type;this.enterScope(n?32:0),this.checkLVal(t.param,n?4:2),this.expect(w.parenR)}else this.options.ecmaVersion<10&&this.unexpected(),t.param=null,this.enterScope(0);t.body=this.parseBlock(!1),this.exitScope(),e.handler=this.finishNode(t,"CatchClause")}return e.finalizer=this.eat(w._finally)?this.parseBlock():null,e.handler||e.finalizer||this.raise(e.start,"Missing catch or finally clause"),this.finishNode(e,"TryStatement")},z.parseVarStatement=function(e,t){return this.next(),this.parseVar(e,!1,t),this.semicolon(),this.finishNode(e,"VariableDeclaration")},z.parseWhileStatement=function(e){return this.next(),e.test=this.parseParenExpression(),this.labels.push(W),e.body=this.parseStatement("while"),this.labels.pop(),this.finishNode(e,"WhileStatement")},z.parseWithStatement=function(e){return this.strict&&this.raise(this.start,"'with' in strict mode"),this.next(),e.object=this.parseParenExpression(),e.body=this.parseStatement("with"),this.finishNode(e,"WithStatement")},z.parseEmptyStatement=function(e){return this.next(),this.finishNode(e,"EmptyStatement")},z.parseLabeledStatement=function(e,t,n,r){for(var i=0,s=this.labels;i<s.length;i+=1)s[i].name===t&&this.raise(n.start,"Label '"+t+"' is already declared");for(var o=this.type.isLoop?"loop":this.type===w._switch?"switch":null,u=this.labels.length-1;u>=0;u--){var a=this.labels[u];if(a.statementStart!==e.start)break;a.statementStart=this.start,a.kind=o}return this.labels.push({name:t,kind:o,statementStart:this.start}),e.body=this.parseStatement(r?-1===r.indexOf("label")?r+"label":r:"label"),this.labels.pop(),e.label=n,this.finishNode(e,"LabeledStatement")},z.parseExpressionStatement=function(e,t){return e.expression=t,this.semicolon(),this.finishNode(e,"ExpressionStatement")},z.parseBlock=function(e,t,n){for(void 0===e&&(e=!0),void 0===t&&(t=this.startNode()),t.body=[],this.expect(w.braceL),e&&this.enterScope(0);this.type!==w.braceR;){var r=this.parseStatement(null);t.body.push(r)}return n&&(this.strict=!1),this.next(),e&&this.exitScope(),this.finishNode(t,"BlockStatement")},z.parseFor=function(e,t){return e.init=t,this.expect(w.semi),e.test=this.type===w.semi?null:this.parseExpression(),this.expect(w.semi),e.update=this.type===w.parenR?null:this.parseExpression(),this.expect(w.parenR),e.body=this.parseStatement("for"),this.exitScope(),this.labels.pop(),this.finishNode(e,"ForStatement")},z.parseForIn=function(e,t){var n=this.type===w._in;return this.next(),"VariableDeclaration"===t.type&&null!=t.declarations[0].init&&(!n||this.options.ecmaVersion<8||this.strict||"var"!==t.kind||"Identifier"!==t.declarations[0].id.type)?this.raise(t.start,(n?"for-in":"for-of")+" loop variable declaration may not have an initializer"):"AssignmentPattern"===t.type&&this.raise(t.start,"Invalid left-hand side in for-loop"),e.left=t,e.right=n?this.parseExpression():this.parseMaybeAssign(),this.expect(w.parenR),e.body=this.parseStatement("for"),this.exitScope(),this.labels.pop(),this.finishNode(e,n?"ForInStatement":"ForOfStatement")},z.parseVar=function(e,t,n){for(e.declarations=[],e.kind=n;;){var r=this.startNode();if(this.parseVarId(r,n),this.eat(w.eq)?r.init=this.parseMaybeAssign(t):"const"!==n||this.type===w._in||this.options.ecmaVersion>=6&&this.isContextual("of")?"Identifier"===r.id.type||t&&(this.type===w._in||this.isContextual("of"))?r.init=null:this.raise(this.lastTokEnd,"Complex binding patterns require an initialization value"):this.unexpected(),e.declarations.push(this.finishNode(r,"VariableDeclarator")),!this.eat(w.comma))break}return e},z.parseVarId=function(e,t){e.id=this.parseBindingAtom(),this.checkLVal(e.id,"var"===t?1:2,!1)};var $=1,J=2;z.parseFunction=function(e,t,n,r){this.initFunction(e),(this.options.ecmaVersion>=9||this.options.ecmaVersion>=6&&!r)&&(this.type===w.star&&t&J&&this.unexpected(),e.generator=this.eat(w.star)),this.options.ecmaVersion>=8&&(e.async=!!r),t&$&&(e.id=4&t&&this.type!==w.name?null:this.parseIdent(),!e.id||t&J||this.checkLVal(e.id,this.strict||e.generator||e.async?this.treatFunctionsAsVar?1:2:3));var i=this.yieldPos,s=this.awaitPos,o=this.awaitIdentPos;return this.yieldPos=0,this.awaitPos=0,this.awaitIdentPos=0,this.enterScope(j(e.async,e.generator)),t&$||(e.id=this.type===w.name?this.parseIdent():null),this.parseFunctionParams(e),this.parseFunctionBody(e,n,!1),this.yieldPos=i,this.awaitPos=s,this.awaitIdentPos=o,this.finishNode(e,t&$?"FunctionDeclaration":"FunctionExpression")},z.parseFunctionParams=function(e){this.expect(w.parenL),e.params=this.parseBindingList(w.parenR,!1,this.options.ecmaVersion>=8),this.checkYieldAwaitInDefaultParams()},z.parseClass=function(e,t){this.next();var n=this.strict;this.strict=!0,this.parseClassId(e,t),this.parseClassSuper(e);var r=this.startNode(),i=!1;for(r.body=[],this.expect(w.braceL);this.type!==w.braceR;){var s=this.parseClassElement(null!==e.superClass);s&&(r.body.push(s),"MethodDefinition"===s.type&&"constructor"===s.kind&&(i&&this.raise(s.start,"Duplicate constructor in the same class"),i=!0))}return this.strict=n,this.next(),e.body=this.finishNode(r,"ClassBody"),this.finishNode(e,t?"ClassDeclaration":"ClassExpression")},z.parseClassElement=function(e){var t=this;if(this.eat(w.semi))return null;var n=this.startNode(),r=function(e,r){void 0===r&&(r=!1);var i=t.start,s=t.startLoc;return!!t.eatContextual(e)&&(!(t.type===w.parenL||r&&t.canInsertSemicolon())||(n.key&&t.unexpected(),n.computed=!1,n.key=t.startNodeAt(i,s),n.key.name=e,t.finishNode(n.key,"Identifier"),!1))};n.kind="method",n.static=r("static");var i=this.eat(w.star),s=!1;i||(this.options.ecmaVersion>=8&&r("async",!0)?(s=!0,i=this.options.ecmaVersion>=9&&this.eat(w.star)):r("get")?n.kind="get":r("set")&&(n.kind="set")),n.key||this.parsePropertyName(n);var o=n.key,u=!1;return n.computed||n.static||!("Identifier"===o.type&&"constructor"===o.name||"Literal"===o.type&&"constructor"===o.value)?n.static&&"Identifier"===o.type&&"prototype"===o.name&&this.raise(o.start,"Classes may not have a static property named prototype"):("method"!==n.kind&&this.raise(o.start,"Constructor can't have get/set modifier"),i&&this.raise(o.start,"Constructor can't be a generator"),s&&this.raise(o.start,"Constructor can't be an async method"),n.kind="constructor",u=e),this.parseClassMethod(n,i,s,u),"get"===n.kind&&0!==n.value.params.length&&this.raiseRecoverable(n.value.start,"getter should have no params"),"set"===n.kind&&1!==n.value.params.length&&this.raiseRecoverable(n.value.start,"setter should have exactly one param"),"set"===n.kind&&"RestElement"===n.value.params[0].type&&this.raiseRecoverable(n.value.params[0].start,"Setter cannot use rest params"),n},z.parseClassMethod=function(e,t,n,r){return e.value=this.parseMethod(t,n,r),this.finishNode(e,"MethodDefinition")},z.parseClassId=function(e,t){this.type===w.name?(e.id=this.parseIdent(),t&&this.checkLVal(e.id,2,!1)):(!0===t&&this.unexpected(),e.id=null)},z.parseClassSuper=function(e){e.superClass=this.eat(w._extends)?this.parseExprSubscripts():null},z.parseExport=function(e,t){if(this.next(),this.eat(w.star))return this.options.ecmaVersion>=11&&(this.eatContextual("as")?(e.exported=this.parseIdent(!0),this.checkExport(t,e.exported.name,this.lastTokStart)):e.exported=null),this.expectContextual("from"),this.type!==w.string&&this.unexpected(),e.source=this.parseExprAtom(),this.semicolon(),this.finishNode(e,"ExportAllDeclaration");if(this.eat(w._default)){var n;if(this.checkExport(t,"default",this.lastTokStart),this.type===w._function||(n=this.isAsyncFunction())){var r=this.startNode();this.next(),n&&this.next(),e.declaration=this.parseFunction(r,4|$,!1,n)}else if(this.type===w._class){var i=this.startNode();e.declaration=this.parseClass(i,"nullableID")}else e.declaration=this.parseMaybeAssign(),this.semicolon();return this.finishNode(e,"ExportDefaultDeclaration")}if(this.shouldParseExportStatement())e.declaration=this.parseStatement(null),"VariableDeclaration"===e.declaration.type?this.checkVariableExport(t,e.declaration.declarations):this.checkExport(t,e.declaration.id.name,e.declaration.id.start),e.specifiers=[],e.source=null;else{if(e.declaration=null,e.specifiers=this.parseExportSpecifiers(t),this.eatContextual("from"))this.type!==w.string&&this.unexpected(),e.source=this.parseExprAtom();else{for(var s=0,o=e.specifiers;s<o.length;s+=1){var u=o[s];this.checkUnreserved(u.local),this.checkLocalExport(u.local)}e.source=null}this.semicolon()}return this.finishNode(e,"ExportNamedDeclaration")},z.checkExport=function(e,t,n){e&&(A(e,t)&&this.raiseRecoverable(n,"Duplicate export '"+t+"'"),e[t]=!0)},z.checkPatternExport=function(e,t){var n=t.type;if("Identifier"===n)this.checkExport(e,t.name,t.start);else if("ObjectPattern"===n)for(var r=0,i=t.properties;r<i.length;r+=1){var s=i[r];this.checkPatternExport(e,s)}else if("ArrayPattern"===n)for(var o=0,u=t.elements;o<u.length;o+=1){var a=u[o];a&&this.checkPatternExport(e,a)}else"Property"===n?this.checkPatternExport(e,t.value):"AssignmentPattern"===n?this.checkPatternExport(e,t.left):"RestElement"===n?this.checkPatternExport(e,t.argument):"ParenthesizedExpression"===n&&this.checkPatternExport(e,t.expression)},z.checkVariableExport=function(e,t){if(e)for(var n=0,r=t;n<r.length;n+=1){var i=r[n];this.checkPatternExport(e,i.id)}},z.shouldParseExportStatement=function(){return"var"===this.type.keyword||"const"===this.type.keyword||"class"===this.type.keyword||"function"===this.type.keyword||this.isLet()||this.isAsyncFunction()},z.parseExportSpecifiers=function(e){var t=[],n=!0;for(this.expect(w.braceL);!this.eat(w.braceR);){if(n)n=!1;else if(this.expect(w.comma),this.afterTrailingComma(w.braceR))break;var r=this.startNode();r.local=this.parseIdent(!0),r.exported=this.eatContextual("as")?this.parseIdent(!0):r.local,this.checkExport(e,r.exported.name,r.exported.start),t.push(this.finishNode(r,"ExportSpecifier"))}return t},z.parseImport=function(e){return this.next(),this.type===w.string?(e.specifiers=V,e.source=this.parseExprAtom()):(e.specifiers=this.parseImportSpecifiers(),this.expectContextual("from"),e.source=this.type===w.string?this.parseExprAtom():this.unexpected()),this.semicolon(),this.finishNode(e,"ImportDeclaration")},z.parseImportSpecifiers=function(){var e=[],t=!0;if(this.type===w.name){var n=this.startNode();if(n.local=this.parseIdent(),this.checkLVal(n.local,2),e.push(this.finishNode(n,"ImportDefaultSpecifier")),!this.eat(w.comma))return e}if(this.type===w.star){var r=this.startNode();return this.next(),this.expectContextual("as"),r.local=this.parseIdent(),this.checkLVal(r.local,2),e.push(this.finishNode(r,"ImportNamespaceSpecifier")),e}for(this.expect(w.braceL);!this.eat(w.braceR);){if(t)t=!1;else if(this.expect(w.comma),this.afterTrailingComma(w.braceR))break;var i=this.startNode();i.imported=this.parseIdent(!0),this.eatContextual("as")?i.local=this.parseIdent():(this.checkUnreserved(i.imported),i.local=i.imported),this.checkLVal(i.local,2),e.push(this.finishNode(i,"ImportSpecifier"))}return e},z.adaptDirectivePrologue=function(e){for(var t=0;t<e.length&&this.isDirectiveCandidate(e[t]);++t)e[t].directive=e[t].expression.raw.slice(1,-1)},z.isDirectiveCandidate=function(e){return"ExpressionStatement"===e.type&&"Literal"===e.expression.type&&"string"==typeof e.expression.value&&('"'===this.input[e.start]||"'"===this.input[e.start])};var K=F.prototype;K.toAssignable=function(e,t,n){if(this.options.ecmaVersion>=6&&e)switch(e.type){case"Identifier":this.inAsync&&"await"===e.name&&this.raise(e.start,"Cannot use 'await' as identifier inside an async function");break;case"ObjectPattern":case"ArrayPattern":case"RestElement":break;case"ObjectExpression":e.type="ObjectPattern",n&&this.checkPatternErrors(n,!0);for(var r=0,i=e.properties;r<i.length;r+=1){var s=i[r];this.toAssignable(s,t),"RestElement"!==s.type||"ArrayPattern"!==s.argument.type&&"ObjectPattern"!==s.argument.type||this.raise(s.argument.start,"Unexpected token")}break;case"Property":"init"!==e.kind&&this.raise(e.key.start,"Object pattern can't contain getter or setter"),this.toAssignable(e.value,t);break;case"ArrayExpression":e.type="ArrayPattern",n&&this.checkPatternErrors(n,!0),this.toAssignableList(e.elements,t);break;case"SpreadElement":e.type="RestElement",this.toAssignable(e.argument,t),"AssignmentPattern"===e.argument.type&&this.raise(e.argument.start,"Rest elements cannot have a default value");break;case"AssignmentExpression":"="!==e.operator&&this.raise(e.left.end,"Only '=' operator can be used for specifying default value."),e.type="AssignmentPattern",delete e.operator,this.toAssignable(e.left,t);case"AssignmentPattern":break;case"ParenthesizedExpression":this.toAssignable(e.expression,t,n);break;case"ChainExpression":this.raiseRecoverable(e.start,"Optional chaining cannot appear in left-hand side");break;case"MemberExpression":if(!t)break;default:this.raise(e.start,"Assigning to rvalue")}else n&&this.checkPatternErrors(n,!0);return e},K.toAssignableList=function(e,t){for(var n=e.length,r=0;r<n;r++){var i=e[r];i&&this.toAssignable(i,t)}if(n){var s=e[n-1];6===this.options.ecmaVersion&&t&&s&&"RestElement"===s.type&&"Identifier"!==s.argument.type&&this.unexpected(s.argument.start)}return e},K.parseSpread=function(e){var t=this.startNode();return this.next(),t.argument=this.parseMaybeAssign(!1,e),this.finishNode(t,"SpreadElement")},K.parseRestBinding=function(){var e=this.startNode();return this.next(),6===this.options.ecmaVersion&&this.type!==w.name&&this.unexpected(),e.argument=this.parseBindingAtom(),this.finishNode(e,"RestElement")},K.parseBindingAtom=function(){if(this.options.ecmaVersion>=6)switch(this.type){case w.bracketL:var e=this.startNode();return this.next(),e.elements=this.parseBindingList(w.bracketR,!0,!0),this.finishNode(e,"ArrayPattern");case w.braceL:return this.parseObj(!0)}return this.parseIdent()},K.parseBindingList=function(e,t,n){for(var r=[],i=!0;!this.eat(e);)if(i?i=!1:this.expect(w.comma),t&&this.type===w.comma)r.push(null);else{if(n&&this.afterTrailingComma(e))break;if(this.type===w.ellipsis){var s=this.parseRestBinding();this.parseBindingListItem(s),r.push(s),this.type===w.comma&&this.raise(this.start,"Comma is not permitted after the rest element"),this.expect(e);break}var o=this.parseMaybeDefault(this.start,this.startLoc);this.parseBindingListItem(o),r.push(o)}return r},K.parseBindingListItem=function(e){return e},K.parseMaybeDefault=function(e,t,n){if(n=n||this.parseBindingAtom(),this.options.ecmaVersion<6||!this.eat(w.eq))return n;var r=this.startNodeAt(e,t);return r.left=n,r.right=this.parseMaybeAssign(),this.finishNode(r,"AssignmentPattern")},K.checkLVal=function(e,t,n){switch(void 0===t&&(t=0),e.type){case"Identifier":2===t&&"let"===e.name&&this.raiseRecoverable(e.start,"let is disallowed as a lexically bound name"),this.strict&&this.reservedWordsStrictBind.test(e.name)&&this.raiseRecoverable(e.start,(t?"Binding ":"Assigning to ")+e.name+" in strict mode"),n&&(A(n,e.name)&&this.raiseRecoverable(e.start,"Argument name clash"),n[e.name]=!0),0!==t&&5!==t&&this.declareName(e.name,t,e.start);break;case"ChainExpression":this.raiseRecoverable(e.start,"Optional chaining cannot appear in left-hand side");break;case"MemberExpression":t&&this.raiseRecoverable(e.start,"Binding member expression");break;case"ObjectPattern":for(var r=0,i=e.properties;r<i.length;r+=1){var s=i[r];this.checkLVal(s,t,n)}break;case"Property":this.checkLVal(e.value,t,n);break;case"ArrayPattern":for(var o=0,u=e.elements;o<u.length;o+=1){var a=u[o];a&&this.checkLVal(a,t,n)}break;case"AssignmentPattern":this.checkLVal(e.left,t,n);break;case"RestElement":this.checkLVal(e.argument,t,n);break;case"ParenthesizedExpression":this.checkLVal(e.expression,t,n);break;default:this.raise(e.start,(t?"Binding":"Assigning to")+" rvalue")}};var Q=F.prototype;Q.checkPropClash=function(e,t,n){if(!(this.options.ecmaVersion>=9&&"SpreadElement"===e.type||this.options.ecmaVersion>=6&&(e.computed||e.method||e.shorthand))){var r,i=e.key;switch(i.type){case"Identifier":r=i.name;break;case"Literal":r=String(i.value);break;default:return}var s=e.kind;if(this.options.ecmaVersion>=6)"__proto__"===r&&"init"===s&&(t.proto&&(n?n.doubleProto<0&&(n.doubleProto=i.start):this.raiseRecoverable(i.start,"Redefinition of __proto__ property")),t.proto=!0);else{var o=t[r="$"+r];o?("init"===s?this.strict&&o.init||o.get||o.set:o.init||o[s])&&this.raiseRecoverable(i.start,"Redefinition of property"):o=t[r]={init:!1,get:!1,set:!1},o[s]=!0}}},Q.parseExpression=function(e,t){var n=this.start,r=this.startLoc,i=this.parseMaybeAssign(e,t);if(this.type===w.comma){var s=this.startNodeAt(n,r);for(s.expressions=[i];this.eat(w.comma);)s.expressions.push(this.parseMaybeAssign(e,t));return this.finishNode(s,"SequenceExpression")}return i},Q.parseMaybeAssign=function(e,t,n){if(this.isContextual("yield")){if(this.inGenerator)return this.parseYield(e);this.exprAllowed=!1}var r=!1,i=-1,s=-1;t?(i=t.parenthesizedAssign,s=t.trailingComma,t.parenthesizedAssign=t.trailingComma=-1):(t=new U,r=!0);var o=this.start,u=this.startLoc;this.type!==w.parenL&&this.type!==w.name||(this.potentialArrowAt=this.start);var a=this.parseMaybeConditional(e,t);if(n&&(a=n.call(this,a,o,u)),this.type.isAssign){var f=this.startNodeAt(o,u);return f.operator=this.value,f.left=this.type===w.eq?this.toAssignable(a,!1,t):a,r||(t.parenthesizedAssign=t.trailingComma=t.doubleProto=-1),t.shorthandAssign>=f.left.start&&(t.shorthandAssign=-1),this.checkLVal(a),this.next(),f.right=this.parseMaybeAssign(e),this.finishNode(f,"AssignmentExpression")}return r&&this.checkExpressionErrors(t,!0),i>-1&&(t.parenthesizedAssign=i),s>-1&&(t.trailingComma=s),a},Q.parseMaybeConditional=function(e,t){var n=this.start,r=this.startLoc,i=this.parseExprOps(e,t);if(this.checkExpressionErrors(t))return i;if(this.eat(w.question)){var s=this.startNodeAt(n,r);return s.test=i,s.consequent=this.parseMaybeAssign(),this.expect(w.colon),s.alternate=this.parseMaybeAssign(e),this.finishNode(s,"ConditionalExpression")}return i},Q.parseExprOps=function(e,t){var n=this.start,r=this.startLoc,i=this.parseMaybeUnary(t,!1);return this.checkExpressionErrors(t)||i.start===n&&"ArrowFunctionExpression"===i.type?i:this.parseExprOp(i,n,r,-1,e)},Q.parseExprOp=function(e,t,n,r,i){var s=this.type.binop;if(null!=s&&(!i||this.type!==w._in)&&s>r){var o=this.type===w.logicalOR||this.type===w.logicalAND,u=this.type===w.coalesce;u&&(s=w.logicalAND.binop);var a=this.value;this.next();var f=this.start,l=this.startLoc,c=this.parseExprOp(this.parseMaybeUnary(null,!1),f,l,s,i),h=this.buildBinary(t,n,e,c,a,o||u);return(o&&this.type===w.coalesce||u&&(this.type===w.logicalOR||this.type===w.logicalAND))&&this.raiseRecoverable(this.start,"Logical expressions and coalesce expressions cannot be mixed. Wrap either by parentheses"),this.parseExprOp(h,t,n,r,i)}return e},Q.buildBinary=function(e,t,n,r,i,s){var o=this.startNodeAt(e,t);return o.left=n,o.operator=i,o.right=r,this.finishNode(o,s?"LogicalExpression":"BinaryExpression")},Q.parseMaybeUnary=function(e,t){var n,r=this.start,i=this.startLoc;if(this.isContextual("await")&&(this.inAsync||!this.inFunction&&this.options.allowAwaitOutsideFunction))n=this.parseAwait(),t=!0;else if(this.type.prefix){var s=this.startNode(),o=this.type===w.incDec;s.operator=this.value,s.prefix=!0,this.next(),s.argument=this.parseMaybeUnary(null,!0),this.checkExpressionErrors(e,!0),o?this.checkLVal(s.argument):this.strict&&"delete"===s.operator&&"Identifier"===s.argument.type?this.raiseRecoverable(s.start,"Deleting local variable in strict mode"):t=!0,n=this.finishNode(s,o?"UpdateExpression":"UnaryExpression")}else{if(n=this.parseExprSubscripts(e),this.checkExpressionErrors(e))return n;for(;this.type.postfix&&!this.canInsertSemicolon();){var u=this.startNodeAt(r,i);u.operator=this.value,u.prefix=!1,u.argument=n,this.checkLVal(n),this.next(),n=this.finishNode(u,"UpdateExpression")}}return!t&&this.eat(w.starstar)?this.buildBinary(r,i,n,this.parseMaybeUnary(null,!1),"**",!1):n},Q.parseExprSubscripts=function(e){var t=this.start,n=this.startLoc,r=this.parseExprAtom(e);if("ArrowFunctionExpression"===r.type&&")"!==this.input.slice(this.lastTokStart,this.lastTokEnd))return r;var i=this.parseSubscripts(r,t,n);return e&&"MemberExpression"===i.type&&(e.parenthesizedAssign>=i.start&&(e.parenthesizedAssign=-1),e.parenthesizedBind>=i.start&&(e.parenthesizedBind=-1)),i},Q.parseSubscripts=function(e,t,n,r){for(var i=this.options.ecmaVersion>=8&&"Identifier"===e.type&&"async"===e.name&&this.lastTokEnd===e.end&&!this.canInsertSemicolon()&&e.end-e.start==5&&this.potentialArrowAt===e.start,s=!1;;){var o=this.parseSubscript(e,t,n,r,i,s);if(o.optional&&(s=!0),o===e||"ArrowFunctionExpression"===o.type){if(s){var u=this.startNodeAt(t,n);u.expression=o,o=this.finishNode(u,"ChainExpression")}return o}e=o}},Q.parseSubscript=function(e,t,n,r,i,s){var o=this.options.ecmaVersion>=11,u=o&&this.eat(w.questionDot);r&&u&&this.raise(this.lastTokStart,"Optional chaining cannot appear in the callee of new expressions");var a=this.eat(w.bracketL);if(a||u&&this.type!==w.parenL&&this.type!==w.backQuote||this.eat(w.dot)){var f=this.startNodeAt(t,n);f.object=e,f.property=a?this.parseExpression():this.parseIdent("never"!==this.options.allowReserved),f.computed=!!a,a&&this.expect(w.bracketR),o&&(f.optional=u),e=this.finishNode(f,"MemberExpression")}else if(!r&&this.eat(w.parenL)){var l=new U,c=this.yieldPos,h=this.awaitPos,p=this.awaitIdentPos;this.yieldPos=0,this.awaitPos=0,this.awaitIdentPos=0;var d=this.parseExprList(w.parenR,this.options.ecmaVersion>=8,!1,l);if(i&&!u&&!this.canInsertSemicolon()&&this.eat(w.arrow))return this.checkPatternErrors(l,!1),this.checkYieldAwaitInDefaultParams(),this.awaitIdentPos>0&&this.raise(this.awaitIdentPos,"Cannot use 'await' as identifier inside an async function"),this.yieldPos=c,this.awaitPos=h,this.awaitIdentPos=p,this.parseArrowExpression(this.startNodeAt(t,n),d,!0);this.checkExpressionErrors(l,!0),this.yieldPos=c||this.yieldPos,this.awaitPos=h||this.awaitPos,this.awaitIdentPos=p||this.awaitIdentPos;var v=this.startNodeAt(t,n);v.callee=e,v.arguments=d,o&&(v.optional=u),e=this.finishNode(v,"CallExpression")}else if(this.type===w.backQuote){(u||s)&&this.raise(this.start,"Optional chaining cannot appear in the tag of tagged template expressions");var m=this.startNodeAt(t,n);m.tag=e,m.quasi=this.parseTemplate({isTagged:!0}),e=this.finishNode(m,"TaggedTemplateExpression")}return e},Q.parseExprAtom=function(e){this.type===w.slash&&this.readRegexp();var t,n=this.potentialArrowAt===this.start;switch(this.type){case w._super:return this.allowSuper||this.raise(this.start,"'super' keyword outside a method"),t=this.startNode(),this.next(),this.type!==w.parenL||this.allowDirectSuper||this.raise(t.start,"super() call outside constructor of a subclass"),this.type!==w.dot&&this.type!==w.bracketL&&this.type!==w.parenL&&this.unexpected(),this.finishNode(t,"Super");case w._this:return t=this.startNode(),this.next(),this.finishNode(t,"ThisExpression");case w.name:var r=this.start,i=this.startLoc,s=this.containsEsc,o=this.parseIdent(!1);if(this.options.ecmaVersion>=8&&!s&&"async"===o.name&&!this.canInsertSemicolon()&&this.eat(w._function))return this.parseFunction(this.startNodeAt(r,i),0,!1,!0);if(n&&!this.canInsertSemicolon()){if(this.eat(w.arrow))return this.parseArrowExpression(this.startNodeAt(r,i),[o],!1);if(this.options.ecmaVersion>=8&&"async"===o.name&&this.type===w.name&&!s)return o=this.parseIdent(!1),!this.canInsertSemicolon()&&this.eat(w.arrow)||this.unexpected(),this.parseArrowExpression(this.startNodeAt(r,i),[o],!0)}return o;case w.regexp:var u=this.value;return(t=this.parseLiteral(u.value)).regex={pattern:u.pattern,flags:u.flags},t;case w.num:case w.string:return this.parseLiteral(this.value);case w._null:case w._true:case w._false:return(t=this.startNode()).value=this.type===w._null?null:this.type===w._true,t.raw=this.type.keyword,this.next(),this.finishNode(t,"Literal");case w.parenL:var a=this.start,f=this.parseParenAndDistinguishExpression(n);return e&&(e.parenthesizedAssign<0&&!this.isSimpleAssignTarget(f)&&(e.parenthesizedAssign=a),e.parenthesizedBind<0&&(e.parenthesizedBind=a)),f;case w.bracketL:return t=this.startNode(),this.next(),t.elements=this.parseExprList(w.bracketR,!0,!0,e),this.finishNode(t,"ArrayExpression");case w.braceL:return this.parseObj(!1,e);case w._function:return t=this.startNode(),this.next(),this.parseFunction(t,0);case w._class:return this.parseClass(this.startNode(),!1);case w._new:return this.parseNew();case w.backQuote:return this.parseTemplate();case w._import:return this.options.ecmaVersion>=11?this.parseExprImport():this.unexpected();default:this.unexpected()}},Q.parseExprImport=function(){var e=this.startNode();this.containsEsc&&this.raiseRecoverable(this.start,"Escape sequence in keyword import");var t=this.parseIdent(!0);switch(this.type){case w.parenL:return this.parseDynamicImport(e);case w.dot:return e.meta=t,this.parseImportMeta(e);default:this.unexpected()}},Q.parseDynamicImport=function(e){if(this.next(),e.source=this.parseMaybeAssign(),!this.eat(w.parenR)){var t=this.start;this.eat(w.comma)&&this.eat(w.parenR)?this.raiseRecoverable(t,"Trailing comma is not allowed in import()"):this.unexpected(t)}return this.finishNode(e,"ImportExpression")},Q.parseImportMeta=function(e){this.next();var t=this.containsEsc;return e.property=this.parseIdent(!0),"meta"!==e.property.name&&this.raiseRecoverable(e.property.start,"The only valid meta property for import is 'import.meta'"),t&&this.raiseRecoverable(e.start,"'import.meta' must not contain escaped characters"),"module"!==this.options.sourceType&&this.raiseRecoverable(e.start,"Cannot use 'import.meta' outside a module"),this.finishNode(e,"MetaProperty")},Q.parseLiteral=function(e){var t=this.startNode();return t.value=e,t.raw=this.input.slice(this.start,this.end),110===t.raw.charCodeAt(t.raw.length-1)&&(t.bigint=t.raw.slice(0,-1).replace(/_/g,"")),this.next(),this.finishNode(t,"Literal")},Q.parseParenExpression=function(){this.expect(w.parenL);var e=this.parseExpression();return this.expect(w.parenR),e},Q.parseParenAndDistinguishExpression=function(e){var t,n=this.start,r=this.startLoc,i=this.options.ecmaVersion>=8;if(this.options.ecmaVersion>=6){this.next();var s,o=this.start,u=this.startLoc,a=[],f=!0,l=!1,c=new U,h=this.yieldPos,p=this.awaitPos;for(this.yieldPos=0,this.awaitPos=0;this.type!==w.parenR;){if(f?f=!1:this.expect(w.comma),i&&this.afterTrailingComma(w.parenR,!0)){l=!0;break}if(this.type===w.ellipsis){s=this.start,a.push(this.parseParenItem(this.parseRestBinding())),this.type===w.comma&&this.raise(this.start,"Comma is not permitted after the rest element");break}a.push(this.parseMaybeAssign(!1,c,this.parseParenItem))}var d=this.start,v=this.startLoc;if(this.expect(w.parenR),e&&!this.canInsertSemicolon()&&this.eat(w.arrow))return this.checkPatternErrors(c,!1),this.checkYieldAwaitInDefaultParams(),this.yieldPos=h,this.awaitPos=p,this.parseParenArrowList(n,r,a);a.length&&!l||this.unexpected(this.lastTokStart),s&&this.unexpected(s),this.checkExpressionErrors(c,!0),this.yieldPos=h||this.yieldPos,this.awaitPos=p||this.awaitPos,a.length>1?((t=this.startNodeAt(o,u)).expressions=a,this.finishNodeAt(t,"SequenceExpression",d,v)):t=a[0]}else t=this.parseParenExpression();if(this.options.preserveParens){var m=this.startNodeAt(n,r);return m.expression=t,this.finishNode(m,"ParenthesizedExpression")}return t},Q.parseParenItem=function(e){return e},Q.parseParenArrowList=function(e,t,n){return this.parseArrowExpression(this.startNodeAt(e,t),n)};var G=[];Q.parseNew=function(){this.containsEsc&&this.raiseRecoverable(this.start,"Escape sequence in keyword new");var e=this.startNode(),t=this.parseIdent(!0);if(this.options.ecmaVersion>=6&&this.eat(w.dot)){e.meta=t;var n=this.containsEsc;return e.property=this.parseIdent(!0),"target"!==e.property.name&&this.raiseRecoverable(e.property.start,"The only valid meta property for new is 'new.target'"),n&&this.raiseRecoverable(e.start,"'new.target' must not contain escaped characters"),this.inNonArrowFunction()||this.raiseRecoverable(e.start,"'new.target' can only be used in functions"),this.finishNode(e,"MetaProperty")}var r=this.start,i=this.startLoc,s=this.type===w._import;return e.callee=this.parseSubscripts(this.parseExprAtom(),r,i,!0),s&&"ImportExpression"===e.callee.type&&this.raise(r,"Cannot use new with import()"),this.eat(w.parenL)?e.arguments=this.parseExprList(w.parenR,this.options.ecmaVersion>=8,!1):e.arguments=G,this.finishNode(e,"NewExpression")},Q.parseTemplateElement=function(e){var t=e.isTagged,n=this.startNode();return this.type===w.invalidTemplate?(t||this.raiseRecoverable(this.start,"Bad escape sequence in untagged template literal"),n.value={raw:this.value,cooked:null}):n.value={raw:this.input.slice(this.start,this.end).replace(/\r\n?/g,"\n"),cooked:this.value},this.next(),n.tail=this.type===w.backQuote,this.finishNode(n,"TemplateElement")},Q.parseTemplate=function(e){void 0===e&&(e={});var t=e.isTagged;void 0===t&&(t=!1);var n=this.startNode();this.next(),n.expressions=[];var r=this.parseTemplateElement({isTagged:t});for(n.quasis=[r];!r.tail;)this.type===w.eof&&this.raise(this.pos,"Unterminated template literal"),this.expect(w.dollarBraceL),n.expressions.push(this.parseExpression()),this.expect(w.braceR),n.quasis.push(r=this.parseTemplateElement({isTagged:t}));return this.next(),this.finishNode(n,"TemplateLiteral")},Q.isAsyncProp=function(e){return!e.computed&&"Identifier"===e.key.type&&"async"===e.key.name&&(this.type===w.name||this.type===w.num||this.type===w.string||this.type===w.bracketL||this.type.keyword||this.options.ecmaVersion>=9&&this.type===w.star)&&!E.test(this.input.slice(this.lastTokEnd,this.start))},Q.parseObj=function(e,t){var n=this.startNode(),r=!0,i={};for(n.properties=[],this.next();!this.eat(w.braceR);){if(r)r=!1;else if(this.expect(w.comma),this.options.ecmaVersion>=5&&this.afterTrailingComma(w.braceR))break;var s=this.parseProperty(e,t);e||this.checkPropClash(s,i,t),n.properties.push(s)}return this.finishNode(n,e?"ObjectPattern":"ObjectExpression")},Q.parseProperty=function(e,t){var n,r,i,s,o=this.startNode();if(this.options.ecmaVersion>=9&&this.eat(w.ellipsis))return e?(o.argument=this.parseIdent(!1),this.type===w.comma&&this.raise(this.start,"Comma is not permitted after the rest element"),this.finishNode(o,"RestElement")):(this.type===w.parenL&&t&&(t.parenthesizedAssign<0&&(t.parenthesizedAssign=this.start),t.parenthesizedBind<0&&(t.parenthesizedBind=this.start)),o.argument=this.parseMaybeAssign(!1,t),this.type===w.comma&&t&&t.trailingComma<0&&(t.trailingComma=this.start),this.finishNode(o,"SpreadElement"));this.options.ecmaVersion>=6&&(o.method=!1,o.shorthand=!1,(e||t)&&(i=this.start,s=this.startLoc),e||(n=this.eat(w.star)));var u=this.containsEsc;return this.parsePropertyName(o),!e&&!u&&this.options.ecmaVersion>=8&&!n&&this.isAsyncProp(o)?(r=!0,n=this.options.ecmaVersion>=9&&this.eat(w.star),this.parsePropertyName(o,t)):r=!1,this.parsePropertyValue(o,e,n,r,i,s,t,u),this.finishNode(o,"Property")},Q.parsePropertyValue=function(e,t,n,r,i,s,o,u){if((n||r)&&this.type===w.colon&&this.unexpected(),this.eat(w.colon))e.value=t?this.parseMaybeDefault(this.start,this.startLoc):this.parseMaybeAssign(!1,o),e.kind="init";else if(this.options.ecmaVersion>=6&&this.type===w.parenL)t&&this.unexpected(),e.kind="init",e.method=!0,e.value=this.parseMethod(n,r);else if(t||u||!(this.options.ecmaVersion>=5)||e.computed||"Identifier"!==e.key.type||"get"!==e.key.name&&"set"!==e.key.name||this.type===w.comma||this.type===w.braceR||this.type===w.eq)this.options.ecmaVersion>=6&&!e.computed&&"Identifier"===e.key.type?((n||r)&&this.unexpected(),this.checkUnreserved(e.key),"await"!==e.key.name||this.awaitIdentPos||(this.awaitIdentPos=i),e.kind="init",t?e.value=this.parseMaybeDefault(i,s,e.key):this.type===w.eq&&o?(o.shorthandAssign<0&&(o.shorthandAssign=this.start),e.value=this.parseMaybeDefault(i,s,e.key)):e.value=e.key,e.shorthand=!0):this.unexpected();else{(n||r)&&this.unexpected(),e.kind=e.key.name,this.parsePropertyName(e),e.value=this.parseMethod(!1);var a="get"===e.kind?0:1;if(e.value.params.length!==a){var f=e.value.start;"get"===e.kind?this.raiseRecoverable(f,"getter should have no params"):this.raiseRecoverable(f,"setter should have exactly one param")}else"set"===e.kind&&"RestElement"===e.value.params[0].type&&this.raiseRecoverable(e.value.params[0].start,"Setter cannot use rest params")}},Q.parsePropertyName=function(e){if(this.options.ecmaVersion>=6){if(this.eat(w.bracketL))return e.computed=!0,e.key=this.parseMaybeAssign(),this.expect(w.bracketR),e.key;e.computed=!1}return e.key=this.type===w.num||this.type===w.string?this.parseExprAtom():this.parseIdent("never"!==this.options.allowReserved)},Q.initFunction=function(e){e.id=null,this.options.ecmaVersion>=6&&(e.generator=e.expression=!1),this.options.ecmaVersion>=8&&(e.async=!1)},Q.parseMethod=function(e,t,n){var r=this.startNode(),i=this.yieldPos,s=this.awaitPos,o=this.awaitIdentPos;return this.initFunction(r),this.options.ecmaVersion>=6&&(r.generator=e),this.options.ecmaVersion>=8&&(r.async=!!t),this.yieldPos=0,this.awaitPos=0,this.awaitIdentPos=0,this.enterScope(64|j(t,r.generator)|(n?128:0)),this.expect(w.parenL),r.params=this.parseBindingList(w.parenR,!1,this.options.ecmaVersion>=8),this.checkYieldAwaitInDefaultParams(),this.parseFunctionBody(r,!1,!0),this.yieldPos=i,this.awaitPos=s,this.awaitIdentPos=o,this.finishNode(r,"FunctionExpression")},Q.parseArrowExpression=function(e,t,n){var r=this.yieldPos,i=this.awaitPos,s=this.awaitIdentPos;return this.enterScope(16|j(n,!1)),this.initFunction(e),this.options.ecmaVersion>=8&&(e.async=!!n),this.yieldPos=0,this.awaitPos=0,this.awaitIdentPos=0,e.params=this.toAssignableList(t,!0),this.parseFunctionBody(e,!0,!1),this.yieldPos=r,this.awaitPos=i,this.awaitIdentPos=s,this.finishNode(e,"ArrowFunctionExpression")},Q.parseFunctionBody=function(e,t,n){var r=t&&this.type!==w.braceL,i=this.strict,s=!1;if(r)e.body=this.parseMaybeAssign(),e.expression=!0,this.checkParams(e,!1);else{var o=this.options.ecmaVersion>=7&&!this.isSimpleParamList(e.params);i&&!o||(s=this.strictDirective(this.end))&&o&&this.raiseRecoverable(e.start,"Illegal 'use strict' directive in function with non-simple parameter list");var u=this.labels;this.labels=[],s&&(this.strict=!0),this.checkParams(e,!i&&!s&&!t&&!n&&this.isSimpleParamList(e.params)),this.strict&&e.id&&this.checkLVal(e.id,5),e.body=this.parseBlock(!1,void 0,s&&!i),e.expression=!1,this.adaptDirectivePrologue(e.body.body),this.labels=u}this.exitScope()},Q.isSimpleParamList=function(e){for(var t=0,n=e;t<n.length;t+=1)if("Identifier"!==n[t].type)return!1;return!0},Q.checkParams=function(e,t){for(var n={},r=0,i=e.params;r<i.length;r+=1){var s=i[r];this.checkLVal(s,1,t?null:n)}},Q.parseExprList=function(e,t,n,r){for(var i=[],s=!0;!this.eat(e);){if(s)s=!1;else if(this.expect(w.comma),t&&this.afterTrailingComma(e))break;var o=void 0;n&&this.type===w.comma?o=null:this.type===w.ellipsis?(o=this.parseSpread(r),r&&this.type===w.comma&&r.trailingComma<0&&(r.trailingComma=this.start)):o=this.parseMaybeAssign(!1,r),i.push(o)}return i},Q.checkUnreserved=function(e){var t=e.start,n=e.end,r=e.name;(this.inGenerator&&"yield"===r&&this.raiseRecoverable(t,"Cannot use 'yield' as identifier inside a generator"),this.inAsync&&"await"===r&&this.raiseRecoverable(t,"Cannot use 'await' as identifier inside an async function"),this.keywords.test(r)&&this.raise(t,"Unexpected keyword '"+r+"'"),this.options.ecmaVersion<6&&-1!==this.input.slice(t,n).indexOf("\\"))||(this.strict?this.reservedWordsStrict:this.reservedWords).test(r)&&(this.inAsync||"await"!==r||this.raiseRecoverable(t,"Cannot use keyword 'await' outside an async function"),this.raiseRecoverable(t,"The keyword '"+r+"' is reserved"))},Q.parseIdent=function(e,t){var n=this.startNode();return this.type===w.name?n.name=this.value:this.type.keyword?(n.name=this.type.keyword,"class"!==n.name&&"function"!==n.name||this.lastTokEnd===this.lastTokStart+1&&46===this.input.charCodeAt(this.lastTokStart)||this.context.pop()):this.unexpected(),this.next(!!e),this.finishNode(n,"Identifier"),e||(this.checkUnreserved(n),"await"!==n.name||this.awaitIdentPos||(this.awaitIdentPos=n.start)),n},Q.parseYield=function(e){this.yieldPos||(this.yieldPos=this.start);var t=this.startNode();return this.next(),this.type===w.semi||this.canInsertSemicolon()||this.type!==w.star&&!this.type.startsExpr?(t.delegate=!1,t.argument=null):(t.delegate=this.eat(w.star),t.argument=this.parseMaybeAssign(e)),this.finishNode(t,"YieldExpression")},Q.parseAwait=function(){this.awaitPos||(this.awaitPos=this.start);var e=this.startNode();return this.next(),e.argument=this.parseMaybeUnary(null,!1),this.finishNode(e,"AwaitExpression")};var Y=F.prototype;Y.raise=function(e,t){var n=P(this.input,e);t+=" ("+n.line+":"+n.column+")";var r=new SyntaxError(t);throw r.pos=e,r.loc=n,r.raisedAt=this.pos,r},Y.raiseRecoverable=Y.raise,Y.curPosition=function(){if(this.options.locations)return new _(this.curLine,this.pos-this.lineStart)};var Z=F.prototype,et=function(e){this.flags=e,this.var=[],this.lexical=[],this.functions=[]};Z.enterScope=function(e){this.scopeStack.push(new et(e))},Z.exitScope=function(){this.scopeStack.pop()},Z.treatFunctionsAsVarInScope=function(e){return 2&e.flags||!this.inModule&&1&e.flags},Z.declareName=function(e,t,n){var r=!1;if(2===t){var i=this.currentScope();r=i.lexical.indexOf(e)>-1||i.functions.indexOf(e)>-1||i.var.indexOf(e)>-1,i.lexical.push(e),this.inModule&&1&i.flags&&delete this.undefinedExports[e]}else if(4===t)this.currentScope().lexical.push(e);else if(3===t){var s=this.currentScope();r=this.treatFunctionsAsVar?s.lexical.indexOf(e)>-1:s.lexical.indexOf(e)>-1||s.var.indexOf(e)>-1,s.functions.push(e)}else for(var o=this.scopeStack.length-1;o>=0;--o){var u=this.scopeStack[o];if(u.lexical.indexOf(e)>-1&&!(32&u.flags&&u.lexical[0]===e)||!this.treatFunctionsAsVarInScope(u)&&u.functions.indexOf(e)>-1){r=!0;break}if(u.var.push(e),this.inModule&&1&u.flags&&delete this.undefinedExports[e],3&u.flags)break}r&&this.raiseRecoverable(n,"Identifier '"+e+"' has already been declared")},Z.checkLocalExport=function(e){-1===this.scopeStack[0].lexical.indexOf(e.name)&&-1===this.scopeStack[0].var.indexOf(e.name)&&(this.undefinedExports[e.name]=e)},Z.currentScope=function(){return this.scopeStack[this.scopeStack.length-1]},Z.currentVarScope=function(){for(var e=this.scopeStack.length-1;;e--){var t=this.scopeStack[e];if(3&t.flags)return t}},Z.currentThisScope=function(){for(var e=this.scopeStack.length-1;;e--){var t=this.scopeStack[e];if(3&t.flags&&!(16&t.flags))return t}};var tt=function(e,t,n){this.type="",this.start=t,this.end=0,e.options.locations&&(this.loc=new D(e,n)),e.options.directSourceFile&&(this.sourceFile=e.options.directSourceFile),e.options.ranges&&(this.range=[t,0])},nt=F.prototype;nt.startNode=function(){return new tt(this,this.start,this.startLoc)},nt.startNodeAt=function(e,t){return new tt(this,e,t)},nt.finishNode=function(e,t){return rt.call(this,e,t,this.lastTokEnd,this.lastTokEndLoc)},nt.finishNodeAt=function(e,t,n,r){return rt.call(this,e,t,n,r)};var it=function(e,t,n,r,i){this.token=e,this.isExpr=!!t,this.preserveSpace=!!n,this.override=r,this.generator=!!i},st={b_stat:new it("{",!1),b_expr:new it("{",!0),b_tmpl:new it("${",!1),p_stat:new it("(",!1),p_expr:new it("(",!0),q_tmpl:new it("`",!0,!0,function(e){return e.tryReadTemplateToken()}),f_stat:new it("function",!1),f_expr:new it("function",!0),f_expr_gen:new it("function",!0,!1,null,!0),f_gen:new it("function",!1,!1,null,!0)},ot=F.prototype;ot.initialContext=function(){return[st.b_stat]},ot.braceIsBlock=function(e){var t=this.curContext();return t===st.f_expr||t===st.f_stat||(e!==w.colon||t!==st.b_stat&&t!==st.b_expr?e===w._return||e===w.name&&this.exprAllowed?E.test(this.input.slice(this.lastTokEnd,this.start)):e===w._else||e===w.semi||e===w.eof||e===w.parenR||e===w.arrow||(e===w.braceL?t===st.b_stat:e!==w._var&&e!==w._const&&e!==w.name&&!this.exprAllowed):!t.isExpr)},ot.inGeneratorContext=function(){for(var e=this.context.length-1;e>=1;e--){var t=this.context[e];if("function"===t.token)return t.generator}return!1},ot.updateContext=function(e){var t,n=this.type;n.keyword&&e===w.dot?this.exprAllowed=!1:(t=n.updateContext)?t.call(this,e):this.exprAllowed=n.beforeExpr},w.parenR.updateContext=w.braceR.updateContext=function(){if(1!==this.context.length){var e=this.context.pop();e===st.b_stat&&"function"===this.curContext().token&&(e=this.context.pop()),this.exprAllowed=!e.isExpr}else this.exprAllowed=!0},w.braceL.updateContext=function(e){this.context.push(this.braceIsBlock(e)?st.b_stat:st.b_expr),this.exprAllowed=!0},w.dollarBraceL.updateContext=function(){this.context.push(st.b_tmpl),this.exprAllowed=!0},w.parenL.updateContext=function(e){var t=e===w._if||e===w._for||e===w._with||e===w._while;this.context.push(t?st.p_stat:st.p_expr),this.exprAllowed=!0},w.incDec.updateContext=function(){},w._function.updateContext=w._class.updateContext=function(e){!e.beforeExpr||e===w.semi||e===w._else||e===w._return&&E.test(this.input.slice(this.lastTokEnd,this.start))||(e===w.colon||e===w.braceL)&&this.curContext()===st.b_stat?this.context.push(st.f_stat):this.context.push(st.f_expr),this.exprAllowed=!1},w.backQuote.updateContext=function(){this.curContext()===st.q_tmpl?this.context.pop():this.context.push(st.q_tmpl),this.exprAllowed=!1},w.star.updateContext=function(e){if(e===w._function){var t=this.context.length-1;this.context[t]===st.f_expr?this.context[t]=st.f_expr_gen:this.context[t]=st.f_gen}this.exprAllowed=!0},w.name.updateContext=function(e){var t=!1;this.options.ecmaVersion>=6&&e!==w.dot&&("of"===this.value&&!this.exprAllowed||"yield"===this.value&&this.inGeneratorContext())&&(t=!0),this.exprAllowed=t};var ut="ASCII ASCII_Hex_Digit AHex Alphabetic Alpha Any Assigned Bidi_Control Bidi_C Bidi_Mirrored Bidi_M Case_Ignorable CI Cased Changes_When_Casefolded CWCF Changes_When_Casemapped CWCM Changes_When_Lowercased CWL Changes_When_NFKC_Casefolded CWKCF Changes_When_Titlecased CWT Changes_When_Uppercased CWU Dash Default_Ignorable_Code_Point DI Deprecated Dep Diacritic Dia Emoji Emoji_Component Emoji_Modifier Emoji_Modifier_Base Emoji_Presentation Extender Ext Grapheme_Base Gr_Base Grapheme_Extend Gr_Ext Hex_Digit Hex IDS_Binary_Operator IDSB IDS_Trinary_Operator IDST ID_Continue IDC ID_Start IDS Ideographic Ideo Join_Control Join_C Logical_Order_Exception LOE Lowercase Lower Math Noncharacter_Code_Point NChar Pattern_Syntax Pat_Syn Pattern_White_Space Pat_WS Quotation_Mark QMark Radical Regional_Indicator RI Sentence_Terminal STerm Soft_Dotted SD Terminal_Punctuation Term Unified_Ideograph UIdeo Uppercase Upper Variation_Selector VS White_Space space XID_Continue XIDC XID_Start XIDS",at=ut+" Extended_Pictographic",ft={9:ut,10:at,11:"ASCII ASCII_Hex_Digit AHex Alphabetic Alpha Any Assigned Bidi_Control Bidi_C Bidi_Mirrored Bidi_M Case_Ignorable CI Cased Changes_When_Casefolded CWCF Changes_When_Casemapped CWCM Changes_When_Lowercased CWL Changes_When_NFKC_Casefolded CWKCF Changes_When_Titlecased CWT Changes_When_Uppercased CWU Dash Default_Ignorable_Code_Point DI Deprecated Dep Diacritic Dia Emoji Emoji_Component Emoji_Modifier Emoji_Modifier_Base Emoji_Presentation Extender Ext Grapheme_Base Gr_Base Grapheme_Extend Gr_Ext Hex_Digit Hex IDS_Binary_Operator IDSB IDS_Trinary_Operator IDST ID_Continue IDC ID_Start IDS Ideographic Ideo Join_Control Join_C Logical_Order_Exception LOE Lowercase Lower Math Noncharacter_Code_Point NChar Pattern_Syntax Pat_Syn Pattern_White_Space Pat_WS Quotation_Mark QMark Radical Regional_Indicator RI Sentence_Terminal STerm Soft_Dotted SD Terminal_Punctuation Term Unified_Ideograph UIdeo Uppercase Upper Variation_Selector VS White_Space space XID_Continue XIDC XID_Start XIDS Extended_Pictographic"},lt="Cased_Letter LC Close_Punctuation Pe Connector_Punctuation Pc Control Cc cntrl Currency_Symbol Sc Dash_Punctuation Pd Decimal_Number Nd digit Enclosing_Mark Me Final_Punctuation Pf Format Cf Initial_Punctuation Pi Letter L Letter_Number Nl Line_Separator Zl Lowercase_Letter Ll Mark M Combining_Mark Math_Symbol Sm Modifier_Letter Lm Modifier_Symbol Sk Nonspacing_Mark Mn Number N Open_Punctuation Ps Other C Other_Letter Lo Other_Number No Other_Punctuation Po Other_Symbol So Paragraph_Separator Zp Private_Use Co Punctuation P punct Separator Z Space_Separator Zs Spacing_Mark Mc Surrogate Cs Symbol S Titlecase_Letter Lt Unassigned Cn Uppercase_Letter Lu",ct="Adlam Adlm Ahom Ahom Anatolian_Hieroglyphs Hluw Arabic Arab Armenian Armn Avestan Avst Balinese Bali Bamum Bamu Bassa_Vah Bass Batak Batk Bengali Beng Bhaiksuki Bhks Bopomofo Bopo Brahmi Brah Braille Brai Buginese Bugi Buhid Buhd Canadian_Aboriginal Cans Carian Cari Caucasian_Albanian Aghb Chakma Cakm Cham Cham Cherokee Cher Common Zyyy Coptic Copt Qaac Cuneiform Xsux Cypriot Cprt Cyrillic Cyrl Deseret Dsrt Devanagari Deva Duployan Dupl Egyptian_Hieroglyphs Egyp Elbasan Elba Ethiopic Ethi Georgian Geor Glagolitic Glag Gothic Goth Grantha Gran Greek Grek Gujarati Gujr Gurmukhi Guru Han Hani Hangul Hang Hanunoo Hano Hatran Hatr Hebrew Hebr Hiragana Hira Imperial_Aramaic Armi Inherited Zinh Qaai Inscriptional_Pahlavi Phli Inscriptional_Parthian Prti Javanese Java Kaithi Kthi Kannada Knda Katakana Kana Kayah_Li Kali Kharoshthi Khar Khmer Khmr Khojki Khoj Khudawadi Sind Lao Laoo Latin Latn Lepcha Lepc Limbu Limb Linear_A Lina Linear_B Linb Lisu Lisu Lycian Lyci Lydian Lydi Mahajani Mahj Malayalam Mlym Mandaic Mand Manichaean Mani Marchen Marc Masaram_Gondi Gonm Meetei_Mayek Mtei Mende_Kikakui Mend Meroitic_Cursive Merc Meroitic_Hieroglyphs Mero Miao Plrd Modi Modi Mongolian Mong Mro Mroo Multani Mult Myanmar Mymr Nabataean Nbat New_Tai_Lue Talu Newa Newa Nko Nkoo Nushu Nshu Ogham Ogam Ol_Chiki Olck Old_Hungarian Hung Old_Italic Ital Old_North_Arabian Narb Old_Permic Perm Old_Persian Xpeo Old_South_Arabian Sarb Old_Turkic Orkh Oriya Orya Osage Osge Osmanya Osma Pahawh_Hmong Hmng Palmyrene Palm Pau_Cin_Hau Pauc Phags_Pa Phag Phoenician Phnx Psalter_Pahlavi Phlp Rejang Rjng Runic Runr Samaritan Samr Saurashtra Saur Sharada Shrd Shavian Shaw Siddham Sidd SignWriting Sgnw Sinhala Sinh Sora_Sompeng Sora Soyombo Soyo Sundanese Sund Syloti_Nagri Sylo Syriac Syrc Tagalog Tglg Tagbanwa Tagb Tai_Le Tale Tai_Tham Lana Tai_Viet Tavt Takri Takr Tamil Taml Tangut Tang Telugu Telu Thaana Thaa Thai Thai Tibetan Tibt Tifinagh Tfng Tirhuta Tirh Ugaritic Ugar Vai Vaii Warang_Citi Wara Yi Yiii Zanabazar_Square Zanb",ht=ct+" Dogra Dogr Gunjala_Gondi Gong Hanifi_Rohingya Rohg Makasar Maka Medefaidrin Medf Old_Sogdian Sogo Sogdian Sogd",pt={9:ct,10:ht,11:"Adlam Adlm Ahom Ahom Anatolian_Hieroglyphs Hluw Arabic Arab Armenian Armn Avestan Avst Balinese Bali Bamum Bamu Bassa_Vah Bass Batak Batk Bengali Beng Bhaiksuki Bhks Bopomofo Bopo Brahmi Brah Braille Brai Buginese Bugi Buhid Buhd Canadian_Aboriginal Cans Carian Cari Caucasian_Albanian Aghb Chakma Cakm Cham Cham Cherokee Cher Common Zyyy Coptic Copt Qaac Cuneiform Xsux Cypriot Cprt Cyrillic Cyrl Deseret Dsrt Devanagari Deva Duployan Dupl Egyptian_Hieroglyphs Egyp Elbasan Elba Ethiopic Ethi Georgian Geor Glagolitic Glag Gothic Goth Grantha Gran Greek Grek Gujarati Gujr Gurmukhi Guru Han Hani Hangul Hang Hanunoo Hano Hatran Hatr Hebrew Hebr Hiragana Hira Imperial_Aramaic Armi Inherited Zinh Qaai Inscriptional_Pahlavi Phli Inscriptional_Parthian Prti Javanese Java Kaithi Kthi Kannada Knda Katakana Kana Kayah_Li Kali Kharoshthi Khar Khmer Khmr Khojki Khoj Khudawadi Sind Lao Laoo Latin Latn Lepcha Lepc Limbu Limb Linear_A Lina Linear_B Linb Lisu Lisu Lycian Lyci Lydian Lydi Mahajani Mahj Malayalam Mlym Mandaic Mand Manichaean Mani Marchen Marc Masaram_Gondi Gonm Meetei_Mayek Mtei Mende_Kikakui Mend Meroitic_Cursive Merc Meroitic_Hieroglyphs Mero Miao Plrd Modi Modi Mongolian Mong Mro Mroo Multani Mult Myanmar Mymr Nabataean Nbat New_Tai_Lue Talu Newa Newa Nko Nkoo Nushu Nshu Ogham Ogam Ol_Chiki Olck Old_Hungarian Hung Old_Italic Ital Old_North_Arabian Narb Old_Permic Perm Old_Persian Xpeo Old_South_Arabian Sarb Old_Turkic Orkh Oriya Orya Osage Osge Osmanya Osma Pahawh_Hmong Hmng Palmyrene Palm Pau_Cin_Hau Pauc Phags_Pa Phag Phoenician Phnx Psalter_Pahlavi Phlp Rejang Rjng Runic Runr Samaritan Samr Saurashtra Saur Sharada Shrd Shavian Shaw Siddham Sidd SignWriting Sgnw Sinhala Sinh Sora_Sompeng Sora Soyombo Soyo Sundanese Sund Syloti_Nagri Sylo Syriac Syrc Tagalog Tglg Tagbanwa Tagb Tai_Le Tale Tai_Tham Lana Tai_Viet Tavt Takri Takr Tamil Taml Tangut Tang Telugu Telu Thaana Thaa Thai Thai Tibetan Tibt Tifinagh Tfng Tirhuta Tirh Ugaritic Ugar Vai Vaii Warang_Citi Wara Yi Yiii Zanabazar_Square Zanb Dogra Dogr Gunjala_Gondi Gong Hanifi_Rohingya Rohg Makasar Maka Medefaidrin Medf Old_Sogdian Sogo Sogdian Sogd Elymaic Elym Nandinagari Nand Nyiakeng_Puachue_Hmong Hmnp Wancho Wcho"},dt={};vt(9),vt(10),vt(11);var mt=F.prototype,gt=function(e){this.parser=e,this.validFlags="gim"+(e.options.ecmaVersion>=6?"uy":"")+(e.options.ecmaVersion>=9?"s":""),this.unicodeProperties=dt[e.options.ecmaVersion>=11?11:e.options.ecmaVersion],this.source="",this.flags="",this.start=0,this.switchU=!1,this.switchN=!1,this.pos=0,this.lastIntValue=0,this.lastStringValue="",this.lastAssertionIsQuantifiable=!1,this.numCapturingParens=0,this.maxBackReference=0,this.groupNames=[],this.backReferenceNames=[]};gt.prototype.reset=function(e,t,n){var r=-1!==n.indexOf("u");this.start=0|e,this.source=t+"",this.flags=n,this.switchU=r&&this.parser.options.ecmaVersion>=6,this.switchN=r&&this.parser.options.ecmaVersion>=9},gt.prototype.raise=function(e){this.parser.raiseRecoverable(this.start,"Invalid regular expression: /"+this.source+"/: "+e)},gt.prototype.at=function(e,t){void 0===t&&(t=!1);var n=this.source,r=n.length;if(e>=r)return-1;var i=n.charCodeAt(e);if(!t&&!this.switchU||i<=55295||i>=57344||e+1>=r)return i;var s=n.charCodeAt(e+1);return s>=56320&&s<=57343?(i<<10)+s-56613888:i},gt.prototype.nextIndex=function(e,t){void 0===t&&(t=!1);var n=this.source,r=n.length;if(e>=r)return r;var i,s=n.charCodeAt(e);return!t&&!this.switchU||s<=55295||s>=57344||e+1>=r||(i=n.charCodeAt(e+1))<56320||i>57343?e+1:e+2},gt.prototype.current=function(e){return void 0===e&&(e=!1),this.at(this.pos,e)},gt.prototype.lookahead=function(e){return void 0===e&&(e=!1),this.at(this.nextIndex(this.pos,e),e)},gt.prototype.advance=function(e){void 0===e&&(e=!1),this.pos=this.nextIndex(this.pos,e)},gt.prototype.eat=function(e,t){return void 0===t&&(t=!1),this.current(t)===e&&(this.advance(t),!0)},mt.validateRegExpFlags=function(e){for(var t=e.validFlags,n=e.flags,r=0;r<n.length;r++){var i=n.charAt(r);-1===t.indexOf(i)&&this.raise(e.start,"Invalid regular expression flag"),n.indexOf(i,r+1)>-1&&this.raise(e.start,"Duplicate regular expression flag")}},mt.validateRegExpPattern=function(e){this.regexp_pattern(e),!e.switchN&&this.options.ecmaVersion>=9&&e.groupNames.length>0&&(e.switchN=!0,this.regexp_pattern(e))},mt.regexp_pattern=function(e){e.pos=0,e.lastIntValue=0,e.lastStringValue="",e.lastAssertionIsQuantifiable=!1,e.numCapturingParens=0,e.maxBackReference=0,e.groupNames.length=0,e.backReferenceNames.length=0,this.regexp_disjunction(e),e.pos!==e.source.length&&(e.eat(41)&&e.raise("Unmatched ')'"),(e.eat(93)||e.eat(125))&&e.raise("Lone quantifier brackets")),e.maxBackReference>e.numCapturingParens&&e.raise("Invalid escape");for(var t=0,n=e.backReferenceNames;t<n.length;t+=1){var r=n[t];-1===e.groupNames.indexOf(r)&&e.raise("Invalid named capture referenced")}},mt.regexp_disjunction=function(e){for(this.regexp_alternative(e);e.eat(124);)this.regexp_alternative(e);this.regexp_eatQuantifier(e,!0)&&e.raise("Nothing to repeat"),e.eat(123)&&e.raise("Lone quantifier brackets")},mt.regexp_alternative=function(e){for(;e.pos<e.source.length&&this.regexp_eatTerm(e););},mt.regexp_eatTerm=function(e){return this.regexp_eatAssertion(e)?(e.lastAssertionIsQuantifiable&&this.regexp_eatQuantifier(e)&&e.switchU&&e.raise("Invalid quantifier"),!0):(e.switchU?!!this.regexp_eatAtom(e):!!this.regexp_eatExtendedAtom(e))&&(this.regexp_eatQuantifier(e),!0)},mt.regexp_eatAssertion=function(e){var t=e.pos;if(e.lastAssertionIsQuantifiable=!1,e.eat(94)||e.eat(36))return!0;if(e.eat(92)){if(e.eat(66)||e.eat(98))return!0;e.pos=t}if(e.eat(40)&&e.eat(63)){var n=!1;if(this.options.ecmaVersion>=9&&(n=e.eat(60)),e.eat(61)||e.eat(33))return this.regexp_disjunction(e),e.eat(41)||e.raise("Unterminated group"),e.lastAssertionIsQuantifiable=!n,!0}return e.pos=t,!1},mt.regexp_eatQuantifier=function(e,t){return void 0===t&&(t=!1),!!this.regexp_eatQuantifierPrefix(e,t)&&(e.eat(63),!0)},mt.regexp_eatQuantifierPrefix=function(e,t){return e.eat(42)||e.eat(43)||e.eat(63)||this.regexp_eatBracedQuantifier(e,t)},mt.regexp_eatBracedQuantifier=function(e,t){var n=e.pos;if(e.eat(123)){var r=0,i=-1;if(this.regexp_eatDecimalDigits(e)&&(r=e.lastIntValue,e.eat(44)&&this.regexp_eatDecimalDigits(e)&&(i=e.lastIntValue),e.eat(125)))return-1!==i&&i<r&&!t&&e.raise("numbers out of order in {} quantifier"),!0;e.switchU&&!t&&e.raise("Incomplete quantifier"),e.pos=n}return!1},mt.regexp_eatAtom=function(e){return this.regexp_eatPatternCharacters(e)||e.eat(46)||this.regexp_eatReverseSolidusAtomEscape(e)||this.regexp_eatCharacterClass(e)||this.regexp_eatUncapturingGroup(e)||this.regexp_eatCapturingGroup(e)},mt.regexp_eatReverseSolidusAtomEscape=function(e){var t=e.pos;if(e.eat(92)){if(this.regexp_eatAtomEscape(e))return!0;e.pos=t}return!1},mt.regexp_eatUncapturingGroup=function(e){var t=e.pos;if(e.eat(40)){if(e.eat(63)&&e.eat(58)){if(this.regexp_disjunction(e),e.eat(41))return!0;e.raise("Unterminated group")}e.pos=t}return!1},mt.regexp_eatCapturingGroup=function(e){if(e.eat(40)){if(this.options.ecmaVersion>=9?this.regexp_groupSpecifier(e):63===e.current()&&e.raise("Invalid group"),this.regexp_disjunction(e),e.eat(41))return e.numCapturingParens+=1,!0;e.raise("Unterminated group")}return!1},mt.regexp_eatExtendedAtom=function(e){return e.eat(46)||this.regexp_eatReverseSolidusAtomEscape(e)||this.regexp_eatCharacterClass(e)||this.regexp_eatUncapturingGroup(e)||this.regexp_eatCapturingGroup(e)||this.regexp_eatInvalidBracedQuantifier(e)||this.regexp_eatExtendedPatternCharacter(e)},mt.regexp_eatInvalidBracedQuantifier=function(e){return this.regexp_eatBracedQuantifier(e,!0)&&e.raise("Nothing to repeat"),!1},mt.regexp_eatSyntaxCharacter=function(e){var t=e.current();return!!bt(t)&&(e.lastIntValue=t,e.advance(),!0)},mt.regexp_eatPatternCharacters=function(e){for(var t=e.pos,n=0;-1!==(n=e.current())&&!bt(n);)e.advance();return e.pos!==t},mt.regexp_eatExtendedPatternCharacter=function(e){var t=e.current();return!(-1===t||36===t||t>=40&&t<=43||46===t||63===t||91===t||94===t||124===t)&&(e.advance(),!0)},mt.regexp_groupSpecifier=function(e){if(e.eat(63)){if(this.regexp_eatGroupName(e))return-1!==e.groupNames.indexOf(e.lastStringValue)&&e.raise("Duplicate capture group name"),void e.groupNames.push(e.lastStringValue);e.raise("Invalid group")}},mt.regexp_eatGroupName=function(e){if(e.lastStringValue="",e.eat(60)){if(this.regexp_eatRegExpIdentifierName(e)&&e.eat(62))return!0;e.raise("Invalid capture group name")}return!1},mt.regexp_eatRegExpIdentifierName=function(e){if(e.lastStringValue="",this.regexp_eatRegExpIdentifierStart(e)){for(e.lastStringValue+=yt(e.lastIntValue);this.regexp_eatRegExpIdentifierPart(e);)e.lastStringValue+=yt(e.lastIntValue);return!0}return!1},mt.regexp_eatRegExpIdentifierStart=function(e){var t=e.pos,n=this.options.ecmaVersion>=11,r=e.current(n);return e.advance(n),92===r&&this.regexp_eatRegExpUnicodeEscapeSequence(e,n)&&(r=e.lastIntValue),function(e){return h(e,!0)||36===e||95===e}(r)?(e.lastIntValue=r,!0):(e.pos=t,!1)},mt.regexp_eatRegExpIdentifierPart=function(e){var t=e.pos,n=this.options.ecmaVersion>=11,r=e.current(n);return e.advance(n),92===r&&this.regexp_eatRegExpUnicodeEscapeSequence(e,n)&&(r=e.lastIntValue),function(e){return p(e,!0)||36===e||95===e||8204===e||8205===e}(r)?(e.lastIntValue=r,!0):(e.pos=t,!1)},mt.regexp_eatAtomEscape=function(e){return!!(this.regexp_eatBackReference(e)||this.regexp_eatCharacterClassEscape(e)||this.regexp_eatCharacterEscape(e)||e.switchN&&this.regexp_eatKGroupName(e))||(e.switchU&&(99===e.current()&&e.raise("Invalid unicode escape"),e.raise("Invalid escape")),!1)},mt.regexp_eatBackReference=function(e){var t=e.pos;if(this.regexp_eatDecimalEscape(e)){var n=e.lastIntValue;if(e.switchU)return n>e.maxBackReference&&(e.maxBackReference=n),!0;if(n<=e.numCapturingParens)return!0;e.pos=t}return!1},mt.regexp_eatKGroupName=function(e){if(e.eat(107)){if(this.regexp_eatGroupName(e))return e.backReferenceNames.push(e.lastStringValue),!0;e.raise("Invalid named reference")}return!1},mt.regexp_eatCharacterEscape=function(e){return this.regexp_eatControlEscape(e)||this.regexp_eatCControlLetter(e)||this.regexp_eatZero(e)||this.regexp_eatHexEscapeSequence(e)||this.regexp_eatRegExpUnicodeEscapeSequence(e,!1)||!e.switchU&&this.regexp_eatLegacyOctalEscapeSequence(e)||this.regexp_eatIdentityEscape(e)},mt.regexp_eatCControlLetter=function(e){var t=e.pos;if(e.eat(99)){if(this.regexp_eatControlLetter(e))return!0;e.pos=t}return!1},mt.regexp_eatZero=function(e){return 48===e.current()&&!xt(e.lookahead())&&(e.lastIntValue=0,e.advance(),!0)},mt.regexp_eatControlEscape=function(e){var t=e.current();return 116===t?(e.lastIntValue=9,e.advance(),!0):110===t?(e.lastIntValue=10,e.advance(),!0):118===t?(e.lastIntValue=11,e.advance(),!0):102===t?(e.lastIntValue=12,e.advance(),!0):114===t&&(e.lastIntValue=13,e.advance(),!0)},mt.regexp_eatControlLetter=function(e){var t=e.current();return!!wt(t)&&(e.lastIntValue=t%32,e.advance(),!0)},mt.regexp_eatRegExpUnicodeEscapeSequence=function(e,t){void 0===t&&(t=!1);var n,r=e.pos,i=t||e.switchU;if(e.eat(117)){if(this.regexp_eatFixedHexDigits(e,4)){var s=e.lastIntValue;if(i&&s>=55296&&s<=56319){var o=e.pos;if(e.eat(92)&&e.eat(117)&&this.regexp_eatFixedHexDigits(e,4)){var u=e.lastIntValue;if(u>=56320&&u<=57343)return e.lastIntValue=1024*(s-55296)+(u-56320)+65536,!0}e.pos=o,e.lastIntValue=s}return!0}if(i&&e.eat(123)&&this.regexp_eatHexDigits(e)&&e.eat(125)&&(n=e.lastIntValue)>=0&&n<=1114111)return!0;i&&e.raise("Invalid unicode escape"),e.pos=r}return!1},mt.regexp_eatIdentityEscape=function(e){if(e.switchU)return!!this.regexp_eatSyntaxCharacter(e)||!!e.eat(47)&&(e.lastIntValue=47,!0);var t=e.current();return!(99===t||e.switchN&&107===t)&&(e.lastIntValue=t,e.advance(),!0)},mt.regexp_eatDecimalEscape=function(e){e.lastIntValue=0;var t=e.current();if(t>=49&&t<=57){do e.lastIntValue=10*e.lastIntValue+(t-48),e.advance();while((t=e.current())>=48&&t<=57);return!0}return!1},mt.regexp_eatCharacterClassEscape=function(e){var t=e.current();if(!function(e){return 100===e||68===e||115===e||83===e||119===e||87===e}(t)){if(e.switchU&&this.options.ecmaVersion>=9&&(80===t||112===t)){if(e.lastIntValue=-1,e.advance(),e.eat(123)&&this.regexp_eatUnicodePropertyValueExpression(e)&&e.eat(125))return!0;e.raise("Invalid property name")}return!1}return e.lastIntValue=-1,e.advance(),!0},mt.regexp_eatUnicodePropertyValueExpression=function(e){var t=e.pos;if(this.regexp_eatUnicodePropertyName(e)&&e.eat(61)){var n=e.lastStringValue;if(this.regexp_eatUnicodePropertyValue(e)){var r=e.lastStringValue;return this.regexp_validateUnicodePropertyNameAndValue(e,n,r),!0}}if(e.pos=t,this.regexp_eatLoneUnicodePropertyNameOrValue(e)){var i=e.lastStringValue;return this.regexp_validateUnicodePropertyNameOrValue(e,i),!0}return!1},mt.regexp_validateUnicodePropertyNameAndValue=function(e,t,n){A(e.unicodeProperties.nonBinary,t)||e.raise("Invalid property name"),e.unicodeProperties.nonBinary[t].test(n)||e.raise("Invalid property value")},mt.regexp_validateUnicodePropertyNameOrValue=function(e,t){e.unicodeProperties.binary.test(t)||e.raise("Invalid property name")},mt.regexp_eatUnicodePropertyName=function(e){var t=0;for(e.lastStringValue="";Et(t=e.current());)e.lastStringValue+=yt(t),e.advance();return""!==e.lastStringValue},mt.regexp_eatUnicodePropertyValue=function(e){var t=0;for(e.lastStringValue="";St(t=e.current());)e.lastStringValue+=yt(t),e.advance();return""!==e.lastStringValue},mt.regexp_eatLoneUnicodePropertyNameOrValue=function(e){return this.regexp_eatUnicodePropertyValue(e)},mt.regexp_eatCharacterClass=function(e){if(e.eat(91)){if(e.eat(94),this.regexp_classRanges(e),e.eat(93))return!0;e.raise("Unterminated character class")}return!1},mt.regexp_classRanges=function(e){for(;this.regexp_eatClassAtom(e);){var t=e.lastIntValue;if(e.eat(45)&&this.regexp_eatClassAtom(e)){var n=e.lastIntValue;!e.switchU||-1!==t&&-1!==n||e.raise("Invalid character class"),-1!==t&&-1!==n&&t>n&&e.raise("Range out of order in character class")}}},mt.regexp_eatClassAtom=function(e){var t=e.pos;if(e.eat(92)){if(this.regexp_eatClassEscape(e))return!0;if(e.switchU){var n=e.current();(99===n||Ct(n))&&e.raise("Invalid class escape"),e.raise("Invalid escape")}e.pos=t}var r=e.current();return 93!==r&&(e.lastIntValue=r,e.advance(),!0)},mt.regexp_eatClassEscape=function(e){var t=e.pos;if(e.eat(98))return e.lastIntValue=8,!0;if(e.switchU&&e.eat(45))return e.lastIntValue=45,!0;if(!e.switchU&&e.eat(99)){if(this.regexp_eatClassControlLetter(e))return!0;e.pos=t}return this.regexp_eatCharacterClassEscape(e)||this.regexp_eatCharacterEscape(e)},mt.regexp_eatClassControlLetter=function(e){var t=e.current();return(!!xt(t)||95===t)&&(e.lastIntValue=t%32,e.advance(),!0)},mt.regexp_eatHexEscapeSequence=function(e){var t=e.pos;if(e.eat(120)){if(this.regexp_eatFixedHexDigits(e,2))return!0;e.switchU&&e.raise("Invalid escape"),e.pos=t}return!1},mt.regexp_eatDecimalDigits=function(e){var t=e.pos,n=0;for(e.lastIntValue=0;xt(n=e.current());)e.lastIntValue=10*e.lastIntValue+(n-48),e.advance();return e.pos!==t},mt.regexp_eatHexDigits=function(e){var t=e.pos,n=0;for(e.lastIntValue=0;Tt(n=e.current());)e.lastIntValue=16*e.lastIntValue+Nt(n),e.advance();return e.pos!==t},mt.regexp_eatLegacyOctalEscapeSequence=function(e){if(this.regexp_eatOctalDigit(e)){var t=e.lastIntValue;if(this.regexp_eatOctalDigit(e)){var n=e.lastIntValue;t<=3&&this.regexp_eatOctalDigit(e)?e.lastIntValue=64*t+8*n+e.lastIntValue:e.lastIntValue=8*t+n}else e.lastIntValue=t;return!0}return!1},mt.regexp_eatOctalDigit=function(e){var t=e.current();return Ct(t)?(e.lastIntValue=t-48,e.advance(),!0):(e.lastIntValue=0,!1)},mt.regexp_eatFixedHexDigits=function(e,t){var n=e.pos;e.lastIntValue=0;for(var r=0;r<t;++r){var i=e.current();if(!Tt(i))return e.pos=n,!1;e.lastIntValue=16*e.lastIntValue+Nt(i),e.advance()}return!0};var kt=function(e){this.type=e.type,this.value=e.value,this.start=e.start,this.end=e.end,e.options.locations&&(this.loc=new D(e,e.startLoc,e.endLoc)),e.options.ranges&&(this.range=[e.start,e.end])},Lt=F.prototype;Lt.next=function(e){!e&&this.type.keyword&&this.containsEsc&&this.raiseRecoverable(this.start,"Escape sequence in keyword "+this.type.keyword),this.options.onToken&&this.options.onToken(new kt(this)),this.lastTokEnd=this.end,this.lastTokStart=this.start,this.lastTokEndLoc=this.endLoc,this.lastTokStartLoc=this.startLoc,this.nextToken()},Lt.getToken=function(){return this.next(),new kt(this)},"undefined"!=typeof Symbol&&(Lt[Symbol.iterator]=function(){var e=this;return{next:function(){var t=e.getToken();return{done:t.type===w.eof,value:t}}}}),Lt.curContext=function(){return this.context[this.context.length-1]},Lt.nextToken=function(){var e=this.curContext();return e&&e.preserveSpace||this.skipSpace(),this.start=this.pos,this.options.locations&&(this.startLoc=this.curPosition()),this.pos>=this.input.length?this.finishToken(w.eof):e.override?e.override(this):void this.readToken(this.fullCharCodeAtPos())},Lt.readToken=function(e){return h(e,this.options.ecmaVersion>=6)||92===e?this.readWord():this.getTokenFromCode(e)},Lt.fullCharCodeAtPos=function(){var e=this.input.charCodeAt(this.pos);return e<=55295||e>=57344?e:(e<<10)+this.input.charCodeAt(this.pos+1)-56613888},Lt.skipBlockComment=function(){var e,t=this.options.onComment&&this.curPosition(),n=this.pos,r=this.input.indexOf("*/",this.pos+=2);if(-1===r&&this.raise(this.pos-2,"Unterminated comment"),this.pos=r+2,this.options.locations)for(S.lastIndex=n;(e=S.exec(this.input))&&e.index<this.pos;)++this.curLine,this.lineStart=e.index+e[0].length;this.options.onComment&&this.options.onComment(!0,this.input.slice(n+2,r),n,this.pos,t,this.curPosition())},Lt.skipLineComment=function(e){for(var t=this.pos,n=this.options.onComment&&this.curPosition(),r=this.input.charCodeAt(this.pos+=e);this.pos<this.input.length&&!x(r);)r=this.input.charCodeAt(++this.pos);this.options.onComment&&this.options.onComment(!1,this.input.slice(t+e,this.pos),t,this.pos,n,this.curPosition())},Lt.skipSpace=function(){e:for(;this.pos<this.input.length;){var e=this.input.charCodeAt(this.pos);switch(e){case 32:case 160:++this.pos;break;case 13:10===this.input.charCodeAt(this.pos+1)&&++this.pos;case 10:case 8232:case 8233:++this.pos,this.options.locations&&(++this.curLine,this.lineStart=this.pos);break;case 47:switch(this.input.charCodeAt(this.pos+1)){case 42:this.skipBlockComment();break;case 47:this.skipLineComment(2);break;default:break e}break;default:if(!(e>8&&e<14||e>=5760&&T.test(String.fromCharCode(e))))break e;++this.pos}}},Lt.finishToken=function(e,t){this.end=this.pos,this.options.locations&&(this.endLoc=this.curPosition());var n=this.type;this.type=e,this.value=t,this.updateContext(n)},Lt.readToken_dot=function(){var e=this.input.charCodeAt(this.pos+1);if(e>=48&&e<=57)return this.readNumber(!0);var t=this.input.charCodeAt(this.pos+2);return this.options.ecmaVersion>=6&&46===e&&46===t?(this.pos+=3,this.finishToken(w.ellipsis)):(++this.pos,this.finishToken(w.dot))},Lt.readToken_slash=function(){var e=this.input.charCodeAt(this.pos+1);return this.exprAllowed?(++this.pos,this.readRegexp()):61===e?this.finishOp(w.assign,2):this.finishOp(w.slash,1)},Lt.readToken_mult_modulo_exp=function(e){var t=this.input.charCodeAt(this.pos+1),n=1,r=42===e?w.star:w.modulo;return this.options.ecmaVersion>=7&&42===e&&42===t&&(++n,r=w.starstar,t=this.input.charCodeAt(this.pos+2)),61===t?this.finishOp(w.assign,n+1):this.finishOp(r,n)},Lt.readToken_pipe_amp=function(e){var t=this.input.charCodeAt(this.pos+1);if(t===e)return this.options.ecmaVersion>=12&&61===this.input.charCodeAt(this.pos+2)?this.finishOp(w.assign,3):this.finishOp(124===e?w.logicalOR:w.logicalAND,2);return 61===t?this.finishOp(w.assign,2):this.finishOp(124===e?w.bitwiseOR:w.bitwiseAND,1)},Lt.readToken_caret=function(){return 61===this.input.charCodeAt(this.pos+1)?this.finishOp(w.assign,2):this.finishOp(w.bitwiseXOR,1)},Lt.readToken_plus_min=function(e){var t=this.input.charCodeAt(this.pos+1);return t===e?45!==t||this.inModule||62!==this.input.charCodeAt(this.pos+2)||0!==this.lastTokEnd&&!E.test(this.input.slice(this.lastTokEnd,this.pos))?this.finishOp(w.incDec,2):(this.skipLineComment(3),this.skipSpace(),this.nextToken()):61===t?this.finishOp(w.assign,2):this.finishOp(w.plusMin,1)},Lt.readToken_lt_gt=function(e){var t=this.input.charCodeAt(this.pos+1),n=1;return t===e?(n=62===e&&62===this.input.charCodeAt(this.pos+2)?3:2,61===this.input.charCodeAt(this.pos+n)?this.finishOp(w.assign,n+1):this.finishOp(w.bitShift,n)):33!==t||60!==e||this.inModule||45!==this.input.charCodeAt(this.pos+2)||45!==this.input.charCodeAt(this.pos+3)?(61===t&&(n=2),this.finishOp(w.relational,n)):(this.skipLineComment(4),this.skipSpace(),this.nextToken())},Lt.readToken_eq_excl=function(e){var t=this.input.charCodeAt(this.pos+1);return 61===t?this.finishOp(w.equality,61===this.input.charCodeAt(this.pos+2)?3:2):61===e&&62===t&&this.options.ecmaVersion>=6?(this.pos+=2,this.finishToken(w.arrow)):this.finishOp(61===e?w.eq:w.prefix,1)},Lt.readToken_question=function(){var e=this.options.ecmaVersion;if(e>=11){var t=this.input.charCodeAt(this.pos+1);if(46===t){var n=this.input.charCodeAt(this.pos+2);if(n<48||n>57)return this.finishOp(w.questionDot,2)}if(63===t)return e>=12&&61===this.input.charCodeAt(this.pos+2)?this.finishOp(w.assign,3):this.finishOp(w.coalesce,2)}return this.finishOp(w.question,1)},Lt.getTokenFromCode=function(e){switch(e){case 46:return this.readToken_dot();case 40:return++this.pos,this.finishToken(w.parenL);case 41:return++this.pos,this.finishToken(w.parenR);case 59:return++this.pos,this.finishToken(w.semi);case 44:return++this.pos,this.finishToken(w.comma);case 91:return++this.pos,this.finishToken(w.bracketL);case 93:return++this.pos,this.finishToken(w.bracketR);case 123:return++this.pos,this.finishToken(w.braceL);case 125:return++this.pos,this.finishToken(w.braceR);case 58:return++this.pos,this.finishToken(w.colon);case 96:if(this.options.ecmaVersion<6)break;return++this.pos,this.finishToken(w.backQuote);case 48:var t=this.input.charCodeAt(this.pos+1);if(120===t||88===t)return this.readRadixNumber(16);if(this.options.ecmaVersion>=6){if(111===t||79===t)return this.readRadixNumber(8);if(98===t||66===t)return this.readRadixNumber(2)};case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.readNumber(!1);case 34:case 39:return this.readString(e);case 47:return this.readToken_slash();case 37:case 42:return this.readToken_mult_modulo_exp(e);case 124:case 38:return this.readToken_pipe_amp(e);case 94:return this.readToken_caret();case 43:case 45:return this.readToken_plus_min(e);case 60:case 62:return this.readToken_lt_gt(e);case 61:case 33:return this.readToken_eq_excl(e);case 63:return this.readToken_question();case 126:return this.finishOp(w.prefix,1)}this.raise(this.pos,"Unexpected character '"+Ot(e)+"'")},Lt.finishOp=function(e,t){var n=this.input.slice(this.pos,this.pos+t);return this.pos+=t,this.finishToken(e,n)},Lt.readRegexp=function(){for(var e,t,n=this.pos;;){this.pos>=this.input.length&&this.raise(n,"Unterminated regular expression");var r=this.input.charAt(this.pos);if(E.test(r)&&this.raise(n,"Unterminated regular expression"),e)e=!1;else{if("["===r)t=!0;else if("]"===r&&t)t=!1;else if("/"===r&&!t)break;e="\\"===r}++this.pos}var i=this.input.slice(n,this.pos);++this.pos;var s=this.pos,o=this.readWord1();this.containsEsc&&this.unexpected(s);var u=this.regexpState||(this.regexpState=new gt(this));u.reset(n,i,o),this.validateRegExpFlags(u),this.validateRegExpPattern(u);var a=null;try{a=new RegExp(i,o)}catch(e){}return this.finishToken(w.regexp,{pattern:i,flags:o,value:a})},Lt.readInt=function(e,t,n){for(var r=this.options.ecmaVersion>=12&&void 0===t,i=n&&48===this.input.charCodeAt(this.pos),s=this.pos,o=0,u=0,a=0,f=null==t?1/0:t;a<f;++a,++this.pos){var l=this.input.charCodeAt(this.pos),c=void 0;if(r&&95===l)i&&this.raiseRecoverable(this.pos,"Numeric separator is not allowed in legacy octal numeric literals"),95===u&&this.raiseRecoverable(this.pos,"Numeric separator must be exactly one underscore"),0===a&&this.raiseRecoverable(this.pos,"Numeric separator is not allowed at the first of digits"),u=l;else{if((c=l>=97?l-97+10:l>=65?l-65+10:l>=48&&l<=57?l-48:1/0)>=e)break;u=l,o=o*e+c}}return r&&95===u&&this.raiseRecoverable(this.pos-1,"Numeric separator is not allowed at the last of digits"),this.pos===s||null!=t&&this.pos-s!==t?null:o},Lt.readRadixNumber=function(e){var t=this.pos;this.pos+=2;var n=this.readInt(e);return null==n&&this.raise(this.start+2,"Expected number in radix "+e),this.options.ecmaVersion>=11&&110===this.input.charCodeAt(this.pos)?(n=At(this.input.slice(t,this.pos)),++this.pos):h(this.fullCharCodeAtPos())&&this.raise(this.pos,"Identifier directly after number"),this.finishToken(w.num,n)},Lt.readNumber=function(e){var t=this.pos;e||null!==this.readInt(10,void 0,!0)||this.raise(t,"Invalid number");var n=this.pos-t>=2&&48===this.input.charCodeAt(t);n&&this.strict&&this.raise(t,"Invalid number");var r=this.input.charCodeAt(this.pos);if(!n&&!e&&this.options.ecmaVersion>=11&&110===r){var i=At(this.input.slice(t,this.pos));return++this.pos,h(this.fullCharCodeAtPos())&&this.raise(this.pos,"Identifier directly after number"),this.finishToken(w.num,i)}n&&/[89]/.test(this.input.slice(t,this.pos))&&(n=!1),46!==r||n||(++this.pos,this.readInt(10),r=this.input.charCodeAt(this.pos)),69!==r&&101!==r||n||(43!==(r=this.input.charCodeAt(++this.pos))&&45!==r||++this.pos,null===this.readInt(10)&&this.raise(t,"Invalid number")),h(this.fullCharCodeAtPos())&&this.raise(this.pos,"Identifier directly after number");var s,o=(s=this.input.slice(t,this.pos),n?parseInt(s,8):parseFloat(s.replace(/_/g,"")));return this.finishToken(w.num,o)},Lt.readCodePoint=function(){var e;if(123===this.input.charCodeAt(this.pos)){this.options.ecmaVersion<6&&this.unexpected();var t=++this.pos;e=this.readHexChar(this.input.indexOf("}",this.pos)-this.pos),++this.pos,e>1114111&&this.invalidStringToken(t,"Code point out of bounds")}else e=this.readHexChar(4);return e},Lt.readString=function(e){for(var t="",n=++this.pos;;){this.pos>=this.input.length&&this.raise(this.start,"Unterminated string constant");var r=this.input.charCodeAt(this.pos);if(r===e)break;92===r?(t+=this.input.slice(n,this.pos),t+=this.readEscapedChar(!1),n=this.pos):(x(r,this.options.ecmaVersion>=10)&&this.raise(this.start,"Unterminated string constant"),++this.pos)}return t+=this.input.slice(n,this.pos++),this.finishToken(w.string,t)};var Mt={};Lt.tryReadTemplateToken=function(){this.inTemplateElement=!0;try{this.readTmplToken()}catch(e){if(e!==Mt)throw e;this.readInvalidTemplateToken()}this.inTemplateElement=!1},Lt.invalidStringToken=function(e,t){if(this.inTemplateElement&&this.options.ecmaVersion>=9)throw Mt;this.raise(e,t)},Lt.readTmplToken=function(){for(var e="",t=this.pos;;){this.pos>=this.input.length&&this.raise(this.start,"Unterminated template");var n=this.input.charCodeAt(this.pos);if(96===n||36===n&&123===this.input.charCodeAt(this.pos+1))return this.pos!==this.start||this.type!==w.template&&this.type!==w.invalidTemplate?(e+=this.input.slice(t,this.pos),this.finishToken(w.template,e)):36===n?(this.pos+=2,this.finishToken(w.dollarBraceL)):(++this.pos,this.finishToken(w.backQuote));if(92===n)e+=this.input.slice(t,this.pos),e+=this.readEscapedChar(!0),t=this.pos;else if(x(n)){switch(e+=this.input.slice(t,this.pos),++this.pos,n){case 13:10===this.input.charCodeAt(this.pos)&&++this.pos;case 10:e+="\n";break;default:e+=String.fromCharCode(n)}this.options.locations&&(++this.curLine,this.lineStart=this.pos),t=this.pos}else++this.pos}},Lt.readInvalidTemplateToken=function(){for(;this.pos<this.input.length;this.pos++)switch(this.input[this.pos]){case"\\":++this.pos;break;case"$":if("{"!==this.input[this.pos+1])break;case"`":return this.finishToken(w.invalidTemplate,this.input.slice(this.start,this.pos))}this.raise(this.start,"Unterminated template")},Lt.readEscapedChar=function(e){var t=this.input.charCodeAt(++this.pos);switch(++this.pos,t){case 110:return"\n";case 114:return"\r";case 120:return String.fromCharCode(this.readHexChar(2));case 117:return Ot(this.readCodePoint());case 116:return"	";case 98:return"\b";case 118:return"";case 102:return"\f";case 13:10===this.input.charCodeAt(this.pos)&&++this.pos;case 10:return this.options.locations&&(this.lineStart=this.pos,++this.curLine),"";case 56:case 57:if(e){var n=this.pos-1;return this.invalidStringToken(n,"Invalid escape sequence in template string"),null};default:if(t>=48&&t<=55){var r=this.input.substr(this.pos-1,3).match(/^[0-7]+/)[0],i=parseInt(r,8);return i>255&&(r=r.slice(0,-1),i=parseInt(r,8)),this.pos+=r.length-1,t=this.input.charCodeAt(this.pos),"0"===r&&56!==t&&57!==t||!this.strict&&!e||this.invalidStringToken(this.pos-1-r.length,e?"Octal literal in template string":"Octal literal in strict mode"),String.fromCharCode(i)}return x(t)?"":String.fromCharCode(t)}},Lt.readHexChar=function(e){var t=this.pos,n=this.readInt(16,e);return null===n&&this.invalidStringToken(t,"Bad character escape sequence"),n},Lt.readWord1=function(){this.containsEsc=!1;for(var e="",t=!0,n=this.pos,r=this.options.ecmaVersion>=6;this.pos<this.input.length;){var i=this.fullCharCodeAtPos();if(p(i,r))this.pos+=i<=65535?1:2;else{if(92!==i)break;this.containsEsc=!0,e+=this.input.slice(n,this.pos);var s=this.pos;117!==this.input.charCodeAt(++this.pos)&&this.invalidStringToken(this.pos,"Expecting Unicode escape sequence \\uXXXX"),++this.pos;var o=this.readCodePoint();(t?h:p)(o,r)||this.invalidStringToken(s,"Invalid Unicode escape"),e+=Ot(o),n=this.pos}t=!1}return e+this.input.slice(n,this.pos)},Lt.readWord=function(){var e=this.readWord1(),t=w.name;return this.keywords.test(e)&&(t=y[e]),this.finishToken(t,e)};var _t="7.4.1";F.acorn={Parser:F,version:_t,defaultOptions:H,Position:_,SourceLocation:D,getLineInfo:P,Node:tt,TokenType:d,tokTypes:w,keywordTypes:y,TokContext:it,tokContexts:st,isIdentifierChar:p,isIdentifierStart:h,Token:kt,isNewLine:x,lineBreak:E,lineBreakG:S,nonASCIIwhitespace:T},e.Node=tt,e.Parser=F,e.Position=_,e.SourceLocation=D,e.TokContext=it,e.Token=kt,e.TokenType=d,e.defaultOptions=H,e.getLineInfo=P,e.isIdentifierChar=p,e.isIdentifierStart=h,e.isNewLine=x,e.keywordTypes=y,e.lineBreak=E,e.lineBreakG=S,e.nonASCIIwhitespace=T,e.parse=function(e,t){return F.parse(e,t)},e.parseExpressionAt=function(e,t,n){return F.parseExpressionAt(e,t,n)},e.tokContexts=st,e.tokTypes=w,e.tokenizer=function(e,t){return F.tokenizer(e,t)},e.version=_t,Object.defineProperty(e,"__esModule",{value:!0})}),define("scriptclass",["lib/acorn.min"],function(e){var t=Class.extend({init:function(e,t){this.game=e,this.name=t,this.loadTimeNr=0},addScriptFunctions:function(e){if(!window.evaljs)return;if(!this.compileScript())return!1;var t=this,n=new evaljs.Environment(this.game.scriptmanager,function(n){window.console&&console.log(n+" at class "+t.name+t.game.scriptmanager.getNPCLogName(e))});return n.setGlobalAndThis(e.scriptenv.scriptGlobal,e.getScriptObject()),n.genAndTransferFunctions(this.scriptCompiled,this.name),!0},compileScript:function(){if(this.scriptCompiled)return!0;if(!this.script||this.script.length<=0||this.script=="{}")return!1;try{this.scriptCompiled=e.parse(this.script,{locations:!0,ecmaVersion:2021});if(!this.scriptCompiled)return!1}catch(t){return window.console&&console.log("Class script compilation failed for "+this.name+": "+t.toString()),!1}return!0},setScript:function(e){this.loadTimeNr=this.game.scriptmanager.lastScriptUpdateNr,this.script=e,this.scriptCompiled=null},isCatchingEvent:function(e){return this.script&&this.script.length>0&&this.script!="{}"&&this.script.toLowerCase().indexOf("on"+e)>=0}});return t}),define("scriptmanager",["scriptclass","newnpc","lib/acorn.min"],function(e,t,n){var r=Class.extend({init:function(e){this.game=e,this.scriptclasses={},this.requestedScriptClasses={},this.lastScriptUpdateNr=1,this.menuButtonNPCs={},this.eventMap={created:"created",updated:"updated",enters:"playerenters",touch:"playertouchsme",say:"playersays",grab:"playergrabs",sword:"playerattacks",hammer:"playerhammers",trashpick:"playerpicks",mouse:"mousedown",timeout:"timeout"}},onScriptChanged:function(e){e.scriptenv={},this.runScript(e,this.game.player,"updated")},onConnected:function(){},runScript:function(e,t,n,r){if(!window.evaljs){this.game.client&&!this.reportednoscript&&(window.console&&console.log("Can't run scripts"),this.game.client.sendLog("noscript","evaljs not found"),this.reportednoscript=!0);return}var i=n in this.eventMap?this.eventMap[n]:n;if(!this.isCatchingEvent(e,i))return;if(!this.compileScript(e))return;var s;try{this.updateScriptEnvironment(e,t,n);var o=this.prepareScriptEnvironment(e);if(o){var u=this.getFunctionFromScriptEnvironment(o,i);u?(r||(r=[]),t&&t!=e&&e.scriptenv.scriptGlobal.player&&r.splice(0,0,e.scriptenv.scriptGlobal.player),s=this.runEvalJSIter(u.apply(e.getScriptObject(),r))):e.scriptenv.scriptProgram&&(s=this.runEvalJSIter(e.scriptenv.scriptProgram()))}e&&(t&&e==t.weaponnpc&&n=="equip"?e.isEquipped=!0:e==this.game.player&&(e.isScriptLogin=!0))}catch(a){window.console&&console.log("Script error:",a)}return s},isCatchingEvent:function(e,t){if(!e.scriptenv.catchedevents||this.lastScriptUpdateNr>e.scriptenv.catchedEventsUpdateNr)e.scriptenv.catchedevents={},e.scriptenv.catchedEventsUpdateNr=this.lastScriptUpdateNr;if(t in e.scriptenv.catchedevents)return e.scriptenv.catchedevents[t];var n=!1,r=e.clientscript;if(r&&r.length>0&&r!="{}"&&r.toLowerCase().indexOf(t)>=0)n=!0;else if(e.scriptenv.updateTimeNr){for(var i in e.scriptenv.joinedClasses)if(e.scriptenv.joinedClasses[i].isCatchingEvent(t)){n=!0;break}}else if(e.scriptclasses)for(var i in e.scriptclasses){var s=this.loadScriptClass(e.scriptclasses[i]);if(s&&s.isCatchingEvent(t)){n=!0;break}}return e.scriptenv.catchedevents[t]=n,n},compileScript:function(e){if(e.scriptenv.scriptCompiled)return!0;var t=e.clientscript;if(!t||t.length<=0||t=="{}")return!0;try{e.scriptenv.scriptCompiled=n.parse(t,{locations:!0,ecmaVersion:2021});if(!e.scriptenv.scriptCompiled)return!1}catch(r){return window.console&&console.log("Script compilation failed: "+r.toString()+" at "+this.getNPCLogName(e)),!1}return!0},getFunctionFromScriptEnvironment:function(e,t){var n="on"+t.toLowerCase(),r=e._curVarStore.vars[n];if(r)return r;for(var i in e._curVarStore.vars)if(i.toLowerCase()==n)return e._curVarStore.vars[i];return null},runEvalJSIter:function(e){var t=5e3;if(!e||typeof e.next!="function"){window.console&&console.log("Invalid iterator provided");return}delete this.nextSleep;var n=e.next();for(var r=0;!n.done;r++){if(this.nextSleep){this.sleepScript(e,this.nextSleep.npc,this.nextSleep.delay),delete this.nextSleep;return}try{n=e.next()}catch(i){window.console&&console.log("Script runtime error: "+i.message);return}if(!n.done&&r>=t){window.console&&console.log("Script exceeded maximum operations ("+t+")");return}}return n.value},sleepScript:function(e,t,n){if(!t||!e)return;t.scheduleTimeout("sleep",n,!1,{iter:e})},wakeUpFromSleep:function(e,t){if(!t||!e)return;this.runEvalJSIter(e)},prepareScriptEnvironment:function(e){this.getNPCScriptGlobal(e);var t=e.scriptenv.scriptEnvironment;if(t){for(var n in e.scriptenv.joinedClasses){var r=e.scriptenv.joinedClasses[n];r.loadTimeNr>e.scriptenv.updateTimeNr&&(r.addScriptFunctions(e)||t.removeClassFunctions(r.name))}e.scriptenv.updateTimeNr=this.lastScriptUpdateNr}else{var i=this;try{t=e.scriptenv.scriptEnvironment=new evaljs.Environment(this,function(t){window.console&&console.log(t+" at script"+i.getNPCLogName(e))}),t.setGlobalAndThis(e.scriptenv.scriptGlobal,e.getScriptObject()),e.scriptenv.scriptCompiled&&(e.scriptenv.scriptProgram=t.gen(e.scriptenv.scriptCompiled)),e.scriptenv.updateTimeNr=this.lastScriptUpdateNr;if(e.scriptclasses&&e.scriptclasses.length>0)for(var n in e.scriptclasses)this.joinScriptClass(e,e.scriptclasses[n])}catch(s){window.console&&console.log("Script error: "+s.toString()+" at "+this.getNPCLogName(e)),e.scriptenv.updateTimeNr=this.lastScriptUpdateNr}}return t},getNPCLogName:function(e){if(e==this.game.player)return" of player "+e.userid+" ("+e.name+")";var t=e.name?" ("+e.name+")":e.scriptclasses&&e.scriptclasses.length>=1?" ("+e.scriptclasses[0]+")":e.image?" ("+e.image+")":e.getAnimation()?" ("+e.getAnimation(!0)+")":"";return(e.id!=-1||t.length<=0?" of npc "+e.id:"")+t},updateScriptEnvironment:function(e,t,n){var r=this.getNPCScriptGlobal(e);r.player=t?t.getScriptObject():this.game.player?this.game.player.getScriptObject():null;for(var i in this.eventMap)r[this.eventMap[i]]=i==n},getNPCScriptGlobal:function(e){if(!e.scriptenv.scriptGlobal){var t=this;e.scriptenv.scriptGlobal={Server:this.getServerScriptObject(),Array:Array,Date:Date,JSON:JSON,Math:Math,Number:Number,Object:Object,String:String,GUI:this.getGUIScriptObject(),window:this.getWindowScriptObject(),echo:function(){window.console&&console.log.apply(null,arguments)},alert:function(e,n){t.game.menu.showAlert(e,n)},translate:function(e,t){return translate(e,t)}};var n=e.getScriptObject();for(var r in n){var i=n[r];typeof i=="function"&&(e.scriptenv.scriptGlobal[r]=i)}}return e.scriptenv.scriptGlobal},joinScriptClass:function(e,t){if(!e||!e.scriptenv||!e.scriptenv.scriptEnvironment)return;if(!t||t.length<=0)return;var n=this.loadScriptClass(t);n.addScriptFunctions(e),this.rememberJoinedClass(e,n)},loadScriptClass:function(t){var n=this.scriptclasses[t];return n?n:(n=new e(this.game,t),this.scriptclasses[t]=n,this.requestScriptClasses([t]),n)},requestScriptClasses:function(e){if(!this.game.client)return;var t=[];for(var n in e){var r=e[n];this.requestedScriptClasses[r]||(this.requestedScriptClasses[r]=!0,t.push(r))}t.length>0&&this.game.client.sendGetClientClasses(t)},rememberJoinedClass:function(e,t){if(!e||!e.scriptenv)return;e.scriptenv.joinedClasses||(e.scriptenv.joinedClasses=[]),e.scriptenv.joinedClasses.indexOf(t)<0&&e.scriptenv.joinedClasses.push(t),e.scriptenv.catchedevents=null},setClientClass:function(e,t){this.requestedScriptClasses[e]=!0,this.lastScriptUpdateNr++,this.loadScriptClass(e).setScript(t);var n=this.game.player;n&&n.scriptclasses&&n.scriptclasses.indexOf(e)>=0&&(n.isScriptLogin||this.runScript(n,n,"login"),this.runScript(n,n,"updated"));if(n&&n.weaponnpc){var r=n.weaponnpc.scriptclasses;r&&r.indexOf(e)>=0&&(n.weaponnpc.isEquipped||this.runScript(n.weaponnpc,n,"equip"),this.runScript(n.weaponnpc,n,"updated"))}for(var i in this.menuButtonNPCs){var s=this.menuButtonNPCs[i],r=s.scriptclasses;r&&r.indexOf(e)>=0&&this.runScript(s,n,"updated")}},getServerScriptObject:function(){if(!this.serverScriptObject){var e=this;this.serverScriptObject={searchnpcs:function(t){return e.searchNPCs(t)},getconfig:function(){return e.game.app.config}}}return this.serverScriptObject},searchNPCs:function(e){var n=[];if(!e)return this.makeArray(n),n;if(e.area&&"x"in e.area){var r=this;this.game.forEachEntity(function(r){r instanceof t&&r.gridX<e.area.x+e.area.w&&r.gridY<e.area.y+e.area.h&&r.gridX+r.tileWidth>e.area.x&&r.gridY+r.tileHeight>e.area.y&&n.push(r.getScriptObject())})}return this.makeArray(n),n},makeArray:function(e){e.length=e.length;var t=["forEach","every","filter","find","map","some"];for(var n in t)this.makeArrayCallback(e,t[n]);var r=this;e.sort=function(t){return!t||typeof t!="function"?Array.prototype.sort.call(e):Array.prototype.sort.call(e,function(e,n){return r.runEvalJSIter(t(e,n))})}},makeArrayCallback:function(e,t){var n=this;e[t]=function(r){if(!r||typeof r!="function")return;var i=Array.prototype[t].call(e,function(e,t,i){return n.runEvalJSIter(r(e,t,i))});return i&&i instanceof Array&&n.makeArray(i),i}},makeSubArray:function(e){if(!e||!(e instanceof Array||typeof e=="object"))return;for(var t in e)e[t]instanceof Array&&this.makeArray(e[t]),this.makeSubArray(e[t])},getGUIScriptObject:function(){if(!this.guiScriptObject){var e=this;this.guiScriptObject={showpopup:function(t){t||(t={title:e.game.app.config.gamename});var n=e.game.menu.showPopUp({title:t.title,width:t.width,height:t.height,noborders:t.noborders,overlap:t.overlap,showbadge:t.showbadge,popupType:"scriptgui"});return(t.head||t.hat||t.mask)&&e.game.menu.addWindowIcon(n,t),t.backbutton&&e.game.menu.addBackButton(n,"Go back",function(t){e.closePopUpNow()}),n},showwindow:function(t){return t||(t={title:e.game.app.config.gamename}),e.game.filemanager.showResizableWindow(t)},showmenu:function(t,n){t=="map"?e.game.menu.showMapAndLoad():e.game.menu.showMenuByName(t,!0,n)},get currentmenu(){return e.game.menu.getCurrentMenu()},hidepopup:function(){e.game.menu.closePopUpNow()},create:function(t,n,r,i){return e.createGui(null,t,n,r,i)},destroy:function(e){gui.remove(e)},get:function(e){return gui.getDom(e)},isvisible:function(e){return gui.isVisible(e)},find:function(t,n){var r;try{r=gui.find(t,n)}catch(i){}return r&&e.makeArray(r),r},exists:function(e){return gui.exists(e)},show:function(e){return gui.show(e)},hide:function(e){return gui.hide(e)},width:function(e){return gui.getWidth(e)},height:function(e){return gui.getHeight(e)},onclick:function(t,n){gui.setClick(t,e.scriptizeCallback(n))},onrightclick:function(t,n){gui.setRightClick(t,e.scriptizeCallback(n))},onkeydown:function(t,n){var r=gui.getDom(t);n=e.scriptizeCallback(n),r&&n&&(r.onkeydown=function(e){n(e,e.which,e.key,e.code)})},onchange:function(t,n){var r=gui.getDom(t);n=e.scriptizeCallback(n),r&&n&&(r.onchange=function(e){n(e,e.target.value)})},oninput:function(t,n){var r=gui.getDom(t);n=e.scriptizeCallback(n),r&&n&&(r.oninput=function(e){n(e,e.target.value)})},onback:function(t){if(!t||typeof t!="function"){var n=gui.find("newpopup",".backbutton");n&&n.length>0&&gui.remove(n[0])}else gui.setChildClick("newpopup",".backbutton",e.scriptizeCallback(t))},get ismobile(){return e.game.renderer.isMobile},setpopuptitle:function(e){gui.setChildHTML("newpopup","div.titletext",e)},addbuttons:function(t,n){if(!n||!(n instanceof Array))return;var r=gui.getDom(t);if(!r)return;for(var i=0;i<n.length;i++){var s=n[i];s&&s.callback&&typeof s.callback=="function"&&(s.callback=e.scriptizeCallback(s.callback))}e.game.menu.addMenuItemsToDialog(r,n)},addmenubuttons:function(t,n,r){var i=gui.getDom(t);if(!i)return;var s=[];e.game.menu.addMenuButtons(s,n,r),e.game.menu.addMenuItemsToDialog(i,s)},get screeneffect(){return e.game.renderer.context?e.game.renderer.context.screenEffect:null},set screeneffect(t){e.game.renderer.context&&e.game.renderer.context.setScreenEffect(t)},get filespath(){return e.game.filespath},getimageforitem:function(t){return typeof t=="object"&&("armor"in t&&t.armor.indexOf(".")<0&&(t.armor=e.game.animationmanager.expandGameFilename("body",t.armor)),"head"in t&&t.head.indexOf(".")<0&&(t.head=e.game.animationmanager.expandGameFilename("head",t.head)),"hat"in t&&t.hat.indexOf(".")<0&&(t.hat=e.game.animationmanager.expandGameFilename("hat",t.hat)),"mask"in t&&t.mask.indexOf(".")<0&&(t.mask=e.game.animationmanager.expandGameFilename("mask",t.mask))),e.game.menu.getImageForItem(t)},getimageclipforitem:function(t){return e.game.menu.getImageClipForItem(t)},drawstory:function(t,n){e.game.storymanager.drawStoryInCanvas(t,null,n)},translate:function(t,n){e.game.menu.translateWithGoogle(t,n,!1)},viewclan:function(t){e.game.client&&e.game.client.sendClanAction("getclaninfobyname",{name:t})},writepm:function(t,n){e.game.menu.writePM(t,n)}}}return this.guiScriptObject},getWindowScriptObject:function(){return this.windowScriptObject||(this.windowScriptObject={get innerWidth(){return window.innerWidth},get innerHeight(){return window.innerHeight},get scrollX(){return window.scrollX},get scrollY(){return window.scrollY},get devicePixelRatio(){return window.devicePixelRatio},getComputedStyle:function(e,t){return window.getComputedStyle(e,t)}}),this.windowScriptObject},scriptizeCallback:function(e){if(!e||typeof e!="function")return null;var t=this;return function(){t.runEvalJSIter(e.apply(null,arguments))}},createGui:function(e,t,n,r,i){if(!t||t.length<=0)return;var s=gui.getDom(t);if(s)return s;var o=gui.getDom("scriptgui");return o?(s=document.createElement("div"),s.id=t,s.className=n,s.style.cssText=r,s.innerHTML=i,o.appendChild(s),e&&e.guis.push(s),s):null},updateWeaponScript:function(e,n){if(e.weaponnpc){this.runScript(e.weaponnpc,e,"unequip");for(var r=0;r<e.weaponnpc.guis.length;r++)gui.remove(e.weaponnpc.guis[r]);e.weaponnpc=null}if(!n||!n.scriptclasses||n.scriptclasses.length<=0)return;e.weaponnpc=new t(this.game,-1),e.weaponnpc.npcType="weapon",e.weaponnpc.setExtendedData(n),this.runScript(e.weaponnpc,e,"equip")},setMenuButtons:function(e){this.serverMenuButtons=e;for(var t in this.serverMenuButtons){var n=this.serverMenuButtons[t];n.preload&&n.scriptclasses&&this.requestScriptClasses(n.scriptclasses)}},getMenuButtonNPC:function(e){if(!e.scriptclasses||e.scriptclasses.length<=0||!e.buttonid)return null;var n=this.menuButtonNPCs[e.buttonid];if(n)return n;n=this.menuButtonNPCs[e.buttonid]=new t(this.game,-1),n.npcType="menu",n.setExtendedData(e);var r=n.getScriptObject();for(var i in e)r[i]||(r[i]=e[i]);return n},getMenuButtonNPCById:function(e){var t=this.menuButtonNPCs[e];if(t)return t;if(this.serverMenuButtons)for(var n in this.serverMenuButtons){var r=this.serverMenuButtons[n];if(r["buttonid"]==e)return this.getMenuButtonNPC(r)}return null}});return r}),define("game",["storage","infomanager","renderer","mapmanager","animationmanager","localplayer","client","sounds","menu","shop","storymanager","filemanager","tradingmanager","minimap","newnpc","player","projectiles","character","scriptmanager","gametypes","lib/class"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y){var b=Class.extend({init:function(n){this.app=n,this.app.config=gameconfig,this.defaultfont="Coolvetica",this.font=this.app.config.font||this.defaultfont,this.filespath=this.app.config.filespath?this.app.config.filespath:"../files/",this.ready=!1,this.started=!1,this.hasNeverStarted=!0,this.didShowGame=!1,this.gameVisible=!0,this.tilesFinishedLoading=!1,this.npcsFinishedLoading=!1,this.minFrameTime=50,this.frameTimeS=.05,this.nextFrameTime=this.currentTime=Date.now(),this.currentFrame=1,this.isiOS=window.navigator&&window.navigator.userAgent.match(/(iPad|iPhone|iPod)/g),this.storage=new e,this.menu=new a(this),this.shop=new f(this),this.storymanager=new l(this),this.filemanager=new c(this),this.tradingmanager=new h(this),this.scriptmanager=new y(this),this.renderer=null,this.minimap=null,this.chatinput=null,this.sounds=null,this.settings={},this.pms=[],this.alltranslations={},this.player=new s(this,"player",Types.Entities.PLAYER),this.entities={},this.players=[],this.mouse={x:0,y:0},this.nexttemporaryentityid=1,this.infoManager=new t(this),this.initKeyConfig()},getTimeHash:function(){var e=Math.floor(Date.now()/1e3);return e-e%86400+1},getFilenameWithHash:function(e){if(e.indexOf("?")<0){var t=this.getTimeHash();if(t)return e+"?t="+t}return e},initKeyConfig:function(){this.defaultKeySettings={MoveUp:{k:38,n:"ArrowUp"},MoveLeft:{k:37,n:"ArrowLeft"},MoveDown:{k:40,n:"ArrowDown"},MoveRight:{k:39,n:"ArrowRight"},MoveUp2:{k:87,n:"W"},MoveLeft2:{k:65,n:"A"},MoveDown2:{k:83,n:"S"},MoveRight2:{k:68,n:"D"},AttackUp:{k:73,n:"I"},AttackLeft:{k:74,n:"J"},AttackDown:{k:75,n:"K"},AttackRight:{k:76,n:"L"},Attack1:{k:32,n:"Space"},Attack2:{k:69,n:"E"},Reload1:{k:17,n:"Control",altTitle:"Bow/Bomb1"},Reload2:{k:66,n:"B",altTitle:"Bow/Bomb2"},"2ndMode":{k:88,n:"X"},HotKey1:{k:49,n:"1"},HotKey2:{k:50,n:"2"},HotKey3:{k:51,n:"3"},HotKey4:{k:52,n:"4"},HotKey5:{k:53,n:"5"},Map:{k:77,n:"M"},Nicknames:{k:78,n:"N"},Items:{k:81,n:"Q"},Strafe:{k:85,n:"U"},StrafeLock:{k:79,n:"O"},Emoticon:{k:16,n:"Shift"},Stealth:{k:84,n:"T"},Zoom:{k:90,n:"Z"}},this.adminActions=["Stealth","Zoom"],this.updateKeyConfig()},getKeyForAction:function(e){var t=this.settings.keys&&this.settings.keys[e]?this.settings.keys[e]:this.defaultKeySettings[e];return t?t.k:null},getKeyNameForAction:function(e){var t=this.settings.keys&&this.settings.keys[e]?this.settings.keys[e]:this.defaultKeySettings[e];return t?t.n:""},updateKeyConfig:function(){this.keyConfig={};for(var e in this.defaultKeySettings){var t=this.settings.keys&&this.settings.keys[e]?this.settings.keys[e]:this.defaultKeySettings[e];t.k&&(this.keyConfig[t.k]=e)}},setup:function(e,t,r,i,s){this.setRenderer(new n(this,e,t,!0)),this.setMinimap(new p(this,r,s)),this.setChatInput(i),this.renderer.isMobile&&(gui.getWidth("canvas")<600||gui.getHeight()<480)&&!this.isiOS&&(this.settings.nomobilezoom=!0,this.renderer.zoom=1)},setRenderer:function(e){this.renderer=e},setMinimap:function(e){this.minimap=e},setChatInput:function(e){this.chatinput=e},preloadMaps:function(){new r(this)},preloadAnimations:function(){new i(this)},getPlayerCountClock:function(e,t){var n=this.app.config.noplayercount&&!(this.player&&this.player.adminlevel>=7)?"":e==1?translate("1 Player"):translate("%d Players",[e]);if(t!==undefined){var r=(new Date(2014,1,1,15,0,0,0)).toLocaleTimeString().indexOf("15")>-1;r?n+=" ⏰"+t:n+=" "+(t<1?"12am":t<13?t+"am":t-12+"pm")}return n},initPlayer:function(){if(!this.player)return;Config_Extern&&Config_Extern.name&&(this.player.name=Config_Extern.name,Config_Extern.name=null),this.player.idle()},getTemporaryEntityID:function(){return Types.IDPrefix.TEMP+this.nexttemporaryentityid++},addEntity:function(e){this.entities[e.id]=e,e.game=this,e instanceof v&&this.players.indexOf(e)<0&&this.players.push(e)},removeEntity:function(e){if(!(e.id in this.entities))return;e.prepareRemoveFromMap(),delete this.entities[e.id];if(e instanceof v){var t=this.players.indexOf(e);t>=0&&this.players.splice(t,1)}e instanceof s&&this.showCoinsArrow(!1)},setServerOptions:function(e){this.serverurl=e},loadAudio:function(){this.sounds=new u(this)},run:function(){this.ready=!0,this.resize(),this.loadAudio(),this.initPlayer(),this.connect()},tick:function(){this.checkDoFrame()&&this.started&&(this.currentFrame++,this.didShowGame&&this.processFrame(),this.renderer.renderFrame(),this.showfps&&this.countFPS()),this.isStopped||requestAnimFrame(this.tick.bind(this))},checkDoFrame:function(){this.gameVisible=!document||!document.hidden;var e=!this.gameVisible||!this.renderer.hasWebGL()?20:this.settings.fps20&&this.isiOS?30:this.settings.fps20?20:60;this.minFrameTime=1e3/e;var t=Date.now();return t<this.nextFrameTime?!1:(this.frameTimeS=Math.max(this.minFrameTime,Math.min(t-this.currentTime,50))/1e3,this.currentTime=t,this.currentTime>=this.nextFrameTime+3*this.minFrameTime?this.nextFrameTime=this.currentTime+this.minFrameTime:this.nextFrameTime+=this.minFrameTime,!0)},countFPS:function(){var e=Math.floor(this.currentTime/1e3);this.frameInfo&&e==this.frameInfo.second?this.frameInfo.frames++:(this.frameInfo&&this.showFPS(this.frameInfo.frames),this.frameInfo={second:e,frames:1})},processFrame:function(){this.player&&(this.player.processScreenShake(),this.player.checkMovement(),this.player.weaponMode&&this.player.weaponMode.autofire&&this.checkAutofire()),this.infoManager.update(this.currentTime),this.minimap.update(this.currentTime),this.mapmanager.currentmap.projectiles.processProjectiles();for(var e in this.mapmanager.activeObjects)this.mapmanager.activeObjects[e].onUpdateInterval();this.animationmanager.processWeather(),this.updateBombButton(),this.client&&this.client.sendPing(),this.storymanager.isRecording&&this.storymanager.updateRecordStory()},checkAutofire:function(){if(this.app.keyPressedAny){if(this.app.keyAction.Attack1||this.app.keyAction.Attack2){this.playerAttack(this.player.dir);return}if(this.app.keyAction.AttackUp){this.playerAttack(Types.Orientations.UP);return}if(this.app.keyAction.AttackLeft){this.playerAttack(Types.Orientations.LEFT);return}if(this.app.keyAction.AttackDown){this.playerAttack(Types.Orientations.DOWN);return}if(this.app.keyAction.AttackRight){this.playerAttack(Types.Orientations.RIGHT);return}}this.app.weaponpadDown&&this.playerAttack(this.app.weaponpadDirection)},start:function(){this.renderer.hideConnectingMessage(),this.tick(),this.hasNeverStarted=!1,this.showMovementHelp(),this.checkLoginLink(),this.client&&!this.renderer.hasWebGL()&&this.client.sendLog("nowebgl","on "+(Config_Extern?Config_Extern.platform:"unknown")),this.player&&this.player.guest&&gui.exists("webads")&&(gui.show("webads"),setTimeout(function(){gui.hide("webads")},1e4)),window.console&&console.log("Started game")},stop:function(){window.console&&console.log("Game stopped."),this.isStopped=!0},entityIdExists:function(e){return e in this.entities},getEntityById:function(e){return this.entities[e]},connect:function(){if(this.client)return;this.client=new o(this.serverurl,this),this.client.connect()},getMouseGridPosition:function(){return this.renderer.transformScreenToGrid(this.mouse.x,this.mouse.y)},forEachEntity:function(e){_.each(this.entities,function(t){e(t)})},forEachVisibleEntityByDepth:function(e,t){var n=[],r=this.player&&this.player.ghostcanplay;_.each(this.entities,function(t){if(t.ghost&&!r)return;var i=t.gridX,s=t.gridY-t.z,o=t.tileWidth,u=t.tileHeight;i+o>e.gridX&&i<e.gridX+e.gridW&&s+u>=e.gridY&&s<e.gridY+e.gridH&&n.push(t)}),n.sort(function(e,t){return e.gridY+(e.isDrawUnder?0:e.tileHeight)-(t.gridY+(t.isDrawUnder?0:t.tileHeight))}),_.each(n,t)},findNearestPlayer:function(e,t,n){var r,i=1e4;for(var s in this.players){var o=this.players[s];if(!o)continue;var u=Math.abs(e-o.gridX)+Math.abs(t-o.gridY);if(u>=n)continue;if(!r||u<i)r=o,i=u}return r},isEntityAt:function(e,t){return!_.isNull(this.getEntityAt(e,t))},getEntityAt:function(e,t){return this.mapmanager.getEntityAt(e,t,0,0)},click:function(){return this.actionOnGUIPos(this.mouse)?!1:(this.clickActionOnGridPos(this.getMouseGridPosition()),!0)},actionOnGUIPos:function(e){if(this.isNearGUI(e))return!0;if(this.checkCloseChat(e))return!0;var t=this.mapmanager.getControlEntityAt(this.renderer.camera.x+e.x/this.renderer.zoom,this.renderer.camera.y+e.y/this.renderer.zoom);return t?(t.entity.onControlMode(t.mode),!0):!1},isNearGUI:function(e){if(e.x<380&&e.y<80)return!0;if(e.x<80&&e.y<200)return!0;var t=this.renderer.canvas.width,n=this.renderer.canvas.height;return e.x>=t-234&&e.y<80?!0:e.x>=t-154&&e.y<234?!0:gui.isVisible("movepad")&&e.x<gui.getWidth("movepad")&&e.y>=n-gui.getHeight("movepad")?!0:gui.isVisible("weaponpad")&&e.x>=t-gui.getWidth("weaponpad")&&e.y>=n-gui.getHeight("weaponpad")?!0:!1},checkCloseChat:function(e){return gui.hasClass("chatbox","active")?e.y>90?(this.app.hideChat(),!1):!0:!1},clickActionOnGridPos:function(e){if(!this.started||!this.player||this.player.isDead||this.player.ghostBlocked())return;var t=this.mapmanager.getEntityAt(e.x,e.y,1,1);if(!t)t=this.findNearestPlayer(e.x,e.y,4/this.renderer.zoom);else if(t instanceof d&&t.isDrawUnder&&t.npcclass!="buildmarker"){var n=this.findNearestPlayer(e.x,e.y,2);n&&(t=n)}if(this.app.config.clicktoshoot&&(!t||Math.abs(this.player.x-t.x)>=48||Math.abs(this.player.y-t.y)>=48)){var r=e.x-this.player.gridX,i=e.y-this.player.gridY;this.app.weaponpadDirection=Math.abs(r)>=Math.abs(i)?r>0?4:3:i>0?2:1,r!=0&&i!=0&&(this.app.weaponpadAngle=Math.atan2(-i,r)),this.playerAttack(this.app.weaponpadDirection);return}if(!t)return;t instanceof d?this.player.isHittingAnimation()||t.onActivate("mouse"):t instanceof v&&this.requestPlayerProfile(t)},requestPlayerProfile:function(e){this.menu.profilebackcallback=null,this.client&&this.client.sendRequestPlayerProfile(e)},requestWinnerProfile:function(){if(!this.minimap.winneruserid)return;this.menu.profilebackcallback=null,this.client&&this.client.sendRequestDBPlayerProfile(this.minimap.winneruserid)},playerAttack:function(e){if(!this.started||!this.player||this.player.isDead||this.player.ghostBlocked())return;if(this.player.isFiring()||this.player.isInWater())return;this.player.weaponMode&&(this.app.config.primaryweapon!="gun"&&(e=this.player.dir),this.player.activateNPCs(e,null,!1),this.player.usePrimaryWeapon(e)),this.hideMovementHelp(),this.unlockSoundsOnMobile()},showMovementHelp:function(){if(!gui.exists("movementhelp"))return;if(this.player&&this.player.onlinetime&&this.player.onlinetime>=3600)return;this.app.config.gameads&&this.app.config.gameads.length>0&&this.app.config.gameads[0].showinmovementhelp&&this.menu.showGameAdInContainer(gui.getDom("movementhelpad"),this.app.config.gameads[0],!0),gui.fadeIn("movementhelp")},hideMovementHelp:function(){gui.isVisible("movementhelp")&&gui.fadeOut("movementhelp")},showShipControls:function(){gui.exists("shipcontrols")&&gui.fadeIn("shipcontrols"),gui.fadeOut("minimap")},hideShipControls:function(){gui.exists("shipcontrols")&&gui.fadeOut("shipcontrols"),this.settings.hideminimap||gui.fadeIn("minimap")},unlockSoundsOnMobile:function(){!this.unlockedsounds&&!this.settings.soundsoff&&(this.sounds&&this.sounds.unlockSounds(),this.unlockedsounds=!0),this.sounds&&this.sounds.updateMusic(!0)},resetCamera:function(){this.player&&this.renderer.camera.lookAt(this.player),this.renderer.updateTiles(!0)},say:function(e,t){switch(e){case"/showping":this.client&&(this.client.showping=!0,this.updatePingInterval(),this.showfps=!1,this.client.lastpingtime&&this.showPing(this.client.lastpingtime));break;case"/hideping":this.client&&this.client.showping&&(this.client.showping=!1,this.updatePingInterval(),gui.hide("pinglabel"));break;case"/showfps":this.showfps=!0,this.client&&(this.client.showping=!1,this.updatePingInterval());break;case"/hidefps":this.showfps&&(this.showfps=!1,gui.hide("pinglabel"));break;case"/hidegui":this.hideGui();break;case"/clearchat":this.forEachEntity(function(e){delete e.chat,e.showChat("")});break;case"/hidechat":this.forEachEntity(function(e){delete e.chat,e.showChat("")}),this.hidechat=!0;break;case"/warpon":this.disableClickWarp&&(this.disableClickWarp=!1,this.showShortMessage(translate("You've enabled click-warp.")));break;case"/warpoff":this.disableClickWarp||(this.disableClickWarp=!0,this.showShortMessage(translate("You've disabled click-warp.")));break;case"/bigchat":gui.hasClass("chatbox","bigchat")||(gui.addClass("chatbox","bigchat"),this.showShortMessage(translate("The chat input is now large!")));break;default:this.client?this.client.sendChat(e):this.player&&(this.player.chat=e,this.player.showChat(e))}},updatePingInterval:function(){if(!this.client)return;var e=this.mapmanager.currentmap&&this.mapmanager.currentmap.isSpar();this.client.pinginterval=e||this.client.showping?2e3:1e4},showPing:function(e){var t=gui.getDom("pinglabel");gui.show(t),t.innerHTML="Ping: "+e},showFPS:function(e){var t=gui.getDom("pinglabel");gui.show(t),t.innerHTML="FPS: "+e},invokeScriptEvent:function(e){if(!this.player)return;this.scriptmanager.runScript(this.player,this.player,e),e=="says"&&(e="playersays");var t={gridX:this.player.gridX-12,gridY:this.player.gridY-9,gridW:24,gridH:18},n=this;this.forEachVisibleEntityByDepth(t,function(t){if(!(t instanceof d))return;n.scriptmanager.runScript(t,n.player,e)})},hideGui:function(){this.guiIsHidden=!0;var e=["movepad","weaponpad","bombbutton","mode2button","lightsbutton","hornbutton","chatbutton","menubutton","homebutton","coinsbutton","invitebutton","postpicturebutton","logoutbutton","fullscreenbutton","clanchatbutton","pmbutton","furniturebutton","coinsarrow","hotkey1","hotkey2","hotkey3","hotkey4","hotkey5"],t=["coinscount","minimap","pmbubble","pmbadge","notifications","movementhelp"];for(var n in e)gui.setBackgroundImage(e[n],null);for(var n in t)gui.hide(t[n]);for(var r=1;r<=5;r++)gui.setChildHTML("hotkey"+r,"div.hotkeyimage","")},checkHideFullGui:function(){var e=this.player&&this.player.ghostBlocked()||this.mapmanager.currentmap&&this.app.config.noguimaps.indexOf(this.mapmanager.currentmap.mapname)>=0;e?(gui.hide("bar-container"),gui.hide("guicontainer")):(gui.show("bar-container"),gui.show("guicontainer"))},restart:function(e){this.initPlayer(),this.started=!0,this.client&&this.client.sendRevive(e)},onDisconnect:function(e){gui.hide("startscreen"),gui.hide("deathscreen");var t=gui.getDom("gamecontainer");t.style.visibility="visible",gui.fadeIn("reconnectscreen"),gui.setChildHTML("reconnectscreen","p","<br>"+e)},onPlayerDeath:function(e){this.playerdeath_callback=e},onPlayerCoinsUpdated:function(e){gui.setChildHTML("coinscount","span.count",e),this.scriptmanager.runScript(this.player,this.player,"coinschange")},showCoinsArrow:function(e){if(!this.app.config.showcoinsarrow)return;e?(gui.stop("coinsarrow"),gui.fadeIn("coinsarrow")):gui.fadeOut("coinsarrow")},resize:function(){var e=this.renderer,t=gui.getWidth("canvas"),n=gui.getHeight("canvas"),r=gui.getDom("entities");r.style.width=t+"px",r.style.height=n+"px";if(e.hasWebGL())e.canvas.width=t,e.canvas.height=n;else{e.canvas.width=t/e.zoom,e.canvas.height=n/e.zoom,e.backcanvas.width=e.canvas.width+64,e.backcanvas.height=e.canvas.height+64;var i=gui.getDom("background");i.style.width=e.backcanvas.width*e.zoom+"px",i.style.height=e.backcanvas.height*e.zoom+"px"}var s=e.camera?e.camera.x:0,o=e.camera?e.camera.y:0;e.rescale(),e.camera.setPosition(s,o),this.resizeMobileButtons(),this.applyButtonZoom(this.settings.buttonzoom)},resizeMobileButtons:function(){if(!this.renderer.isMobile)return;var e=gui.getWidth("canvas"),t=gui.getHeight("canvas");if(e>=768&&t>=768&&!this.wasResizingButtons)return;var n=gui.getDom("movepad"),r=gui.getDom("weaponpad"),i=gui.getDom("bombbutton"),s=gui.getDom("hotkeys");if(!n||!r||!s)return;var o=t>=600?300:Math.floor(t/2),u=gui.getPosition(n).left;n.style.width=o+"px",n.style.height=o+"px",r.style.width=o+"px",r.style.height=o+"px",i&&(i.style.bottom=o-20+"px"),s.style.left=u+o+30+"px",s.style.right=u+o+20+"px";var a=gui.getDom("mode2button"),f=gui.getDom("lightsbutton"),l=gui.getDom("hornbutton");if(a&&f&&l){var c=Math.min(t/5,128);a.style.bottom=o-16+"px",a.style.right=u+Math.floor(c+12*o/300)+"px",f.style.bottom=o-16+"px",f.style.right=u+Math.floor(c+12*o/300)+"px",l.style.bottom=Math.floor(o*7/10)+"px",l.style.right=u+c*2+"px"}this.wasResizingButtons=!0},removeObsoleteEntities:function(e){var t=this;_.each(e,function(e){t.removeEntity(e)})},registerPayment:function(e,t,n,r,i){this.client.sendPayment(e,t,n,r,i),this.shop.hasExternInterfaceVersion(1.1)&&this.shop.sendFinishTransaction&&n!="fake"&&this.shop.sendFinishTransaction(n)},onSettingsChanged:function(e){this.settings.musicoff?this.sounds.stopMusic():(this.sounds.updateVolume(),this.sounds.updateMusic(!1));var t=this.settings.newfont&&this.app.config.font?this.app.config.font:this.defaultfont;t!=this.font&&(this.font=t,this.renderer.setFontSize(this.renderer.fontSize),this.forEachEntity(function(e){e.deleteTextCache()})),this.settings.hideminimap?gui.fadeOut("minimap"):gui.isVisible("shipcontrols")||gui.fadeIn("minimap"),this.settings.hidehome?gui.fadeOut("homebutton"):gui.fadeIn("homebutton");var n=this.settings.gamezoom;n||(this.renderer.isMobile?n=this.settings.nomobilezoom?1:2:n=this.settings.zoom2x?2:1,gui.getWidth("canvas")<600&&(n=1)),n!=this.renderer.zoom&&(this.renderer.zoom=n,this.resize(),this.infoManager&&this.infoManager.updateAllInGameSize()),this.settings.noingametv&&this.infoManager&&this.infoManager.removeAllInGameDom(),this.renderer.isMobile&&["3x360x780","2x375x667","3x375x812","3x390x844","2x414x896","3x428x926","3x393x852","3x430x932"].indexOf(""+window.devicePixelRatio+"x"+window.screen.width+"x"+window.screen.height)>=0&&(this.settings.buttonspacing=!0),this.settings.buttonspacing?gui.addClass("body","buttonspacing"):gui.removeClass("body","buttonspacing"),this.applyButtonZoom(this.settings.buttonzoom),this.updateKeyConfig(),delete this.settings.fps60,delete this.settings.autotranslate,e&&this.client.sendSetSettings(this.settings),this.resizeMobileButtons()},applyButtonZoom:function(e){var t=gui.getDom("gamecontainer"),n=gui.getDom("bar-container");e||(e=1);if(e==1&&(!n.style.transform||n.style.transform==""||n.style.transform=="none"))return;var r=gui.getWidth(t),i=gui.getHeight(t);e==1?(n.style.transform="",n.style.width="100%",n.style.height="100%"):(n.style.transform="translate("+Math.floor((r-r/e)/2)+"px, "+Math.floor((i-i/e)/2)+"px) scale("+e+")",n.style.width=Math.floor(r/e)+"px",n.style.height=Math.floor(i/e)+"px")},onEnteredMap:function(e,t,n){var r=this.app.config.showfurnitureshops&&(e.indexOf("playerland_")==0||e.indexOf("house_")==0);gui.exists("furniturebutton")&&(r?gui.show("furniturebutton"):(gui.hide("furniturebutton"),this.menu.getCurrentMenu()=="furnitureshops"&&this.menu.closePopUpNow())),r||this.renderer.isMobile||Config_Extern&&Config_Extern.platform&&Config_Extern["platform"]!="facebook"?gui.hide("invitebutton"):gui.show("invitebutton"),(Config_Extern&&["iphone","android"].indexOf(Config_Extern.platform)>=0||this.isiOS)&&gui.hide("fullscreenbutton"),this.player&&(this.player.setFocus(null,null),this.player.showCurrentHitPoints()),this.animationmanager&&this.animationmanager.stopWeather(),this.infoManager&&this.infoManager.clearKillerInfos(),this.app.config.noguimaps.indexOf(e)>=0&&(this.checkHideFullGui(),this.tilesFinishedLoading=!0,this.npcsFinishedLoading=!0,this.checkHideStartScreen()),this.player&&this.scriptmanager.runScript(this.player,this.player,"entermap",[e,t,n]),this.mapmanager.currentmap&&this.mapmanager.currentmap.checkLoadZone(),this.updatePingInterval()},isDrawingNames:function(){return!this.settings.hidenames||this.app.keyAction.Nicknames},showClanChatButton:function(e){e?gui.fadeIn("clanchatbutton"):gui.fadeOut("clanchatbutton")},showGeneralMessage:function(e,t){this.showNotification("generalmessage",0,t,e,{},0)},showShortMessage:function(e,t){this.showNotification("shortmessage",0,t,e,{},0)},showNotification:function(e,t,n,r,i,s){this.pmcount=this.pmcount?this.pmcount+1:1;var o={controlid:this.pmcount,type:e,senderid:t,senderlook:n,message:r,data:i,id:s};this.settings.notranslate||this.getGoogleTranslation(o.message,function(e){o.originalMessage=r,e!=o.message&&(o.message=e+"⌝",gui.setChildHTML("notification"+o.controlid,".translatehere",o.type=="pm"&&o.message.length>100?o.message.substring(0,97)+"...":o.message))});var u=!1,a=o.data&&o.data.show&&!this.menu.getCurrentMenu();if(["guide","generalmessage","shortmessage","history"].indexOf(o.type)<0&&!a&&n){u=this.removeDuplicatePM(o),this.pms.push(o),gui.setChildHTML("pmbutton","div.pmbadge",this.pms.length),gui.fadeIn("pmbutton");if(this.mapmanager.currentmap&&this.mapmanager.currentmap.isSpar())return}if(["pm","invitation","clanmessage","server","console","script","guide"].indexOf(e)>=0)if(this.checkPMSoundOrDirectOpen(o,u)||e=="guide")return;if(e=="pm"&&this.settings.nopmnotification)return;var f=10,l=5;switch(e){case"generalmessage":f=15,l=3;break;case"shortmessage":f=5;break;case"pm":o.message.length>=30&&(f=15)}var c="",h=o.type=="invitation"?"invitation":o.type=="history"?"viewhistory":t>0||i&&i.replyid?"reply":o.data&&o.data.mapmarkers?"view":"dismiss",p;n&&n.head&&(p=[{x:4,y:-8,itemtype:"head",head:this.animationmanager.expandGameFilename("head",n.head)}],n.hat&&p.push({x:4,y:-24,itemtype:"hat",hat:this.animationmanager.expandGameFilename("hat",n.hat)})),p&&(c+=this.menu.getHTMLFromItemsInFlow(p,!0)),c+='<div class="notificationtitle" style="'+(p?"margin-left:46px;":"")+'">'+(n&&n.name?"<b>"+n.name.substring(0,25)+(o.message.length>0?":":"")+"</b> ":"")+'<span class="translatehere">'+(e=="pm"&&o.message.length>100?o.message.substring(0,97)+"...":o.message)+"</span>"+"</div>";var d=this;switch(h){case"invitation":c+='<input id="pmyesbutton'+o.controlid+'" type=submit value="'+translate("Yes")+'" class="notificationbutton">',c+='<input id="pmnobutton'+o.controlid+'" type=submit value="'+translate("No")+'" class="notificationbutton">';break;case"reply":c+='<input id="pmreplybutton'+o.controlid+'" type=submit value="'+translate("Reply")+'" class="notificationbutton">';break;case"view":c+='<input id="pmviewbutton'+o.controlid+'" type=submit value="'+translate("View")+'" class="notificationbutton">';break;case"viewhistory":c+='<input id="pmviewhistorybutton'+o.controlid+'" type=submit value="'+translate("View")+'" class="notificationbutton">';break;case"dismiss":c+='<div class="dismissnotification"></div>'}var v=gui.cloneAndTimeout("notificationprototype",f,l,function(e){gui.remove(e),h=="viewhistory"?d.menu.showMessageList(null,!0):h!="dismiss"&&(d.removePM(o),d.menu.showPM(o))});if(v){v.id="notification"+o.controlid,gui.setChildHTML(v,".notificationtext",c);switch(h){case"invitation":gui.setClick("pmyesbutton"+o.controlid,function(){gui.hide("notification"+o.controlid),d.removePM(o),d.acceptInvitation(o,!0)}),gui.setClick("pmnobutton"+o.controlid,function(){gui.hide("notification"+o.controlid),d.removePM(o),d.acceptInvitation(o,!1)});break;case"reply":gui.setClick("pmreplybutton"+o.controlid,function(){gui.hide("notification"+o.controlid),d.removePM(o),d.menu.writePMAsReply(o)});break;case"view":gui.setClick("pmviewbutton"+o.controlid,function(){gui.hide("notification"+o.controlid),d.showSinglePM(o)});break;case"viewhistory":gui.setClick("pmviewbutton"+o.controlid,function(){gui.hide("notification"+o.controlid),d.menu.showMessageList(null,!0)})}}},showPMButton:function(e,t,n,r,i,s){this.showNotification(e,t,n,r,i,s)},checkPMSoundOrDirectOpen:function(e,t){var n=!t,r=e.data&&e.data.show&&!this.menu.getCurrentMenu();return r?this.menu.showPM(e):!this.minimap.showStoryPM(e)&&e.type=="guide"&&(n=!1),n&&(!this.lastPMSound||this.currentTime>=this.lastPMSound+5e3)&&(this.lastPMSound=this.currentTime,this.sounds.play("pm_sound")),r},removeDuplicatePM:function(e){var t=e.id&&e.id!=0,n=!1;for(var r=this.pms.length-1;r>=0;r--){var i=this.pms[r];if(t&&e.id==i.id||i.type==e.type&&i.senderid==e.senderid&&i.message==e.message||i.type==e.type&&e.type=="pm"&&i.senderid==e.senderid||i.type==e.type&&e.type=="console"||i.type==e.type&&e.type=="clanmessage")this.pms.splice(r,1),n=!0}return n},showNextPM:function(){if(this.pms.length>0){var e=this.pms.shift();this.menu.showPM(e),gui.setChildHTML("pmbutton","div.pmbadge",this.pms.length),this.pms.length<=0&&gui.fadeOut("pmbutton")}},showSinglePM:function(e){if(!e)return;this.menu.showPM(e),this.removePM(e)},removePM:function(e){var t=this.pms.indexOf(e);t>=0&&(this.pms.splice(t,1),gui.setChildHTML("pmbutton","div.pmbadge",this.pms.length),this.pms.length<=0&&gui.fadeOut("pmbutton"))},acceptInvitation:function(e,t){if(!e||!e.data)return;this.client&&e.data&&(e.data.replyid?this.client.sendPMAction("sendpm",{userid:e.senderid,message:t?"yes":"no",replyid:e.data.replyid}):this.client.sendPMAction("confirminvitation",{type:e.data.type,userid:e.senderid,accept:t}))},checkHideStartScreen:function(){if(this.didShowGame)return;if(!this.tilesFinishedLoading||!this.npcsFinishedLoading)return;this.didShowGame=!0;var e=gui.getDom("gamecontainer");e.style.visibility="visible",gui.fadeOut("startscreen",250)},activateHotkey:function(e,t){if(!this.player||this.player.ghostBlocked()||!this.client||e>this.app.config.hotkeys)return;if(e>this.getHotKeyCount())return;this.player.hotkeys&&this.player.hotkeys[e]?t?this.checkEquipOnHotkey(this.player.hotkeys[e].itemid):this.menu.showCategory({category:"weapon",offset:this.player.hotkeys[e].itemid,fromhotkey:e},!0):this.menu.showCategory({category:"weapon",offset:0,fromhotkey:e},!0)},addHotkey:function(e,t){if(!this.player||!this.client)return;if(e>this.getHotKeyCount())return;this.player.hotkeys||(this.player.hotkeys={}),this.player.hotkeys[e]=t,this.client.sendHotkey(e,t.itemid),this.displayHotkey(e),t.itemtype!="food"&&this.checkEquipOnHotkey(t.itemid)},updateHotkeys:function(){if(!gui.getDom("hotkeys"))return;for(var e=1;e<=this.app.config.hotkeys;e++)this.displayHotkey(e)},displayHotkey:function(e){if(e>this.getHotKeyCount()){gui.hide("hotkey"+e),gui.setChildHTML("hotkey"+e,"div.hotkeyimage","");return}var t=this.player&&this.player.hotkeys?this.player.hotkeys[e]:null;gui.show("hotkey"+e);var n=gui.setChildHTML("hotkey"+e,"div.hotkeyimage","");if(!this.guiIsHidden){n&&t&&n.appendChild(this.menu.getImageDivForMenuItem(t));var r=t&&this.player&&this.player.weaponMode&&this.player.weaponMode["itemid"]==t.itemid;gui.setBackgroundImage("hotkey"+e,this.filespath+"gui/bbuilder_hotkey"+(r?"-active":"")+".png")}},getHotKeyCount:function(){if(!this.app.config.hotKeysFree)return 5;var e=this.player.getScriptObject().hotKeySlots||0;return this.app.config.hotKeysFree+e},checkEquipOnHotkey:function(e){this.player&&this.client&&!this.player.isReloading()&&(!this.player.weaponMode||this.player.weaponMode["itemid"]!=e||!!this.player.mountData)&&this.client.sendUseInventory(e,"equip")},markBombButtonUpdate:function(){this.updatebomb=!0},updateBombButton:function(){if(!this.updatebomb)return;this.updatebomb=!1;var e,t;this.player?this.player.isCar()?e="carbutton_brake":this.player.weaponMode&&(this.player.weaponMode["weapontype"]=="gun"||this.player.weaponData.mode2)&&(!this.player.bow||!this.player.bowData||this.player.bowData["weapontype"]!="snowball")?(this.player.weaponMode.clip?e="reload"+(this.renderer.isMobile?"":"pc")+"button":e=null,this.player.weaponMode.mode2&&(t="2ndmode-hotkey"+(this.player.weaponMode==this.player.weaponData?"":"-active"))):e=(this.player.bow&&this.player.bowData?this.player.bowData.weapontype:"bomb")+"button":e=null,this.player&&this.player.showGrabButton()&&(e="fistbutton"),e=="bombbutton"&&this.app.config.disablebombs&&(e="fistbutton"),e!==this.livebutton&&(this.livebutton=e,e?(gui.setBackgroundImage("bombbutton",this.filespath+"gui/bbuilder_"+e+".png"),gui.show("bombbutton")):gui.hide("bombbutton")),t!==this.livebutton2&&(this.livebutton2=t,t?(gui.setBackgroundImage("mode2button",this.filespath+"gui/"+t+".png"),gui.show("mode2button")):gui.hide("mode2button"))},updateCarButtons:function(){if(this.app.config.primaryweapon!="gun")return;this.player&&this.player.isCar()?(gui.setBackgroundImage("movepad",this.filespath+"gui/bbuilder_carbutton_steer.png"),gui.removeClass("movepad","padmaxhalf"),gui.setBackgroundImage("weaponpad",this.filespath+"gui/bbuilder_carbutton_gas.png"),gui.removeClass("weaponpad","padmaxhalf"),gui.setBackgroundImage("lightsbutton",this.filespath+"gui/bbuilder_carbutton_lights"+(this.player.carLightsOn?"":"off")+".png"),gui.show("lightsbutton"),gui.show("hornbutton")):(gui.setBackgroundImage("movepad",this.filespath+"gui/corleone_movepad.png"),gui.addClass("movepad","padmaxhalf"),gui.setBackgroundImage("weaponpad",this.filespath+"gui/corleone_weaponpad.png"),gui.addClass("weaponpad","padmaxhalf"),gui.hide("lightsbutton"),gui.hide("hornbutton")),this.markBombButtonUpdate()},showVS:function(e,t){if(!gui.exists("showvs"))return;var n=this.animationmanager;gui.hide("showvswinner"),gui.setBackgroundImage("showvshead1",n.getPathForDefault("HEAD")+n.expandGameFilename("head",e.head)),gui.setBackgroundImage("showvshat1",e.hat&&e.hat.length>0?n.getPathForDefault("HAT")+n.expandGameFilename("hat",e.hat):""),gui.setHTML("showvsname1",e.name),gui.setBackgroundImage("showvshead2",n.getPathForDefault("HEAD")+n.expandGameFilename("head",t.head)),gui.setBackgroundImage("showvshat2",t.hat&&t.hat.length>0?n.getPathForDefault("HAT")+n.expandGameFilename("hat",t.hat):""),gui.setHTML("showvsname2",t.name),gui.show("showvs"),this.vstimeout&&clearTimeout(this.vstimeout);var r=this;this.vstimeout=setTimeout(function(){r.vstimeout=null,gui.hide("showvs")},3e3)},showVSWinner:function(e,t){if(!gui.exists("showvswinner"))return;var n=this.animationmanager;gui.hide("showvs"),gui.setBackgroundImage("showvsheadw",n.getPathForDefault("HEAD")+n.expandGameFilename("head",e.head)),gui.setBackgroundImage("showvshatw",e.hat&&e.hat.length>0?n.getPathForDefault("HAT")+n.expandGameFilename("hat",e.hat):""),gui.setHTML("showvsnamew",e.name),gui.setHTML("showvsstreak",t&&t>1?translate("Streak of %d",[t]):""),gui.show("showvswinner"),this.vswinnertimeout&&clearTimeout(this.vswinnertimeout);var r=this;this.vswinnertimeout=setTimeout(function(){r.vswinnertimeout=null,gui.hide("showvswinner")},5e3)},showVSClans:function(e,t){if(!gui.exists("showvsclans"))return;gui.hide("showvsclanwinner"),gui.setHTML("showvsclan1",e),gui.setHTML("showvsclan2",t),gui.show("showvsclans"),this.vsclanstimeout&&clearTimeout(this.vsclanstimeout);var n=this;this.vsclanstimeout=setTimeout(function(){n.vsclanstimeout=null,gui.hide("showvsclans")},3e3)},showVSClanWinner:function(e){if(!gui.exists("showvsclanwinner"))return;gui.hide("showvsclans"),gui.setHTML("showvsclanw",e),gui.show("showvsclanwinner"),this.vsclanwinnertimeout&&clearTimeout(this.vsclanwinnertimeout);var t=this;this.vsclanwinnertimeout=setTimeout(function(){t.vsclanwinnertimeout=null,gui.hide("showvsclanwinner")},5e3)},getClanFromName:function(e){if(!e)return null;var t=e.indexOf("(");return t<0?null:(e=e.substring(t+1),t=e.indexOf(")"),t<0?null:e.substring(0,t).trim())},canIdentify:function(){return this.player&&(this.player.ghost||this.player.guest)&&this.client},identifyByType:function(e){if(!this.canIdentify())return;switch(e){case"device":this.identifyByDevice();break;case"facebook":this.identifyByFacebook();break;case"google":this.identifyByCognito("Google");break;case"steam":this.identifyBySteam();break;case"cognito":this.identifyByCognito()}},identifyByDevice:function(){if(!this.canIdentify()||this.startedIdentify)return;gui.hide("identifybuttons"),gui.show("identifywait"),this.player&&this.player.stopAndAnimate("idle"),this.startedIdentify="device",this.storage.loadWithCookie(""),this.client.sendIdentify("device",{cookie:this.storage.getCookie(),cookie2:this.storage.getCookie2()})},identifyByFacebook:function(){window.console&&console.log("identify facebook:",Config_Extern,window.FB);if(Config_Extern&&["iphone","android"].indexOf(Config_Extern.platform)>=0){this.shop.identifyExternal("facebook");return}if(!window.FB){this.menu.showAlert("Login with Facebook failed, library not loaded.","Facebook");return}var e=this;FB.login(function(t){e.loginWithFacebookResponse(t)},{scope:this.app.config.facebookscopes})},loginWithFacebookResponse:function(e){if(!this.canIdentify()||this.startedIdentify)return;if(e.status!="connected"||!e.authResponse)return;gui.hide("identifybuttons"),gui.show("identifywait"),this.player&&this.player.stopAndAnimate("idle"),this.startedIdentify="facebook",this.storage.loadWithCookie(""),this.client.sendIdentify("facebook",{signedrequest:e.authResponse.signedRequest,cookie:this.storage.getCookie()})},identifyByCognito:function(e){if(Config_Extern&&["iphone","android"].indexOf(Config_Extern.platform)>=0){this.shop.identifyExternal(e?e.toLowerCase():"cognito");return}if(!this.app.config.cognitoclientid)return;window.location.href="https://"+this.app.config.cognitoapidomain+(e?"/oauth2/authorize?identity_provider="+e+"&":"/login?")+"response_type=code&"+"client_id="+encodeURIComponent(this.app.config.cognitoclientid)+"&redirect_uri="+encodeURIComponent(window.location.host?"https://"+window.location.host:this.app.config.cognitoredirecturi)+"&state=CGNTSTATE1&scope=openid+email+profile"},loginWithCognitoCode:function(e){if(!e||!this.canIdentify()||this.startedIdentify)return;gui.hide("identifybuttons"),gui.show("identifywait"),this.player&&this.player.stopAndAnimate("idle"),this.startedIdentify="cognito",this.storage.loadWithCookie(""),this.client.sendIdentify("cognito",{code:e,cookie:this.storage.getCookie(),redirecturi:window.location.host?"https://"+window.location.host:this.app.config.cognitoredirecturi})},identifyBySteam:function(){var e=this;if(window.electron&&window.electron.loginToSteam){window.electron.on("onSteamLogin",function(t,n){n&&n.ticket&&e.loginWithSteamCode(null,n.ticket)}),window.electron.loginToSteam();return}if(Config_Extern&&["iphone","android"].indexOf(Config_Extern.platform)>=0){this.shop.identifyExternal("steam");return}var t="https://steamcommunity.com/openid/login?openid.ns=http://specs.openid.net/auth/2.0&openid.mode=checkid_setup&openid.return_to="+encodeURIComponent(window.location.href)+"&openid.realm="+encodeURIComponent(window.location.href)+"&openid.identity=http://specs.openid.net/auth/2.0/identifier_select"+"&openid.claimed_id=http://specs.openid.net/auth/2.0/identifier_select";window.location.href=t},loginWithSteamCode:function(e,t){if(!e&&!t||!this.canIdentify()||this.startedIdentify)return;gui.hide("identifybuttons"),gui.show("identifywait"),this.player&&this.player.stopAndAnimate("idle"),this.startedIdentify="steam",this.storage.loadWithCookie(""),this.client.sendIdentify("steam",{code:e,ticket:t,cookie:this.storage.getCookie()})},showIdentifyByEmail:function(){if(!this.canIdentify()||this.startedIdentify)return;gui.hide("identifybuttons"),gui.show("identifyscreenemail")},closeIdentifyByEmail:function(){if(!this.canIdentify()||this.startedIdentify)return;gui.hide("identifyscreenemail"),gui.show("identifybuttons")},sendIdentifyByEmail:function(){if(!this.canIdentify()||this.startedIdentify)return;var e=gui.getDom("identifyscreenemail"),t=e.querySelector("#email").value.trim(),n=e.querySelector("#password").value.trim();if(t.length<=0||n.length<=0)return;this.loginWithEmailPassword(t,n)},checkLoginLink:function(){if(!this.canIdentify()||this.startedIdentify)return;var e=this.getUrlVars(window.location.href);if(e.code&&e.code.length>0&&e.state&&e["state"].indexOf("CGNTSTATE1")==0){this.loginWithCognitoCode(decodeURIComponent(e.code)),this.removeHistoryParams();return}if(e.signed_request&&e.signed_request.length>0&&e.state&&e["state"].indexOf("FBSTATE1")==0){this.loginWithFacebookResponse({status:"connected",authResponse:{signedRequest:decodeURIComponent(e.signed_request)}}),this.removeHistoryParams();return}if(e["openid.claimed_id"]&&e["openid.claimed_id"].indexOf("https://steamcommunity.com")==0){this.loginWithSteamCode(window.location.search,null),this.removeHistoryParams();return}},removeHistoryParams:function(){window.history&&window.history.replaceState({},document.title,window.location.href.split("?")[0])},loginWithEmailPassword:function(e,t){gui.hide("identifybuttons"),gui.hide("identifyscreenemail"),gui.show("identifywait"),this.player&&this.player.stopAndAnimate("idle"),this.startedIdentify="email",this.storage.loadWithCookie(""),this.client.sendIdentify("email",{email:e,password:t,cookie:this.storage.getCookie()})},getUrlVars:function(e){var t={},n=e.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,n,r){t[n]=decodeURIComponent(r)});return t},receivedIdentifyInfo:function(e,t){if(!this.canIdentify()||!this.startedIdentify||this.startedIdentify!=e)return;if(t.error){delete this.startedIdentify;switch(t.error){case"nodevicelogin":this.menu.showModalMessage("You cannot identify by device here.",!0,"Device Login Disabled");break;case"invalidfbtoken":this.menu.showModalMessage("There was a problem with the Facebook login.",!0,"Facebook Login Problem");break;case"invalidcognitocode":this.menu.showModalMessage("There was a problem with the sign-In.",!0,"Sign-In Problem");break;case"invalidsteamcode":this.menu.showModalMessage("There was a problem with the Steam sign-In.",!0,"Sign-In Problem");break;case"accountinactive":this.menu.showModalMessage("Your account has been set inactive by administrators.",!0,"Account Inactive");break;case"wrongaccount":this.menu.showModalMessage("An account with that name couldn't be found. Please type the correct name.",!0,"Wrong Account");break;case"wrongpassword":this.menu.showModalMessage("The password is wrong. Please type the correct password.",!0,"Wrong Password");break;case"silent":break;default:this.menu.showModalMessage(translate("There was an error logging in (%s)",[t.error]),!0,"Error")}Config_Extern&&["iphone","android"].indexOf(Config_Extern.platform)>=0&&this.shop.identifyErrorExternal(t.error);switch(e){case"device":case"facebook":case"google":case"cognito":case"steam":gui.hide("identifywait"),gui.show("identifybuttons");break;case"email":gui.hide("identifywait"),gui.show("identifyscreenemail")}}},finishedIdentify:function(){delete this.startedIdentify,this.player&&delete this.player.ghost,gui.hide("identifyscreen"),gui.removeClass("canvas","grayed"),gui.removeClass("body","ghostcanplay"),this.checkHideFullGui(),delete this.storage.ghost},getGoogleTranslation:function(e,t,n){if(!e||e.trim().length<=0){t(e);return}var r=this.alltranslations[e];if(r){t(r);return}var i=window.navigator?window.navigator.language||window.navigator.userLanguage:null;i?i=i.split("-")[0]:i="en";var s="https://translate.googleapis.com/translate_a/single?client=gtx&ie=UTF-8&oe=UTF-8&sl=auto&tl="+i+"&dt=t&q="+encodeURIComponent(e),o=this;gui.ajax(s,!0,function(r){var i="";for(var s=0;s<r[0].length;s++)i+=r[0][s][0];if(i.length<=0){n&&n();return}o.alltranslations[e]=i,t(i)},n)}});return b}),function(){var e=this,t=e._,n={},r=Array.prototype,i=Object.prototype,s=r.slice,o=r.unshift,u=i.toString,a=i.hasOwnProperty,f=r.forEach,l=r.map,c=r.reduce,h=r.reduceRight,p=r.filter,d=r.every,v=r.some,m=r.indexOf,g=r.lastIndexOf;i=Array.isArray;var y=Object.keys,b=Function.prototype.bind,w=function(e){return new N(e)};e._=w,w.VERSION="1.1.7";var E=w.each=w.forEach=function(e,t,r){if(e!=null)if(f&&e.forEach===f)e.forEach(t,r);else if(e.length===+e.length){for(var i=0,s=e.length;i<s;i++)if(i in e&&t.call(r,e[i],i,e)===n)break}else for(i in e)if(a.call(e,i)&&t.call(r,e[i],i,e)===n)break};w.map=function(e,t,n){var r=[];return e==null?r:l&&e.map===l?e.map(t,n):(E(e,function(e,i,s){r[r.length]=t.call(n,e,i,s)}),r)},w.reduce=w.foldl=w.inject=function(e,t,n,r){var i=n!==void 0;e==null&&(e=[]);if(c&&e.reduce===c)return r&&(t=w.bind(t,r)),i?e.reduce(t,n):e.reduce(t);E(e,function(e,s,o){i?n=t.call(r,n,e,s,o):(n=e,i=!0)});if(!i)throw new TypeError("Reduce of empty array with no initial value");return n},w.reduceRight=w.foldr=function(e,t,n,r){return e==null&&(e=[]),h&&e.reduceRight===h?(r&&(t=w.bind(t,r)),n!==void 0?e.reduceRight(t,n):e.reduceRight(t)):(e=(w.isArray(e)?e.slice():w.toArray(e)).reverse(),w.reduce(e,t,n,r))},w.find=w.detect=function(e,t,n){var r;return S(e,function(e,i,s){if(t.call(n,e,i,s))return r=e,!0}),r},w.filter=w.select=function(e,t,n){var r=[];return e==null?r:p&&e.filter===p?e.filter(t,n):(E(e,function(e,i,s){t.call(n,e,i,s)&&(r[r.length]=e)}),r)},w.reject=function(e,t,n){var r=[];return e==null?r:(E(e,function(e,i,s){t.call(n,e,i,s)||(r[r.length]=e)}),r)},w.every=w.all=function(e,t,r){var i=!0;return e==null?i:d&&e.every===d?e.every(t,r):(E(e,function(e,s,o){if(!(i=i&&t.call(r,e,s,o)))return n}),i)};var S=w.some=w.any=function(e,t,r){t=t||w.identity;var i=!1;return e==null?i:v&&e.some===v?e.some(t,r):(E(e,function(e,s,o){if(i|=t.call(r,e,s,o))return n}),!!i)};w.include=w.contains=function(e,t){var n=!1;return e==null?n:m&&e.indexOf===m?e.indexOf(t)!=-1:(S(e,function(e){if(n=e===t)return!0}),n)},w.invoke=function(e,t){var n=s.call(arguments,2);return w.map(e,function(e){return(t.call?t||e:e[t]).apply(e,n)})},w.pluck=function(e,t){return w.map(e,function(e){return e[t]})},w.max=function(e,t,n){if(!t&&w.isArray(e))return Math.max.apply(Math,e);var r={computed:-Infinity};return E(e,function(e,i,s){i=t?t.call(n,e,i,s):e,i>=r.computed&&(r={value:e,computed:i})}),r.value},w.min=function(e,t,n){if(!t&&w.isArray(e))return Math.min.apply(Math,e);var r={computed:Infinity};return E(e,function(e,i,s){i=t?t.call(n,e,i,s):e,i<r.computed&&(r={value:e,computed:i})}),r.value},w.sortBy=function(e,t,n){return w.pluck(w.map(e,function(e,r,i){return{value:e,criteria:t.call(n,e,r,i)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;return n<r?-1:n>r?1:0}),"value")},w.groupBy=function(e,t){var n={};return E(e,function(e,r){var i=t(e,r);(n[i]||(n[i]=[])).push(e)}),n},w.sortedIndex=function(e,t,n){n||(n=w.identity);for(var r=0,i=e.length;r<i;){var s=r+i>>1;n(e[s])<n(t)?r=s+1:i=s}return r},w.toArray=function(e){return e?e.toArray?e.toArray():w.isArray(e)?s.call(e):w.isArguments(e)?s.call(e):w.values(e):[]},w.size=function(e){return w.toArray(e).length},w.first=w.head=function(e,t,n){return t!=null&&!n?s.call(e,0,t):e[0]},w.rest=w.tail=function(e,t,n){return s.call(e,t==null||n?1:t)},w.last=function(e){return e[e.length-1]},w.compact=function(e){return w.filter(e,function(e){return!!e})},w.flatten=function(e){return w.reduce(e,function(e,t){return w.isArray(t)?e.concat(w.flatten(t)):(e[e.length]=t,e)},[])},w.without=function(e){return w.difference(e,s.call(arguments,1))},w.uniq=w.unique=function(e,t){return w.reduce(e,function(e,n,r){if(0==r||(t===!0?w.last(e)!=n:!w.include(e,n)))e[e.length]=n;return e},[])},w.union=function(){return w.uniq(w.flatten(arguments))},w.intersection=w.intersect=function(e){var t=s.call(arguments,1);return w.filter(w.uniq(e),function(e){return w.every(t,function(t){return w.indexOf(t,e)>=0})})},w.difference=function(e,t){return w.filter(e,function(e){return!w.include(t,e)})},w.zip=function(){for(var e=s.call(arguments),t=w.max(w.pluck(e,"length")),n=Array(t),r=0;r<t;r++)n[r]=w.pluck(e,""+r);return n},w.indexOf=function(e,t,n){if(e==null)return-1;var r;if(n)return n=w.sortedIndex(e,t),e[n]===t?n:-1;if(m&&e.indexOf===m)return e.indexOf(t);n=0;for(r=e.length;n<r;n++)if(e[n]===t)return n;return-1},w.lastIndexOf=function(e,t){if(e==null)return-1;if(g&&e.lastIndexOf===g)return e.lastIndexOf(t);for(var n=e.length;n--;)if(e[n]===t)return n;return-1},w.range=function(e,t,n){arguments.length<=1&&(t=e||0,e=0),n=arguments[2]||1;for(var r=Math.max(Math.ceil((t-e)/n),0),i=0,s=Array(r);i<r;)s[i++]=e,e+=n;return s},w.bind=function(e,t){if(e.bind===b&&b)return b.apply(e,s.call(arguments,1));var n=s.call(arguments,2);return function(){return e.apply(t,n.concat(s.call(arguments)))}},w.bindAll=function(e){var t=s.call(arguments,1);return t.length==0&&(t=w.functions(e)),E(t,function(t){e[t]=w.bind(e[t],e)}),e},w.memoize=function(e,t){var n={};return t||(t=w.identity),function(){var r=t.apply(this,arguments);return a.call(n,r)?n[r]:n[r]=e.apply(this,arguments)}},w.delay=function(e,t){var n=s.call(arguments,2);return setTimeout(function(){return e.apply(e,n)},t)},w.defer=function(e){return w.delay.apply(w,[e,1].concat(s.call(arguments,1)))};var x=function(e,t,n){var r;return function(){var i=this,s=arguments,o=function(){r=null,e.apply(i,s)};n&&clearTimeout(r);if(n||!r)r=setTimeout(o,t)}};w.throttle=function(e,t){return x(e,t,!1)},w.debounce=function(e,t){return x(e,t,!0)},w.once=function(e){var t=!1,n;return function(){return t?n:(t=!0,n=e.apply(this,arguments))}},w.wrap=function(e,t){return function(){var n=[e].concat(s.call(arguments));return t.apply(this,n)}},w.compose=function(){var e=s.call(arguments);return function(){for(var t=s.call(arguments),n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},w.after=function(e,t){return function(){if(--e<1)return t.apply(this,arguments)}},w.keys=y||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[],n;for(n in e)a.call(e,n)&&(t[t.length]=n);return t},w.values=function(e){return w.map(e,w.identity)},w.functions=w.methods=function(e){var t=[],n;for(n in e)w.isFunction(e[n])&&t.push(n);return t.sort()},w.extend=function(e){return E(s.call(arguments,1),function(t){for(var n in t)t[n]!==void 0&&(e[n]=t[n])}),e},w.defaults=function(e){return E(s.call(arguments,1),function(t){for(var n in t)e[n]==null&&(e[n]=t[n])}),e},w.clone=function(e){return w.isArray(e)?e.slice():w.extend({},e)},w.tap=function(e,t){return t(e),e},w.isEqual=function(e,t){if(e===t)return!0;var n=typeof e;if(n!=typeof t)return!1;if(e==t)return!0;if(!e&&t||e&&!t)return!1;e._chain&&(e=e._wrapped),t._chain&&(t=t._wrapped);if(e.isEqual)return e.isEqual(t);if(t.isEqual)return t.isEqual(e);if(w.isDate(e)&&w.isDate(t))return e.getTime()===t.getTime();if(w.isNaN(e)&&w.isNaN(t))return!1;if(w.isRegExp(e)&&w.isRegExp(t))return e.source===t.source&&e.global===t.global&&e.ignoreCase===t.ignoreCase&&e.multiline===t.multiline;if(n!=="object")return!1;if(e.length&&e.length!==t.length)return!1;n=w.keys(e);var r=w.keys(t);if(n.length!=r.length)return!1;for(var i in e)if(!(i in t)||!w.isEqual(e[i],t[i]))return!1;return!0},w.isEmpty=function(e){if(w.isArray(e)||w.isString(e))return e.length===0;for(var t in e)if(a.call(e,t))return!1;return!0},w.isElement=function(e){return!!e&&e.nodeType==1},w.isArray=i||function(e){return u.call(e)==="[object Array]"},w.isObject=function(e){return e===Object(e)},w.isArguments=function(e){return!!e&&!!a.call(e,"callee")},w.isFunction=function(e){return!(!e||!e.constructor||!e.call||!e.apply)},w.isString=function(e){return!!(e===""||e&&e.charCodeAt&&e.substr)},w.isNumber=function(e){return!!(e===0||e&&e.toExponential&&e.toFixed)},w.isNaN=function(e){return e!==e},w.isBoolean=function(e){return e===!0||e===!1},w.isDate=function(e){return!(!e||!e.getTimezoneOffset||!e.setUTCFullYear)},w.isRegExp=function(e){return!(!e||!e.test||!e.exec||!e.ignoreCase&&e.ignoreCase!==!1)},w.isNull=function(e){return e===null},w.isUndefined=function(e){return e===void 0},w.noConflict=function(){return e._=t,this},w.identity=function(e){return e},w.times=function(e,t,n){for(var r=0;r<e;r++)t.call(n,r)},w.mixin=function(e){E(w.functions(e),function(t){k(t,w[t]=e[t])})};var T=0;w.uniqueId=function(e){var t=T++;return e?e+t:t},w.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g},w.template=function(e,t){var n=w.templateSettings;return n="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+e.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(n.interpolate,function(e,t){return"',"+t.replace(/\\'/g,"'")+",'"}).replace(n.evaluate||null,function(e,t){return"');"+t.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",n=new Function("obj",n),t?n(t):n};var N=function(e){this._wrapped=e};w.prototype=N.prototype;var C=function(e,t){return t?w(e).chain():e},k=function(e,t){N.prototype[e]=function(){var e=s.call(arguments);return o.call(e,this._wrapped),C(t.apply(w,e),this._chain)}};w.mixin(w),E(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=r[e];N.prototype[e]=function(){return t.apply(this._wrapped,arguments),C(this._wrapped,this._chain)}}),E(["concat","join","slice"],function(e){var t=r[e];N.prototype[e]=function(){return C(t.apply(this._wrapped,arguments),this._chain)}}),N.prototype.chain=function(){return this._chain=!0,this},N.prototype.value=function(){return this._wrapped}}(),define("lib/underscore.min",function(){}),function(e){function n(){var e=arguments[0],t=n.cache;if(!t[e]||!t.hasOwnProperty(e))t[e]=n.parse(e);return n.format.call(null,t[e],arguments)}function i(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}function s(e,t){return Array(t+1).join(e)}var t={not_string:/[^s]/,number:/[diefg]/,json:/[j]/,not_json:/[^j]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-gijosuxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[\+\-]/};n.format=function(e,r){var o=1,u=e.length,a="",f,l=[],c,h,p,d,v,m,g=!0,y="";for(c=0;c<u;c++){a=i(e[c]);if(a==="string")l[l.length]=e[c];else if(a==="array"){p=e[c];if(p[2]){f=r[o];for(h=0;h<p[2].length;h++){if(!f.hasOwnProperty(p[2][h]))throw new Error(n("[sprintf] property '%s' does not exist",p[2][h]));f=f[p[2][h]]}}else p[1]?f=r[p[1]]:f=r[o++];i(f)=="function"&&(f=f());if(t.not_string.test(p[8])&&t.not_json.test(p[8])&&i(f)!="number"&&isNaN(f))throw new TypeError(n("[sprintf] expecting number but found %s",i(f)));t.number.test(p[8])&&(g=f>=0);switch(p[8]){case"b":f=f.toString(2);break;case"c":f=String.fromCharCode(f);break;case"d":case"i":f=parseInt(f,10);break;case"j":f=JSON.stringify(f,null,p[6]?parseInt(p[6]):0);break;case"e":f=p[7]?f.toExponential(p[7]):f.toExponential();break;case"f":f=p[7]?parseFloat(f).toFixed(p[7]):parseFloat(f);break;case"g":f=p[7]?parseFloat(f).toPrecision(p[7]):parseFloat(f);break;case"o":f=f.toString(8);break;case"s":f=(f=String(f))&&p[7]?f.substring(0,p[7]):f;break;case"u":f>>>=0;break;case"x":f=f.toString(16);break;case"X":f=f.toString(16).toUpperCase()}t.json.test(p[8])?l[l.length]=f:(t.number.test(p[8])&&(!g||p[3])?(y=g?"+":"-",f=f.toString().replace(t.sign,"")):y="",v=p[4]?p[4]==="0"?"0":p[4].charAt(1):" ",m=p[6]-(y+f).length,d=p[6]?m>0?s(v,m):"":"",l[l.length]=p[5]?y+f+d:v==="0"?y+d+f:d+y+f)}}return l.join("")},n.cache={},n.parse=function(e){var n=e,r=[],i=[],s=0;while(n){if((r=t.text.exec(n))!==null)i[i.length]=r[0];else if((r=t.modulo.exec(n))!==null)i[i.length]="%";else{if((r=t.placeholder.exec(n))===null)throw new SyntaxError("[sprintf] unexpected placeholder");if(r[2]){s|=1;var o=[],u=r[2],a=[];if((a=t.key.exec(u))===null)throw new SyntaxError("[sprintf] failed to parse named argument key");o[o.length]=a[1];while((u=u.substring(a[0].length))!=="")if((a=t.key_access.exec(u))!==null)o[o.length]=a[1];else{if((a=t.index_access.exec(u))===null)throw new SyntaxError("[sprintf] failed to parse named argument key");o[o.length]=a[1]}r[2]=o}else s|=2;if(s===3)throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported");i[i.length]=r}n=n.substring(r[0].length)}return i};var r=function(e,t,r){return r=(t||[]).slice(0),r.splice(0,0,e),n.apply(null,r)};typeof exports!="undefined"?(exports.sprintf=n,exports.vsprintf=r):(e.sprintf=n,e.vsprintf=r,typeof define=="function"&&define.amd&&define("lib/sprintf",[],function(){return{sprintf:n,vsprintf:r}}))}(typeof window=="undefined"?this:window);var isInt=function(e){return e%1===0},requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,50)},translate=function(e,t){if(e){typeof translations!="undefined"&&translations[e]&&translations[e].length>0&&(e=translations[e]);if(t&&t.length>0)try{e=vsprintf(e,t)}catch(n){}}return e};define("util",function(){});var Guid=Guid||function(){var e="00000000-0000-0000-0000-000000000000",t=function(e,n,r){return e.length>=n?e:t(r+e,n,r||" ")},n=function(e){var n=e.toString(16);return t(n,4,"0")},r=function(){var e=new window.Uint16Array(8);return window.crypto.getRandomValues(e),[n(e[0])+n(e[1]),n(e[2]),n(e[3]),n(e[4]),n(e[5])+n(e[6])+n(e[7])].join("-")},i=function(){var e=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+Math.random()*16)%16|0;return e=Math.floor(e/16),(t==="x"?n:n&7|8).toString(16)})},s=function(){var e=typeof window.crypto!="undefined",t=e&&typeof window.crypto.getRandomValues!="undefined";return e&&t?r():i()};return{newGuid:s,empty:e}}();define("guid",function(){});var gui=gui||function(){var e=function(e){return typeof e=="string"?e==="body"?document.body:document.getElementById(e):e},t=function(e){return document.getElementById(e)!=null},n=function(t){var n=e(t);n&&(n.style.display="none")},r=function(t){var n=e(t);n&&(n.style.display="block")},i=function(t,n){var r=e(t);return r?r.querySelectorAll(n):null},s=function(t,n){var r=e(t);if(!r)return;r.classList?r.classList.add(n):r.className+=" "+n},o=function(t,n){var r=e(t);if(!r)return;r.classList?r.classList.remove(n):r.className=r.className.replace(new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi")," ")},u=function(t,n,r,i){var u=e(t);if(!u)return;var a=u.querySelectorAll(r);for(var f in a){var l=a[f];l==i?s(l,n):typeof l=="object"&&o(l,n)}},a=function(t,n){var r=e(t);return r?r.classList?r.classList.contains(n):(new RegExp("(^| )"+n+"( |$)","gi")).test(r.className):!1},f=function(e,t){return e&&(a(e,t)||e.parentNode&&f(e.parentNode,t))},l=function(e,t){return e&&(e.id==t||e.parentNode&&l(e.parentNode,t))},c=function(t,n){var r=e(t);return r&&(r.innerHTML=n),r},h=function(t,n,r){var i=e(t);i&&i.setAttribute(n,r)},p=function(t,n){var r=e(t);r&&(r.style.backgroundImage=n&&n.length>0?"url('"+n+"')":"none")},d=function(t){var n=e(t);n&&n.parentNode&&n.parentNode.removeChild(n)},v=function(t,n,r){var i=e(t);if(!i)return null;var s=function(e){r&&!r(e)&&e&&(e.preventDefault(),e.stopPropagation())};return i.addEventListener(n,s,!1),s},m=function(t,n,r){if(!r)return;var i=e(t);i&&i.removeEventListener(n,r,!1)},g=function(t){if(Config_Extern&&Config_Extern.platform=="iphone")return;var n=e(t);n&&n.focus()},y=function(t){var n=e(t);n&&n.blur()},b=function(t){var n=e(t);return n?n.offsetWidth:0},w=function(t){var n=e(t);return n?n.offsetHeight:0},E=function(t){var n=e(t);if(!n)return{left:0,top:0};var r=n.getBoundingClientRect();return{top:r.top+document.body.scrollTop,left:r.left+document.body.scrollLeft}},S=function(t){var n=e(t);return{left:n.offsetLeft,top:n.offsetTop}},x=function(t,n){var r=n.changedTouches?n.changedTouches:n.originalEvent?n.originalEvent.changedTouches:null;r&&r.length>0&&(n=r[0]);if(n.pageX!==undefined){var i=gui.getDom("gamecontainer").style.zoom;i||(i=1);var s=e(t),o=s.getBoundingClientRect(),u={x:n.pageX/i-o.left,y:n.pageY/i-o.top};return o.width!=s.offsetWidth&&(u.x*=s.offsetWidth/o.width,u.y*=s.offsetHeight/o.height),u}return{x:n.offsetX?n.offsetX:n.layerX,y:n.offsetY?n.offsetY:n.layerY}},T=function(t){var n=e(t);return n?!!(n.offsetWidth||n.offsetHeight||n.getClientRects().length):!1},N=function(t,n,r){var i=e(t);if(!i)return;if(!n){i.onclick=null;return}i.onclick=function(e){if(e){e.stopPropagation(),e.preventDefault();var t=x(i,e);n(e,t.x,t.y)}else n(e);return!1},!r&&!f(i,"scrollable")&&v(i,"touchstart",function(e){if(e){e.stopPropagation(),e.preventDefault();var t=x(i,e);n(e,t.x,t.y)}else n(e);return!1})},C=function(t,n){var r=e(t);if(!r)return;if(!n){r.onclick=null;return}r.oncontextmenu=function(e){if(e){e.stopPropagation(),e.preventDefault();var t=x(r,e);n(e,t.x,t.y)}else n(e);return!1}},k=function(t,n,r){var i=e(t);if(!i)return;var s=i.querySelectorAll(n);for(var o in s){var u=s[o];r?u.onclick=function(e){return e&&(e.stopPropagation(),e.preventDefault()),r(e),!1}:u.onclick=null}},L=function(t,n,r){var i=e(t);if(!i)return null;var s=i.querySelector(n);return s?(s.innerHTML=r,s):null},A=function(t,n,r,i){var s=e(t);if(!s)return null;var o=s.querySelector(n);return o?(o.setAttribute(r,i),o):null},O=function(e,t){if(t){var n=!0;for(var r in t)e+=(n?"?":"&")+r+"="+encodeURIComponent(t[r]),n=!1}var i=new XMLHttpRequest;i.open("GET",e,!0),i.send()},M=function(t,n,r,i){var s=e(t);if(!s)return null;var o=s.cloneNode(!0);o.style.display="block",s.parentNode.appendChild(o),n&&setTimeout(function(){o&&o.parentNode&&o.parentNode.removeChild(o)},n*1e3),i&&(o.onclick=function(e){i(o)},o.ontouchstart=function(e){e&&(e.stopPropagation(),e.preventDefault()),i(o)});if(r){var u=s.parentNode.childNodes;if(u.length>1+r){var a=u.length-1-r,f=[];for(var l=0;l<u.length&&f.length<a;l++){var c=s.parentNode.childNodes[l];c!=s&&c!=o&&f.push(c)}for(var l in f)s.parentNode.removeChild(f[l])}}return o},_=function(e,t,n,r,i){var s=new XMLHttpRequest;n&&(s.onload=function(){if(!s.responseText)return;try{n(t?JSON.parse(s.responseText):s.responseText)}catch(e){r&&r(s,null,e)}}),r&&(s.onerror=function(e){r(s,s.status,"file not found")}),s.open("GET",e,!0),i&&s.overrideMimeType&&s.overrideMimeType(i),s.send(null)},D=function(t,n,r){var i=e(t);if(!i)return;i.innerHTML+=n+(r?"<br>":""),i.scrollTop=i.scrollHeight},P=function(e){v(window,"resize",e)},H=function(e){v(window,"unload",e)},B=function(t,n){var r=e(t);if(!r)return;r.style.opacity=n},j=function(e,t){q(e,1,t)},F=function(e,t){q(e,0,t)},I={},q=function(t,n,r,i){var s=e(t);if(!s)return;var o=r&&typeof r=="number"?r:r=="fast"?200:400;s.style.transition="opacity "+o/1e3+"s linear",s.style.opacity=n,n>0?(s.style.display="block",i&&(I[t]=setTimeout(function(){delete I[t],s.style.transition="",i()},o))):I[t]=setTimeout(function(){delete I[t],s&&(s.style.display="none",s.style.transition="",s.style.opacity=1),i&&i()},o)},R=function(e,t,n){I[e]&&(clearTimeout(I[e]),delete I[e])};return{addClass:s,ajax:_,animate:q,appendAndScroll:D,bind:v,blur:y,callURL:O,cloneAndTimeout:M,exists:t,fadeIn:j,fadeOut:F,find:i,focus:g,getDom:e,getHeight:w,getOffset:E,getPosition:S,getPositionFromEvent:x,getWidth:b,hasClass:a,hide:n,isInClass:f,isInDom:l,isVisible:T,remove:d,removeClass:o,setAlpha:B,setAttribute:h,setBackgroundImage:p,setChildAttribute:A,setChildClass:u,setChildClick:k,setChildHTML:L,setClick:N,setHTML:c,setResize:P,setRightClick:C,setUnload:H,show:r,stop:R,unbind:m}}();define("gui",function(){});var bitsToNum=function(e){return e.reduce(function(e,t){return e*2+t},0)},byteToBitArr=function(e){var t=[];for(var n=7;n>=0;n--)t.push(!!(e&1<<n));return t},Stream=function(e){this.data=e,this.len=this.data.length,this.pos=0,this.readByte=function(){if(this.pos>=this.data.length)throw new Error("Attempted to read past end of stream.");return e.charCodeAt(this.pos++)&255},this.readBytes=function(e){var t=[];for(var n=0;n<e;n++)t.push(this.readByte());return t},this.read=function(e){var t="";for(var n=0;n<e;n++)t+=String.fromCharCode(this.readByte());return t},this.readUnsigned=function(){var e=this.readBytes(2);return(e[1]<<8)+e[0]}},lzwDecode=function(e,t){var n=0,r=function(e){var r=0;for(var i=0;i<e;i++)t.charCodeAt(n>>3)&1<<(n&7)&&(r|=1<<i),n++;return r},i=[],s=1<<e,o=s+1,u=e+1,a=[],f=function(){a=[],u=e+1;for(var t=0;t<s;t++)a[t]=[t];a[s]=[],a[o]=null},l,c;for(;;){c=l,l=r(u);if(l===s){f();continue}if(l===o)break;if(l<a.length)c!==s&&a.push(a[c].concat(a[l][0]));else{if(l!==a.length)throw new Error("Invalid LZW code.");a.push(a[c].concat(a[c][0]))}i.push.apply(i,a[l]),a.length===1<<u&&u<12&&u++}return i},parseGIF=function(e,t){t||(t={});var n=function(t){var n=[];for(var r=0;r<t;r++)n.push(e.readBytes(3));return n},r=function(){var t,n;n="";do t=e.readByte(),n+=e.read(t);while(t!==0);return n},i=function(){var r={};r.sig=e.read(3),r.ver=e.read(3);if(r.sig!=="GIF")throw new Error("Not a GIF file.");r.width=e.readUnsigned(),r.height=e.readUnsigned();var i=byteToBitArr(e.readByte());r.gctFlag=i.shift(),r.colorRes=bitsToNum(i.splice(0,3)),r.sorted=i.shift(),r.gctSize=bitsToNum(i.splice(0,3)),r.bgColor=e.readByte(),r.pixelAspectRatio=e.readByte(),r.gctFlag&&(r.gct=n(1<<r.gctSize+1)),t.hdr&&t.hdr(r)},s=function(n){var i=function(n){var r=e.readByte(),i=byteToBitArr(e.readByte());n.reserved=i.splice(0,3),n.disposalMethod=bitsToNum(i.splice(0,3)),n.userInput=i.shift(),n.transparencyGiven=i.shift(),n.delayTime=e.readUnsigned(),n.transparencyIndex=e.readByte(),n.terminator=e.readByte(),t.gce&&t.gce(n)},s=function(e){e.comment=r(),t.com&&t.com(e)},o=function(n){var i=e.readByte();n.ptHeader=e.readBytes(12),n.ptData=r(),t.pte&&t.pte(n)},u=function(n){var i=e.readByte();n.identifier=e.read(8),n.authCode=e.read(3),i>11&&e.read(i-8-3),n.appData=r(),t.app&&t.app[n.identifier]&&t.app[n.identifier](n)},a=function(e){e.data=r(),t.unknown&&t.unknown(e)};n.label=e.readByte();switch(n.label){case 249:n.extType="gce",i(n);break;case 254:n.extType="com",s(n);break;case 1:n.extType="pte",o(n);break;case 255:n.extType="app",u(n);break;default:n.extType="unknown",a(n)}},o=function(i){var s=function(e,t){var n=new Array(e.length),r=e.length/t,i=function(r,i){var s=e.slice(i*t,(i+1)*t);n.splice.apply(n,[r*t,t].concat(s))},s=[0,4,2,1],o=[8,8,4,2],u=0;for(var a=0;a<4;a++)for(var f=s[a];f<r;f+=o[a])i(f,u),u++;return n};i.leftPos=e.readUnsigned(),i.topPos=e.readUnsigned(),i.width=e.readUnsigned(),i.height=e.readUnsigned();var o=byteToBitArr(e.readByte());i.lctFlag=o.shift(),i.interlaced=o.shift(),i.sorted=o.shift(),i.reserved=o.splice(0,2),i.lctSize=bitsToNum(o.splice(0,3)),i.lctFlag&&(i.lct=n(1<<i.lctSize+1)),i.lzwMinCodeSize=e.readByte();var u=r();i.pixels=lzwDecode(i.lzwMinCodeSize,u),i.interlaced&&(i.pixels=s(i.pixels,i.width)),t.img&&t.img(i)},u=function(){var n={};n.sentinel=e.readByte();switch(String.fromCharCode(n.sentinel)){case"!":n.type="ext",s(n);break;case",":n.type="img",o(n);break;case";":n.type="eof",t.eof&&t.eof(n);break;default:t.error&&t.error("Unknown block: 0x"+n.sentinel.toString(16)),n.type="eof",t.eof&&t.eof(n)}n.type!=="eof"&&(window.navigator?setTimeout(u,0):u())},a=function(){i(),window.navigator?setTimeout(u,0):u()};a()};typeof exports!="undefined"&&(exports.Stream=Stream,exports.parseGIF=parseGIF),define("lib/gif",function(){}),define("main",["app","game","lib/require","lib/class","lib/underscore.min","lib/sprintf","util","guid","gui","lib/gif"],function(e,t){function i(e){document.readyState!="loading"?e():document.addEventListener?document.addEventListener("DOMContentLoaded",e):document.attachEvent("onreadystatechange",function(){document.readyState!="loading"&&e()})}var n,r,s=function(){i(function(){n=new e,n.center(),j(),window.autoStartGame&&n.tryStartGame()})},o=0,u=0,a=300,f=function(e){return newTime=Date.now(),o&&newTime>=o+a&&(u=0),o=newTime,!e.pageX&&!e.changedTouches&&!e.originalEvent?!0:B(e)?!0:(n.center(),n.setMouseCoordinates(e),!gui.isVisible("deathscreen")&&!gui.isVisible("reconnectscreen")&&r&&r.click()&&e&&(e.stopPropagation(),e.preventDefault()),n.hideWindows(),!1)},l=function(){if(!gui.getDom("movepad"))return;gui.bind("movepad","touchstart",c),gui.bind("movepad","touchmove",h),gui.bind("movepad","touchend",p),gui.bind("movepad","touchcancel",p),gui.bind("movepad","touchleave",p)},c=function(e){e&&(e.stopPropagation(),e.preventDefault());var t=gui.getPositionFromEvent("movepad",e);n.movepadDown=!0,n.config.movepadalpha&&gui.setAlpha("movepad",1),d(t.x,t.y),r&&r.unlockSoundsOnMobile()},h=function(e){e&&(e.stopPropagation(),e.preventDefault());if(!n.movepadDown)return;var t=gui.getPositionFromEvent("movepad",e);d(t.x,t.y)},p=function(e){e&&(e.stopPropagation(),e.preventDefault());if(!n.movepadDown)return;n.movepadDown=!1,n.config.movepadalpha&&gui.setAlpha("movepad",n.config.movepadalpha)},d=function(e,t){var r=e-gui.getWidth("movepad")/2,i=t-gui.getHeight("movepad")/2,s=Math.atan2(i,r),o=Math.PI/4,u=Math.round(s/o),a=u==2||u==-2?0:Math.abs(u)<2?1:-1,f=u>0&&u<4?1:u<0&&u>-4?-1:0;n.movepadVector={x:a,y:f}},v=function(){if(!gui.getDom("weaponpad"))return;gui.bind("weaponpad","touchstart",m),gui.bind("weaponpad","touchmove",g),gui.bind("weaponpad","touchend",y),gui.bind("weaponpad","touchcancel",y),gui.bind("weaponpad","touchleave",y),gui.bind("weaponpad","mousedown",m),gui.bind("weaponpad","mousemove",g),gui.bind("weaponpad","mouseup",y),gui.bind("weaponpad","mouseleave",y)},m=function(e){e&&(e.stopPropagation(),e.preventDefault());var t=gui.getPositionFromEvent("weaponpad",e);n.weaponpadDown=!0,n.config.movepadalpha&&gui.setAlpha("weaponpad",1),b(t.x,t.y),r&&r.playerAttack(n.weaponpadDirection)},g=function(e){e&&(e.stopPropagation(),e.preventDefault());if(!n.weaponpadDown)return;var t=gui.getPositionFromEvent("weaponpad",e);t.x>=0&&t.y>=0&&b(t.x,t.y)},y=function(e){e&&(e.stopPropagation(),e.preventDefault());if(!n.weaponpadDown)return;n.weaponpadDown=!1,n.config.movepadalpha&&gui.setAlpha("weaponpad",n.config.movepadalpha)},b=function(e,t){var r=e-gui.getWidth("weaponpad")/2,i=t-gui.getHeight("weaponpad")/2;n.weaponpadDirection=Math.abs(r)>=Math.abs(i)?r>0?4:3:i>0?2:1,n.weaponpadAngle=Math.atan2(-i,r)},w=function(){gui.bind("bombbutton","touchstart",E),gui.bind("bombbutton","touchend",S),gui.bind("bombbutton","touchcancel",S),gui.bind("bombbutton","touchleave",S),gui.bind("bombbutton","mousedown",E),gui.bind("bombbutton","mouseup",S),gui.bind("bombbutton","mouseleave",S),gui.bind("lightsbutton","mousedown",x),gui.bind("lightsbutton","touchstart",x),gui.bind("hornbutton","mousedown",T),gui.bind("hornbutton","touchstart",T),gui.bind("mode2button","mousedown",N),gui.bind("mode2button","touchstart",N)},E=function(e){e&&(e.stopPropagation(),e.preventDefault()),n.itemkeyDown=!0,r&&r.player&&r.player.useSecondaryWeapon(!0)},S=function(e){e&&(e.stopPropagation(),e.preventDefault()),n.itemkeyDown=!1},x=function(e){e&&(e.stopPropagation(),e.preventDefault()),r&&r.player&&r.player.useLightsButton()},T=function(e){e&&(e.stopPropagation(),e.preventDefault()),r&&r.player&&r.player.useHornButton()},N=function(e){e&&(e.stopPropagation(),e.preventDefault()),r&&r.player&&r.player.useMode2Button()},C=function(e){gui.bind("hotkey"+e,"touchstart",function(t){A(e)}),gui.bind("hotkey"+e,"touchend",function(t){O(e)}),gui.bind("hotkey"+e,"touchcancel",function(t){M(e)}),gui.bind("hotkey"+e,"touchleave",function(t){M(e)}),gui.bind("hotkey"+e,"mousedown",function(t){A(e)}),gui.bind("hotkey"+e,"mouseup",function(t){O(e)}),gui.bind("hotkey"+e,"mouseleave",function(t){M(e)})},k={},L=null,A=function(e){if(k[e])return;k[e]=!0,L&&clearTimeout(L),L=setTimeout(function(){k[e]&&(k[e]=!1,r.activateHotkey(e,!1))},500)},O=function(e){L&&(clearTimeout(L),L=null),k[e]&&r.activateHotkey(e,!0),k[e]=!1},M=function(e){L&&(clearTimeout(L),L=null),k[e]=!1},_=function(){D()?H():P(gui.getDom("gamecontainer"))},D=function(){return document.fullscreenElement?document.fullscreenElement:document.msFullscreenElement?document.msFullscreenElement:document.mozFullScreenElement?document.mozFullScreenElement:document.webkitFullscreenElement?document.webkitFullscreenElement:null},P=function(e){e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullScreen&&(e.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT),document.webkitFullscreenElement||e.webkitRequestFullscreen()),window.navigator&&window.navigator.userAgent.match(/(Android)/g)&&(e.style.zoom=.5)},H=function(){document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen(),window.navigator&&window.navigator.userAgent.match(/(Android)/g)&&(gui.getDom("gamecontainer").style.zoom=1)},B=function(e){return gui.isVisible("deathscreen")||gui.isVisible("reconnectscreen")||gui.isVisible("startscreen")||gui.isVisible("modal_background")||gui.isVisible("newpopup")||gui.isVisible("identifyscreen")?!0:gui.isInClass(e.target,"resizablewindow")||gui.isInDom(e.target,"scriptgui")||gui.isInDom(e.target,"webads")?!0:e.target.href?!0:!1},j=function(){var e=gui.getDom("entities"),i=gui.getDom("background"),s=gui.getDom("minimapcanvas"),c=gui.getDom("chatinput"),h=gui.getDom("winnercanvas");if(!e)return;r=new t(n),r.setup(e,i,s,c,h),n.setGame(r),r.preloadMaps(),r.preloadAnimations(),gui.setClick("movementhelp",function(e,t,r){if(r>=gui.getHeight("movementhelp")/2&&n.config.gameads&&n.config.gameads.length>0&&n.config.gameads[0].showinmovementhelp)return;gui.fadeOut("movementhelp")}),gui.setClick("chatbutton",function(){gui.isVisible("chatbox")?n.hideChat():n.showChat()}),gui.setClick("clanchatbutton",function(){r.menu.showMenuByName("writeclanmessage",!0)}),gui.setClick("registerbutton",function(){r.menu.showMenuByName("register",!0)}),gui.setClick("minimap",function(){r.minimap.onClick()}),gui.setClick("invitebutton",function(){r.menu.showMenuByName("invitefriends",!0)}),gui.setClick("furniturebutton",function(){r.menu.showMenuByName("furnitureshops",!0)}),gui.setClick("menubutton",function(){r.menu.showMenuByName("main",!0)}),gui.setClick("homebutton",function(){r.menu.showMenuByName("homemenu",!0)}),gui.setClick("coinsbutton",function(){r.shop.showBuyCoinsDialog("game",null)}),gui.setClick("postpicturebutton",function(){r.storymanager.showStoryInterface()}),gui.setClick("fullscreenbutton",function(){_()}),gui.setClick("logoutbutton",function(){r.menu.showConfirmLogout()}),gui.setClick("recordclosebutton",function(){r.storymanager.closeRecordStory()}),gui.setClick("recordstartbutton",function(){r.storymanager.startRecordStory()}),gui.setClick("recordstopbutton",function(){r.storymanager.stopRecordStory()}),l(),v(),w(),gui.getDom("hotkeys")&&(C(1),C(2),C(3),C(4),C(5)),gui.setClick("winnercanvas",function(){r&&r.requestWinnerProfile()}),gui.setClick("playbutton",function(){n.startGame()}),gui.setClick("identifydevicebutton",function(){r.identifyByType("device")}),gui.setClick("identifyemailbutton",function(){r.showIdentifyByEmail()}),gui.setClick("identifyemailsendbutton",function(){r.sendIdentifyByEmail()}),gui.setClick("identifyemailbackbutton",function(){r.closeIdentifyByEmail()}),gui.setClick("identifyfacebookbutton",function(){r.identifyByType("facebook")},!0),gui.setClick("identifysteambutton",function(){r.identifyByType("steam")},!0),gui.setClick("identifygooglebutton",function(){r.identifyByType("google")},!0),gui.setClick("identifycognitobutton",function(){r.identifyByType("cognito")},!0),document.addEventListener("touchstart",function(){},!1),document.addEventListener("touchmove",function(e){if(e.target&&(gui.hasClass(e.target,"scrollable")||e.target.parentNode&&gui.hasClass(e.target.parentNode,"scrollable")))return;e.preventDefault()}),gui.setHTML("underconstruction",translate("Avalonia allows you to build a house, fight monsters and conquer castles! It's fresh and new, so we hope you will have fun and support us. Press play and Enjoy! :-)")),gui.setAttribute("coinsbutton","help",translate("Get coins for cool items!")),gui.setAttribute("invitebutton","help",translate("Invite friends to the game to build your clan!")),gui.setAttribute("furniturebutton","help",translate("Get furniture for your house!")),gui.setAttribute("postpicturebutton","help",translate("Record a story")),gui.setAttribute("logoutbutton","help",translate("Logout from Account!")),gui.setAttribute("fullscreenbutton","help",translate("Switch to Fullscreen!")+" (F11)"),gui.setAttribute("clanchatbutton","help",translate("Click to send messages to your clan!")),gui.setAttribute("chatbutton","help",translate("Click to chat with people!")),gui.setAttribute("menubutton","help",translate("Open the menu!")),gui.setAttribute("homebutton","help",translate("Go back to start!")),gui.setAttribute("pmbutton","help",translate("View the message!")),r.onPlayerDeath(function(e){if(gui.isVisible("reconnectscreen"))return;var t;e&&e.name?t='<div style="margin-left:80px;">'+translate("You've been killed by %s!",[e.name])+(e.hitPoints&&e.maxHitPoints?"<br>"+translate("Health of %s:",[e.name])+" "+e.hitPoints+"/"+e.maxHitPoints:"")+"</div>":t=translate("You died!");var n=gui.setHTML("deathmessage",t);if(n&&e){if(e.head){var i=n.appendChild(r.menu.getImageDivForMenuItem({itemtype:"head",head:r.animationmanager.expandGameFilename("head",e.head)}));i.style.left="44px",i.style.top="38px"}if(e.hat){var i=n.appendChild(r.menu.getImageDivForMenuItem({itemtype:"hat",hat:r.animationmanager.expandGameFilename("hat",e.hat)}));i.style.left="44px",i.style.top="22px"}}gui.fadeIn("deathscreen")}),gui.setClick("pmbutton",function(){r.showNextPM()}),gui.setClick("foreground",f);var p=function(e){if(!r.player||!r.mapmanager.currentmap)return!0;if(!r.player.allowClickWarp())return!0;if(B(e))return!0;n.setMouseCoordinates(e);var t=r.getMouseGridPosition();return r.client.sendMapMove(r.mapmanager.currentmap.mapname,t.x,t.y),!1};gui.getDom("gamecontainer").oncontextmenu=p,gui.setResize(function(e){r.resize()}),gui.setClick(document.body,null),gui.bind("body","touchstart",f),gui.bind("body","touchend",function(e){if(B(e))return!0;var t=Date.now();return o&&t>o&&t<o+a?(o=t,u++,u==2&&p(e)):u=0,!1}),gui.bind("body","click",function(e){return B(e)?!0:(gui.isVisible("movementhelp")&&gui.fadeOut("movementhelp"),r.started&&r.player&&r.click(),!1)}),gui.setClick("unstickmebutton",function(){n.revive(!0)}),gui.setClick("deathscreen",function(){n.revive(!1)}),gui.setClick("reconnectscreen",function(){n.reconnect()}),gui.bind(document,"mousemove",function(e){return n.setMouseCoordinates(e),!0});var d=[],m=d.concat([""]),g=d.length;gui.getDom("chatinput").onkeydown=function(e){switch(e.which){case 13:var t=this.value.trim();return this.value="",t.length>0?(r.player&&r.say(t,!0),this.placeholder="",n.hideChat(),gui.focus("foreground"),g<d.length&&(m[g]=d[g]),g>=0&&g>=d.length-1&&d[d.length-1]===t?m[d.length]="":(m[d.length]=t,m.push(""),d.push(t),d.length>100&&(m.shift(),d.shift())),g=d.length):n.hideChat(),!1;case 27:return n.hideChat(),!1;case 38:return g>0&&(m[g--]=this.value,this.value=m[g]),!1;case 40:return g<d.length&&(m[g++]=this.value,this.value=m[g]),!1}},gui.bind(document,"keydown",function(e){if(r.player&&r.player.ghostBlocked())return!0;var t=e.which,i=e.altKey||e.ctrlKey||e.metaKey||e.shiftKey;if(t==122)return e.repeat||_(),!1;if(gui.exists("modal_background")||gui.exists("newpopup")){n.hideChat();var s=r.keyConfig[t];switch(s){case"Map":var o=r.menu.getCurrentMenu();(o=="map"||o=="scriptgui"&&r.menu.currentPopupScript=="map")&&r.menu.closePopUp();break;case"Items":var o=r.menu.getCurrentMenu();(o=="inventory"||o=="category")&&r.menu.closePopUp();break;case"HotKey1":case"HotKey2":case"HotKey3":case"HotKey4":case"HotKey5":var u=parseInt(s.substr(6));if(r.menu.getCurrentMenu()=="category"&&r.menu.inventoryCategory.fromhotkey!=u)return r.menu.closePopUp(),r.activateHotkey(u,!1),!1}return!0}if(t==9||t===13){if(gui.isVisible("chatbox"))return n.hideChat(),!1;if(e.target.tagName.toLowerCase()=="body")return r.ready&&r.player&&!r.player.guest&&n.showChat(),!1}if(e.target.tagName.toLowerCase()=="input"||e.target.tagName.toLowerCase()=="textarea")return!0;var a=r.keyConfig[16]=="Emoticon"?e.shiftKey:r.keyConfig[17]=="Emoticon"?e.ctrlKey:r.keyConfig[18]=="Emoticon"?e.altKey:!1;if(a){switch(t){case 65:return r.say("X-("),!1;case 70:return r.say(":-("),!1;case 72:return r.say("<3"),!1;case 73:return r.say("(i)"),!1;case 75:return r.say(":-*"),!1;case 77:return r.say(":-|"),!1;case 78:return r.say("D-)"),!1;case 79:return r.say("o.o"),!1;case 80:return r.say(":-p"),!1;case 81:return r.say(":)]"),!1;case 68:return r.say(":-D"),!1;case 83:return r.say(":-)"),!1;case 84:return r.say(":_("),!1;case 86:return r.say("?-("),!1;case 87:return r.say(";-)"),!1;case 88:return r.say("x-x"),!1;case 90:return r.say("z_z"),!1}if(n.config.extendedemoticons)switch(t){case 66:return r.say(":brb:"),!1;case 69:return r.say(":help:"),!1;case 71:return r.say(":go:"),!1;case 82:return r.say(":afk:"),!1;case 89:return r.say(":ok:"),!1}}if(t==27)return n.hideWindows(),!1;if(e.metaKey||e.shiftKey&&!r.keyConfig[16]||e.ctrlKey&&!r.keyConfig[17]||e.altKey&&!r.keyConfig[18])return!0;if(i&&!(t<32&&r.keyConfig[t]||r.keyConfig[t]&&(r.keyConfig[t].indexOf("Move")==0||r.keyConfig[t].indexOf("Attack")==0)))return!0;if(r.player&&r.player.weaponnpc){if(n.keyScript==t&&e.repeat)return!1;if(r.scriptmanager.runScript(r.player.weaponnpc,r.player,"keydown",[e.which,e.key,e.code,r.keyConfig[t]]))return n.keyScript=t,!1}n.keyScript=null;var s=r.keyConfig[t];if(s&&r.player&&(r.adminActions.indexOf(s)<0||r.player.isGameAdmin())){var f=n.keyAction[s];n.keyAction[s]=!0,n.keyPressedAny=!0;switch(s){case"MoveUp":case"MoveUp2":case"MoveLeft":case"MoveLeft2":case"MoveDown":case"MoveDown2":case"MoveRight":case"MoveRight2":r.unlockSoundsOnMobile(),gui.isVisible("deathscreen")&&n.revive(!1);break;case"Attack1":case"Attack2":f||r.playerAttack(r.player.dir);break;case"AttackUp":f||r.playerAttack(Types.Orientations.UP);break;case"AttackLeft":f||r.playerAttack(Types.Orientations.LEFT);break;case"AttackDown":f||r.playerAttack(Types.Orientations.DOWN);break;case"AttackRight":f||r.playerAttack(Types.Orientations.RIGHT);break;case"Reload1":case"Reload2":r.player.useSecondaryWeapon(!1);break;case"2ndMode":r.player.useMode2Button();break;case"HotKey1":A(1);break;case"HotKey2":A(2);break;case"HotKey3":A(3);break;case"HotKey4":A(4);break;case"HotKey5":A(5);break;case"StrafeLock":r.player.strafeLock=!r.player.strafeLock,r.showShortMessage("Strafe: "+(r.player.strafeLock?"On":"Off"));break;case"Stealth":r.client&&r.client.sendChat("/stealth "+(r.player.stealth?"off":"on"));break;case"Zoom":r.client&&r.client.sendChat("/zoom "+(r.player.zoom>1?"off":"on"));break;case"Map":["map","scriptgui"].indexOf(r.menu.getCurrentMenu())>=0?r.menu.closePopUp():r.menu.showMapAndLoad();break;case"Items":["inventory","category"].indexOf(r.menu.getCurrentMenu())>=0?r.menu.closePopUp():r.menu.showMenuByName("inventory",!0)}return!1}}),gui.bind(document,"keyup",function(e){var t=e.which,i=r.keyConfig[t];if(i){switch(i){case"HotKey1":O(1);break;case"HotKey2":O(2);break;case"HotKey3":O(3);break;case"HotKey4":O(4);break;case"HotKey5":O(5)}n.keyAction[i]=!1}}),window.console&&console.log("Initialized game")};s()});if(typeof window.onerror=="object"){var lastErrorLogTime=null;window.onerror=function(e,t,n,r,i){var s=Date.now();return lastErrorLogTime&&s<lastErrorLogTime+5e3?!1:(lastErrorLogTime=s,gui.callURL("errorlog.php",{message:e,url:t,linenr:n,column:r,error:JSON.stringify(i)}),!1)}};